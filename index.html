<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="迷途小书童" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="90后迷途小书童">
<meta property="og:type" content="website">
<meta property="og:title" content="迷途小书童">
<meta property="og:url" content="https://wangyun137.github.io/index.html">
<meta property="og:site_name" content="迷途小书童">
<meta property="og:description" content="90后迷途小书童">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="迷途小书童">
<meta name="twitter:description" content="90后迷途小书童">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://wangyun137.github.io/"/>





  <title>迷途小书童</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">迷途小书童</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">遇见一个人可能只要一秒，喜欢一个人可能需要一天，忘记一个人却需要一辈子</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-/"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/Retrofit学习-二/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/Retrofit学习-二/" itemprop="url">Retrofit学习(二)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:22:11+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Retrofit/" itemprop="url" rel="index">
                    <span itemprop="name">Retrofit</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前的<a href="https://wangyun137.github.io/2017/07/24/Retrofit%E5%AD%A6%E4%B9%A0-%E4%B8%80/">Retrofit学习(一)</a>了解了一下<code>Retrofit</code>的最基本使用，不过目前最流行的<code>Retrofit</code>使用方式是<code>Retrofit + RxJava + Gson</code>, 如果要使用<code>RxJava</code>, 需要在创建<code>Retrofit</code>时配置<code>RxJava</code>对应的CallAdapter:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">OkHttpclient client = <span class="keyword">new</span> OkHttpClient.Builder().build();</div><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">    .client(client)</div><div class="line">    .addCallAdapterFactory(RxJava2CallAdapterFactory.create())</div><div class="line">    .baseUrl(<span class="string">"http://localhost:4567/"</span>)</div><div class="line">    .build();</div></pre></td></tr></table></figure>
<p>下面就主要分析一下<code>RxJava2CallAdapterFactory</code>是如何工作的</p>
<h2 id="RxJava2CallAdapterFactory"><a href="#RxJava2CallAdapterFactory" class="headerlink" title="RxJava2CallAdapterFactory"></a>RxJava2CallAdapterFactory</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RxJava2CallAdapterFactory <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RxJava2CallAdapterFactory(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RxJava2CallAdapterFactory <span class="title">createAsync</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RxJava2CallAdapterFactory(<span class="keyword">null</span>, <span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RxJava2CallAdapterFactory <span class="title">createWithScheduler</span><span class="params">(Scheduler scheduler)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"scheduler == null"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RxJava2CallAdapterFactory(scheduler, <span class="keyword">false</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Scheduler scheduler;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isAsync;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">RxJava2CallAdapterFactory</span><span class="params">(Scheduler scheduler, <span class="keyword">boolean</span> isAsync)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.scheduler = scheduler;</div><div class="line">    <span class="keyword">this</span>.isAsync = isAsync;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>RxJava2CallAdapterFactory</code>提供了三个<code>create</code>系列方法，一般情况下，最常使用的是第一个没有参数的<code>create</code>方法，即不指定<code>Scheduler</code>，<code>isAsync = false</code>, <code>isAsync</code>指明是调用<code>Call.execute</code>还是<code>Call.enqueue</code></p>
<h2 id="RxJava2CallAdapterFactory-get"><a href="#RxJava2CallAdapterFactory-get" class="headerlink" title="RxJava2CallAdapterFactory.get"></a>RxJava2CallAdapterFactory.get</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</div><div class="line">    Class&lt;?&gt; rawType = getRawType(returnType);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (rawType == Completable.class) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RxJava2CallAdapter(Void.class, scheduler, isAsync, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</div><div class="line">                <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> isFlowable = rawType == Flowable.class;</div><div class="line">    <span class="keyword">boolean</span> isSingle = rawType == Single.class;</div><div class="line">    <span class="keyword">boolean</span> isMaybe = rawType == Maybe.class;</div><div class="line">    <span class="comment">//确保返回值是Observable, Flowable, Single, Maybe</span></div><div class="line">    <span class="keyword">if</span> (rawType != Observable.class &amp;&amp; !isFlowable &amp;&amp; !isSingle &amp;&amp; !isMaybe) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> isResult = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">boolean</span> isBody = <span class="keyword">false</span>;</div><div class="line">    Type responseType;</div><div class="line">    <span class="comment">//ParameterizedType指泛型类型，如List&lt;T&gt;</span></div><div class="line">    <span class="keyword">if</span> (!(returnType <span class="keyword">instanceof</span> ParameterizedType)) &#123;</div><div class="line">        String name = isFlowable ? <span class="string">"Flowable"</span></div><div class="line">                : isSingle ? <span class="string">"Single"</span></div><div class="line">                : isMaybe ? <span class="string">"Maybe"</span> : <span class="string">"Observable"</span>;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取返回值的泛型参数</span></div><div class="line">    Type observableType = getParameterUpperBound(<span class="number">0</span>, (ParameterizedType) returnType);</div><div class="line">    Class&lt;?&gt; rawObservableType = getRawType(observableType);</div><div class="line">    <span class="keyword">if</span> (rawObservableType == Response.class) &#123;</div><div class="line">        <span class="comment">//如果泛型参数是Response, 且Response没有泛型参数,抛出异常，Response必须是以泛型形式使用</span></div><div class="line">        <span class="keyword">if</span> (!(observableType <span class="keyword">instanceof</span> ParameterizedType)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//获取Response&lt;T&gt;中的T</span></div><div class="line">        responseType = getParameterUpperBound(<span class="number">0</span>, (ParameterizedType) observableType);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawObservableType == Result.class) &#123;</div><div class="line">        <span class="comment">//如果泛型参数是Result, 且Result没有泛型参数， 抛出异常，Result必须是以泛型形式使用</span></div><div class="line">        <span class="keyword">if</span> (!(observableType <span class="keyword">instanceof</span> ParameterizedType)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//获取Result&lt;T&gt;中的T</span></div><div class="line">        responseType = getParameterUpperBound(<span class="number">0</span>, (ParameterizedType) observableType);</div><div class="line">        isResult = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        responseType = observableType;</div><div class="line">        isBody = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RxJava2CallAdapter(responseType, scheduler, isAsync, isResult, isBody, isFlowable,</div><div class="line">            isSingle, isMaybe, <span class="keyword">false</span>);</div><div class="line">&#125;``</div></pre></td></tr></table></figure>
<ol>
<li>如果返回值类型是<code>Completable</code>， 直接返回一个<code>RxJava2CallAdapter</code>指定其中的<code>isBody = true, isCompletable = true</code></li>
<li>确保方法的返回值<code>Observable</code>, <code>Flowable</code>, <code>Single</code>, <code>Maybe</code>, 否则返回null, 如果是null, 则根据之前的分析，如果<code>CallAdapter.Factory.get()</code>返回null, 在<code>Retrofit.nextCallAdapter</code>中会抛出异常(<code>Retrofit</code>默认有一个<code>ExecutorCallAdapterFactory</code>, 但如果方法返回值不是<code>Call</code>类型，其<code>get()</code>方法会直接返回null)</li>
<li>如果返回值不是泛型，抛出异常</li>
<li>获取返回值中的泛型参数的类型，假设返回值类型<code>Observable&lt;Bean&gt;</code>, 这里获取到的泛型参数类型就是<code>Bean</code></li>
<li>如果泛型参数的类型是<code>retrofit2.Response</code>或<code>retrofit2.Result</code>，确保<code>Response</code>和<code>Result</code>也是以泛型的形式声明的，即返回值类型是<code>Observable&lt;Response&lt;T&gt;&gt;</code>或<code>Observable&lt;Result&lt;T&gt;&gt;</code>；<code>Retrofit + RxJava2</code>最常见的的用法是<code>Observable&lt;Bean&gt; getName(...)</code>, 一般都会直接使用自定义的<code>Bean</code>类， 所以一般情况下， <code>isBody = true</code></li>
<li>返回<code>RxJava2CallAdapter</code></li>
</ol>
<h2 id="RxJava2CallAdapter-adapt"><a href="#RxJava2CallAdapter-adapt" class="headerlink" title="RxJava2CallAdapter.adapt"></a>RxJava2CallAdapter.adapt</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">adapt</span><span class="params">(Call&lt;R&gt; call)</span> </span>&#123;</div><div class="line">    <span class="comment">//call是OkHttpCall, 将R转换为Response&lt;R&gt;</span></div><div class="line">    Observable&lt;Response&lt;R&gt;&gt; responseObservable = isAsync</div><div class="line">            ? <span class="keyword">new</span> CallEnqueueObservable&lt;&gt;(call)</div><div class="line">            : <span class="keyword">new</span> CallExecuteObservable&lt;&gt;(call);</div><div class="line"></div><div class="line">    Observable&lt;?&gt; observable;</div><div class="line">    <span class="keyword">if</span> (isResult) &#123;</div><div class="line">        observable = <span class="keyword">new</span> ResultObservable&lt;&gt;(responseObservable);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBody) &#123;</div><div class="line">        <span class="comment">//将Response&lt;T&gt;转换为T</span></div><div class="line">        observable = <span class="keyword">new</span> BodyObservable&lt;&gt;(responseObservable);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        observable = responseObservable;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (scheduler != <span class="keyword">null</span>) &#123;</div><div class="line">        observable = observable.subscribeOn(scheduler);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isFlowable) &#123;</div><div class="line">        <span class="keyword">return</span> observable.toFlowable(BackpressureStrategy.LATEST);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isSingle) &#123;</div><div class="line">        <span class="keyword">return</span> observable.singleOrError();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isMaybe) &#123;</div><div class="line">        <span class="keyword">return</span> observable.singleElement();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isCompletable) &#123;</div><div class="line">        <span class="keyword">return</span> observable.ignoreElements();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> observable;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先生成一个<code>Obsersavle&lt;Response&lt;R&gt;&gt;</code>, 这里会根据<code>isAsync</code>是否为tru,来确定是生成<code>CallEnqueueObservable</code>还是<code>CallExecuteObservable</code>，这两者的区别在于前者最终实际是调用<code>OkHttpCall.enqueue</code>方法，后者实际调用了<code>OkHttpCall.execute</code>方法， 前者异步执行，后者同步执行</li>
<li><code>Retrofit + RxJava2</code>最常见的的用法是<code>Observable&lt;Bean&gt; getName(...)</code>, 一般都会直接使用自定义的<code>Bean</code>类，</li>
<li>根据之前的分析可以知道，一般情况下，由于开发者都直接使用自己的Bean, 所以<code>isBody = true</code>， 会创建一个<code>BodyObservable</code></li>
<li>之后会根据方法返回值是否是<code>Flowable, Single, Maybe, Completable</code>其中一种来做出具体的转换</li>
</ol>
<h2 id="BodyObservable"><a href="#BodyObservable" class="headerlink" title="BodyObservable"></a>BodyObservable</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BodyObservable</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Observable&lt;Response&lt;T&gt;&gt; upstream;</div><div class="line"></div><div class="line">    BodyObservable(Observable&lt;Response&lt;T&gt;&gt; upstream) &#123;</div><div class="line">        <span class="keyword">this</span>.upstream = upstream;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</div><div class="line">        <span class="comment">//upstream是CallExecuteObservable或CallEnqueueObservable, BodyObserver是一个代理</span></div><div class="line">        <span class="comment">//作用就是把Response&lt;T&gt;转换为T</span></div><div class="line">        upstream.subscribe(<span class="keyword">new</span> BodyObserver&lt;T&gt;(observer));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BodyObserver</span>&lt;<span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">Observer</span>&lt;<span class="title">Response</span>&lt;<span class="title">R</span>&gt;&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> R&gt; observer;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> terminated;</div><div class="line"></div><div class="line">        BodyObserver(Observer&lt;? <span class="keyword">super</span> R&gt; observer) &#123;</div><div class="line">            <span class="keyword">this</span>.observer = observer;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable disposable)</span> </span>&#123;</div><div class="line">            observer.onSubscribe(disposable);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Response&lt;R&gt; response)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (response.isSuccessful()) &#123;</div><div class="line">                observer.onNext(response.body());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                ...</div><div class="line">            &#125;            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (!terminated) &#123;</div><div class="line">                observer.onComplete();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (!terminated) &#123;</div><div class="line">                observer.onError(throwable);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里<code>upstream</code>是<code>CallExecutorObservable</code>或<code>CallEnqueueObservable</code>，一般情况下，这里会是<code>CallExecutorObservable</code>；<code>在subscribeActual</code>中可以看到，在传入的<code>observer</code>外又包装了一个<code>BodyObserver</code>, 传入的<code>observer</code>就是开发者传入的自定义<code>Observer</code></p>
<h1 id="CallExecutorObservable"><a href="#CallExecutorObservable" class="headerlink" title="CallExecutorObservable"></a>CallExecutorObservable</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CallExecuteObservable</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">Response</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Call&lt;T&gt; originalCall;</div><div class="line"></div><div class="line">    CallExecuteObservable(Call&lt;T&gt; originalCall) &#123;</div><div class="line">        <span class="keyword">this</span>.originalCall = originalCall;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> Response&lt;T&gt;&gt; observer)</span> </span>&#123;</div><div class="line">        <span class="comment">//originalCall是OkHttpCall</span></div><div class="line">        Call&lt;T&gt; call = originalCall.clone();</div><div class="line">        observer.onSubscribe(<span class="keyword">new</span> CallDisposable(call));</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> terminated = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//call.execute会调用OkHttpCall.execute(), 从而得到okhttp3.Response</span></div><div class="line">            <span class="comment">//再从okhttp3.Response中得到okhttp3.ResponseBody, 然后调用    Converter.convert转换结果，最后将接过封装为retrofit.Response</span></div><div class="line">            Response&lt;T&gt; response = call.execute();</div><div class="line">            <span class="keyword">if</span> (!call.isCanceled()) &#123;</div><div class="line">            	<span class="comment">//BodyObserver.onNext -&gt; 自定义Onserver.onNext</span></div><div class="line">                observer.onNext(response);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!call.isCanceled()) &#123;</div><div class="line">                terminated = <span class="keyword">true</span>;</div><div class="line">                observer.onComplete();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CallDisposable</span> <span class="keyword">implements</span> <span class="title">Disposable</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Call&lt;?&gt; call;</div><div class="line"></div><div class="line">        CallDisposable(Call&lt;?&gt; call) &#123;</div><div class="line">            <span class="keyword">this</span>.call = call;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispose</span><span class="params">()</span> </span>&#123;</div><div class="line">            call.cancel();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDisposed</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> call.isCanceled();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>originalCall</code>是<code>OkHttpCall</code>, 可以看到在<code>subscribeActual</code>中会调用<code>call.execute</code>即调用<code>OkHttpCall.execute</code>来从而得到okhttp3.Response, 再从okhttp3.Response中得到okhttp3.ResponseBody, 然后调用    <code>Converter.convert</code>转换结果，最后将结果封装为<code>retrofit.Response</code>,</p>
<p><code>subscribeActual</code>的参数<code>observer</code>是<code>BodyObserver</code>, 而从之前的分析中可以看到<code>BodyObserver</code>的各方法会再调用开发人员自定义的<code>Observer</code>的响应方法</p>
<p> <strong>这里看似比较抽象的一系列操作，是为了获得一个统一的结果， 一般开发人员在定义请求方法时,都会使用<code>Observable&lt;Bean&gt;</code>这种方式，即直接将<code>Observable&lt;T&gt;</code>中的T设为自定义Bean, 但不同场景下肯定会定义不同的类型Bean, Retrofit不可能预先知道开发人员会定义那些Bean, 为了得到一个统一的结果，先将Bean转换为<code>Reponse&lt;T&gt;</code>,这样无论T是哪种类型，都可以得到一个统一的结果，之后再通过<code>Response.body()</code>将Response转换为自定义Bean</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/Retrofit学习-一/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/Retrofit学习-一/" itemprop="url">Retrofit学习(一)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:18:55+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Retrofit/" itemprop="url" rel="index">
                    <span itemprop="name">Retrofit</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一-使用用例"><a href="#一-使用用例" class="headerlink" title="一. 使用用例"></a>一. 使用用例</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//步骤【1】</span></div><div class="line">OkHttpclient client = <span class="keyword">new</span> OkHttpClient.Builder().build();</div><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">	.client(client)</div><div class="line">       .baseUrl(<span class="string">"http://localhost:4567/"</span>)</div><div class="line">       .build();</div><div class="line">   </div><div class="line">   </div><div class="line">   <span class="meta">@GET</span>(<span class="string">"/getName"</span>)</div><div class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">request</span><span class="params">(@Query(<span class="string">"name"</span>)</span> String name)</span>;</div><div class="line">  	</div><div class="line">   <span class="comment">//步骤【2】</span></div><div class="line">   IService service = retrofit.create(IService.class); </div><div class="line">   Call&lt;ResponseBody&gt; call = service.request(<span class="string">"test"</span>);</div><div class="line">   <span class="comment">//步骤【3】</span></div><div class="line">   call.enqueue(<span class="keyword">new</span> Callable() &#123;</div><div class="line">   	...</div><div class="line">   )</div></pre></td></tr></table></figure>
<h1 id="二-源码解析"><a href="#二-源码解析" class="headerlink" title="二. 源码解析"></a>二. 源码解析</h1><h2 id="1-Retrofit-Build"><a href="#1-Retrofit-Build" class="headerlink" title="1. Retrofit.Build"></a>1. Retrofit.Build</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">    <span class="comment">//一般情况下，Platform是Android</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>(Platform.get());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    Builder(Platform platform) &#123;</div><div class="line">            <span class="keyword">this</span>.platform = platform;</div><div class="line">            converterFactories.add(<span class="keyword">new</span> BuiltInConverters());</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Retrofit <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (baseUrl == <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Base URL required."</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        okhttp3.Call.Factory callFactory = <span class="keyword">this</span>.callFactory;</div><div class="line">        <span class="keyword">if</span> (callFactory == <span class="keyword">null</span>) &#123;</div><div class="line">             callFactory = <span class="keyword">new</span> OkHttpClient();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Executor callbackExecutor = <span class="keyword">this</span>.callbackExecutor;</div><div class="line">        <span class="comment">//如果是Android平台，则Executor的实际逻辑就是在当前主线程中runnable</span></div><div class="line">        <span class="keyword">if</span> (callbackExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">            callbackExecutor = platform.defaultCallbackExecutor();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        List&lt;CallAdapter.Factory&gt; adapterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.adapterFactories);</div><div class="line">        <span class="comment">//如果是Android平台，defaultCallAdapterFactory是ExecutorCallAdapterFactory</span></div><div class="line">            adapterFactories.add(platform.defaultCallAdapterFactory(callbackExecutor));</div><div class="line"></div><div class="line">       <span class="comment">//如果没设置，默认没有convert</span></div><div class="line">       List&lt;Converter.Factory&gt; converterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.converterFactories);</div><div class="line"></div><div class="line">       <span class="comment">//validateEagerly默认为false</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Retrofit(callFactory, baseUrl, converterFactories, adapterFactories,</div><div class="line">                    callbackExecutor, validateEagerly);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>如果没有设置<code>CallAdapter</code>,对于Android平台，默认使用<code>ExecutorCallAdapterFactory</code></li>
<li>如果没有设置<code>ConvertFactory</code>, 默认使用<code>BuiltInConverters</code></li>
</ol>
<h2 id="2-Retrofit-create"><a href="#2-Retrofit-create" class="headerlink" title="2. Retrofit.create"></a>2. Retrofit.create</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</div><div class="line">	<span class="comment">//校验传入的Class是不是Interface,且定义了至少一个方法</span></div><div class="line">       Utils.validateServiceInterface(service);</div><div class="line">       <span class="keyword">if</span> (validateEagerly) &#123;</div><div class="line">       	<span class="comment">//如果是Android平台，isDefaultMethod = false, 将service中所有method都生成对应的</span></div><div class="line">       	<span class="comment">//ServiceMethod类，并放入缓存(核心调用为【2.1】loadServiceMethod)</span></div><div class="line">           eagerlyValidateMethods(service);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[]&#123;service&#125;,</div><div class="line">               <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">                   <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</div><div class="line"></div><div class="line">                   <span class="meta">@Override</span></div><div class="line">                   <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></div><div class="line">                           <span class="keyword">throws</span> Throwable &#123;</div><div class="line">                       <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</div><div class="line">                           <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</div><div class="line">                       &#125;</div><div class="line">                       <span class="comment">//Android平台isDefaultMethod = false</span></div><div class="line">                       <span class="keyword">if</span> (platform.isDefaultMethod(method)) &#123;</div><div class="line">                           <span class="keyword">return</span> platform.invokeDefaultMethod(method, service, proxy, args);</div><div class="line">                       &#125;</div><div class="line">                       ServiceMethod&lt;Object, Object&gt; serviceMethod =</div><div class="line">                               (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method);</div><div class="line">                       OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line">                       <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</div><div class="line">                   &#125;</div><div class="line">               &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先校验传入的Class是不是一个接口</li>
<li>因为默认的validateEagly = false, 所以不执行eagerlyValidateMethods方法，该方法实质上根据接口中的所有方法生成每个方法相应的ServiceMethod，并放入缓存</li>
<li><strong>创建动态代理(核心步骤)，以后每次调用接口的方法都会调用InvocationHandler.invoke(…)方法</strong></li>
</ol>
<h3 id="2-1-Retrofit-loadServiceMethod"><a href="#2-1-Retrofit-loadServiceMethod" class="headerlink" title="2.1 Retrofit.loadServiceMethod"></a>2.1 Retrofit.loadServiceMethod</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ServiceMethod&lt;?, ?&gt; loadServiceMethod(Method method) &#123;</div><div class="line">    ServiceMethod&lt;?, ?&gt; result = serviceMethodCache.get(method);</div><div class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (serviceMethodCache) &#123;</div><div class="line">        result = serviceMethodCache.get(method);</div><div class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//【2.2】</span></div><div class="line">            result = <span class="keyword">new</span> ServiceMethod.Builder&lt;&gt;(<span class="keyword">this</span>, method).build();</div><div class="line">            serviceMethodCache.put(method, result);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建相应的<code>ServiceMethod</code>类，并放入缓存</p>
<h3 id="2-2-ServiceMethod-Builder"><a href="#2-2-ServiceMethod-Builder" class="headerlink" title="2.2 ServiceMethod.Builder"></a>2.2 ServiceMethod.Builder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Builder(Retrofit retrofit, Method method) &#123;</div><div class="line">    <span class="keyword">this</span>.retrofit = retrofit;</div><div class="line">    <span class="keyword">this</span>.method = method;</div><div class="line">    <span class="keyword">this</span>.methodAnnotations = method.getAnnotations();</div><div class="line">    <span class="keyword">this</span>.parameterTypes = method.getGenericParameterTypes();</div><div class="line">    <span class="keyword">this</span>.parameterAnnotationsArray = method.getParameterAnnotations();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> ServiceMethod <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="comment">//获取CallAdapter, 【2.2.1】</span></div><div class="line">     callAdapter = createCallAdapter();</div><div class="line">     <span class="comment">//获取Call&lt;T&gt;中T的具体类型</span></div><div class="line">     responseType = callAdapter.responseType();</div><div class="line">     <span class="comment">//确保T并不是retrofit2.Response或者okhttp3.Response</span></div><div class="line">     <span class="keyword">if</span> (responseType == Response.class||responseType == okhttp3.Response.class) &#123;</div><div class="line">		...</div><div class="line">     &#125;</div><div class="line">     <span class="comment">//如果没有设置Converter,默认的Converter是BuiltInConverter, 通过</span></div><div class="line">     <span class="comment">//BuiltInConvert.responseBodyConverter返回Convert, </span></div><div class="line">     <span class="comment">//如果Annotation中Streaming, 则返回StreamingResponseBodyConverter， </span></div><div class="line">     <span class="comment">//否则返回BufferingResponseBodyConverter </span></div><div class="line">     <span class="comment">//【2.2.2】</span></div><div class="line">     responseConverter = createResponseConverter();</div><div class="line">     <span class="comment">//处理方法的注释, 【2.2.3】</span></div><div class="line">     <span class="keyword">for</span> (Annotation annotation : methodAnnotations) &#123;</div><div class="line">          parseMethodAnnotation(annotation);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">if</span> (httpMethod == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> methodError(...);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">    <span class="comment">//对于GET，HEAD等没有body的请求，不允许出现@FormEncodedUrl或@MultiPart等注释</span></div><div class="line">     <span class="keyword">if</span> (!hasBody) &#123;</div><div class="line">         <span class="keyword">if</span> (isMultipart) &#123;</div><div class="line">                <span class="keyword">throw</span> methodError(..);</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">if</span> (isFormEncoded) &#123;</div><div class="line">               <span class="keyword">throw</span> methodError(...);</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">     <span class="comment">//处理参数的注解, 【2.2.4】</span></div><div class="line">     <span class="keyword">int</span> parameterCount = parameterAnnotationsArray.length;</div><div class="line">     parameterHandlers = <span class="keyword">new</span> ParameterHandler&lt;?&gt;[parameterCount];</div><div class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; parameterCount; p++) &#123;</div><div class="line">           Type parameterType = parameterTypes[p];</div><div class="line">            <span class="keyword">if</span> (Utils.hasUnresolvableType(parameterType)) &#123;</div><div class="line">                 <span class="keyword">throw</span> parameterError(...);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Annotation[] parameterAnnotations = parameterAnnotationsArray[p];</div><div class="line">            <span class="keyword">if</span> (parameterAnnotations == <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="keyword">throw</span> parameterError(...);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (relativeUrl == <span class="keyword">null</span> &amp;&amp; !gotUrl) &#123;</div><div class="line">              <span class="keyword">throw</span> methodError(...);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//GET, DELETE等方法不可以有@Body</span></div><div class="line">       <span class="keyword">if</span> (!isFormEncoded &amp;&amp; !isMultipart &amp;&amp; !hasBody &amp;&amp; gotBody) &#123;</div><div class="line">             <span class="keyword">throw</span> methodError(...);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//有@FormUrlEncoded注释则参数中至少有一个@Field注释</span></div><div class="line">       <span class="keyword">if</span> (isFormEncoded &amp;&amp; !gotField) &#123;</div><div class="line">             <span class="keyword">throw</span> methodError(...);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//有@Multipart注释，参数中至少有一个@Part注释</span></div><div class="line">       <span class="keyword">if</span> (isMultipart &amp;&amp; !gotPart) &#123;</div><div class="line">             <span class="keyword">throw</span> methodError(...);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ServiceMethod&lt;&gt;(<span class="keyword">this</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ol>
<li>获取CallAdapter</li>
<li>获取Call<t>中T的具体类型，并确保T并不是retrofit2.Reponse或okhttp3.Response</t></li>
<li>获取Converter</li>
<li>处理方法注释</li>
<li>注释参数注释</li>
</ol>
<h4 id="2-2-1-ServiceMethod-createCallAdapter"><a href="#2-2-1-ServiceMethod-createCallAdapter" class="headerlink" title="2.2.1 ServiceMethod.createCallAdapter"></a>2.2.1 ServiceMethod.createCallAdapter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> CallAdapter&lt;T, R&gt; <span class="title">createCallAdapter</span><span class="params">()</span> </span>&#123;</div><div class="line">      Type returnType = method.getGenericReturnType();</div><div class="line">       <span class="comment">//返回值不能是TypeVariable和WildcardType</span></div><div class="line">       <span class="keyword">if</span> (Utils.hasUnresolvableType(returnType)) &#123;</div><div class="line">             <span class="keyword">throw</span> methodError(...);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//确保返回值不能是void</span></div><div class="line">       <span class="keyword">if</span> (returnType == <span class="keyword">void</span>.class) &#123;</div><div class="line">            <span class="keyword">throw</span> methodError(...);</div><div class="line">      &#125;</div><div class="line">      Annotation[] annotations = method.getAnnotations();</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">             <span class="keyword">return</span> (CallAdapter&lt;T, R&gt;) retrofit.callAdapter(returnType, annotations);</div><div class="line">      &#125; <span class="keyword">catch</span> (RuntimeException e) &#123; </div><div class="line">             <span class="keyword">throw</span> methodError(...);</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="2-2-1-1-Retrofit-callAdapter"><a href="#2-2-1-1-Retrofit-callAdapter" class="headerlink" title="2.2.1.1 Retrofit.callAdapter"></a>2.2.1.1 Retrofit.callAdapter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> CallAdapter&lt;?, ?&gt; callAdapter(Type returnType, Annotation[] annotations) &#123;</div><div class="line">    <span class="keyword">return</span> nextCallAdapter(<span class="keyword">null</span>, returnType, annotations);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> CallAdapter&lt;?, ?&gt; nextCallAdapter(CallAdapter.Factory skipPast, Type returnType,</div><div class="line">                                         Annotation[] annotations) &#123;</div><div class="line">    checkNotNull(returnType, <span class="string">"returnType == null"</span>);</div><div class="line">    checkNotNull(annotations, <span class="string">"annotations == null"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> start = adapterFactories.indexOf(skipPast) + <span class="number">1</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = start, count = adapterFactories.size(); i &lt; count; i++) &#123;</div><div class="line">    	<span class="comment">//如果没有显示的设置，Android平台的默认只有一个CallAdapter.Factory -&gt; ExecutorCallAdapterFactory</span></div><div class="line">        CallAdapter&lt;?, ?&gt; adapter = adapterFactories.get(i).get(returnType, annotations, <span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (adapter != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> adapter;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...        </div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(...);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="2-2-1-2-ExecutorCallAdapterFactory-get"><a href="#2-2-1-2-ExecutorCallAdapterFactory-get" class="headerlink" title="2.2.1.2 ExecutorCallAdapterFactory.get()"></a>2.2.1.2 ExecutorCallAdapterFactory.get()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</div><div class="line">    <span class="comment">//确保返回值类型是Call</span></div><div class="line">    <span class="keyword">if</span> (getRawType(returnType) != Call.class) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//返回Call&lt;T&gt;的具体所指的类型</span></div><div class="line">    <span class="keyword">final</span> Type responseType = Utils.getCallResponseType(returnType);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CallAdapter&lt;Object, Call&lt;?&gt;&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Type <span class="title">responseType</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> responseType;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Call&lt;Object&gt; <span class="title">adapt</span><span class="params">(Call&lt;Object&gt; call)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ExecutorCallbackCall&lt;&gt;(callbackExecutor, call);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-2-ServiceMethod-createResponseConverter"><a href="#2-2-2-ServiceMethod-createResponseConverter" class="headerlink" title="2.2.2 ServiceMethod.createResponseConverter()"></a>2.2.2 ServiceMethod.createResponseConverter()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Converter&lt;ResponseBody, T&gt; <span class="title">createResponseConverter</span><span class="params">()</span> </span>&#123;</div><div class="line">           Annotation[] annotations = method.getAnnotations();</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="keyword">return</span> retrofit.responseBodyConverter(responseType, annotations);</div><div class="line">           &#125; <span class="keyword">catch</span> (RuntimeException e) &#123; </div><div class="line">                <span class="keyword">throw</span> methodError(...);</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<h5 id="2-2-2-1-Retrofit-responseBodyConverter"><a href="#2-2-2-1-Retrofit-responseBodyConverter" class="headerlink" title="2.2.2.1 Retrofit.responseBodyConverter"></a>2.2.2.1 Retrofit.responseBodyConverter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Converter&lt;ResponseBody, T&gt; <span class="title">responseBodyConverter</span><span class="params">(Type type, Annotation[] annotations)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> nextResponseBodyConverter(<span class="keyword">null</span>, type, annotations);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="keyword">public</span> &lt;T&gt; <span class="function">Converter&lt;ResponseBody, T&gt; <span class="title">nextResponseBodyConverter</span><span class="params">(Converter.Factory skipPast,Type type, Annotation[] annotations)</span> </span>&#123;</div><div class="line">   </div><div class="line">       checkNotNull(type, <span class="string">"type == null"</span>);</div><div class="line">       checkNotNull(annotations, <span class="string">"annotations == null"</span>);</div><div class="line"></div><div class="line">       <span class="keyword">int</span> start = converterFactories.indexOf(skipPast) + <span class="number">1</span>;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = start, count = converterFactories.size(); i &lt; count; i++) &#123;</div><div class="line">       	<span class="comment">//如果没有显示设置， convertFactories里面只有BuiltInConverters</span></div><div class="line">           Converter&lt;ResponseBody, ?&gt; converter =</div><div class="line">                   converterFactories.get(i).responseBodyConverter(type, annotations, <span class="keyword">this</span>);</div><div class="line">           <span class="keyword">if</span> (converter != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">return</span> (Converter&lt;ResponseBody, T&gt;) converter;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       ...</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(...);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h5 id="2-2-2-2-BuiltInConverters-responseBodyConverter"><a href="#2-2-2-2-BuiltInConverters-responseBodyConverter" class="headerlink" title="2.2.2.2 BuiltInConverters.responseBodyConverter"></a>2.2.2.2 BuiltInConverters.responseBodyConverter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotations,</div><div class="line">                                                           Retrofit retrofit) &#123;</div><div class="line">       <span class="keyword">if</span> (type == ResponseBody.class) &#123;</div><div class="line">           <span class="keyword">return</span> Utils.isAnnotationPresent(annotations, Streaming.class)</div><div class="line">                   ? StreamingResponseBodyConverter.INSTANCE</div><div class="line">                   : BufferingResponseBodyConverter.INSTANCE;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (type == Void.class) &#123;</div><div class="line">           <span class="keyword">return</span> VoidResponseBodyConverter.INSTANCE;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-3-ServiceMethod-parseMethodAnnotation"><a href="#2-2-3-ServiceMethod-parseMethodAnnotation" class="headerlink" title="2.2.3 ServiceMethod.parseMethodAnnotation"></a>2.2.3 ServiceMethod.parseMethodAnnotation</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseMethodAnnotation</span><span class="params">(Annotation annotation)</span> </span>&#123;</div><div class="line">           <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> DELETE) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"DELETE"</span>, ((DELETE) annotation).value(), <span class="keyword">false</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> GET) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"GET"</span>, ((GET) annotation).value(), <span class="keyword">false</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> HEAD) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"HEAD"</span>, ((HEAD) annotation).value(), <span class="keyword">false</span>);</div><div class="line">               <span class="keyword">if</span> (!Void.class.equals(responseType)) &#123;</div><div class="line">                   <span class="keyword">throw</span> methodError(<span class="string">"HEAD method must use Void as response type."</span>);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> PATCH) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"PATCH"</span>, ((PATCH) annotation).value(), <span class="keyword">true</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> POST) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"POST"</span>, ((POST) annotation).value(), <span class="keyword">true</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> PUT) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"PUT"</span>, ((PUT) annotation).value(), <span class="keyword">true</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> OPTIONS) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"OPTIONS"</span>, ((OPTIONS) annotation).value(), <span class="keyword">false</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> HTTP) &#123;</div><div class="line">               HTTP http = (HTTP) annotation;</div><div class="line">               parseHttpMethodAndPath(http.method(), http.path(), http.hasBody());</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> retrofit2.http.Headers) &#123;</div><div class="line">               String[] headersToParse = ((retrofit2.http.Headers) annotation).value();</div><div class="line">               <span class="keyword">if</span> (headersToParse.length == <span class="number">0</span>) &#123;</div><div class="line">                   <span class="keyword">throw</span> methodError(<span class="string">"@Headers annotation is empty."</span>);</div><div class="line">               &#125;</div><div class="line">               headers = parseHeaders(headersToParse);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> Multipart) &#123;</div><div class="line">               <span class="keyword">if</span> (isFormEncoded) &#123;</div><div class="line">                   <span class="keyword">throw</span> methodError(<span class="string">"Only one encoding annotation is allowed."</span>);</div><div class="line">               &#125;</div><div class="line">               isMultipart = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> FormUrlEncoded) &#123;</div><div class="line">               <span class="keyword">if</span> (isMultipart) &#123;</div><div class="line">                   <span class="keyword">throw</span> methodError(<span class="string">"Only one encoding annotation is allowed."</span>);</div><div class="line">               &#125;</div><div class="line">               isFormEncoded = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p><code>parseMethodAnnotation</code>方法主要就是用过<code>parseHttpMethodAndPath</code>方法设置<code>ServiceMethhod</code>的请求方法，相对Url,  是否有body等选项</p>
<h4 id="2-2-4-ServiceMethod-parseParameter"><a href="#2-2-4-ServiceMethod-parseParameter" class="headerlink" title="2.2.4 ServiceMethod.parseParameter"></a>2.2.4 ServiceMethod.parseParameter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ParameterHandler&lt;?&gt; parseParameter(<span class="keyword">int</span> p, Type parameterType, Annotation[] annotations) &#123;</div><div class="line">     ParameterHandler&lt;?&gt; result = <span class="keyword">null</span>;</div><div class="line">     <span class="keyword">for</span> (Annotation annotation : annotations) &#123;</div><div class="line">          <span class="comment">//核心调用</span></div><div class="line">         ParameterHandler&lt;?&gt; annotationAction = parseParameterAnnotation(</div><div class="line">                        p, parameterType, annotations, annotation);</div><div class="line">         <span class="keyword">if</span> (annotationAction == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">continue</span>;</div><div class="line">          &#125;</div><div class="line">         <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">throw</span> parameterError(...);</div><div class="line">         &#125;</div><div class="line">         result = annotationAction;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> parameterError(p, <span class="string">"No Retrofit annotation found."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法中的核心调用<code>parseParameterAnnotation</code>,这个方法的主要作用是根据参数的注解进行不同的处理，参数的注解可以是以下几种:</p>
<ul>
<li>@Url</li>
<li>@Path</li>
<li>@Query</li>
<li>@QueryName</li>
<li>@QueryMap</li>
<li>@Header</li>
<li>@HeaderMap</li>
<li>@Field</li>
<li>@FieldMap</li>
<li>@Part</li>
<li>@PartMap</li>
<li>@Body</li>
</ul>
<h3 id="2-3-ServiceMethod-callAdapter-adapter"><a href="#2-3-ServiceMethod-callAdapter-adapter" class="headerlink" title="2.3 ServiceMethod.callAdapter.adapter"></a>2.3 ServiceMethod.callAdapter.adapter</h3><p>ServiceMethod.callAdapter是通过<code>ExcecutorAdapterFactory.get()</code>创建的一个匿名<code>CallAdapter</code>, 其实现为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">new</span> CallAdapter&lt;Object, Call&lt;?&gt;&gt;() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Type <span class="title">responseType</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> responseType;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Call&lt;Object&gt; <span class="title">adapt</span><span class="params">(Call&lt;Object&gt; call)</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">new</span> ExecutorCallbackCall&lt;&gt;(callbackExecutor, call);</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">       </div><div class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorCallbackCall</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Call</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">   	<span class="keyword">final</span> Executor callbackExecutor;</div><div class="line">       <span class="keyword">final</span> Call&lt;T&gt; delegate;</div><div class="line">   	....</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>由此可以看出，最终真正返回的是<code>ExecutorCallbackCall</code>, 其中<code>delagate</code>是<code>OkHttpCall</code></p>
<h2 id="3-ExecutorCallbackCall-enqueue"><a href="#3-ExecutorCallbackCall-enqueue" class="headerlink" title="3. ExecutorCallbackCall.enqueue"></a>3. ExecutorCallbackCall.enqueue</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;</div><div class="line">   	<span class="keyword">if</span> (callback == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"callback == null"</span>);</div><div class="line">	<span class="comment">//实际是调用OkHttpCall.enqueue</span></div><div class="line">       delegate.enqueue(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;T&gt; call, <span class="keyword">final</span> Response&lt;T&gt; response)</span> </span>&#123;</div><div class="line">                   callbackExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                           <span class="keyword">if</span> (delegate.isCanceled()) &#123;</div><div class="line">                               callback.onFailure(ExecutorCallbackCall.<span class="keyword">this</span>, <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>));</div><div class="line">                           &#125; <span class="keyword">else</span> &#123;</div><div class="line">                               callback.onResponse(ExecutorCallbackCall.<span class="keyword">this</span>, response);</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;T&gt; call, <span class="keyword">final</span> Throwable t)</span> </span>&#123;</div><div class="line">                   callbackExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                           callback.onFailure(ExecutorCallbackCall.<span class="keyword">this</span>, t);</div><div class="line">                       &#125;</div><div class="line">                   &#125;);</div><div class="line">               &#125;</div><div class="line">      &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到实际调用的是<code>OkHttpCall.enqueue</code></p>
<h3 id="3-1-OkHttpCall-enqueue"><a href="#3-1-OkHttpCall-enqueue" class="headerlink" title="3.1 OkHttpCall.enqueue"></a>3.1 OkHttpCall.enqueue</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (callback == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"callback == null"</span>);</div><div class="line"></div><div class="line">       okhttp3.Call call;</div><div class="line">       Throwable failure;</div><div class="line"></div><div class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (executed)</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already executed."</span>);</div><div class="line">           executed = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">           call = rawCall;</div><div class="line">           failure = creationFailure;</div><div class="line">           <span class="keyword">if</span> (call == <span class="keyword">null</span> &amp;&amp; failure == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">               	<span class="comment">//【3.1.1】</span></div><div class="line">                   call = rawCall = createRawCall();</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                   failure = creationFailure = t;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (failure != <span class="keyword">null</span>) &#123;</div><div class="line">           callback.onFailure(<span class="keyword">this</span>, failure);</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (canceled) &#123;</div><div class="line">           call.cancel();</div><div class="line">       &#125;</div><div class="line">	<span class="comment">//调用okhttp3.Call.enqueue,后续走的就是okhttp请求的流程</span></div><div class="line">       call.enqueue(<span class="keyword">new</span> okhttp3.Callback() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response rawResponse)</span></span></div><div class="line">                   <span class="keyword">throws</span> IOException &#123;</div><div class="line">               Response&lt;T&gt; response;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">//【3.1.2】</span></div><div class="line">                   response = parseResponse(rawResponse);</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">                   callFailure(e);</div><div class="line">                   <span class="keyword">return</span>;</div><div class="line">               &#125;</div><div class="line">               callSuccess(response);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(okhttp3.Call call, IOException e)</span> </span>&#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   callback.onFailure(OkHttpCall.<span class="keyword">this</span>, e);</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                   t.printStackTrace();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callFailure</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   callback.onFailure(OkHttpCall.<span class="keyword">this</span>, e);</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                   t.printStackTrace();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callSuccess</span><span class="params">(Response&lt;T&gt; response)</span> </span>&#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   callback.onResponse(OkHttpCall.<span class="keyword">this</span>, response);</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                   t.printStackTrace();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="3-1-1-OkHttpCall-createNewCall"><a href="#3-1-1-OkHttpCall-createNewCall" class="headerlink" title="3.1.1 OkHttpCall.createNewCall"></a>3.1.1 OkHttpCall.createNewCall</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> okhttp3.<span class="function">Call <span class="title">createRawCall</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	<span class="comment">//这里的args就是被动态代理的方法的参数, 【3.1.2.1】</span></div><div class="line">    Request request = serviceMethod.toRequest(args);</div><div class="line">    <span class="comment">//callFactory是OkHttpClient</span></div><div class="line">    okhttp3.Call call = serviceMethod.callFactory.newCall(request);</div><div class="line">    <span class="keyword">if</span> (call == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Call.Factory returned null."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> call;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>OkHttpClient</code>同样实现了<code>okhttp3.Call.Factory</code>接口， 而通过步骤【1】和【2.2】的代码可以看出, 这里的<code>callFactory</code>就是<code>OkHttpClient</code>,所以调用的是<code>OkhttpClient.newCall</code>(实际返回一个<code>okhttp3.RealCall</code>)</p>
<h5 id="3-1-1-1-ServiceMethod-toRequest"><a href="#3-1-1-1-ServiceMethod-toRequest" class="headerlink" title="3.1.1.1 ServiceMethod.toRequest"></a>3.1.1.1 ServiceMethod.toRequest</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function">Request <span class="title">toRequest</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       RequestBuilder requestBuilder = <span class="keyword">new</span> RequestBuilder(httpMethod, baseUrl, relativeUrl, headers,</div><div class="line">               contentType, hasBody, isFormEncoded, isMultipart);</div><div class="line"></div><div class="line">        ParameterHandler&lt;Object&gt;[] handlers = (ParameterHandler&lt;Object&gt;[]) parameterHandlers;</div><div class="line"></div><div class="line">       <span class="keyword">int</span> argumentCount = args != <span class="keyword">null</span> ? args.length : <span class="number">0</span>;</div><div class="line">       <span class="keyword">if</span> (argumentCount != handlers.length) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Argument count ("</span> + argumentCount</div><div class="line">                   + <span class="string">") doesn't match expected count ("</span> + handlers.length + <span class="string">")"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; argumentCount; p++) &#123;</div><div class="line">       	<span class="comment">//不同参数的注释有对应不同的handler, 以Query为例，其handler是Query&lt;T&gt;</span></div><div class="line">           handlers[p].apply(requestBuilder, args[p]);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> requestBuilder.build();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这个方法的核心调用在于<code>handlers[p].apply</code>,不同的参数注释，对应这不同的<code>ParameterHandler</code>,以<code>@Query</code>为例，它所对应的<code>ParammeterHandler</code>是<code>Query&lt;T&gt;</code>, <code>Query&lt;T&gt;.apply</code>的作用是将<code>@Query</code>所修饰的参数转为<code>String</code>类型并添加到要请求的url的query string中</p>
<h4 id="3-1-2-OkHttpCall-parseResponse"><a href="#3-1-2-OkHttpCall-parseResponse" class="headerlink" title="3.1.2 OkHttpCall.parseResponse"></a>3.1.2 OkHttpCall.parseResponse</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function">Response&lt;T&gt; <span class="title">parseResponse</span><span class="params">(okhttp3.Response rawResponse)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        ResponseBody rawBody = rawResponse.body();</div><div class="line"></div><div class="line">        <span class="comment">// Remove the body's source (the only stateful object) so we can pass the response along.</span></div><div class="line">        rawResponse = rawResponse.newBuilder()</div><div class="line">                .body(<span class="keyword">new</span> NoContentResponseBody(rawBody.contentType(), rawBody.contentLength()))</div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="keyword">int</span> code = rawResponse.code();</div><div class="line">        <span class="keyword">if</span> (code &lt; <span class="number">200</span> || code &gt;= <span class="number">300</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// Buffer the entire body to avoid future I/O.</span></div><div class="line">                ResponseBody bufferedBody = Utils.buffer(rawBody);</div><div class="line">                <span class="keyword">return</span> Response.error(bufferedBody, rawResponse);</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                rawBody.close();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (code == <span class="number">204</span> || code == <span class="number">205</span>) &#123;</div><div class="line">            rawBody.close();</div><div class="line">            <span class="keyword">return</span> Response.success(<span class="keyword">null</span>, rawResponse);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ExceptionCatchingRequestBody catchingBody = <span class="keyword">new</span> ExceptionCatchingRequestBody(rawBody);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            T body = serviceMethod.toResponse(catchingBody);</div><div class="line">            <span class="keyword">return</span> Response.success(body, rawResponse);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">            <span class="comment">// If the underlying source threw an exception, propagate that rather than indicating it was</span></div><div class="line">            <span class="comment">// a runtime exception.</span></div><div class="line">            catchingBody.throwIfCaught();</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">`</div></pre></td></tr></table></figure>
<h4 id="3-1-3-ServiceMethod-toResponse"><a href="#3-1-3-ServiceMethod-toResponse" class="headerlink" title="3.1.3 ServiceMethod.toResponse"></a>3.1.3 ServiceMethod.toResponse</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">R <span class="title">toResponse</span><span class="params">(ResponseBody body)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">return</span> responseConverter.convert(body);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在之前【2.2.2】中可以得知， 如果没有设置Converter，则使用默认的BuiltInConverter来获取对应的response convert, 如果方法中有<code>@Streaming</code>注释，则<code>responseConverter</code>是<code>StreamingResponseBodyConverter</code>, 否则是<code>BufferingResponseBodyConverter</code>, 一般情况下不会有<code>@Streaming</code>注释</p>
<h4 id="3-1-4-Converter-convert"><a href="#3-1-4-Converter-convert" class="headerlink" title="3.1.4 Converter.convert"></a>3.1.4 Converter.convert</h4><h5 id="3-1-4-1-StreamingResponseBodyConverter"><a href="#3-1-4-1-StreamingResponseBodyConverter" class="headerlink" title="3.1.4.1 StreamingResponseBodyConverter"></a>3.1.4.1 StreamingResponseBodyConverter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamingResponseBodyConverter</span></span></div><div class="line">        <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">ResponseBody</span>, <span class="title">ResponseBody</span>&gt; &#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> StreamingResponseBodyConverter INSTANCE = <span class="keyword">new</span> StreamingResponseBodyConverter();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ResponseBody <span class="title">convert</span><span class="params">(ResponseBody value)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="3-1-4-2-BufferingResponseBodyConverter"><a href="#3-1-4-2-BufferingResponseBodyConverter" class="headerlink" title="3.1.4.2 BufferingResponseBodyConverter"></a>3.1.4.2 BufferingResponseBodyConverter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferingResponseBodyConverter</span></span></div><div class="line">            <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">ResponseBody</span>, <span class="title">ResponseBody</span>&gt; &#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">final</span> BufferingResponseBodyConverter INSTANCE = <span class="keyword">new</span> BufferingResponseBodyConverter();</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ResponseBody <span class="title">convert</span><span class="params">(ResponseBody value)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Buffer the entire body to avoid future I/O.</span></div><div class="line">            <span class="keyword">return</span> Utils.buffer(value);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            value.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">//Utils.buffer </span></div><div class="line"><span class="function"><span class="keyword">static</span> ResponseBody <span class="title">buffer</span><span class="params">(<span class="keyword">final</span> ResponseBody body)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Buffer buffer = <span class="keyword">new</span> Buffer();</div><div class="line">    body.source().readAll(buffer);</div><div class="line">    <span class="keyword">return</span> ResponseBody.create(body.contentType(), body.contentLength(), buffer);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/DiskLruCache学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/DiskLruCache学习/" itemprop="url">DiskLruCache学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:15:26+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DiskLruCache/" itemprop="url" rel="index">
                    <span itemprop="name">DiskLruCache</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一-用法"><a href="#一-用法" class="headerlink" title="一. 用法"></a>一. 用法</h1><p><code>DiskLruCache</code>是Google官方推荐的磁盘缓存方案，很多优秀的App都在使用这一方案，在<a href="http://blog.csdn.net/guolin_blog/article/details/28863651" target="_blank" rel="external">Android DiskLruCache完全解析， 硬盘缓存的最佳方案</a>这篇博客中，很详细的介绍了如何使用<code>DiskLruCache</code>，通过这篇博文可以将<code>DiskLruCache</code>的用法总结为以下几个步骤:</p>
<h2 id="1-1-写缓存"><a href="#1-1-写缓存" class="headerlink" title="1.1 写缓存"></a>1.1 写缓存</h2><ol>
<li>确定缓存目录， 获取App版本号， 调用<code>DiskaLruCache.open</code>创建<code>DiskLruCache</code>对象</li>
<li>通过<code>DiskLruCache.editor()</code>获取<code>DiskLruCache.Editor</code>对象</li>
<li>通过<code>Editor.newOutputStream()</code>获取输出流，之后利用该输出流将缓存文件写入磁盘</li>
<li>调用<code>Editor.commit()</code>,<code>DiskLruCache.flush()</code>刷新日志文件</li>
</ol>
<h2 id="1-2-读缓存"><a href="#1-2-读缓存" class="headerlink" title="1.2 读缓存"></a>1.2 读缓存</h2><ol>
<li>通过<code>DiskLruCache.get()</code>获取<code>Snapshot</code>对象</li>
<li>通过<code>Snapshot.getInputStream()</code>获取输入流，利用该输入流读取缓存文件</li>
</ol>
<h2 id="1-3-日志文件"><a href="#1-3-日志文件" class="headerlink" title="1.3 日志文件"></a>1.3 日志文件</h2><p><code>DiskLruCache</code>主要通过日志文件来记录和管理缓存文件，在<code>DiskLruCache</code>的源码中有一段注释详细陈述了日志文件的格式:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">libcore.io.DiskLruCache</div><div class="line">1</div><div class="line">100</div><div class="line">2</div><div class="line"></div><div class="line">CLEAN 3400330d1dfc7f3f7f4b8d4d803dfcf6 832 21054</div><div class="line">DIRTY 335c4c6028171cfddfbaae1a9c313c52</div><div class="line">CLEAN 335c4c6028171cfddfbaae1a9c313c52 3934 2342</div><div class="line">REMOVE 335c4c6028171cfddfbaae1a9c313c52</div><div class="line">DIRTY 1ab96a171faeeee38496d8b330771a7a</div><div class="line">CLEAN 1ab96a171faeeee38496d8b330771a7a 1600 234</div><div class="line">READ 335c4c6028171cfddfbaae1a9c313c52</div><div class="line">READ 3400330d1dfc7f3f7f4b8d4d803dfcf6</div></pre></td></tr></table></figure>
<p>前五行是日志文件的头部信息，其意义分别是</p>
<ul>
<li>第一行的<code>libcore.io.DiskLruCache</code>是文件的<code>MAGIC</code>, 用来标识该文件是<code>DiskLruCache</code>的日志文件</li>
<li>第二行是<code>DiskLruCache</code>自身的版本号</li>
<li>第三行是App的版本号，通过<code>DiskLruCache.open</code>的第二个参数设置</li>
<li>第四行是<code>DiskLruCache.open</code>的第三个参数，代表一个key值可以缓存多少个Entry</li>
<li>第五行是一个空行</li>
</ul>
<p>从第六行开始记录了缓存文件的相应操作:</p>
<ul>
<li>每次调用<code>DiskLruCache.edit()</code>时，都会向日志文件写入一条DIRTY数据，表示当前正在准备写入一条缓存数据, DIRTY后面各一个空格写入缓存的key值</li>
<li>当调用<code>Editor.commit()</code>将缓存写入成功之后，会在DIRTY数据下一行写入一条key值相同的CLEAN数据， CLEAN后面隔一个空格写入相同的key值，key值后隔一个空格写入以字节为单位的该缓存文件的大小，如果在<code>DiskLruCache.open</code>中第三个参数<code>valueCount</code>传大于1的值，那么每一个key值可以对应多个缓存文件，相应的一条CLEAN数据后面就会记录多个缓存文件的大小，其数目等于<code>valueCount</code>；如果调用<code>Editor.abort()</code>，那么会在DIRTY数据下一行下入一条REMOVE记录。也就是说， 每一条DIRTY数据下一行都有条CLEAN数据或REMOVE<br>数据，DIRTY数据不可以单独存在，否则这条数据就会被删除掉; 当调用<code>DiskLruCache.get()</code>时都会想日志文件写如一条READ数据，表示正在读取缓存文件</li>
</ul>
<h1 id="二-源码分析"><a href="#二-源码分析" class="headerlink" title="二.源码分析"></a>二.源码分析</h1><p>下面就根据这几个步骤结合源码来看一下<code>DiskLruCache</code>的具体实现</p>
<h2 id="2-1-重要变量和类"><a href="#2-1-重要变量和类" class="headerlink" title="2.1 重要变量和类"></a>2.1 重要变量和类</h2><h3 id="2-1-1-变量"><a href="#2-1-1-变量" class="headerlink" title="2.1.1 变量"></a>2.1.1 变量</h3><ul>
<li>journalWriter: Writer 用于向日志文件写入内容</li>
<li>lruEntries: LinkedHashMap<string, entry=""> 每一个缓存文件都有一个对应的Entry对象，lruEntries用来存放key值对应的Entry对象</string,></li>
<li>redundantOpCount:记录操作缓存的次数，如果该值达到2000，<code>DiskLruCache</code>就会重新构建日志文件，将其中一些冗余的数据删除</li>
<li>size: 记录总有缓存文件总大小</li>
<li>maxSize: 所有缓存文件大小的总和的上限值，如果超过该值，那么就会删除一些缓存文件</li>
<li>cleanupCallable: Callable 当缓存文件总大小超过上限时会触发该任务，用于清除一些缓存文件，从而减少缓存文件总和</li>
</ul>
<h3 id="2-1-2-类"><a href="#2-1-2-类" class="headerlink" title="2.1.2 类"></a>2.1.2 类</h3><ul>
<li>Snapshot: 调用<code>DiskLruCache.get()</code>会获取一个<code>Snapshot</code>对象，通过<code>Snapshot</code>可以获取缓存文件的输入流</li>
<li>Editor: 编辑器，对于缓存文件的操作以及日志文件的更新都是通过这个类完成</li>
<li>Entry: 每一个缓存文件都有一个对应的<code>Entry</code>对象， <code>DiskLruCache</code>通过操作<code>Entry</code>对象来完成对缓存文件的操作</li>
<li>StrictLineReader: 封装了输入流，提供可以每次读取一行内容的方法</li>
</ul>
<h2 id="2-2-DiskLruCache-open"><a href="#2-2-DiskLruCache-open" class="headerlink" title="2.2 DiskLruCache.open"></a>2.2 DiskLruCache.open</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> String JOURNAL_FILE = <span class="string">"journal"</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> String JOURNAL_FILE_BACKUP = <span class="string">"journal.bkp"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DiskLruCache <span class="title">open</span><span class="params">(File directory, <span class="keyword">int</span> appVersion, <span class="keyword">int</span> valueCount, <span class="keyword">long</span> maxSize)</span></span></div><div class="line">           <span class="keyword">throws</span> IOException &#123;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (maxSize &lt;= <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"maxSize &lt;= 0"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (valueCount &lt;= <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"valueCount &lt;= 0"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//如果备份文件存在则使用备份文件</span></div><div class="line">       File backupFile = <span class="keyword">new</span> File(directory, JOURNAL_FILE_BACKUP);</div><div class="line">       <span class="keyword">if</span> (backupFile.exists()) &#123;</div><div class="line">           File journalFile = <span class="keyword">new</span> File(directory, JOURNAL_FILE);</div><div class="line">           <span class="comment">//如果日志文件存在，删除备份文件</span></div><div class="line">           <span class="keyword">if</span> (journalFile.exists()) &#123;</div><div class="line">               backupFile.delete();</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">//将备份文件重命名为日志文件</span></div><div class="line">               renameTo(backupFile, journalFile, <span class="keyword">false</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Prefer to pick up where we left off.</span></div><div class="line">       DiskLruCache cache = <span class="keyword">new</span> DiskLruCache(directory, appVersion, valueCount, maxSize);</div><div class="line">       <span class="comment">//如果日志文件存在的话，读取日志文件并处理，填充lruEntries, 然后直接返回DiskLruCache对象</span></div><div class="line">       <span class="keyword">if</span> (cache.journalFile.exists()) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="comment">//读取journal文件, 【2.2.1】</span></div><div class="line">               cache.readJournal();</div><div class="line">               <span class="comment">//处理读取的journal文件内容, 【2.2.2】</span></div><div class="line">               cache.processJournal();</div><div class="line">               <span class="keyword">return</span> cache;</div><div class="line">           &#125; <span class="keyword">catch</span> (IOException journalIsCorrupt) &#123;</div><div class="line">               ...</div><div class="line">               cache.delete();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//如果没有已有的日志文件，创建对应的缓存目录， 并初始化日志文件</span></div><div class="line">       directory.mkdirs();</div><div class="line">       cache = <span class="keyword">new</span> DiskLruCache(directory, appVersion, valueCount, maxSize);</div><div class="line">       <span class="comment">//新建日志文件,【2.2.3】</span></div><div class="line">       cache.rebuildJournal();</div><div class="line">       <span class="keyword">return</span> cache;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先检查备份文件是否存在，之后再确定日志文件是否存在， 如果日志文件存在，则删除备份文件，如果日志文件不存在但备份文件村咋，将备份文件重命名为日志文件</li>
<li>创建<code>DiskLruCache</code>对象，构造函数中几个参数的意义分别是:<code>directory</code> - 缓存目录; <code>appVersion</code> - 应用版本号; <code>valueCount</code> - 一个可以可以缓存几个Entry, 一般都传1; <code>maxSize</code> - 所有缓存文件大小的总和占据的最大存储空间</li>
<li>如果日志文件已存在，读取日志文件并根据日志文件进行一些必要的操作，如删除以<code>DIRTY</code>开头的文件</li>
<li>如果日志文件不存在，创建缓存目录,并新建日志文件</li>
</ol>
<h3 id="2-2-1-DiskLruCache-readJournal"><a href="#2-2-1-DiskLruCache-readJournal" class="headerlink" title="2.2.1 DiskLruCache.readJournal"></a>2.2.1 DiskLruCache.readJournal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readJournal</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       StrictLineReader reader = <span class="keyword">new</span> StrictLineReader(<span class="keyword">new</span> FileInputStream(journalFile), Util.US_ASCII);</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">//读取第一行魔数</span></div><div class="line">           String magic = reader.readLine();</div><div class="line">           <span class="comment">//读取第二行version</span></div><div class="line">           String version = reader.readLine();</div><div class="line">           <span class="comment">//读取第三行appVersion</span></div><div class="line">           String appVersionString = reader.readLine();</div><div class="line">           <span class="comment">//读取第四行valueCount</span></div><div class="line">           String valueCountString = reader.readLine();</div><div class="line">           <span class="comment">//读取第五行空行</span></div><div class="line">           String blank = reader.readLine();</div><div class="line">           <span class="comment">//确保头部信息正确</span></div><div class="line">           <span class="keyword">if</span> (!MAGIC.equals(magic)</div><div class="line">                   || !VERSION_1.equals(version)</div><div class="line">                   || !Integer.toString(appVersion).equals(appVersionString)</div><div class="line">                   || !Integer.toString(valueCount).equals(valueCountString)</div><div class="line">                   || !<span class="string">""</span>.equals(blank)) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IOException(...);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">int</span> lineCount = <span class="number">0</span>;</div><div class="line">           <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">//处理这一行内容,【2.2.1.1】</span></div><div class="line">                   readJournalLine(reader.readLine());</div><div class="line">                   lineCount++;</div><div class="line">               &#125; <span class="keyword">catch</span> (EOFException endOfJournal) &#123;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//处理了多少行 - lruEntries.size()</span></div><div class="line">           redundantOpCount = lineCount - lruEntries.size();</div><div class="line"></div><div class="line">           <span class="comment">// 如果遇到IO异常， 重新构建日志文件</span></div><div class="line">           <span class="keyword">if</span> (reader.hasUnterminatedLine()) &#123;</div><div class="line">               rebuildJournal();</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               journalWriter = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(</div><div class="line">                       <span class="keyword">new</span> FileOutputStream(journalFile, <span class="keyword">true</span>), Util.US_ASCII));</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           Util.closeQuietly(reader);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>从代码中可以看到，读取日志文件每一行内容主要使用了<code>StrictLineReader</code>这个类， 这个类实际上封装了<code>InputStream</code>, 内部有一个缓存数组，每次缓存<strong>8192</strong>个字节，从而提高了读取的效率，当遇到换行符时即判定为一行内容</p>
</blockquote>
<ol>
<li>首先读取前五行，校验是否是正确的头部信息</li>
<li>c处理完前五行之后，依次读取每一行内容并根据内容进行操作</li>
<li>如果遇到IO异常，重新构建日志文件；否则一切正常的话， 初始化<code>journalWriter</code>(用来写入日志文件)</li>
</ol>
<h4 id="2-2-1-1-DiskLruCache-readJournalLine"><a href="#2-2-1-1-DiskLruCache-readJournalLine" class="headerlink" title="2.2.1.1 DiskLruCache.readJournalLine"></a>2.2.1.1 DiskLruCache.readJournalLine</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readJournalLine</span><span class="params">(String line)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="comment">//获取第一个空格的位置</span></div><div class="line">       <span class="keyword">int</span> firstSpace = line.indexOf(<span class="string">' '</span>);</div><div class="line">       <span class="keyword">if</span> (firstSpace == -<span class="number">1</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"unexpected journal line: "</span> + line);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//第一个空格后面是key的起始位置</span></div><div class="line">       <span class="keyword">int</span> keyBegin = firstSpace + <span class="number">1</span>;</div><div class="line">       <span class="comment">//获取第二个空格的位置， 一般如果是CLEAN的话会有第二个空格</span></div><div class="line">       <span class="keyword">int</span> secondSpace = line.indexOf(<span class="string">' '</span>, keyBegin);</div><div class="line">       <span class="keyword">final</span> String key;</div><div class="line">       <span class="keyword">if</span> (secondSpace == -<span class="number">1</span>) &#123;</div><div class="line">           key = line.substring(keyBegin);</div><div class="line">           <span class="comment">//如果这一行的开头是REMOVE, 从lruEntries中删除key</span></div><div class="line">           <span class="keyword">if</span> (firstSpace == REMOVE.length() &amp;&amp; line.startsWith(REMOVE)) &#123;</div><div class="line">               lruEntries.remove(key);</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           key = line.substring(keyBegin, secondSpace);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//从lruEntries中获取key值对应的Entry, 如果lruEntries中没有对应的Entry，生成一个新的Entry并放入lruEntries</span></div><div class="line">       Entry entry = lruEntries.get(key);</div><div class="line">       <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">           entry = <span class="keyword">new</span> Entry(key);</div><div class="line">           lruEntries.put(key, entry);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//如果这一行是以CLEAN开头, 获取第二个空格之后内容</span></div><div class="line">       <span class="keyword">if</span> (secondSpace != -<span class="number">1</span> &amp;&amp; firstSpace == CLEAN.length() &amp;&amp; line.startsWith(CLEAN)) &#123;</div><div class="line">           String[] parts = line.substring(secondSpace + <span class="number">1</span>).split(<span class="string">" "</span>);</div><div class="line">           entry.readable = <span class="keyword">true</span>;</div><div class="line">           entry.currentEditor = <span class="keyword">null</span>;</div><div class="line">           entry.setLengths(parts);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//如果这一行是以DIRTY开头，将currentEditor指向一个新的Editor</span></div><div class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (secondSpace == -<span class="number">1</span> &amp;&amp; firstSpace == DIRTY.length() &amp;&amp; line.startsWith(DIRTY)) &#123;</div><div class="line">           entry.currentEditor = <span class="keyword">new</span> Editor(entry);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//如果这一行以READ开头，啥也不干</span></div><div class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (secondSpace == -<span class="number">1</span> &amp;&amp; firstSpace == READ.length() &amp;&amp; line.startsWith(READ)) &#123;</div><div class="line">           <span class="comment">// This work was already done by calling lruEntries.get().</span></div><div class="line">       &#125;</div><div class="line">       <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"unexpected journal line: "</span> + line);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>根据空格依次获得每一行的开头标识(DIRTY, CLEAN, REMOVE)以及对应的key值</li>
<li>如果这一行是以REMOVE开头，从<code>lruEntries</code>中删除key对应的Entry并返回</li>
<li>从<code>lruEntries</code>中获取key值对应的<code>Entry</code>，如果没有则生成一个新的<code>Entry</code>对象并放入<code>lruEntries</code>,这个操作的目的是为了保持日志文件和内存中<code>lruEntries</code>的数据的一致性</li>
<li>如果这一行是以CLEAN开头，获取key值以后的内容(记录一个或多个对象缓存文件的大小)，同时标记<code>entry.readable = true</code>, <code>entry.currentEditor = null</code>，即表示该缓存文件为可读的</li>
<li>如果这一行是以DIRTY开头的，将<code>entry.currentEditor</code>指向一个新创建的<code>Editor</code>对象</li>
</ol>
<h3 id="2-2-2-DiskLruCache-processJournal"><a href="#2-2-2-DiskLruCache-processJournal" class="headerlink" title="2.2.2 DiskLruCache.processJournal"></a>2.2.2 DiskLruCache.processJournal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processJournal</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="comment">//删除journal.tmp文件</span></div><div class="line">        deleteIfExists(journalFileTmp);</div><div class="line">        <span class="comment">//遍历lruEntries</span></div><div class="line">        <span class="keyword">for</span> (Iterator&lt;Entry&gt; i = lruEntries.values().iterator(); i.hasNext(); ) &#123;</div><div class="line">            Entry entry = i.next();</div><div class="line">            <span class="keyword">if</span> (entry.currentEditor == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//如果currentEditor为null, 代表该entry是CLEAN的，增加size</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> t = <span class="number">0</span>; t &lt; valueCount; t++) &#123;</div><div class="line">                    size += entry.lengths[t];</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//如果currentEditor不为null， 代表该entry是DIRTY的，删除对应的缓存文件和临时文件</span></div><div class="line">                <span class="comment">//并从lruEntries中删除该entry</span></div><div class="line">                entry.currentEditor = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> t = <span class="number">0</span>; t &lt; valueCount; t++) &#123;</div><div class="line">                    deleteIfExists(entry.getCleanFile(t));</div><div class="line">                    deleteIfExists(entry.getDirtyFile(t));</div><div class="line">                &#125;</div><div class="line">                i.remove();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>如果临时日志文件存在，删除临时文件</li>
<li>遍历<code>lruEntries</code>, 如果<code>entry.currentEditor == null</code>代表这一个entry是CLEAN的，将entry对应的文件大小统计到所有缓存文件大小总和中；相反，则代表entry是DIRTY的，删除对应的缓存文件，并从<code>lruEntries</code>中删除(NOTE:这里其实针对的是只有DIRTY记录的缓存文件，因为正常情况下，每一条DIRTY数据后都会紧跟一条CLEAN或者REMOVE数据，如果有CLEAN或REMOVE数据，在之前的【2.2.1.1】<code>readJournalLine</code>中都已经经过了处理，其所对应的entry的currentEditor肯定为null或不在<code>lruEntries</code>中了)</li>
</ol>
<h3 id="2-2-3-DiskLruCache-rebuildJournal"><a href="#2-2-3-DiskLruCache-rebuildJournal" class="headerlink" title="2.2.3 DiskLruCache.rebuildJournal"></a>2.2.3 DiskLruCache.rebuildJournal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">rebuildJournal</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="keyword">if</span> (journalWriter != <span class="keyword">null</span>) &#123;</div><div class="line">           journalWriter.close();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//先写入journal.tmp文件</span></div><div class="line">       Writer writer = <span class="keyword">new</span> BufferedWriter(</div><div class="line">               <span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(journalFileTmp), Util.US_ASCII));</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">//写入头部信息</span></div><div class="line">           writer.write(MAGIC);</div><div class="line">           writer.write(<span class="string">"\n"</span>);</div><div class="line">           writer.write(VERSION_1);</div><div class="line">           writer.write(<span class="string">"\n"</span>);</div><div class="line">           writer.write(Integer.toString(appVersion));</div><div class="line">           writer.write(<span class="string">"\n"</span>);</div><div class="line">           writer.write(Integer.toString(valueCount));</div><div class="line">           writer.write(<span class="string">"\n"</span>);</div><div class="line">           writer.write(<span class="string">"\n"</span>);</div><div class="line"></div><div class="line">           <span class="keyword">for</span> (Entry entry : lruEntries.values()) &#123;</div><div class="line">               <span class="keyword">if</span> (entry.currentEditor != <span class="keyword">null</span>) &#123;</div><div class="line">                   <span class="comment">//如果currentEditor不为null, 则写入DIRTY开头的行</span></div><div class="line">                   writer.write(DIRTY + <span class="string">' '</span> + entry.key + <span class="string">'\n'</span>);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">//写入以CLEAN开头的行</span></div><div class="line">                   writer.write(CLEAN + <span class="string">' '</span> + entry.key + entry.getLengths() + <span class="string">'\n'</span>);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           writer.close();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (journalFile.exists()) &#123;</div><div class="line">           renameTo(journalFile, journalFileBackup, <span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">       renameTo(journalFileTmp, journalFile, <span class="keyword">false</span>);</div><div class="line">       journalFileBackup.delete();</div><div class="line"></div><div class="line">       journalWriter = <span class="keyword">new</span> BufferedWriter(</div><div class="line">               <span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(journalFile, <span class="keyword">true</span>), Util.US_ASCII));</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先写入固定头部</li>
<li>遍历<code>lruEntries</code>,根据<code>entry.currentEditor</code>是否等于null，写入DIRTY或者CLEAN记录</li>
</ol>
<h2 id="2-3-DiskLruCache-edit"><a href="#2-3-DiskLruCache-edit" class="headerlink" title="2.3 DiskLruCache.edit"></a>2.3 DiskLruCache.edit</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Editor <span class="title">edit</span><span class="params">(String key)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="keyword">return</span> edit(key, ANY_SEQUENCE_NUMBER);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> Editor <span class="title">edit</span><span class="params">(String key, <span class="keyword">long</span> expectedSequenceNumber)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="comment">//如果journalWritter == null， 抛出异常</span></div><div class="line">       checkNotClosed();</div><div class="line">       <span class="comment">//校验key是否合法</span></div><div class="line">       validateKey(key);</div><div class="line">       <span class="comment">//从lruEntries中获取Entry</span></div><div class="line">       Entry entry = lruEntries.get(key);</div><div class="line">       <span class="keyword">if</span> (expectedSequenceNumber != ANY_SEQUENCE_NUMBER &amp;&amp; (entry == <span class="keyword">null</span></div><div class="line">               || entry.sequenceNumber != expectedSequenceNumber)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// Snapshot is stale.</span></div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">           entry = <span class="keyword">new</span> Entry(key);</div><div class="line">           lruEntries.put(key, entry);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry.currentEditor != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// Another edit is in progress.</span></div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Editor editor = <span class="keyword">new</span> Editor(entry);</div><div class="line">       entry.currentEditor = editor;</div><div class="line"></div><div class="line">       <span class="comment">// 先写入DIRTY行</span></div><div class="line">       journalWriter.write(DIRTY + <span class="string">' '</span> + key + <span class="string">'\n'</span>);</div><div class="line">       journalWriter.flush();</div><div class="line">       <span class="keyword">return</span> editor;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>检查<code>journal</code>是否为null, 如果是抛出异常</li>
<li>检查key值是否符合<code>[a-z0-9_-]{1,120}</code>规则</li>
<li>根据key获取对应的<code>Entry</code></li>
<li>新建一个<code>Editor</code>对象，将<code>entry.currentEditor</code>指向新建的<code>Editor</code>对象</li>
<li>向日志文件写入DIRTY数据</li>
</ol>
<blockquote>
<p>每当调用<code>editor()</code>时都会先在日志文件中写入一条DIRTY数据,表示正在准备操作缓存文件</p>
</blockquote>
<h2 id="2-4-Editor-newOutputStream"><a href="#2-4-Editor-newOutputStream" class="headerlink" title="2.4 Editor.newOutputStream"></a>2.4 Editor.newOutputStream</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> OutputStream <span class="title">newOutputStream</span><span class="params">(<span class="keyword">int</span> index)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">           <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt;= valueCount) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(...);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">synchronized</span> (DiskLruCache.<span class="keyword">this</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (entry.currentEditor != <span class="keyword">this</span>) &#123;</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (!entry.readable) &#123;</div><div class="line">                   written[index] = <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="comment">//先在临时文件中写入</span></div><div class="line">               File dirtyFile = entry.getDirtyFile(index);</div><div class="line">               FileOutputStream outputStream;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   outputStream = <span class="keyword">new</span> FileOutputStream(dirtyFile);</div><div class="line">               &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">                   <span class="comment">// Attempt to recreate the cache directory.</span></div><div class="line">                   directory.mkdirs();</div><div class="line">                   <span class="keyword">try</span> &#123;</div><div class="line">                       outputStream = <span class="keyword">new</span> FileOutputStream(dirtyFile);</div><div class="line">                   &#125; <span class="keyword">catch</span> (FileNotFoundException e2) &#123;</div><div class="line">                       <span class="comment">// We are unable to recover. Silently eat the writes.</span></div><div class="line">                       <span class="keyword">return</span> NULL_OUTPUT_STREAM;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               <span class="comment">//FaultHidingOutputStream是一个代理类，实际还是调用outputStream的方法</span></div><div class="line">               <span class="comment">//只不过异常发生时会不会抛出异常</span></div><div class="line">               <span class="keyword">return</span> <span class="keyword">new</span> FaultHidingOutputStream(outputStream);</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>获取的是临时文件的输出流</p>
<h2 id="2-5-Editor-commit"><a href="#2-5-Editor-commit" class="headerlink" title="2.5 Editor.commit"></a>2.5 Editor.commit</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (hasErrors) &#123;</div><div class="line">        <span class="comment">//如果有错误，删除缓存文件, 【2.5.1】</span></div><div class="line">        completeEdit(<span class="keyword">this</span>, <span class="keyword">false</span>);</div><div class="line">        remove(entry.key); <span class="comment">// The previous entry is stale.</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        completeEdit(<span class="keyword">this</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    committed = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果IO输出过程有错误发生，从<code>lruEntries</code>中删除相应entry,同时删除对应的缓存文件; 无论是否错误，都会调用<code>DiskLruCache.compleEdit</code>方法, 区别在于错误时传入的第二个参数为false, 正常时为true</p>
<blockquote>
<p><code>hasError</code>是在<code>FaultHidingOutputStream</code>中当出现IO异常时设为true</p>
</blockquote>
<h3 id="2-5-1-DiskLruCache-completeEdit"><a href="#2-5-1-DiskLruCache-completeEdit" class="headerlink" title="2.5.1 DiskLruCache.completeEdit"></a>2.5.1 DiskLruCache.completeEdit</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">completeEdit</span><span class="params">(Editor editor, <span class="keyword">boolean</span> success)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       Entry entry = editor.entry;</div><div class="line">       <span class="keyword">if</span> (entry.currentEditor != editor) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line">       &#125;</div><div class="line"></div><div class="line"></div><div class="line">       <span class="keyword">if</span> (success &amp;&amp; !entry.readable) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">               <span class="keyword">if</span> (!editor.written[i]) &#123;</div><div class="line">                   editor.abort();</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</div><div class="line">               &#125;</div><div class="line">               <span class="comment">//确保临时文件存在</span></div><div class="line">               <span class="keyword">if</span> (!entry.getDirtyFile(i).exists()) &#123;</div><div class="line">                   editor.abort();</div><div class="line">                   <span class="keyword">return</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">           File dirty = entry.getDirtyFile(i);</div><div class="line">           <span class="keyword">if</span> (success) &#123;</div><div class="line">               <span class="keyword">if</span> (dirty.exists()) &#123;</div><div class="line">                   File clean = entry.getCleanFile(i);</div><div class="line">                   dirty.renameTo(clean);</div><div class="line">                   <span class="keyword">long</span> oldLength = entry.lengths[i];</div><div class="line">                   <span class="keyword">long</span> newLength = clean.length();</div><div class="line">                   entry.lengths[i] = newLength;</div><div class="line">                   size = size - oldLength + newLength;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               deleteIfExists(dirty);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       redundantOpCount++;</div><div class="line">       entry.currentEditor = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">if</span> (entry.readable | success) &#123;</div><div class="line">           entry.readable = <span class="keyword">true</span>;</div><div class="line">           <span class="comment">//向日志文件写入CLEAN行</span></div><div class="line">           journalWriter.write(CLEAN + <span class="string">' '</span> + entry.key + entry.getLengths() + <span class="string">'\n'</span>);</div><div class="line">           <span class="keyword">if</span> (success) &#123;</div><div class="line">               entry.sequenceNumber = nextSequenceNumber++;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">//从lruEntries中删除，并向日志文件写入REMOVE行</span></div><div class="line">           lruEntries.remove(entry.key);</div><div class="line">           journalWriter.write(REMOVE + <span class="string">' '</span> + entry.key + <span class="string">'\n'</span>);</div><div class="line">       &#125;</div><div class="line">       journalWriter.flush();</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (size &gt; maxSize || journalRebuildRequired()) &#123;</div><div class="line">           executorService.submit(cleanupCallable);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>确保临时的缓存文件存在，不存在则调用<code>Editor.abort</code></li>
<li>如果传入的<code>success = true</code>即代表IO输出成功，则将临时缓存文件重命名为正式的缓存文件，同时更新缓存文件大小总和；如果<code>sucess = false</code>代表出现错误，则删除临时缓存文件</li>
<li>递增<code>redundantOpCount</code></li>
<li>如果IO输出成功，想日志文件写入CLEAN行数据，否则从<code>lruEntries</code>中删除对应的entry,并向日志文件写入REMOVE行内容</li>
<li>如果缓存文件总大小超出上限或者<code>redundantOpCount</code>大于等于2000时，在线程池中执行<code>cleanupCallable</code>任务</li>
</ol>
<h4 id="2-5-1-1-DiskLruCache-cleanupCallable"><a href="#2-5-1-1-DiskLruCache-cleanupCallable" class="headerlink" title="2.5.1.1 DiskLruCache.cleanupCallable"></a>2.5.1.1 DiskLruCache.cleanupCallable</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Callable&lt;Void&gt; cleanupCallable = <span class="keyword">new</span> Callable&lt;Void&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Void <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (DiskLruCache.<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (journalWriter == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// Closed.</span></div><div class="line">            &#125;</div><div class="line">            trimToSize();</div><div class="line">            <span class="keyword">if</span> (journalRebuildRequired()) &#123;</div><div class="line">            	<span class="comment">//【2.2.3】</span></div><div class="line">                rebuildJournal();</div><div class="line">                redundantOpCount = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">trimToSize</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">//如果缓存的文件总大小超过了maxSize, 删除缓存文件直到小于上限，并更新日志文件</span></div><div class="line">    <span class="keyword">while</span> (size &gt; maxSize) &#123;</div><div class="line">        Map.Entry&lt;String, Entry&gt; toEvict = lruEntries.entrySet().iterator().next();</div><div class="line">        remove(toEvict.getKey());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">journalRebuildRequired</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> redundantOpCompactThreshold = <span class="number">2000</span>;</div><div class="line">    <span class="keyword">return</span> redundantOpCount &gt;= redundantOpCompactThreshold <span class="comment">//</span></div><div class="line">            &amp;&amp; redundantOpCount &gt;= lruEntries.size();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-6-DiskLruCache-flush"><a href="#2-6-DiskLruCache-flush" class="headerlink" title="2.6 DiskLruCache.flush"></a>2.6 DiskLruCache.flush</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="comment">//确保journalWriter不等于null</span></div><div class="line">     checkNotClosed();</div><div class="line">     <span class="comment">//【2.5.1.1】, 删除缓存文件，直到总大小小于上限</span></div><div class="line">     trimToSize();</div><div class="line">     journalWriter.flush();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="2-7-DiskLruCache-get"><a href="#2-7-DiskLruCache-get" class="headerlink" title="2.7 DiskLruCache.get"></a>2.7 DiskLruCache.get</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Snapshot <span class="title">get</span><span class="params">(String key)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	<span class="comment">//确保journalWriter不为null</span></div><div class="line">       checkNotClosed();</div><div class="line">       <span class="comment">//验证key值符合规则</span></div><div class="line">       validateKey(key);</div><div class="line">       Entry entry = lruEntries.get(key);</div><div class="line">       <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (!entry.readable) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line">	<span class="comment">//创建缓存文件输入流</span></div><div class="line">       InputStream[] ins = <span class="keyword">new</span> InputStream[valueCount];</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">               ins[i] = <span class="keyword">new</span> FileInputStream(entry.getCleanFile(i));</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">           <span class="comment">// A file must have been deleted manually!</span></div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">               <span class="keyword">if</span> (ins[i] != <span class="keyword">null</span>) &#123;</div><div class="line">                   Util.closeQuietly(ins[i]);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       redundantOpCount++;</div><div class="line">       <span class="comment">//更新日志文件，添加READ行</span></div><div class="line">       journalWriter.append(READ + <span class="string">' '</span> + key + <span class="string">'\n'</span>);</div><div class="line">       <span class="keyword">if</span> (journalRebuildRequired()) &#123;</div><div class="line">           executorService.submit(cleanupCallable);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Snapshot(key, entry.sequenceNumber, ins, entry.lengths);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>确保<code>journalWriter</code>不等于null, key值符合规则</li>
<li>创建缓存文件输入流</li>
<li>向日志文件中写入READ行</li>
<li>返回<code>Snapshot</code>对象</li>
</ol>
<h2 id="2-8-DiskLruCache-close"><a href="#2-8-DiskLruCache-close" class="headerlink" title="2.8 DiskLruCache.close"></a>2.8 DiskLruCache.close</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (journalWriter == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>; <span class="comment">// Already closed.</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (Entry entry : <span class="keyword">new</span> ArrayList&lt;Entry&gt;(lruEntries.values())) &#123;</div><div class="line">        <span class="keyword">if</span> (entry.currentEditor != <span class="keyword">null</span>) &#123;</div><div class="line">            entry.currentEditor.abort();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    trimToSize();</div><div class="line">    journalWriter.close();</div><div class="line">    journalWriter = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>遍历<code>lruEntries</code>,如果<code>entry.currentEditor != null</code>, 调用<code>Editor.abort</code>(abort方法实际调用<code>DiakLruache.completeEdit</code>【2.5.1】, 第二个参数传入false)</li>
<li>检查缓存总大小是否超出上限，如果超出，删除一些缓存文件直到小于上限</li>
<li>关闭<code>journalWrite</code></li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/开源项目学习之Volley-二/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/开源项目学习之Volley-二/" itemprop="url">开源项目学习之Volley(二)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:07:19+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Volley/" itemprop="url" rel="index">
                    <span itemprop="name">Volley</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Volley不仅可以进行普通的网络请求，还提供了一个简单的图片加载框架，下面这段代码展示了最普遍的使用Volley加载图片的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">RequestQueue queue = Volley.newRequestQueue(context);</div><div class="line">ImageLoader loader = <span class="keyword">new</span> ImageLoader(queue, <span class="keyword">new</span> ImageCache() &#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putBitmap</span><span class="params">(String url, Bitmap bitmap)</span> </span>&#123;</div><div class="line">	</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Bitmap <span class="title">getBitmap</span><span class="params">(String url)</span> </span>&#123;</div><div class="line">	</div><div class="line">	&#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">ImageListener listener = ImageLoader.getImageListener(imageView, R.drwable.ic_default_icon, R.drawable.ic_error_icon);</div><div class="line"></div><div class="line">loader.get(<span class="string">"xxx.jpeg"</span>, listener, <span class="number">200</span>, <span class="number">200</span>);</div></pre></td></tr></table></figure>
<p>除了这种用法外，另一种比较常用的是<code>NetworkImageView</code>，它的用法更为简单是:</p>
<ol>
<li>在布局文件中声明一个<code>NetworkImageView</code>控件</li>
<li>获取控件实例</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">networkImageView.setDefaultImageResId(R.drawable.ic_default_icon);  </div><div class="line">networkImageView.setErrorImageResId(R.drawable.ic_error_icon);  </div><div class="line">networkImageView.setImageUrl(&quot;xxx.png&quot;,  </div><div class="line">                imageLoader);</div></pre></td></tr></table></figure>
<p><code>NetworkImageView</code>内部的实现其实仍然是使用了<code>ImageLoader</code>，所以我们主要看一下<code>ImageLoader</code>相关的代码</p>
<h2 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h2><h2 id="1-ImageLoader-getImageListener"><a href="#1-ImageLoader-getImageListener" class="headerlink" title="1. ImageLoader.getImageListener"></a>1. ImageLoader.getImageListener</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ImageListener <span class="title">getImageListener</span><span class="params">(<span class="keyword">final</span> ImageView view,</span></span></div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> defaultImageResId, <span class="keyword">final</span> <span class="keyword">int</span> errorImageResId) &#123;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ImageListener() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</div><div class="line">               <span class="keyword">if</span> (errorImageResId != <span class="number">0</span>) &#123;</div><div class="line">                   view.setImageResource(errorImageResId);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(ImageContainer response, <span class="keyword">boolean</span> isImmediate)</span> </span>&#123;</div><div class="line">               <span class="keyword">if</span> (response.getBitmap() != <span class="keyword">null</span>) &#123;</div><div class="line">                   view.setImageBitmap(response.getBitmap());</div><div class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (defaultImageResId != <span class="number">0</span>) &#123;</div><div class="line">                   view.setImageResource(defaultImageResId);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li><code>defaultImageResId</code>是占位图，<code>errorImageResId</code>是当出现错误时显示的占位图</li>
<li>也可以自定义一个<code>ImgeListener</code></li>
</ul>
<h2 id="2-ImageLoader-get"><a href="#2-ImageLoader-get" class="headerlink" title="2. ImageLoader.get"></a>2. ImageLoader.get</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> ImageContainer <span class="title">get</span><span class="params">(String requestUrl, <span class="keyword">final</span> ImageListener listener)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> get(requestUrl, listener, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> ImageContainer <span class="title">get</span><span class="params">(String requestUrl, ImageListener imageListener,</span></span></div><div class="line">        <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight) &#123;</div><div class="line">    <span class="keyword">return</span> get(requestUrl, imageListener, maxWidth, maxHeight, ScaleType.CENTER_INSIDE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> ImageContainer <span class="title">get</span><span class="params">(String requestUrl, ImageListener imageListener,</span></span></div><div class="line">        <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight, ScaleType scaleType) &#123;</div><div class="line"></div><div class="line">    <span class="comment">//确定是在主线程</span></div><div class="line">    throwIfNotOnMainThread();</div><div class="line">    <span class="comment">//生成缓存key</span></div><div class="line">    <span class="keyword">final</span> String cacheKey = getCacheKey(requestUrl, maxWidth, maxHeight, scaleType);</div><div class="line"></div><div class="line">    <span class="comment">//从缓存中查找Bitmap</span></div><div class="line">    Bitmap cachedBitmap = mCache.getBitmap(cacheKey);</div><div class="line">    <span class="keyword">if</span> (cachedBitmap != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 如果从缓存中找到，则直接回调onResponse</span></div><div class="line">        ImageContainer container = <span class="keyword">new</span> ImageContainer(cachedBitmap, requestUrl, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">        imageListener.onResponse(container, <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">return</span> container;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 生成一个bitmap = null的ImageContainer, 回调onResponse, 这样做的目的是显示占位图</span></div><div class="line">    ImageContainer imageContainer =</div><div class="line">            <span class="keyword">new</span> ImageContainer(<span class="keyword">null</span>, requestUrl, cacheKey, imageListener);</div><div class="line">    imageListener.onResponse(imageContainer, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 从InFlightRequest中查找是否有正在请求的Request</span></div><div class="line">    BatchedImageRequest request = mInFlightRequests.get(cacheKey);</div><div class="line">    <span class="keyword">if</span> (request != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// If it is, add this request to the list of listeners.</span></div><div class="line">        request.addContainer(imageContainer);</div><div class="line">        <span class="keyword">return</span> imageContainer;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">//创建一个新的请求，用于请求图片</span></div><div class="line">    Request&lt;Bitmap&gt; newRequest = makeImageRequest(requestUrl, maxWidth, maxHeight, scaleType,</div><div class="line">            cacheKey);</div><div class="line">    mRequestQueue.add(newRequest);</div><div class="line">    mInFlightRequests.put(cacheKey,</div><div class="line">            <span class="keyword">new</span> BatchedImageRequest(newRequest, imageContainer));</div><div class="line">    <span class="keyword">return</span> imageContainer;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>确定当前是在主线程</li>
<li>生成缓存key, key的规则是“url + #W${maxWidth} + #H${maxHeight} + #S${scaleType.ordinal}”</li>
<li>从缓存中查找Bitmap1,如果找到则回调<code>ImageListener.onResponse</code>,并返回</li>
<li>如果缓存中没有找到，则先生成一个<code>bitmap = null</code>的<code>ImageContainer</code>,然后回调<code>ImageListener.onResponse</code>, 这样做的目的在于可以先让<code>ImageView</code>显示占位图</li>
<li>从<code>inFlightRequests</code>中查找是否存在key对应的正在请求的Request</li>
<li>创建一个新的请求，添加到队列</li>
</ol>
<h3 id="2-1-ImageLoader-makeImageRequest"><a href="#2-1-ImageLoader-makeImageRequest" class="headerlink" title="2.1 ImageLoader.makeImageRequest"></a>2.1 ImageLoader.makeImageRequest</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Request&lt;Bitmap&gt; <span class="title">makeImageRequest</span><span class="params">(String requestUrl, <span class="keyword">int</span> maxWidth, <span class="keyword">int</span> maxHeight,ScaleType scaleType, <span class="keyword">final</span> String cacheKey)</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ImageRequest(requestUrl, <span class="keyword">new</span> Listener&lt;Bitmap&gt;() &#123;</div><div class="line">    	<span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Bitmap response)</span> </span>&#123;</div><div class="line">            onGetImageSuccess(cacheKey, response);</div><div class="line">        &#125;</div><div class="line">     &#125;, maxWidth, maxHeight, scaleType, Config.RGB_565, <span class="keyword">new</span> ErrorListener() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onErrorResponse</span><span class="params">(VolleyError error)</span> </span>&#123;</div><div class="line">            onGetImageError(cacheKey, error);</div><div class="line">        &#125;</div><div class="line">     &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，实际就是构建了一个<code>ImageRequest</code></p>
<h4 id="2-1-1-ImageRequest"><a href="#2-1-1-ImageRequest" class="headerlink" title="2.1.1 ImageRequest"></a>2.1.1 ImageRequest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImageRequest</span> <span class="keyword">extends</span> <span class="title">Request</span>&lt;<span class="title">Bitmap</span>&gt; </span>&#123;</div><div class="line">	...</div><div class="line">	<span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> Response&lt;Bitmap&gt; <span class="title">parseNetworkResponse</span><span class="params">(NetworkResponse response)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (sDecodeLock) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">return</span> doParse(response);</div><div class="line">            &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</div><div class="line">                <span class="keyword">return</span> Response.error(<span class="keyword">new</span> ParseError(e));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> Response&lt;Bitmap&gt; <span class="title">doParse</span><span class="params">(NetworkResponse response)</span> </span>&#123;</div><div class="line">        <span class="keyword">byte</span>[] data = response.data;</div><div class="line">        BitmapFactory.Options decodeOptions = <span class="keyword">new</span> BitmapFactory.Options();</div><div class="line">        Bitmap bitmap = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (mMaxWidth == <span class="number">0</span> &amp;&amp; mMaxHeight == <span class="number">0</span>) &#123;</div><div class="line">            decodeOptions.inPreferredConfig = mDecodeConfig;</div><div class="line">            bitmap = BitmapFactory.decodeByteArray(data, <span class="number">0</span>, data.length, decodeOptions);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// If we have to resize this image, first get the natural bounds.</span></div><div class="line">            decodeOptions.inJustDecodeBounds = <span class="keyword">true</span>;</div><div class="line">            BitmapFactory.decodeByteArray(data, <span class="number">0</span>, data.length, decodeOptions);</div><div class="line">            <span class="keyword">int</span> actualWidth = decodeOptions.outWidth;</div><div class="line">            <span class="keyword">int</span> actualHeight = decodeOptions.outHeight;</div><div class="line"></div><div class="line">            <span class="comment">// 计算出合适的width和height</span></div><div class="line">            <span class="keyword">int</span> desiredWidth = getResizedDimension(mMaxWidth, mMaxHeight,</div><div class="line">                    actualWidth, actualHeight, mScaleType);</div><div class="line">            <span class="keyword">int</span> desiredHeight = getResizedDimension(mMaxHeight, mMaxWidth,</div><div class="line">                    actualHeight, actualWidth, mScaleType);</div><div class="line">            </div><div class="line">            decodeOptions.inJustDecodeBounds = <span class="keyword">false</span>;</div><div class="line">            <span class="comment">// decodeOptions.inPreferQualityOverSpeed = PREFER_QUALITY_OVER_SPEED;</span></div><div class="line">            <span class="comment">//计算出合适的imSampleSize</span></div><div class="line">            decodeOptions.inSampleSize =</div><div class="line">                findBestSampleSize(actualWidth, actualHeight, desiredWidth, desiredHeight);</div><div class="line">            Bitmap tempBitmap =</div><div class="line">                BitmapFactory.decodeByteArray(data, <span class="number">0</span>, data.length, decodeOptions);</div><div class="line"></div><div class="line">            <span class="comment">// If necessary, scale down to the maximal acceptable size.</span></div><div class="line">            <span class="keyword">if</span> (tempBitmap != <span class="keyword">null</span> &amp;&amp; (tempBitmap.getWidth() &gt; desiredWidth ||</div><div class="line">                    tempBitmap.getHeight() &gt; desiredHeight)) &#123;</div><div class="line">                bitmap = Bitmap.createScaledBitmap(tempBitmap,</div><div class="line">                        desiredWidth, desiredHeight, <span class="keyword">true</span>);</div><div class="line">                tempBitmap.recycle();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                bitmap = tempBitmap;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> Response.error(<span class="keyword">new</span> ParseError(response));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> Response.success(bitmap, HttpHeaderParser.parseCacheHeaders(response));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从之前的<a href="http://www.jianshu.com/p/2abe464c4b21" target="_blank" rel="external">开源项目学习之Volley(一)</a>可以知道，<code>Request</code>最重要的方法就是<code>performNetworkResponse</code>,<code>ImageRequest</code>的<code>performNetworkResponse</code>直接调用的私有方法<code>doParse</code>, 从<code>doParse</code>的代码中可以看出其逻辑主要就是解析出合适的Bitmap</p>
<h4 id="2-1-2-ImageLoader-onGetImageSuccess"><a href="#2-1-2-ImageLoader-onGetImageSuccess" class="headerlink" title="2.1.2 ImageLoader.onGetImageSuccess"></a>2.1.2 ImageLoader.onGetImageSuccess</h4><p><code>onGetImageSuccess</code>会再调用<code>batchResponse</code>, 这两个方法的逻辑总结起来就是： <strong>将请求到的Bitmap放入缓存，之后获取到之前传入的<code>ImageListener</code>，回调<code>onResponse</code></strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/开源项目学习之Volley-一/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/开源项目学习之Volley-一/" itemprop="url">开源项目学习之Volley(一)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:04:37+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Volley/" itemprop="url" rel="index">
                    <span itemprop="name">Volley</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一-重要的类"><a href="#一-重要的类" class="headerlink" title="一. 重要的类"></a>一. 重要的类</h2><h3 id="1-1-RequestQueue"><a href="#1-1-RequestQueue" class="headerlink" title="1.1 RequestQueue"></a>1.1 RequestQueue</h3><h4 id="重要变量"><a href="#重要变量" class="headerlink" title="重要变量"></a>重要变量</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//请求等待集合，队列中的请求是重复的，之前已经有一个相同的请求正在执行</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Queue&lt;Request&lt;?&gt;&gt;&gt; mWaitingRequests =</div><div class="line">           <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Request&lt;?&gt;&gt; mCurrentRequests = <span class="keyword">new</span> HashSet&lt;Request&lt;?&gt;&gt;();</div><div class="line"></div><div class="line">   <span class="comment">//缓存队列</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> PriorityBlockingQueue&lt;Request&lt;?&gt;&gt; mCacheQueue =</div><div class="line">           <span class="keyword">new</span> PriorityBlockingQueue&lt;&gt;();</div><div class="line"></div><div class="line">   <span class="comment">//网络请求队列</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> PriorityBlockingQueue&lt;Request&lt;?&gt;&gt; mNetworkQueue =</div><div class="line">           <span class="keyword">new</span> PriorityBlockingQueue&lt;&gt;();</div><div class="line">           </div><div class="line">   <span class="comment">//默认使用的是DiskBasedCache</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Cache mCache;</div><div class="line"></div><div class="line">   <span class="comment">/** 默认使用BasicNetwork */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> Network mNetwork;</div><div class="line"></div><div class="line">   <span class="comment">/** 默认使用ExecutorDelivery */</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> ResponseDelivery mDelivery;</div><div class="line"></div><div class="line">   <span class="comment">//网络请求线程数组</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> NetworkDispatcher[] mDispatchers;</div><div class="line"></div><div class="line">   <span class="comment">//缓存线程</span></div><div class="line">   <span class="keyword">private</span> CacheDispatcher mCacheDispatcher;</div></pre></td></tr></table></figure>
<h4 id="重要方法"><a href="#重要方法" class="headerlink" title="重要方法"></a>重要方法</h4><ul>
<li><code>add()</code>, 可以将请求放入队列中</li>
<li><code>start()</code>, <code>RequestQueue</code>还负责启动cache线程和network线程</li>
<li><code>stop()</code>, 停止缓存线程和网络线程</li>
<li><code>finish()</code>, 请求结束后的回调</li>
</ul>
<h3 id="1-2-Request"><a href="#1-2-Request" class="headerlink" title="1.2 Request"></a>1.2 Request</h3><p>抽象了Http请求， <code>Request</code>本身是一个抽象类，继承它的子类必须要实现两个抽象方法:</p>
<ul>
<li>abstract protected Response<t> parseNetworkResponse(NetworkResponse response) - 将http请求返回的响应解析成合适的类型</t></li>
<li>abstract protected void deliverResponse(T response) - 将解析好的响应传递给监听器</li>
</ul>
<p>每一个<code>Request</code>的缓存key就是它的<code>Url</code>, 如果要创建<code>POST</code>或者<code>PUT</code>请求， 也可以重写以下两个方法:</p>
<ul>
<li><code>public byte[] getBody() throws AuthFailureError {}</code></li>
<li><code>public Map&lt;String, String&gt; getParams() throws AuthFailureError</code></li>
</ul>
<p><code>getBody()</code>方法默认也是通过<code>getParams</code>方法来创建Body内容，而<code>getParams</code>方法默认实现是直接返回null，所以一般构建<code>POST</code>或<code>PUT</code>请求应当重写这两个方法中的一个, 一般直接重写<code>getParams</code>即可</p>
<h4 id="子类"><a href="#子类" class="headerlink" title="子类"></a>子类</h4><ul>
<li><code>StringRequest</code>, 返回值为String类型</li>
<li><code>JsonRequest</code>, 代表了Body为json的请求, 本身也是一个抽象类</li>
<li><code>JsonObjectRequest</code>, 继承了<code>JsonRequest</code>， 将返回值解析为<code>JSONObject</code></li>
<li><code>JsonArrayRequest</code>, 继承了<code>JsonRequest</code>, 将返回值解析为<code>JsonArrayRequest</code></li>
<li><code>ImageRequest</code>, 图片请求，将返回值解析成为<code>Bitmap</code> </li>
</ul>
<h3 id="1-3-HttpStack"><a href="#1-3-HttpStack" class="headerlink" title="1.3 HttpStack"></a>1.3 HttpStack</h3><p><code>HttpStack</code>是一个接口，就定义了一个执行方网络请求的方法<code>performRequest</code>, 它有两个实现类<code>HurlStack</code>和<code>HttpClientStack</code></p>
<h4 id="HurlStack"><a href="#HurlStack" class="headerlink" title="HurlStack"></a>HurlStack</h4><p><code>HurlStack</code>的<code>performRequest</code>主要是用<code>HttpUrlConnection</code>来实现网络请求，这也是Android官方目前推荐使用的方式</p>
<h4 id="HttpClientStack"><a href="#HttpClientStack" class="headerlink" title="HttpClientStack"></a>HttpClientStack</h4><p><code>HttpClientStack</code>是使用Apache的<code>HttpClient</code>来进行网络请求，这一方式目前目前不被Android官方推荐，<code>HttpClient</code>也已从Android源码中移除</p>
<h3 id="1-4-BasicNetwork"><a href="#1-4-BasicNetwork" class="headerlink" title="1.4 BasicNetwork"></a>1.4 BasicNetwork</h3><p><code>BasicNetwork</code>实现了<code>Network</code>接口，其内部含有<code>HttpStack</code><br>引用，其<code>performRequest</code>主要工作是解析请求的<code>Header</code>，调用<code>HttpStack.performRequest</code>来真正执行网络请求， 之后判断http响应码(主要是判断304，跟缓存相关)，生成<code>NetworkResponse</code></p>
<h3 id="1-5-DiskBasedCache"><a href="#1-5-DiskBasedCache" class="headerlink" title="1.5 DiskBasedCache"></a>1.5 DiskBasedCache</h3><p>磁盘缓存类，实现了<code>Cache</code>接口</p>
<h4 id="重要方法-1"><a href="#重要方法-1" class="headerlink" title="重要方法"></a>重要方法</h4><ul>
<li><code>public synchronized void initialize()</code>,初始化缓存，扫面缓存目录(默认为<code>/data/data/pkg_name/files/cache/volley</code>)得到缓存数据生成缓存header并放入内存</li>
<li><code>public synchronized Entry get(String key)</code>, 从缓存中获取缓存header,然后读取缓存文件</li>
<li><code>public synchronized void put(String key, Entry entry)</code>, 先检查如果给当前Entry分配空间以后， 缓存是否会满，如果会满则遍历并逐个删除缓存，直到如果为当前Entry分配空间以后，缓存量小于最大缓存量的0.9， 然后再新建缓存文件</li>
</ul>
<h2 id="二-基本流程"><a href="#二-基本流程" class="headerlink" title="二. 基本流程"></a>二. 基本流程</h2><h3 id="2-1-Volley-newRequestQueue"><a href="#2-1-Volley-newRequestQueue" class="headerlink" title="2.1 Volley.newRequestQueue"></a>2.1 Volley.newRequestQueue</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RequestQueue <span class="title">newRequestQueue</span><span class="params">(Context context, HttpStack stack)</span> </span>&#123;</div><div class="line">       <span class="comment">//创建缓存目录，默认在/data/data/pkg_name/files/cache/volley</span></div><div class="line">       File cacheDir = <span class="keyword">new</span> File(context.getCacheDir(), DEFAULT_CACHE_DIR);</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (stack == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">9</span>) &#123;</div><div class="line">               <span class="comment">//使用HttpUrlConnection的方式进行网络请求</span></div><div class="line">               stack = <span class="keyword">new</span> HurlStack();</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">           	<span class="comment">//使用HttpClient进行http请求</span></div><div class="line">               ...</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//使用默认的BasicNetwork</span></div><div class="line">       Network network = <span class="keyword">new</span> BasicNetwork(stack);</div><div class="line">       <span class="comment">//创建请求队列, 默认使用ExecutorDelivery</span></div><div class="line">       RequestQueue queue = <span class="keyword">new</span> RequestQueue(<span class="keyword">new</span> DiskBasedCache(cacheDir), network);</div><div class="line">       <span class="comment">//启动CacheDispatcher和NetworkDispatcher线程,开始接收请求，[2]</span></div><div class="line">       queue.start();</div><div class="line"></div><div class="line">       <span class="keyword">return</span> queue;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>创建缓存目录, 默认为<code>/data/data/pkg_name/files/cache/volley</code></li>
<li>创建对应的<code>HttpStack</code></li>
<li>创建<code>BasciNetwork</code></li>
<li>创建<code>DiskBasedCache</code></li>
<li>创建<code>RequestQueue</code>, 并启动</li>
</ol>
<h3 id="2-2-RequestQueue-start"><a href="#2-2-RequestQueue-start" class="headerlink" title="2.2 RequestQueue.start"></a>2.2 RequestQueue.start</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">//停止所有缓存线程和网络请求线程, </span></div><div class="line">       stop();</div><div class="line">       <span class="comment">//创建缓存线程，并启动线程. [3]</span></div><div class="line">       mCacheDispatcher = <span class="keyword">new</span> CacheDispatcher(mCacheQueue, mNetworkQueue, mCache, mDelivery);</div><div class="line">       mCacheDispatcher.start();</div><div class="line"></div><div class="line">       <span class="comment">//创建网络请求线程数组中所有的网络请求线程，并启动, [4]</span></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mDispatchers.length; i++) &#123;</div><div class="line">           NetworkDispatcher networkDispatcher = <span class="keyword">new</span> NetworkDispatcher(mNetworkQueue, mNetwork, mCache, mDelivery);</div><div class="line">           mDispatchers[i] = networkDispatcher;</div><div class="line">           networkDispatcher.start();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li><code>mCacheQueue</code>是<code>PriorityBlockingQueue&lt;Request&lt;?&gt;&gt;</code>类型</li>
<li><code>mNetworkQueue</code>也是<code>PriorityBlockingQueue&lt;Request&lt;?&gt;&gt;</code>类型</li>
<li><code>CacheDispatcher</code>和<code>NetworkDispatcher</code>都是继承自<code>Thread</code>即一个线程类</li>
</ol>
<h3 id="2-3-CacheDispatcher-run"><a href="#2-3-CacheDispatcher-run" class="headerlink" title="2.3 CacheDispatcher.run"></a>2.3 CacheDispatcher.run</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">//设置缓存线程的优先级</span></div><div class="line">       Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line"></div><div class="line">       <span class="comment">// 初始化DiskBasedCache, [2.3.1]</span></div><div class="line">       mCache.initialize();</div><div class="line"></div><div class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="comment">/* 从缓存队列中读取Request, 如果队列中没有请求，则线程阻塞*/</span></div><div class="line">               <span class="keyword">final</span> Request&lt;?&gt; request = mCacheQueue.take();</div><div class="line">               request.addMarker(<span class="string">"cache-queue-take"</span>);</div><div class="line"></div><div class="line">               <span class="comment">/* 如果请求已经被取消，则直接结束当前请求, 从当前请求集合以及等待请求列表中删除*/</span></div><div class="line">               <span class="keyword">if</span> (request.isCanceled()) &#123;</div><div class="line">                   request.finish(<span class="string">"cache-discard-canceled"</span>);</div><div class="line">                   <span class="keyword">continue</span>;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="comment">/* 判断当前请求有没有缓存， request的cacheKey就是url*/</span></div><div class="line">               Cache.Entry entry = mCache.get(request.getCacheKey());</div><div class="line">               <span class="comment">/* 没有缓存结果，则直接交友网络请求线程*/</span></div><div class="line">               <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">                   request.addMarker(<span class="string">"cache-miss"</span>);</div><div class="line">                   mNetworkQueue.put(request);</div><div class="line">                   <span class="keyword">continue</span>;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="comment">/* 如果有缓存结果，但缓存结果已经失效，同样交由网络线程*/</span></div><div class="line">               <span class="keyword">if</span> (entry.isExpired()) &#123;</div><div class="line">                   request.addMarker(<span class="string">"cache-hit-expired"</span>);</div><div class="line">                   request.setCacheEntry(entry);</div><div class="line">                   mNetworkQueue.put(request);</div><div class="line">                   <span class="keyword">continue</span>;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               request.addMarker(<span class="string">"cache-hit"</span>);</div><div class="line">               <span class="comment">/* 缓存命中，则调用Request的parseNetworkResponse获取相应的Response*/</span></div><div class="line">               Response&lt;?&gt; response = request.parseNetworkResponse(</div><div class="line">                       <span class="keyword">new</span> NetworkResponse(entry.data, entry.responseHeaders));</div><div class="line">               request.addMarker(<span class="string">"cache-hit-parsed"</span>);</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (!entry.refreshNeeded()) &#123;</div><div class="line">                   <span class="comment">/* 如果缓存不需要刷新，则直接传递结果*/</span></div><div class="line">                   mDelivery.postResponse(request, response);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">/* 如果缓存还需要刷新，传递响应结果，将将请求交由网络线程进行新鲜度验证*/</span></div><div class="line">                   request.addMarker(<span class="string">"cache-hit-refresh-needed"</span>);</div><div class="line">                   request.setCacheEntry(entry);</div><div class="line"></div><div class="line">                   response.intermediate = <span class="keyword">true</span>;</div><div class="line">				</div><div class="line">				 <span class="comment">/* 向网络请求队列中添加请求*/</span></div><div class="line">                   mDelivery.postResponse(request, response, <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                           <span class="keyword">try</span> &#123;</div><div class="line">                               mNetworkQueue.put(request);</div><div class="line">                           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                               <span class="comment">// Not much we can do about this.</span></div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">               <span class="comment">// We may have been interrupted because it was time to quit.</span></div><div class="line">               <span class="keyword">if</span> (mQuit) &#123;</div><div class="line">                   <span class="keyword">return</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>初始化缓存，获取缓存内容</li>
<li>开启无限循环，从<code>PriorityBlockingQueue</code>中取出请求，查看请求是否有缓存(请求的key就是url)，如果队列中没有请求，则线程阻塞</li>
<li>如果没有缓存命中，则将请求放入网络队列，去执行网络请求</li>
<li>如果有缓存命中，检查缓存是否失效，如果失效也放入网络队列，去执行网络请求</li>
<li>如果缓存命中且有效，调用<code>Request.parseNetworkResponse</code>获取相应的Response</li>
<li>判断缓存需不要刷新，如果不需要刷新，则直接调用<code>ExceutorDelivery.postResponse</code>传递Response;如果缓存还需要刷新，则还是将请求放入网络请求队列，去执行网络请求获取最新结果</li>
</ol>
<h4 id="2-3-1-DiskBasedCache-initialize"><a href="#2-3-1-DiskBasedCache-initialize" class="headerlink" title="2.3.1 DiskBasedCache.initialize"></a>2.3.1 DiskBasedCache.initialize</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">/* 如果缓存目录不存在，则创建缓存目录 */</span></div><div class="line">       <span class="keyword">if</span> (!mRootDirectory.exists()) &#123;</div><div class="line">           <span class="keyword">if</span> (!mRootDirectory.mkdirs()) &#123;</div><div class="line">               VolleyLog.e(<span class="string">"Unable to create cache dir %s"</span>, mRootDirectory.getAbsolutePath());</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 获取缓存目录下所有文件*/</span></div><div class="line">       File[] files = mRootDirectory.listFiles();</div><div class="line">       <span class="keyword">if</span> (files == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="comment">/* 遍历多有缓存文件，如果能够正常读取，则为每个缓存文件生成一个CacheHeader</span></div><div class="line">       * 并放入集合中*/</div><div class="line">       <span class="keyword">for</span> (File file : files) &#123;</div><div class="line">           BufferedInputStream fis = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               fis = <span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(file));</div><div class="line">               CacheHeader entry = CacheHeader.readHeader(fis);</div><div class="line">               entry.size = file.length();</div><div class="line">               putEntry(entry.key, entry);</div><div class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">               <span class="comment">/* 如果发生异常，证明该文件不符合Volley的缓存格式</span></div><div class="line">               * 删除该文件*/</div><div class="line">               <span class="keyword">if</span> (file != <span class="keyword">null</span>) &#123;</div><div class="line">                  file.delete();</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">finally</span> &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="keyword">if</span> (fis != <span class="keyword">null</span>) &#123;</div><div class="line">                       fis.close();</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">catch</span> (IOException ignored) &#123; &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="2-4-NetworkDispatcher-run"><a href="#2-4-NetworkDispatcher-run" class="headerlink" title="2.4 NetworkDispatcher.run"></a>2.4 NetworkDispatcher.run</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">//设置该网络线程的优先级</span></div><div class="line">       Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND);</div><div class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">           <span class="keyword">long</span> startTimeMs = SystemClock.elapsedRealtime();</div><div class="line">           Request&lt;?&gt; request;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="comment">// 从网络请求队列中获取请求</span></div><div class="line">               request = mQueue.take();</div><div class="line">           &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">               ...</div><div class="line">               <span class="keyword">continue</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               ...</div><div class="line">               <span class="comment">/* 如果请求已经被取消，则直接结束当前请求, 从当前请求集合以及等待请求列表中删除*/</span></div><div class="line">               <span class="keyword">if</span> (request.isCanceled()) &#123;</div><div class="line">                   request.finish(<span class="string">"network-discard-cancelled"</span>);</div><div class="line">                   <span class="keyword">continue</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="comment">/* 设置网络流量标识*/</span></div><div class="line">               addTrafficStatsTag(request);</div><div class="line"></div><div class="line">               <span class="comment">/* 执行网络请求, 并获取对应的Response [2.4.1]*/</span> </div><div class="line">               NetworkResponse networkResponse = mNetwork.performRequest(request);</div><div class="line">               request.addMarker(<span class="string">"network-http-complete"</span>);</div><div class="line"></div><div class="line">               <span class="comment">/* 如果服务端返回304同时我们已经传输了Response, 则结束该Request避免重复传输Response*/</span></div><div class="line">               <span class="keyword">if</span> (networkResponse.notModified &amp;&amp; request.hasHadResponseDelivered()) &#123;</div><div class="line">                   request.finish(<span class="string">"not-modified"</span>);</div><div class="line">                   <span class="keyword">continue</span>;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="comment">/* 调用Request的parseNetworkResponse解析结果*/</span></div><div class="line">               Response&lt;?&gt; response = request.parseNetworkResponse(networkResponse);</div><div class="line">               request.addMarker(<span class="string">"network-parse-complete"</span>);</div><div class="line"></div><div class="line">               <span class="comment">/* 如果Request允许缓存且缓存实体不为空，则调用DiskBasedCache进行缓存 */</span></div><div class="line">               <span class="keyword">if</span> (request.shouldCache() &amp;&amp; response.cacheEntry != <span class="keyword">null</span>) &#123;</div><div class="line">                   mCache.put(request.getCacheKey(), response.cacheEntry);</div><div class="line">                   request.addMarker(<span class="string">"network-cache-written"</span>);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="comment">/* 标记Request已传输结果 */</span></div><div class="line">               request.markDelivered();</div><div class="line">               <span class="comment">/* ExecutorDelivery 传输结果 */</span></div><div class="line">               mDelivery.postResponse(request, response);</div><div class="line">           &#125; <span class="keyword">catch</span> (VolleyError volleyError) &#123;</div><div class="line">               ... <span class="comment">//分发VolleyError</span></div><div class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			... <span class="comment">//分发VolleyError</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>从网络请求队列中取出请求，如果没有请求则线程会一直阻塞</li>
<li>调用<code>BasicNetwork.performRequest</code>执行网络请求，并获取相应的Response</li>
<li>如果Request允许缓存且缓存实体不为空，则将Request放入缓存</li>
<li>调用<code>ExecutorDelivery.postResponse</code>传输结果</li>
</ol>
<h4 id="2-4-1-BasicNetwork-performRequest"><a href="#2-4-1-BasicNetwork-performRequest" class="headerlink" title="2.4.1 BasicNetwork.performRequest"></a>2.4.1 BasicNetwork.performRequest</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> NetworkResponse <span class="title">performRequest</span><span class="params">(Request&lt;?&gt; request)</span> <span class="keyword">throws</span> VolleyError </span>&#123;</div><div class="line">       <span class="keyword">long</span> requestStart = SystemClock.elapsedRealtime();</div><div class="line">       <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">           HttpResponse httpResponse = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">byte</span>[] responseContents = <span class="keyword">null</span>;</div><div class="line">           Map&lt;String, String&gt; responseHeaders = Collections.emptyMap();</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="comment">// Gather headers.</span></div><div class="line">               Map&lt;String, String&gt; headers = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">               <span class="comment">//如果请求中包含缓存字段，存储进headers</span></div><div class="line">               addCacheHeaders(headers, request.getCacheEntry());</div><div class="line">               <span class="comment">//调用HttpStack.performRequest, 一般情况下，HttpStack都会是HurlStack</span></div><div class="line">               <span class="comment">//[2.4.2]</span></div><div class="line">               httpResponse = mHttpStack.performRequest(request, headers);</div><div class="line"></div><div class="line">               StatusLine statusLine = httpResponse.getStatusLine();</div><div class="line">               <span class="keyword">int</span> statusCode = statusLine.getStatusCode();</div><div class="line">			<span class="comment">//解析Header</span></div><div class="line">               responseHeaders = convertHeaders(httpResponse.getAllHeaders());</div><div class="line">               <span class="comment">// 返回码是304</span></div><div class="line">               <span class="keyword">if</span> (statusCode == HttpStatus.SC_NOT_MODIFIED) &#123;</div><div class="line">                   Entry entry = request.getCacheEntry();</div><div class="line">                   <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">                       <span class="keyword">return</span> <span class="keyword">new</span> NetworkResponse(HttpStatus.SC_NOT_MODIFIED, <span class="keyword">null</span>,</div><div class="line">                               responseHeaders, <span class="keyword">true</span>,</div><div class="line">                               SystemClock.elapsedRealtime() - requestStart);</div><div class="line">                   &#125;</div><div class="line"></div><div class="line">                   entry.responseHeaders.putAll(responseHeaders);</div><div class="line">                   <span class="keyword">return</span> <span class="keyword">new</span> NetworkResponse(HttpStatus.SC_NOT_MODIFIED, entry.data,</div><div class="line">                           entry.responseHeaders, <span class="keyword">true</span>,</div><div class="line">                           SystemClock.elapsedRealtime() - requestStart);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               <span class="comment">// Some responses such as 204s do not have content.  We must check.</span></div><div class="line">               <span class="keyword">if</span> (httpResponse.getEntity() != <span class="keyword">null</span>) &#123;</div><div class="line">                 responseContents = entityToBytes(httpResponse.getEntity());</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                 <span class="comment">// Add 0 byte response as a way of honestly representing a</span></div><div class="line">                 <span class="comment">// no-content request.</span></div><div class="line">                 responseContents = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</div><div class="line">               &#125;</div><div class="line"></div><div class="line">               ...</div><div class="line"></div><div class="line">               <span class="keyword">if</span> (statusCode &lt; <span class="number">200</span> || statusCode &gt; <span class="number">299</span>) &#123;</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IOException();</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">new</span> NetworkResponse(statusCode, responseContents, responseHeaders, <span class="keyword">false</span>,SystemClock.elapsedRealtime() - requestStart);</div><div class="line">           &#125; <span class="keyword">catch</span> (SocketTimeoutException e) &#123;</div><div class="line">           	<span class="comment">//[2.4.3]</span></div><div class="line">           	attempRetryonExcption(<span class="string">"socket"</span>, request, <span class="keyword">new</span> TimeoutError());</div><div class="line">           &#125; <span class="keyword">catch</span> .... &#123;<span class="comment">//其他excption</span></div><div class="line">           	.... <span class="comment">//基本都是attempRetryonExcption</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="2-4-2-HurlStack-performRequest"><a href="#2-4-2-HurlStack-performRequest" class="headerlink" title="2.4.2 HurlStack.performRequest"></a>2.4.2 HurlStack.performRequest</h4><p>由于目前Android平台基本都是使用<code>HttpUrlConnection</code>, 所以这里就默认使用<code>HurlStack</code>, 不考虑<code>HttpClientStack</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> HttpResponse <span class="title">performRequest</span><span class="params">(Request&lt;?&gt; request, Map&lt;String, String&gt; additionalHeaders)</span> <span class="keyword">throws</span> IOException, AuthFailureError </span>&#123;</div><div class="line">   	<span class="comment">//设置Header</span></div><div class="line">       String url = request.getUrl();</div><div class="line">       HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">       map.putAll(request.getHeaders());</div><div class="line">       <span class="comment">//additionalHeader一般都是用来缓存的Header</span></div><div class="line">       map.putAll(additionalHeaders);</div><div class="line">       <span class="keyword">if</span> (mUrlRewriter != <span class="keyword">null</span>) &#123;</div><div class="line">           String rewritten = mUrlRewriter.rewriteUrl(url);</div><div class="line">           <span class="keyword">if</span> (rewritten == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"URL blocked by rewriter: "</span> + url);</div><div class="line">           &#125;</div><div class="line">           url = rewritten;</div><div class="line">       &#125;</div><div class="line">       URL parsedUrl = <span class="keyword">new</span> URL(url);</div><div class="line">       <span class="comment">//建立Http连接[2.4.2.1]</span></div><div class="line">       HttpURLConnection connection = openConnection(parsedUrl, request);</div><div class="line">       <span class="comment">//设置请求头</span></div><div class="line">       <span class="keyword">for</span> (String headerName : map.keySet()) &#123;</div><div class="line">           connection.addRequestProperty(headerName, map.get(headerName));</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//设置请求方法，请求参数等</span></div><div class="line">       setConnectionParametersForRequest(connection, request);</div><div class="line">       <span class="comment">// Initialize HttpResponse with data from the HttpURLConnection.</span></div><div class="line">       ProtocolVersion protocolVersion = <span class="keyword">new</span> ProtocolVersion(<span class="string">"HTTP"</span>, <span class="number">1</span>, <span class="number">1</span>);</div><div class="line">       <span class="keyword">int</span> responseCode = connection.getResponseCode();</div><div class="line">       <span class="keyword">if</span> (responseCode == -<span class="number">1</span>) &#123;</div><div class="line">          ...</div><div class="line">       &#125;</div><div class="line">       StatusLine responseStatus = <span class="keyword">new</span> BasicStatusLine(protocolVersion,</div><div class="line">               connection.getResponseCode(), connection.getResponseMessage());</div><div class="line">       BasicHttpResponse response = <span class="keyword">new</span> BasicHttpResponse(responseStatus);</div><div class="line">       <span class="keyword">if</span> (hasResponseBody(request.getMethod(), responseStatus.getStatusCode())) &#123;</div><div class="line">           response.setEntity(entityFromConnection(connection));</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">for</span> (Entry&lt;String, List&lt;String&gt;&gt; header : connection.getHeaderFields().entrySet()) &#123;</div><div class="line">           <span class="keyword">if</span> (header.getKey() != <span class="keyword">null</span>) &#123;</div><div class="line">               Header h = <span class="keyword">new</span> BasicHeader(header.getKey(), header.getValue().get(<span class="number">0</span>));</div><div class="line">               response.addHeader(h);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> response;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h5 id="2-4-2-1-HurlStack-openConnection"><a href="#2-4-2-1-HurlStack-openConnection" class="headerlink" title="2.4.2.1 HurlStack.openConnection"></a>2.4.2.1 HurlStack.openConnection</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> HttpURLConnection <span class="title">openConnection</span><span class="params">(URL url, Request&lt;?&gt; request)</span> <span class="keyword">throws</span> 			IOException </span>&#123;</div><div class="line">       HttpURLConnection connection = createConnection(url);</div><div class="line"></div><div class="line">       <span class="keyword">int</span> timeoutMs = request.getTimeoutMs();</div><div class="line">       connection.setConnectTimeout(timeoutMs);</div><div class="line">       connection.setReadTimeout(timeoutMs);</div><div class="line">       connection.setUseCaches(<span class="keyword">false</span>);</div><div class="line">       connection.setDoInput(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">       <span class="comment">// use caller-provided custom SslSocketFactory, if any, for HTTPS</span></div><div class="line">       <span class="comment">// 如果scheme是https，设置SSLSocketFactory</span></div><div class="line">       <span class="keyword">if</span> (<span class="string">"https"</span>.equals(url.getProtocol()) &amp;&amp; mSslSocketFactory != <span class="keyword">null</span>) &#123;</div><div class="line">           ((HttpsURLConnection)connection).setSSLSocketFactory(mSslSocketFactory);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> connection;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="2-4-3-BasicNetwork-attemptRetryOnException"><a href="#2-4-3-BasicNetwork-attemptRetryOnException" class="headerlink" title="2.4.3 BasicNetwork.attemptRetryOnException"></a>2.4.3 BasicNetwork.attemptRetryOnException</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">attemptRetryOnException</span><span class="params">(String logPrefix, Request&lt;?&gt; request,</span></span></div><div class="line">           VolleyError exception) <span class="keyword">throws</span> VolleyError &#123;</div><div class="line">       <span class="comment">//默认是DefaultRetryPolicy</span></div><div class="line">       RetryPolicy retryPolicy = request.getRetryPolicy();</div><div class="line">       <span class="keyword">int</span> oldTimeout = request.getTimeoutMs();</div><div class="line"></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">       	<span class="comment">//DefaultRetryPolicy中的retry主要就是判断重试次数是否已经到达上限</span></div><div class="line">           retryPolicy.retry(exception);</div><div class="line">       &#125; <span class="keyword">catch</span> (VolleyError e) &#123;</div><div class="line">           request.addMarker(</div><div class="line">                   String.format(<span class="string">"%s-timeout-giveup [timeout=%s]"</span>, logPrefix, oldTimeout));</div><div class="line">           <span class="keyword">throw</span> e;</div><div class="line">       &#125;</div><div class="line">       request.addMarker(String.format(<span class="string">"%s-retry [timeout=%s]"</span>, logPrefix, oldTimeout));</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="2-5-ExecutorDelivery-postResponse"><a href="#2-5-ExecutorDelivery-postResponse" class="headerlink" title="2.5. ExecutorDelivery.postResponse"></a>2.5. ExecutorDelivery.postResponse</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postResponse</span><span class="params">(Request&lt;?&gt; request, Response&lt;?&gt; response, Runnable runnable)</span> </span>&#123;</div><div class="line">      request.markDelivered();</div><div class="line">      request.addMarker(<span class="string">"post-response"</span>);</div><div class="line">      <span class="comment">//向线程池中提交任务</span></div><div class="line"><span class="comment">//[2.5.1]</span></div><div class="line">      mResponsePoster.execute(<span class="keyword">new</span> ResponseDeliveryRunnable(request, response, runnable));</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h4 id="2-5-1-ResponseDeliveryRunnable-run"><a href="#2-5-1-ResponseDeliveryRunnable-run" class="headerlink" title="2.5.1 ResponseDeliveryRunnable.run()"></a>2.5.1 ResponseDeliveryRunnable.run()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">          <span class="keyword">if</span> (mRequest.isCanceled()) &#123;</div><div class="line">              mRequest.finish(<span class="string">"canceled-at-delivery"</span>);</div><div class="line">              <span class="keyword">return</span>;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// Deliver a normal response or error, depending.</span></div><div class="line">          <span class="keyword">if</span> (mResponse.isSuccess()) &#123;</div><div class="line">              <span class="comment">//如果成功会回调Response.Listener的onResponse</span></div><div class="line">              mRequest.deliverResponse(mResponse.result);</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">              <span class="comment">//如果失败会回调Response.ErrorListener的onErrorResponse</span></div><div class="line">              mRequest.deliverError(mResponse.error);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">if</span> (mResponse.intermediate) &#123;</div><div class="line">              <span class="comment">//如果这是一个intermediate Response，添加Marker</span></div><div class="line">              mRequest.addMarker(<span class="string">"intermediate-response"</span>);</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">              <span class="comment">//结束当前请求</span></div><div class="line">              mRequest.finish(<span class="string">"done"</span>);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// If we have been provided a post-delivery runnable, run it.</span></div><div class="line">          <span class="keyword">if</span> (mRunnable != <span class="keyword">null</span>) &#123;</div><div class="line">              mRunnable.run();</div><div class="line">          &#125;</div><div class="line">     &#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/ART-Runtime创建-三-Heap的创建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/ART-Runtime创建-三-Heap的创建/" itemprop="url">ART Runtime创建(三)--Heap的创建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:00:13+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ART/" itemprop="url" rel="index">
                    <span itemprop="name">ART</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>Heap</code>的创建位于<code>/art/runtime/runtime.cc</code>的<code>Runtime::Init</code>方法中<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> Runtime::Init(RuntimeArgumentMap&amp;&amp; runtime_options_in) &#123;</div><div class="line">  ...</div><div class="line">  <span class="comment">//-Xgc</span></div><div class="line">  XGcOption xgc_option = runtime_options.GetOrDefault(Opt::GcOption);</div><div class="line">  heap_ = <span class="keyword">new</span> gc::Heap(runtime_options.GetOrDefault(Opt::MemoryInitialSize),<span class="comment">//-Xms:8m</span></div><div class="line">                       <span class="comment">//-XX:HeapGrowthLimit:256m</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::HeapGrowthLimit),</div><div class="line">                       <span class="comment">//-XX:HeapMinFree:512k</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::HeapMinFree),</div><div class="line">                       <span class="comment">//-XX:HeapMaxFree:8m</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::HeapMaxFree),</div><div class="line">                       <span class="comment">//-XX:HeapTargetUtilization:0.75</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::HeapTargetUtilization),</div><div class="line">                       <span class="comment">//-XX:ForegroundHeapGrowthMultiplier</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::ForegroundHeapGrowthMultiplier),</div><div class="line">                       <span class="comment">//-Xmx:512m</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::MemoryMaximumSize),</div><div class="line">                       <span class="comment">//-XX:NonMovingSpaceCapacity</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::NonMovingSpaceCapacity),</div><div class="line">                       <span class="comment">//-Ximage:/system/framework/boot.art</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::Image),</div><div class="line">                       <span class="comment">//imgaeinstructionset,是一个extra_info,用来hook: null</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::ImageInstructionSet),</div><div class="line">                       <span class="comment">//-Xgc:kuseReadBarrier ? gc::kCollectorTypeCC : gc::kCollectorTypeDefault</span></div><div class="line">                       xgc_option.collector_type_,</div><div class="line">                       <span class="comment">//-XX:BackgroundGC</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::BackgroundGc),</div><div class="line">                       <span class="comment">//-XX:LargeObjectSpace</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::LargeObjectSpace),</div><div class="line">                       <span class="comment">//-XX:LargeObjectThreshold</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::LargeObjectThreshold),</div><div class="line">                       <span class="comment">//-XX:ParallelGCThreads:0u</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::ParallelGCThreads),</div><div class="line">                       <span class="comment">//-XX:ConcGCThreads</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::ConcGCThreads),</div><div class="line">                       <span class="comment">//-XX:LowMemoryMode:false</span></div><div class="line">                       runtime_options.Exists(Opt::LowMemoryMode),</div><div class="line">                       <span class="comment">//-XX:LongPauseLogThreshold</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::LongPauseLogThreshold),</div><div class="line">                       <span class="comment">//-XX:LongGCLogThreshold</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::LongGCLogThreshold),</div><div class="line">                       <span class="comment">//-XX:IgnoreMaxFootprint</span></div><div class="line">                       runtime_options.Exists(Opt::IgnoreMaxFootprint),</div><div class="line">                       <span class="comment">//-XX:UseTLAB</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::UseTLAB),</div><div class="line">                       <span class="comment">//default false</span></div><div class="line">                       xgc_option.verify_pre_gc_heap_,</div><div class="line">                       <span class="comment">//default kIsDebugBuild</span></div><div class="line">                       xgc_option.verify_pre_sweeping_heap_, </div><div class="line">                       <span class="comment">//default false</span></div><div class="line">                       xgc_option.verify_post_gc_heap_, </div><div class="line">                       <span class="comment">//default kIsDebugBuild</span></div><div class="line">                       xgc_option.verify_pre_gc_rosalloc_, </div><div class="line">                       <span class="comment">// default false</span></div><div class="line">                       xgc_option.verify_pre_sweeping_rosalloc_,</div><div class="line">                       <span class="comment">//default false</span></div><div class="line">                       xgc_option.verify_post_gc_rosalloc_,</div><div class="line">                       <span class="comment">//default false</span></div><div class="line">                       xgc_option.gcstress_,</div><div class="line">                       <span class="comment">//-XX:EnableHSpaceCompactForOOM</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::EnableHSpaceCompactForOOM),</div><div class="line">                       <span class="comment">//-XX:HspaceCompactForOOMMinIntervalMs</span></div><div class="line">                       runtime_options.GetOrDefault(Opt::HSpaceCompactForOOMMinIntervalsMs));</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="一-相关知识预热"><a href="#一-相关知识预热" class="headerlink" title="一. 相关知识预热"></a>一. 相关知识预热</h2><h3 id="1-1-Garbage-Collection-Type"><a href="#1-1-Garbage-Collection-Type" class="headerlink" title="1.1 Garbage Collection Type"></a>1.1 Garbage Collection Type</h3><p>垃圾回收的算法有多种，如MarkSweep-标记清楚算法,MarkCompact-标记整理算法,Copying-复制算法等等，之前的Dalvik一直使用的是MarkSweep算法，ART则在MarkSweep的基础上添加了对其他垃圾回收算法的支持，具体的算法可以通过<code>-Xgc</code>指定，如果没有特别指定，则使用默认指定的：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /art/smdline/cmdline_types.h</span></div><div class="line">gc::CollectorType collector_type_ =  kUseReadBarrier ?</div><div class="line">                                           <span class="comment">// If RB is enabled (currently a build-time decision),</span></div><div class="line">                                           <span class="comment">// use CC as the default GC.</span></div><div class="line">                                           gc::kCollectorTypeCC :</div><div class="line">                                           gc::kCollectorTypeDefault;</div></pre></td></tr></table></figure></p>
<p><code>kUseReadBarrier</code>定义在<code>/art/runtime/globals.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_BAKER_READ_BARRIER</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">bool</span> kUseBakerReadBarrier = <span class="literal">true</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">bool</span> kUseBakerReadBarrier = <span class="literal">false</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_BROOKS_READ_BARRIER</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">bool</span> kUseBrooksReadBarrier = <span class="literal">true</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">bool</span> kUseBrooksReadBarrier = <span class="literal">false</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_TABLE_LOOKUP_READ_BARRIER</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">bool</span> kUseTableLookupReadBarrier = <span class="literal">true</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">bool</span> kUseTableLookupReadBarrier = <span class="literal">false</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">bool</span> kUseBakerOrBrooksReadBarrier = kUseBakerReadBarrier || kUseBrooksReadBarrier;</div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">bool</span> kUseReadBarrier =</div><div class="line">    kUseBakerReadBarrier || kUseBrooksReadBarrier || kUseTableLookupReadBarrier;</div></pre></td></tr></table></figure>
<p><code>kUseReadBarrier</code>根据三个编译宏决定true或false,只要这个三个编译宏中有一个存在，则<code>kUseReadBarrier=true</code></p>
<p><code>gc::kCollectorTypeCC</code>和<code>gc::kCollectorTypeDefault</code>定义在<code>/art/runtime/gc/collector_type.h</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">enum</span> CollectorType &#123;</div><div class="line">  <span class="comment">// No collector selected.</span></div><div class="line">  kCollectorTypeNone,</div><div class="line">  <span class="comment">//普通Mark-Sweep</span></div><div class="line">  kCollectorTypeMS,</div><div class="line">  <span class="comment">// 并发Mark-Sweep.</span></div><div class="line">  kCollectorTypeCMS,</div><div class="line">  <span class="comment">// Semi-space和Mark-Sweep的混合</span></div><div class="line">  kCollectorTypeSS,</div><div class="line">  <span class="comment">// Generational Semi-space</span></div><div class="line">  kCollectorTypeGSS,</div><div class="line">  <span class="comment">// Mark compact</span></div><div class="line">  kCollectorTypeMC,</div><div class="line">  <span class="comment">// Heap trimming collector, doesn't do any actual collecting.</span></div><div class="line">  kCollectorTypeHeapTrim,</div><div class="line">  <span class="comment">// A (mostly) concurrent copying collector.</span></div><div class="line">  kCollectorTypeCC,</div><div class="line">  <span class="comment">// Instrumentation critical section fake collector.</span></div><div class="line">  kCollectorTypeInstrumentation,</div><div class="line">  <span class="comment">// Fake collector for adding or removing application image spaces.</span></div><div class="line">  kCollectorTypeAddRemoveAppImageSpace,</div><div class="line">  <span class="comment">// A homogeneous space compaction collector used in background transition</span></div><div class="line">  <span class="comment">// when both foreground and background collector are CMS.</span></div><div class="line">  kCollectorTypeHomogeneousSpaceCompact,</div><div class="line">  <span class="comment">// Class linker fake collector.</span></div><div class="line">  kCollectorTypeClassLinker,</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> CollectorType kCollectorTypeDefault =</div><div class="line">#<span class="keyword">if</span> ART_DEFAULT_GC_TYPE_IS_CMS</div><div class="line">    kCollectorTypeCMS</div><div class="line">#elif ART_DEFAULT_GC_TYPE_IS_SS</div><div class="line">    kCollectorTypeSS</div><div class="line">#elif ART_DEFAULT_GC_TYPE_IS_GSS</div><div class="line">    kCollectorTypeGSS</div><div class="line">#<span class="keyword">else</span></div><div class="line">    kCollectorTypeCMS</div><div class="line">#error <span class="string">"ART default GC type must be set"</span></div><div class="line">#endif</div></pre></td></tr></table></figure>
<p>从代码中的定义可以看到，如果<code>kUseReadBarrier＝true</code>，则垃圾回收算法使用<code>Concurrent-Copying</code>,否则默认算法，默认算法根据编译宏选择，没有特别指定的情况下使用<code>Concurrent Mark-Sweep</code></p>
<h2 id="二-Heap-Heap"><a href="#二-Heap-Heap" class="headerlink" title="二. Heap::Heap()"></a>二. Heap::Heap()</h2><h3 id="2-1-构造函数声明"><a href="#2-1-构造函数声明" class="headerlink" title="2.1 构造函数声明"></a>2.1 构造函数声明</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">Heap(<span class="keyword">size_t</span> initial_size,<span class="comment">//堆的初始大小</span></div><div class="line">      <span class="keyword">size_t</span> growth_limit,<span class="comment">//堆的增长上限</span></div><div class="line">      <span class="keyword">size_t</span> min_free,<span class="comment">//堆的最小空闲值</span></div><div class="line">      <span class="keyword">size_t</span> max_free,<span class="comment">//堆的最大空闲值</span></div><div class="line">      <span class="keyword">double</span> target_utilization,<span class="comment">//堆的目标利用率</span></div><div class="line">      <span class="keyword">double</span> foreground_heap_growth_multiplier,<span class="comment">//前台堆增长因子(乘数)</span></div><div class="line">      <span class="keyword">size_t</span> capacity,<span class="comment">//堆的容量</span></div><div class="line">      <span class="keyword">size_t</span> non_moving_space_capacity,<span class="comment">//存储不可移动对象的space的容量</span></div><div class="line">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; original_image_file_name,<span class="comment">//image文件路径</span></div><div class="line">      InstructionSet image_instruction_set,<span class="comment">//指令集</span></div><div class="line">      CollectorType foreground_collector_type,<span class="comment">//前台回收器类型</span></div><div class="line">      CollectorType background_collector_type,<span class="comment">//后台回收器类型</span></div><div class="line">      space::LargeObjectSpaceType large_object_space_type,<span class="comment">//存储大对象的space类型</span></div><div class="line">      <span class="keyword">size_t</span> large_object_threshold,<span class="comment">//大对象数量的阈值</span></div><div class="line">      <span class="keyword">size_t</span> parallel_gc_threads,<span class="comment">//GC暂停阶段用于同时执行GC任务的线程数</span></div><div class="line">      <span class="keyword">size_t</span> conc_gc_threads,<span class="comment">//并行GC的线程数</span></div><div class="line">      <span class="keyword">bool</span> low_memory_mode,<span class="comment">//是否是low memory mode</span></div><div class="line">      <span class="keyword">size_t</span> long_pause_threshold,<span class="comment">//GC造成应用程序暂停的时间阀值,超过则输出log</span></div><div class="line">      <span class="keyword">size_t</span> long_gc_threshold,<span class="comment">//GC时间阀值,超过则输出log</span></div><div class="line">      <span class="keyword">bool</span> ignore_max_footprint,<span class="comment">//不对堆的增长进行限制,堆可以增长到它的最大容量</span></div><div class="line">      <span class="keyword">bool</span> use_tlab,<span class="comment">//是否开启TLAB选项</span></div><div class="line">      <span class="keyword">bool</span> verify_pre_gc_heap,<span class="comment">//是否在开始GC前验证堆</span></div><div class="line">      <span class="keyword">bool</span> verify_pre_sweeping_heap,<span class="comment">//是否在GC执行清扫前验证堆</span></div><div class="line">      <span class="keyword">bool</span> verify_post_gc_heap,<span class="comment">//是否在GC完成清扫后验证堆</span></div><div class="line">      <span class="keyword">bool</span> verify_pre_gc_rosalloc,<span class="comment">//是否在开始GC前验证RosAllocSpace</span></div><div class="line">      <span class="keyword">bool</span> verify_pre_sweeping_rosalloc,<span class="comment">//是否在GC执行清扫前验证RosAllocSpace</span></div><div class="line">      <span class="keyword">bool</span> verify_post_gc_rosalloc,<span class="comment">//是否在GC完成清扫后验证RosAllocSpace</span></div><div class="line">      <span class="keyword">bool</span> gc_stress_mode,</div><div class="line">      <span class="keyword">bool</span> use_homogeneous_space_compaction,<span class="comment">//是否使用homogeneous space compaction来避免OOM</span></div><div class="line">      <span class="keyword">uint64_t</span> min_interval_homogeneous_space_compaction_by_oom);<span class="comment">//两次OOM引起homogeneous space compaction时间间隔</span></div></pre></td></tr></table></figure>
<h3 id="2-2-构造函数实现"><a href="#2-2-构造函数实现" class="headerlink" title="2.2 构造函数实现"></a>2.2 构造函数实现</h3><h4 id="2-2-1-字段初始化"><a href="#2-2-1-字段初始化" class="headerlink" title="2.2.1 字段初始化"></a>2.2.1 字段初始化</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div></pre></td><td class="code"><pre><div class="line">Heap::Heap(...) :</div><div class="line">      <span class="comment">//space::MallocSpace*,存放不可移动对象</span></div><div class="line">      non_moving_space_(<span class="literal">nullptr</span>),</div><div class="line">      <span class="comment">//kAllocatorTypeROSAlloc space</span></div><div class="line">      rosalloc_space_(<span class="literal">nullptr</span>),</div><div class="line">      <span class="comment">//kAllocatorTypeDlMalloc space</span></div><div class="line">      dlmalloc_space_(<span class="literal">nullptr</span>),</div><div class="line">      <span class="comment">//GC操作的主要space,这个space不是dlmalloc_space_就是rosalloc_space_</span></div><div class="line">      main_space_(<span class="literal">nullptr</span>),</div><div class="line">      <span class="comment">//回收器类型</span></div><div class="line">      collector_type_(kCollectorTypeNone),</div><div class="line">      <span class="comment">//前台回收器类型</span></div><div class="line">      foreground_collector_type_(foreground_collector_type),</div><div class="line">      <span class="comment">//后台回收器类型</span></div><div class="line">      background_collector_type_(background_collector_type),</div><div class="line">      <span class="comment">//希望的回收器类型,如果它!=collector_type_, heap trimming daemon会transitions堆</span></div><div class="line">      desired_collector_type_(foreground_collector_type_),</div><div class="line">      <span class="comment">//Mutex*</span></div><div class="line">      pending_task_lock_(<span class="literal">nullptr</span>),</div><div class="line">      <span class="comment">//GC暂停阶段用于同时执行GC任务的线程数</span></div><div class="line">      parallel_gc_threads_(parallel_gc_threads),</div><div class="line">      <span class="comment">//concurrent gc线程数</span></div><div class="line">      conc_gc_threads_(conc_gc_threads),</div><div class="line">      <span class="comment">//是否是低内存模式</span></div><div class="line">      low_memory_mode_(low_memory_mode),</div><div class="line">      <span class="comment">//GC造成应用程序暂停的时间阀值,超过则输出log</span></div><div class="line">      long_pause_log_threshold_(long_pause_log_threshold),</div><div class="line">      <span class="comment">//GC时间阀值,超过则输出log</span></div><div class="line">      long_gc_log_threshold_(long_gc_log_threshold),</div><div class="line">      <span class="comment">//是否对堆的增长不限制</span></div><div class="line">      ignore_max_footprint_(ignore_max_footprint),</div><div class="line">      <span class="comment">//zygote space创建时的锁, Mutex</span></div><div class="line">      zygote_creation_lock_(<span class="string">"zygote creation lock"</span>, kZygoteCreationLock),</div><div class="line">      <span class="comment">//space::ZygoteSpace 在zygote space创建之前不会包含大对象</span></div><div class="line">      zygote_space_(<span class="literal">nullptr</span>),</div><div class="line">      <span class="comment">//大对象数量的阈值</span></div><div class="line">      large_object_threshold_(large_object_threshold),</div><div class="line">      <span class="comment">//跟踪在JNI critical section中有多少个线程</span></div><div class="line">      disable_thread_flip_count_(<span class="number">0</span>),</div><div class="line">      thread_flip_running_(<span class="literal">false</span>),</div><div class="line">      <span class="comment">//正在运行的回收器类型</span></div><div class="line">      collector_type_running_(kCollectorTypeNone),</div><div class="line">      <span class="comment">//最后一次运行的GC类型</span></div><div class="line">      last_gc_type_(collector::kGcTypeNone),</div><div class="line">      <span class="comment">//下一次将要运行的GC类型</span></div><div class="line">      next_gc_type_(collector::kGcTypePartial),</div><div class="line">      <span class="comment">//堆的容量</span></div><div class="line">      capacity_(capacity),</div><div class="line">      <span class="comment">//堆的增长上限</span></div><div class="line">      growth_limit_(growth_limit),</div><div class="line">      <span class="comment">//分配对象的上限数，一旦超过着搁置会引起一次GC</span></div><div class="line">      max_allowed_footprint_(initial_size),</div><div class="line">      <span class="comment">//由registerNativeAllocation请求的一次concurrent GC需要的临界线, size_t</span></div><div class="line">      native_footprint_gc_watermark_(initial_size),</div><div class="line">      <span class="comment">//bool, 是否需要在下一次的native allocation中运行finalizers</span></div><div class="line">      native_need_to_run_finalization_(<span class="literal">false</span>),</div><div class="line">      <span class="comment">//当num_bytes_allocated_超过该值后,concurrent GC会启动</span></div><div class="line">      concurrent_start_bytes_(<span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">size_t</span>&gt;::max()),</div><div class="line">      <span class="comment">//总共释放的bytes自从heap创建以来</span></div><div class="line">      total_bytes_freed_ever_(<span class="number">0</span>),</div><div class="line">      <span class="comment">//总共释放的对象自从heap创建以来</span></div><div class="line">      total_objects_freed_ever_(<span class="number">0</span>),</div><div class="line">      <span class="comment">//当前分配的bytes数量.每次释放和分配以后都会更新</span></div><div class="line">      num_bytes_allocated_(<span class="number">0</span>),</div><div class="line">      <span class="comment">//native分配的bytes数量</span></div><div class="line">      native_bytes_allocated_(<span class="number">0</span>),</div><div class="line">      <span class="comment">//Mutex</span></div><div class="line">      native_histogram_lock_(<span class="string">"Native allocation lock"</span>),</div><div class="line">      <span class="comment">//Histogram&lt;uint64_t&gt;,native分配的统计图</span></div><div class="line">      native_allocation_histogram_(<span class="string">"Native allocation sizes"</span>,</div><div class="line">                                   <span class="number">1U</span>,</div><div class="line">                                   kNativeAllocationHistogramBuckets),</div><div class="line">      <span class="comment">//native释放的统计图</span></div><div class="line">      native_free_histogram_(<span class="string">"Native free sizes"</span>, <span class="number">1U</span>, kNativeAllocationHistogramBuckets),</div><div class="line">      num_bytes_freed_revoke_(<span class="number">0</span>),</div><div class="line">      verify_missing_card_marks_(<span class="literal">false</span>),</div><div class="line">      verify_system_weaks_(<span class="literal">false</span>),</div><div class="line">     <span class="comment">//是否在开始GC前验证堆</span></div><div class="line">      verify_pre_gc_heap_(verify_pre_gc_heap),</div><div class="line">      <span class="comment">//是否在GC执行清扫前验证堆</span></div><div class="line">      verify_pre_sweeping_heap_(verify_pre_sweeping_heap),</div><div class="line">      <span class="comment">//是否在GC完成清扫后验证堆</span></div><div class="line">      verify_post_gc_heap_(verify_post_gc_heap),</div><div class="line">      <span class="comment">//是否验证ModUnionTable</span></div><div class="line">      verify_mod_union_table_(<span class="literal">false</span>),</div><div class="line">      <span class="comment">//是否在开始GC前验证RosAllocSpace</span></div><div class="line">      verify_pre_gc_rosalloc_(verify_pre_gc_rosalloc),</div><div class="line">      <span class="comment">//是否在GC执行清扫前验证RosAllocSpace</span></div><div class="line">      verify_pre_sweeping_rosalloc_(verify_pre_sweeping_rosalloc),</div><div class="line">      <span class="comment">//是否在GC完成清扫后验证RosAllocSpace</span></div><div class="line">      verify_post_gc_rosalloc_(verify_post_gc_rosalloc),</div><div class="line">      <span class="comment">/* For GC a lot mode, we limit the allocations stacks to be kGcAlotInterval allocations. This</span></div><div class="line">       * causes a lot of GC since we do a GC for alloc whenever the stack is full. When heap</div><div class="line">       * verification is enabled, we limit the size of allocation stacks to speed up their</div><div class="line">       * searching.</div><div class="line">       */</div><div class="line">      <span class="comment">//分配栈最大数量</span></div><div class="line">      max_allocation_stack_size_(kGCALotMode ? kGcAlotAllocationStackSize</div><div class="line">          : (kVerifyObjectSupport &gt; kVerifyObjectModeFast) ? kVerifyObjectAllocationStackSize :</div><div class="line">          kDefaultAllocationStackSize),</div><div class="line">      <span class="comment">//当前分配器    </span></div><div class="line">      current_allocator_(kAllocatorTypeDlMalloc),</div><div class="line">      <span class="comment">//当前不可移动对象分配器</span></div><div class="line">      current_non_moving_allocator_(kAllocatorTypeNonMoving),</div><div class="line">      <span class="comment">//阶跃型指针space</span></div><div class="line">      bump_pointer_space_(<span class="literal">nullptr</span>),</div><div class="line">      <span class="comment">//临时space,Semispace回收器会将对象拷贝至这里</span></div><div class="line">      temp_space_(<span class="literal">nullptr</span>),</div><div class="line">      <span class="comment">//RegionSpace 有一系列大小相等的区域组成</span></div><div class="line">      region_space_(<span class="literal">nullptr</span>),</div><div class="line">      <span class="comment">//最小空余内存</span></div><div class="line">      min_free_(min_free),</div><div class="line">      <span class="comment">//最大空余内存</span></div><div class="line">      max_free_(max_free),</div><div class="line">      <span class="comment">//堆目标利用率</span></div><div class="line">      target_utilization_(target_utilization),</div><div class="line">      <span class="comment">//前台堆增长因子</span></div><div class="line">      foreground_heap_growth_multiplier_(foreground_heap_growth_multiplier),</div><div class="line">      <span class="comment">//mutators暂停等待GC的总共时间</span></div><div class="line">      total_wait_time_(<span class="number">0</span>),</div><div class="line">      <span class="comment">//VerifyObjectMode, 目前heap verification的状态</span></div><div class="line">      verify_object_mode_(kVerifyObjectModeDisabled),</div><div class="line">      <span class="comment">//Compacting GC disable count</span></div><div class="line">      disable_moving_gc_count_(<span class="number">0</span>),</div><div class="line">      is_running_on_memory_tool_(Runtime::Current()-&gt;IsRunningOnMemoryTool()),</div><div class="line">      use_tlab_(use_tlab),</div><div class="line">      <span class="comment">//homogeneous space compaction时的新main space</span></div><div class="line">      main_space_backup_(<span class="literal">nullptr</span>),</div><div class="line">      <span class="comment">//两次OOM引起homogeneous space compaction时间间隔</span></div><div class="line">      min_interval_homogeneous_space_compaction_by_oom_(</div><div class="line">          min_interval_homogeneous_space_compaction_by_oom),</div><div class="line">      <span class="comment">//上一次由OOM引起的HomogeneousSpaceCompact的时间</span></div><div class="line">      last_time_homogeneous_space_compaction_by_oom_(NanoTime()),</div><div class="line">      <span class="comment">//CollectorTransitionTask*</span></div><div class="line">      pending_collector_transition_(<span class="literal">nullptr</span>),</div><div class="line">      <span class="comment">//HeapTrimTask*</span></div><div class="line">      pending_heap_trim_(<span class="literal">nullptr</span>),</div><div class="line">      <span class="comment">//是否使用homogeneous space compaction来避免OOM</span></div><div class="line">      use_homogeneous_space_compaction_for_oom_(use_homogeneous_space_compaction_for_oom),</div><div class="line">      <span class="comment">//如果当前的回收工作导致一些线程暂停,则该值为true</span></div><div class="line">      running_collection_is_blocking_(<span class="literal">false</span>),</div><div class="line">      <span class="comment">//blocking gc 数量</span></div><div class="line">      blocking_gc_count_(<span class="number">0U</span>),</div><div class="line">      <span class="comment">//blocking gc总共持续时间</span></div><div class="line">      blocking_gc_time_(<span class="number">0U</span>),</div><div class="line">      <span class="comment">//GC count rate统计图最后已更新时间</span></div><div class="line">      last_update_time_gc_count_rate_histograms_(  <span class="comment">// Round down by the window duration.</span></div><div class="line">          (NanoTime() / kGcCountRateHistogramWindowDuration) * kGcCountRateHistogramWindowDuration),</div><div class="line">      <span class="comment">//在上一个window运行的GC数量</span></div><div class="line">      gc_count_last_window_(<span class="number">0U</span>),</div><div class="line">      <span class="comment">//在上一个window运行的blocking GC数量</span></div><div class="line">      blocking_gc_count_last_window_(<span class="number">0U</span>),</div><div class="line">      <span class="comment">//每一个window的GC调用统计图</span></div><div class="line">      gc_count_rate_histogram_(<span class="string">"gc count rate histogram"</span>, <span class="number">1U</span>, kGcCountRateMaxBucketCount),</div><div class="line">      <span class="comment">//每一个window的blocking GC调用统计图</span></div><div class="line">      blocking_gc_count_rate_histogram_(<span class="string">"blocking gc count rate histogram"</span>, <span class="number">1U</span>,</div><div class="line">                                        kGcCountRateMaxBucketCount),</div><div class="line">      <span class="comment">//是否支持allocation tracking</span></div><div class="line">      alloc_tracking_enabled_(<span class="literal">false</span>),</div><div class="line">      <span class="comment">//Mutex*</span></div><div class="line">      backtrace_lock_(<span class="literal">nullptr</span>),</div><div class="line">      seen_backtrace_count_(<span class="number">0u</span>),</div><div class="line">      unique_backtrace_count_(<span class="number">0u</span>),</div><div class="line">      gc_disabled_for_shutdown_(<span class="literal">false</span>) &#123;</div></pre></td></tr></table></figure>
<h4 id="2-2-2-具体创建逻辑"><a href="#2-2-2-具体创建逻辑" class="headerlink" title="2.2.2 具体创建逻辑"></a>2.2.2 具体创建逻辑</h4><p>Heap的构造函数的代码较多，不过整体逻辑比较清晰，整体逻辑可以分为以下几块:</p>
<ol>
<li><p>判断当前是否在zygote进程,如果不在zygote，将<code>background_collector_type_</code>设为和<code>foreground_collector_type_</code>一样，并检查传入的<code>desired_collector_type_</code>和<code>collector_type_</code>是否一样，如果不一样，则将<code>collector_type_</code>设为<code>desired_collector_type_</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">Runtime* <span class="keyword">const</span> runtime = Runtime::Current();</div><div class="line">  <span class="comment">//判断当前是否是zygote模式,如果不是判断后台回收器类型是否和前台回收器相等,不想等,则设为相等</span></div><div class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> is_zygote = runtime-&gt;IsZygote();</div><div class="line">  <span class="keyword">if</span> (!is_zygote) &#123;</div><div class="line">      <span class="keyword">if</span> (background_collector_type_ != foreground_collector_type_) &#123;</div><div class="line">          ...</div><div class="line">          background_collector_type_ = foreground_collector_type_;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//检查collector_type_是否和desired_collector_type_相等,不等的话将collector_type_置为desired_collector_type_</span></div><div class="line">  ChangeCollector(desired_collector_type_);</div></pre></td></tr></table></figure>
</li>
<li><p>创建两个HeapBitmap(<code>live_bitmap_</code>:用来记录上次GC之后还存活的对象;<code>mark_bitmap_</code>:用来记录当前GC中还存活的对象)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">live_bitmap_.reset(<span class="keyword">new</span> accounting::HeapBitmap(<span class="keyword">this</span>));</div><div class="line">mark_bitmap_.reset(<span class="keyword">new</span> accounting::HeapBitmap(<span class="keyword">this</span>));</div></pre></td></tr></table></figure>
</li>
<li><p>如果<code>foreground_collector_type_</code>是Concurrent-Copying,设置<code>requested_alloc_space_begin</code>即alloc space的起始地址为(<strong>如果前台回收器是CC则是300MB-non_moving_space_capacity，否则是nullptr</strong>)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (foreground_collector_type_ == kCollectorTypeCC) &#123;</div><div class="line">    ...  </div><div class="line">    requested_alloc_space_begin = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uint8_t</span>*&gt;(<span class="number">300</span> * MB) - non_moving_space_capacity;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>根据传入的image文件路径(<code>/system/framework/boot.art</code>)创建ImageSpace,在ImageSpace后面紧跟的是<code>/system/framework/boot.oat</code>,如果创建成功，将<code>requested_alloc_space_begin</code>指向boot.oat地址的末尾；如果创建ImageSpace失败，删除已加载的Space，将<code>requested_alloc_space_begin</code>指回原来的(300MB-non_moving_space_capacity)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建ImageSpace, image_file_name是/system/framework/boot.art</span></div><div class="line"><span class="keyword">if</span> (!image_file_name.empty()) &#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; image_file_names;</div><div class="line">    image_file_names.push_back(image_file_name);</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;space::Space*&gt; added_image_spaces;</div><div class="line">    <span class="keyword">uint8_t</span>* <span class="keyword">const</span> original_requested_alloc_space_begin = requested_alloc_space_begin;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> index = <span class="number">0</span>; index &lt; image_file_names.size(); ++index) &#123;</div><div class="line">        <span class="built_in">std</span>::<span class="built_in">string</span>&amp; image_name = image_file_names[index];<span class="comment">///system/framework/boot.art</span></div><div class="line">        <span class="built_in">std</span>::<span class="built_in">string</span> error_msg;</div><div class="line">        <span class="comment">//创建boot_image_space</span></div><div class="line">        space::ImageSpace* boot_image_space = space::ImageSpace::CreateBootImage(</div><div class="line">                image_name.c_str(),</div><div class="line">                image_instruction_set,</div><div class="line">                index &gt; <span class="number">0</span>,</div><div class="line">                &amp;error_msg);</div><div class="line">        <span class="comment">//创建boot_image_space成功</span></div><div class="line">        <span class="keyword">if</span> (boot_image_space != <span class="literal">nullptr</span>) &#123;</div><div class="line">            <span class="comment">/* 根据boot_image_space是否时连续空间，将boot_image_space添加到对应的Space列表，并在live_bitmap_和mark_bitmap_中添加对应的位图 */</span></div><div class="line">            AddSpace(boot_image_space);</div><div class="line">            added_image_spaces.push_back(boot_image_space);</div><div class="line">            <span class="comment">//Oat文件即boot.oat紧跟在boot_image_space末尾</span></div><div class="line">            <span class="keyword">uint8_t</span>* oat_file_end_addr = boot_image_space-&gt;GetImageHeader().GetOatFileEnd();</div><div class="line">            ...</div><div class="line">            <span class="comment">//将boot.oat的地址按页大小(pageSize)对齐</span></div><div class="line">            requested_alloc_space_begin = AlignUp(oat_file_end_addr, kPageSize);</div><div class="line">            boot_image_spaces_.push_back(boot_image_space);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</div><div class="line">              <span class="comment">//如果是第一块Space,检查是否还有其他的oat文件需要加载</span></div><div class="line">              <span class="keyword">const</span> OatFile* boot_oat_file = boot_image_space-&gt;GetOatFile();</div><div class="line">              <span class="keyword">if</span> (boot_oat_file == <span class="literal">nullptr</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">              &#125;</div><div class="line">              <span class="comment">//如果还有其他的oat文件，根据OatHeader获取boot_classpath,再根据boot_classpath生成</span></div><div class="line">              <span class="comment">//oat文件完整路径，将完整路径添加进image文件列表，从而可以在下次循环中加载</span></div><div class="line">              <span class="keyword">const</span> OatHeader&amp; boot_oat_header = boot_oat_file-&gt;GetOatHeader();</div><div class="line">              <span class="keyword">const</span> <span class="keyword">char</span>* boot_classpath =</div><div class="line">                  boot_oat_header.GetStoreValueByKey(OatHeader::kBootClassPathKey);</div><div class="line">              <span class="keyword">if</span> (boot_classpath == <span class="literal">nullptr</span>) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">              &#125;</div><div class="line">              space::ImageSpace::CreateMultiImageLocations(image_file_name,</div><div class="line">                                                                 boot_classpath,</div><div class="line">                                                                 &amp;image_file_names);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//创建ImageSpace失败, 删除已加载的Space</span></div><div class="line">            <span class="keyword">for</span> (space::Space* loaded_space : added_image_spaces) &#123;</div><div class="line">              RemoveSpace(loaded_space);</div><div class="line">              <span class="keyword">delete</span> loaded_space;</div><div class="line">            &#125;</div><div class="line">            boot_image_spaces_.clear();</div><div class="line">            requested_alloc_space_begin = original_requested_alloc_space_begin;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>判断是否支持Homogeneous-Space-Compact.当<code>background_collector_type_</code>是Homogeneous-Space-Compact或者<code>foreground_collector_type_</code>不是<code>GSS(Generational Semi-Space)</code>和<code>CC(Concurrent-Copying)</code>时，支持Homogeneous-Space-Compact</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (foreground_collector_type_ == kCollectorTypeGSS ||</div><div class="line">            foreground_collector_type_ == kCollectorTypeCC) &#123;</div><div class="line">      use_homogeneous_space_compaction_for_oom_ = <span class="literal">false</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//如果后台回收器是homogeneous space compact或者前台回收器不是GSS和CC时，支持homogeneous space compact</span></div><div class="line"><span class="keyword">bool</span> support_homogeneous_space_compaction =</div><div class="line">      background_collector_type_ == gc::kCollectorTypeHomogeneousSpaceCompact ||</div><div class="line">      use_homogeneous_space_compaction_for_oom_;</div></pre></td></tr></table></figure>
</li>
<li><p>判断是否给Non-Moving Space独立的地址.只要以下满足四个条件中的一项就会给Non-Moving Space独立地址(处于Zygote;支持Homogeneous-Space-Compact(<code>foreground_collector_type_</code>不是<code>GSS</code>或者不是<code>CC</code>);<code>foreground_collector_type_</code>可以移动对象;<code>background_collector_type_</code>可以移动对象), 之后再排除<code>foreground_collector_type_</code>是GSS的情况，即前台回收器是GSS时，不给Non-Moving Space独立地址</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//如果当前处于Zygote模式或者支持homogeneous space compact或者前台回收器是可以移动对象的或者后台回收器也可以移动对象时</span></div><div class="line"><span class="comment">//给non_moving_space一个独立的地址</span></div><div class="line"><span class="keyword">bool</span> separate_non_moving_space = is_zygote ||</div><div class="line">          support_homogeneous_space_compaction || IsMovingGc(foreground_collector_type_) ||</div><div class="line">          IsMovingGc(background_collector_type_);</div><div class="line"><span class="comment">//再次检查前台进程是否是GSS,如果是，则不给non_moving_space_一个独立的地址</span></div><div class="line"><span class="keyword">if</span> (foreground_collector_type_ == kCollectorTypeGSS) &#123;</div><div class="line">    separate_non_moving_space = <span class="literal">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>只要传入的type是SS,GSS,CC,MC,Homogeneous-Space-Compact其中一个时,<code>IsMovingGc</code>返回的都是true</p>
<ol>
<li>创建两个内存映射<code>MemMap</code><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;MemMap&gt; main_mem_map_1;</div><div class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;MemMap&gt; main_mem_map_2;</div></pre></td></tr></table></figure>
</li>
</ol>
</blockquote>
<ol>
<li><p>如果之前创建ImageSpace失败同时<code>foreground_collector_type_</code>是<code>MarkSweep</code>而且此时的Runtime由dex2oat创建即处于dex2oat进程中时，将<code>requested_alloc_space_begin</code>指向<code>kAllocSpaceBeginForDeterministicAoT</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 如果前台回收器是MS(MarkSweep)且requested_alloc_space_begin</span></div><div class="line"><span class="comment">// 是null(即之前ImageSpace创建失败)同时当前是dex2oat程序</span></div><div class="line"><span class="comment">// 将requested_alloc_space_begin设为kAllocSpaceBeginForDeterministicAoT</span></div><div class="line"><span class="keyword">if</span> (foreground_collector_type_ == kCollectorTypeMS &amp;&amp;</div><div class="line">            requested_alloc_space_begin == <span class="literal">nullptr</span> &amp;&amp;</div><div class="line">            Runtime::Current()-&gt;IsAotCompiler()) &#123;</div><div class="line">    requested_alloc_space_begin = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uint8_t</span>*&gt;(kAllocSpaceBeginForDeterministicAoT);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>初始化<code>request_begin</code>.如果Non-Moving Space有独立地址，根据当前是否是zygote确定Non-Moving Space的名字,之后创建一块匿名内存映射，由<code>non_moving_space_mem_map</code>指向，<code>non_moving_space_mem_map</code>紧跟在<code>requested_alloc_space_begin</code>后面，如果ImageSpace创建成功，就是紧跟在<strong>ImageSpace+boot.oat</strong>后面，否则紧跟在<code>kAllocSpaceBeginForDeterministicAoT</code>后面,最后设置<code>request_begin</code>为300MB,即其他Space的起始地址为<strong>300MB</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">uint8_t</span>* request_begin = requested_alloc_space_begin;</div><div class="line"><span class="keyword">if</span> (request_begin != <span class="literal">nullptr</span> &amp;&amp; separate_non_moving_space) &#123;</div><div class="line">    request_begin += non_moving_space_capacity;</div><div class="line">&#125;</div><div class="line"><span class="built_in">std</span>::<span class="built_in">string</span> error_str;</div><div class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;MemMap&gt; non_moving_space_mem_map;</div><div class="line"><span class="comment">//如果确定给non moving space一块独立的地址</span></div><div class="line"><span class="keyword">if</span> (separate_non_moving_space) &#123;</div><div class="line">    <span class="function">ScopedTrace <span class="title">trace2</span><span class="params">(<span class="string">"Create separate non moving space"</span>)</span></span>;</div><div class="line">    <span class="comment">// 如果当前正在Zygote当中，将non moving space设为zygote space</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* space_name = is_zygote ? kZygoteSpaceName: kNonMovingSpaceName;</div><div class="line">    <span class="comment">//创建匿名内存映射</span></div><div class="line">    <span class="comment">//non moving sapce紧跟在requested_alloc_space_begin后面(即如果ImageSpace创建成功，紧跟在ImageSpace + boo.oat后面)</span></div><div class="line">    non_moving_space_mem_map.reset(</div><div class="line">            MemMap::MapAnonymous(space_name, requested_alloc_space_begin,</div><div class="line">                                non_moving_space_capacity, PROT_READ | PROT_WRITE, <span class="literal">true</span>, <span class="literal">false</span>,</div><div class="line">                                &amp;error_str));</div><div class="line">    ...</div><div class="line">    <span class="comment">// 如果要给non moving space一个独立的地址, 将其他Space的起始地址设为300MB,由request_begin指向</span></div><div class="line">    request_begin = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uint8_t</span>*&gt;(<span class="number">300</span> * MB);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>如果<code>foreground_collector_type_</code>不是<code>CC</code>,初始化之前创造的<code>main_mem_map_1</code>,这块内存的作用是作为<code>MarkSweep</code>的<strong>Main Space</strong>或者<code>Compact GC</code>的<strong>From-Bump-Space</strong>.当Non-Moving Space有独立地址且当前不处于Zygote时，紧跟在300MB后面创建匿名内存映射;否则紧跟在<strong>ImageSpace+boot.oat</strong>后面创建匿名内存映射</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//如果前台回收器不是CC，创建第一块匿名共享内存,由main_mem_map_1指向，这块内存的作用是作为Compact GC的From Bump Space或者</span></div><div class="line"><span class="comment">//MarkSweep的Main Space</span></div><div class="line"><span class="keyword">if</span> (foreground_collector_type_ != kCollectorTypeCC) &#123;</div><div class="line">      <span class="function">ScopedTrace <span class="title">trace2</span><span class="params">(<span class="string">"Create main mem map"</span>)</span></span>;</div><div class="line">      <span class="keyword">if</span> (separate_non_moving_space || !is_zygote) &#123;</div><div class="line">          <span class="comment">//如果non moving space有独立地址或者当前不是zygote，则main_mem_map_1紧跟在  request_begin后面，即300MB后面</span></div><div class="line">          <span class="comment">//名字是main space</span></div><div class="line">          main_mem_map_1.reset(MapAnonymousPreferredAddress(kMemMapSpaceName[<span class="number">0</span>],</div><div class="line">                                                            request_begin,</div><div class="line">                                                            capacity_,</div><div class="line">                                                            &amp;error_str));</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="comment">//如果non-moving space有独立地址且当前处于zygote或者non-moving space没有独立地址，</span></div><div class="line">          <span class="comment">//则main space必须紧跟在ImageSpace后面,这样zygote space就会临近ImageSpace</span></div><div class="line">          main_mem_map_1.reset(MemMap::MapAnonymous(kMemMapSpaceName[<span class="number">0</span>], request_begin, capacity_,</div><div class="line">                                                    PROT_READ | PROT_WRITE, <span class="literal">true</span>, <span class="literal">false</span>,</div><div class="line">                                                    &amp;error_str));</div><div class="line">      &#125;</div><div class="line">      ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>如果支持Homogeneous-Space-Compact或者<code>background_collector_type_</code>和<code>foreground_collector_type_</code>其中一个是<code>SS</code>时，创建第二块匿名内存映射<code>main_mem_map_2</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//如果支持homogeneous space compact或者后台回收器和前台回收器中有一个为为SS(Semi Space)时，创建第二块匿名共享内存</span></div><div class="line"><span class="comment">//由main_mem_map_2指向</span></div><div class="line"><span class="keyword">if</span> (support_homogeneous_space_compaction ||</div><div class="line">        background_collector_type_ == kCollectorTypeSS ||</div><div class="line">        foreground_collector_type_ == kCollectorTypeSS) &#123;</div><div class="line">      <span class="function">ScopedTrace <span class="title">trace2</span><span class="params">(<span class="string">"Create main mem map 2"</span>)</span></span>;</div><div class="line">      main_mem_map_2.reset(MapAnonymousPreferredAddress(kMemMapSpaceName[<span class="number">1</span>], main_mem_map_1-&gt;End(),</div><div class="line">                                                            capacity_, &amp;error_str));</div><div class="line">      ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>如果Non-Moving Space有独立地址，则之前已经创建了匿名内存映射<code>non_moving_space_mem_map</code>，现在将这块内存封装成<code>DlMallocSpace</code>,由<code>non-moving_space</code>指向，并将这块Space添加至Space列表中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//如果non moving space有独立的地址时，将non_moving_space_mem_map封装成Non-Moving Space(space::MallocSpace)</span></div><div class="line"><span class="keyword">if</span> (separate_non_moving_space) &#123;</div><div class="line">      <span class="function">ScopedTrace <span class="title">trace2</span><span class="params">(<span class="string">"Add non moving space"</span>)</span></span>;</div><div class="line">      <span class="comment">//Non-Moving Space必须是dlmalloc，因为目前并不支持多个rosalloc spaces</span></div><div class="line">      <span class="keyword">const</span> <span class="keyword">size_t</span> size = non_moving_space_mem_map-&gt;Size();</div><div class="line">      non_moving_space_ = space::DlMallocSpace::CreateFromMemMap(</div><div class="line">            non_moving_space_mem_map.release(), <span class="string">"zygote / non moving space"</span>, kDefaultStartingSize,</div><div class="line">            initial_size, size, size, <span class="literal">false</span>);</div><div class="line">      <span class="comment">//设置Non-Moving Space大小限制</span></div><div class="line">      non_moving_space_-&gt;SetFootprintLimit(non_moving_space_-&gt;Capacity());</div><div class="line">      ...</div><div class="line">      <span class="comment">//将non_moving_space_添加至space列表中</span></div><div class="line">      AddSpace(non_moving_space_);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>根据条件处理之前创建的另外两块匿名内存映射<code>main_mem_map_1</code>和<code>main_mem_map_2</code>.因为在之前的逻辑中，当<code>foreground_collector_type_</code>是CC时，并没有创建<code>main_mem_map_1</code>匿名内存映射，所以如果<code>foreground_collector_type_</code>恰好是CC时，紧跟<code>request_begin</code>(如果Non-Moving Space有独立地址，则是300MB,否则是ImageSpace+boot.oat)创建一个<code>RegionSpace</code>，由<code>region_space_</code>指向; 如果<code>foreground_collector_type_</code>不是CC时，也要分两种情况：(1)<code>foreground_collector_type_</code>是<code>SS,MC,Homogeneous-Space-Compact</code>中的一个;(2)<code>foreground_collector_type_</code>是<code>MarkSweep, Compact MarkSweep</code>或者<code>GSS</code>. 对于第一种情况来说，将<code>main_mem_map_1</code>封装成<code>BumpPointerSpace1</code>并添加至space列表，由<code>bump_pointer_space_</code>指向，将<code>main_mem_map_2</code>封装成另一块<code>BumpPointerSpace2</code>同样添加至space列表,由<code>temp_space_</code>指向;对于第二种情况，首先将<code>main_mem_map_1</code>封装成<code>MainSpace</code>同时添加至space列表，之后如果Non-Moving Space没有独立地址，则将<code>non_moving_space_</code>指向MainSpace,即MainSpace和Non-Moving Space共用同一块内存，接着判断如果foreground_collector<em>type</em>是GSS时，调用<code>BumpPointerSpace::Craete</code>直接创建<code>BumpPointerSpace1</code>(<code>bump_pointer_space_</code>)和<code>BumpPointerSpace2</code>(<code>temp_space_</code>)并依次添加至space列表;如果<code>foreground_collector_type_</code>不是<code>GSS</code>时，即<code>MarkSweep</code>或<code>Compact MarkSweep</code>,且<code>main_mem_map_2</code>不为空时(如果支持HomogeneousSpaceCompact),将<code>main_mem_map_2</code>封装成<code>Backup Space</code>,并添加至space列表</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (foreground_collector_type_ == kCollectorTypeCC) &#123;</div><div class="line">      <span class="comment">// 如果前台回收器是CC(Concurrent Copying),创建RegionSpace,并将RegionSpace添加至space列表</span></div><div class="line">      region_space_ = space::RegionSpace::Create(<span class="string">"Region space"</span>, capacity_ * <span class="number">2</span>, request_begin);</div><div class="line">      AddSpace(region_space_);</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (IsMovingGc(foreground_collector_type_) &amp;&amp;</div><div class="line">          foreground_collector_type_ != kCollectorTypeGSS) &#123;</div><div class="line">      <span class="comment">//如果前台回收器是除了GSS(Generational Semi-Space)以外的Compact GC,将main_mem_map_1封装成BumpPointerSpace</span></div><div class="line">      <span class="comment">//并将bump_pointer_space_添加至space列表</span></div><div class="line">      <span class="comment">// <span class="doctag">TODO:</span> Place bump-pointer spaces somewhere to minimize size of card table.</span></div><div class="line">      bump_pointer_space_ = space::BumpPointerSpace::CreateFromMemMap(<span class="string">"Bump pointer space 1"</span>,</div><div class="line">                                                                            main_mem_map_1.release());</div><div class="line">      ...</div><div class="line">      AddSpace(bump_pointer_space_);</div><div class="line">      <span class="comment">//将main_mem_map_2封装成第二块BumpPointerSpace，由temp_space_指向，同时将temp_space_添加至space列表</span></div><div class="line">      temp_space_ = space::BumpPointerSpace::CreateFromMemMap(<span class="string">"Bump pointer space 2"</span>,</div><div class="line">                                                                    main_mem_map_2.release());</div><div class="line">      ...</div><div class="line">      AddSpace(temp_space_);</div><div class="line">      ...</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">//如果前台回收器不是Compact GC即MarkSweep或者是GSS,则在main_mem_map_1创建Main Space,并将Main Space添加至space列表</span></div><div class="line">      CreateMainMallocSpace(main_mem_map_1.release(), initial_size, growth_limit_, capacity_);</div><div class="line">      ...</div><div class="line">      AddSpace(main_space_);</div><div class="line">      <span class="keyword">if</span> (!separate_non_moving_space) &#123;</div><div class="line">          <span class="comment">//如果Non-Moving Space没有独立地址，则将non_moving_space_指向main_space_,即Non-Moving Space和Main Space是同一块Space</span></div><div class="line">          non_moving_space_ = main_space_;</div><div class="line">          ...</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (foreground_collector_type_ == kCollectorTypeGSS) &#123;</div><div class="line">          ....</div><div class="line">          <span class="comment">//如果前台回收器是GSS, 并创建BumpPointerSpace，由bump_pointer_space_指向</span></div><div class="line">          <span class="comment">//同时将bump_pointer_space_添加至space列表</span></div><div class="line">          main_mem_map_2.release();</div><div class="line">          bump_pointer_space_ = space::BumpPointerSpace::Create(<span class="string">"Bump pointer space 1"</span>,</div><div class="line">                                                              kGSSBumpPointerSpaceCapacity, <span class="literal">nullptr</span>);</div><div class="line">          ...</div><div class="line">          AddSpace(bump_pointer_space_);</div><div class="line">          <span class="comment">//创建第二块BumpPointerSpace,由temp_space_指向,并将temp_space_添加至space列表</span></div><div class="line">          temp_space_ = space::BumpPointerSpace::Create(<span class="string">"Bump pointer space 2"</span>,</div><div class="line">                                                            kGSSBumpPointerSpaceCapacity, <span class="literal">nullptr</span>);</div><div class="line">          ...</div><div class="line">          AddSpace(temp_space_);</div><div class="line">      &#125;  <span class="keyword">else</span> <span class="keyword">if</span> (main_mem_map_2.get() != <span class="literal">nullptr</span>) &#123;</div><div class="line">          <span class="comment">//此时前台回收器根据排除法只剩MarkSweep了，将main_mem_map_2封装成Backup Space,由main_space_backup_指向</span></div><div class="line">          <span class="comment">//同时将main_space_backup_添加至space列表,如果kUseRosAlloc为true,main_space_backup_为RosAllocSpace，否则为DlMallocSpace</span></div><div class="line">          <span class="keyword">const</span> <span class="keyword">char</span>* name = kUseRosAlloc ? kRosAllocSpaceName[<span class="number">1</span>] : kDlMallocSpaceName[<span class="number">1</span>];</div><div class="line">          main_space_backup_.reset(CreateMallocSpaceFromMemMap(main_mem_map_2.release(), initial_size,</div><div class="line">                                                                   growth_limit_, capacity_, name, <span class="literal">true</span>));</div><div class="line">          ...</div><div class="line">          AddSpace(main_space_backup_.get());</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建大对象存储空间.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 创建LargeObjectSpace(大对象存储空间)</span></div><div class="line"><span class="keyword">if</span> (large_object_space_type == space::LargeObjectSpaceType::kFreeList) &#123;</div><div class="line">      <span class="comment">//如果LargeObjectSpace类型是FreeList，创建FreeList类型的LargeObjectSpace</span></div><div class="line">      large_object_space_ = space::FreeListSpace::Create(<span class="string">"free list large object space"</span>, <span class="literal">nullptr</span>,</div><div class="line">                                                               capacity_);</div><div class="line">      ...</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (large_object_space_type == space::LargeObjectSpaceType::kMap) &#123;</div><div class="line">      <span class="comment">//创建相互独立的内存快组成的LargeObjectSpace</span></div><div class="line">      large_object_space_ = space::LargeObjectMapSpace::Create(<span class="string">"mem map large object space"</span>);</div><div class="line">      ...</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">      large_object_threshold_ = <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">size_t</span>&gt;::max();</div><div class="line">      large_object_space_ = <span class="literal">nullptr</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">//如果LargeObjectSpace不为空，则添加至Space列表</span></div><div class="line"><span class="keyword">if</span> (large_object_space_ != <span class="literal">nullptr</span>) &#123;</div><div class="line">      AddSpace(large_object_space_);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>如果<code>foreground_collector_type_</code>是MarkSweep或Compact MarkSweep且创建了<code>Backup Space</code>时，由于Backup Space占用的额外的空间会降低GC速度,所以移除Backup Space;之后创建<code>CardTable</code>(Card Table是为了记录在垃圾收集过程中对象的引用情况的), <code>ModUnionTable</code>(来记录ImageSpace对ZygoteSpace引用情况的ModUnionTable), <code>RememberSet</code>(用来记录Non-moving Space对其他Space引用情况的RememberedSet, <code>GSS</code>时不会创建，<code>CC, SS, MC, HomogeneousSpaceCompact</code>时根据<code>collector::SemiSpace::kUseRememberedSet == true</code>判断, <code>MS,CMS</code>时根据Non-Moving Space有没有独立地址加<code>collector::SemiSpace::kUseRememberedSet == true</code>判断)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//获取连续空间的起始地址和结束地址</span></div><div class="line"><span class="keyword">uint8_t</span>* heap_begin = continuous_spaces_.front()-&gt;Begin();</div><div class="line"><span class="keyword">uint8_t</span>* heap_end = continuous_spaces_.back()-&gt;Limit();</div><div class="line"><span class="keyword">size_t</span> heap_capacity = heap_end - heap_begin;</div><div class="line"><span class="comment">//移除main_space_backup_,此时foreground_collector_type_是MarkSweep</span></div><div class="line"><span class="comment">//因为Backup Space的额外的未使用的空间降低了GC速度</span></div><div class="line"><span class="keyword">if</span> (main_space_backup_.get() != <span class="literal">nullptr</span>) &#123;</div><div class="line">       RemoveSpace(main_space_backup_.get());</div><div class="line">&#125;</div><div class="line">...</div><div class="line"><span class="comment">// 创建card table,因为不知道在low_4gb模式下,app image会在何处定位，</span></div><div class="line"><span class="comment">// 所以card table将会从64KB开始覆盖整个4GB的低地址，64KB以前的地址预留给kernel</span></div><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keyword">size_t</span> kMinHeapAddress = <span class="number">4</span> * KB;</div><div class="line">card_table_.reset(accounting::CardTable::Create(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uint8_t</span>*&gt;(kMinHeapAddress), <span class="number">4</span> * GB - kMinHeapAddress));</div><div class="line">....</div><div class="line"><span class="comment">//如果前台回收器是CC(Concurrent Copying)同时kUseTableLookupReadBarrier=true,创建ReadBarrierTable</span></div><div class="line"><span class="keyword">if</span> (foreground_collector_type_ == kCollectorTypeCC &amp;&amp; kUseTableLookupReadBarrier) &#123;</div><div class="line">      rb_table_.reset(<span class="keyword">new</span> accounting::ReadBarrierTable());</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (HasBootImageSpace()) &#123;</div><div class="line">    <span class="comment">// 如果有ImageSpace,则创建用来记录ImageSpace对ZygoteSpace引用情况的ModUnionTable</span></div><div class="line">    <span class="keyword">for</span> (space::ImageSpace* image_space : GetBootImageSpaces()) &#123;</div><div class="line">        accounting::ModUnionTable* mod_union_table = <span class="keyword">new</span>     accounting::ModUnionTableToZygoteAllocspace(</div><div class="line">              <span class="string">"Image mod-union table"</span>, <span class="keyword">this</span>, image_space);</div><div class="line">          ...</div><div class="line">        AddModUnionTable(mod_union_table);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//如果Non-moving Space有独立地址而且kUseRememberedSet=true,</span></div><div class="line"><span class="comment">//创建用来记录Non-moving Space对其他Space引用情况的RememberedSet</span></div><div class="line"><span class="keyword">if</span> (collector::SemiSpace::kUseRememberedSet &amp;&amp; non_moving_space_ != main_space_) &#123;</div><div class="line">        accounting::RememberedSet* non_moving_space_rem_set =</div><div class="line">            <span class="keyword">new</span> accounting::RememberedSet(<span class="string">"Non-moving space remembered set"</span>, <span class="keyword">this</span>, non_moving_space_);</div><div class="line">        ...</div><div class="line">        AddRememberedSet(non_moving_space_rem_set);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>创建<code>Mark-Stack</code>,<code>Allocation-Stack</code>,<code>Live-Stack</code>;创建之后GC需要用到的的锁;创建<code>TaskProcessor</code>,<code>ReferenceProcessor</code>;如果前后台回收器有一个是CMS,则创建一组包含三个支持并发的<code>Collector:MarkSweep, PartialMarkSweep, StickyMarkSweep</code>回收器; 如果前后台回收器有一个是MS,则创建一组包含三个不支持并发的<code>Collector:MarkSweep, PartialMarkSweep, StickyMarkSweep</code>回收器;之后再根据条件创建<code>Semi-Space Collector</code>(<code>SS</code>或<code>GSS</code>时创建),<code>Concurrent-Copying Collector</code>(<code>CC</code>时创建),<code>Mark Compact Collector</code>(<code>MS,CMS</code>shichu)</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// <span class="doctag">TODO:</span> Count objects in the image space here?</span></div><div class="line">num_bytes_allocated_.StoreRelaxed(<span class="number">0</span>);</div><div class="line"><span class="comment">// 创建Mark-Stack, Allocation-Stack, Live-Stack</span></div><div class="line">mark_stack_.reset(accounting::ObjectStack::Create(<span class="string">"mark stack"</span>, kDefaultMarkStackSize, kDefaultMarkStackSize));</div><div class="line"><span class="keyword">const</span> <span class="keyword">size_t</span> alloc_stack_capacity = max_allocation_stack_size_ + kAllocationStackReserveSize;</div><div class="line">allocation_stack_.reset(accounting::ObjectStack::Create(<span class="string">"allocation stack"</span>, max_allocation_stack_size_, alloc_stack_capacity));</div><div class="line">live_stack_.reset(accounting::ObjectStack::Create(<span class="string">"live stack"</span>, max_allocation_stack_size_, alloc_stack_capacity));</div><div class="line"><span class="comment">// 创建gc_complete_lock_,thread_flip_lock_</span></div><div class="line">gc_complete_lock_ = <span class="keyword">new</span> Mutex(<span class="string">"GC complete lock"</span>);</div><div class="line">gc_complete_cond_.reset(<span class="keyword">new</span> ConditionVariable(<span class="string">"GC complete condition variable"</span>,*gc_complete_lock_));</div><div class="line">thread_flip_lock_ = <span class="keyword">new</span> Mutex(<span class="string">"GC thread flip lock"</span>);</div><div class="line">thread_flip_cond_.reset(<span class="keyword">new</span> ConditionVariable(<span class="string">"GC thread flip condition variable"</span>,*thread_flip_lock_));</div><div class="line"><span class="comment">//创建TaskProcessor, ReferenceProcessor, pending_task_lock_</span></div><div class="line">task_processor_.reset(<span class="keyword">new</span> TaskProcessor());</div><div class="line">reference_processor_.reset(<span class="keyword">new</span> ReferenceProcessor());</div><div class="line">pending_task_lock_ = <span class="keyword">new</span> Mutex(<span class="string">"Pending task lock"</span>);</div><div class="line"><span class="keyword">if</span> (ignore_max_footprint_) &#123;</div><div class="line">      <span class="comment">//如果不限制堆的增长，则将堆的最大限制数设为最大</span></div><div class="line">      SetIdealFootprint(<span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">size_t</span>&gt;::max());</div><div class="line">      <span class="comment">//将concurrent gc的启动值也设为最大，即只有堆达到最大时，才开启concurrent gc</span></div><div class="line">      concurrent_start_bytes_ = <span class="built_in">std</span>::numeric_limits&lt;<span class="keyword">size_t</span>&gt;::max();</div><div class="line">&#125;</div><div class="line">...</div><div class="line"><span class="comment">// 如果前后台回收器有一个是CMS,则创建一组包含三个支持并发的Collector:MarkSweep, PartialMarkSweep, StickyMarkSweep回收器</span></div><div class="line"><span class="comment">// 如果前后台回收器有一个是MS,则创建一组包含三个不支持并发的Collector:MarkSweep, PartialMarkSweep, StickyMarkSweep回收器</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; ++i) &#123;</div><div class="line">      <span class="keyword">const</span> <span class="keyword">bool</span> concurrent = i != <span class="number">0</span>;</div><div class="line">      <span class="keyword">if</span> ((MayUseCollector(kCollectorTypeCMS) &amp;&amp; concurrent) ||</div><div class="line">                (MayUseCollector(kCollectorTypeMS) &amp;&amp; !concurrent)) &#123;</div><div class="line">          garbage_collectors_.push_back(<span class="keyword">new</span> collector::MarkSweep(<span class="keyword">this</span>, concurrent));</div><div class="line">          garbage_collectors_.push_back(<span class="keyword">new</span> collector::PartialMarkSweep(<span class="keyword">this</span>, concurrent));</div><div class="line">          garbage_collectors_.push_back(<span class="keyword">new</span> collector::StickyMarkSweep(<span class="keyword">this</span>, concurrent));</div><div class="line">      &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (kMovingCollector) &#123;<span class="comment">//kMovingCollector=true</span></div><div class="line">      <span class="keyword">if</span> (MayUseCollector(kCollectorTypeSS) || MayUseCollector(kCollectorTypeGSS) ||</div><div class="line">                  MayUseCollector(kCollectorTypeHomogeneousSpaceCompact) ||</div><div class="line">                  use_homogeneous_space_compaction_for_oom_) &#123;</div><div class="line">        <span class="comment">//如果前后台回收器中某一个是SS,GSS,HomogeneousSpaceCompact三者其中一个或者</span></div><div class="line">        <span class="comment">//使用homogeneous space compaction来避免OOM时，再创键一个Semi-Space Collector</span></div><div class="line">        <span class="keyword">const</span> <span class="keyword">bool</span> generational = foreground_collector_type_ == kCollectorTypeGSS;</div><div class="line">        semi_space_collector_ = <span class="keyword">new</span> collector::SemiSpace(<span class="keyword">this</span>, generational,</div><div class="line">                                                               generational ? <span class="string">"generational"</span> : <span class="string">""</span>);</div><div class="line">        garbage_collectors_.push_back(semi_space_collector_);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (MayUseCollector(kCollectorTypeCC)) &#123;</div><div class="line">        <span class="comment">//如果前后台回收器中某一个是CC,再创建一个ConcurrentCopying Collector</span></div><div class="line">        concurrent_copying_collector_ = <span class="keyword">new</span> collector::ConcurrentCopying(<span class="keyword">this</span>);</div><div class="line">        garbage_collectors_.push_back(concurrent_copying_collector_);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (MayUseCollector(kCollectorTypeMC)) &#123;</div><div class="line">        <span class="comment">//如果前后台回收器中某一个是MarkCompact,再创建一个MarkCompact Collector</span></div><div class="line">        mark_compact_collector_ = <span class="keyword">new</span> collector::MarkCompact(<span class="keyword">this</span>);</div><div class="line">        garbage_collectors_.push_back(mark_compact_collector_);</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>如果有ImageSpace同时Non-Moving Space不为空同时满足三个条件(处于zygote，Non-Moving Space有独立地址，前台回收器是GSS)中的一个时，检查ImageSpace和Non-Moving Space之间没有内存空隙</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!GetBootImageSpaces().empty() &amp;&amp; non_moving_space_ != <span class="literal">nullptr</span> &amp;&amp;</div><div class="line">            (is_zygote || separate_non_moving_space || foreground_collector_type_ == kCollectorTypeGSS)) &#123;</div><div class="line">      <span class="comment">//如果有ImageSpace同时Non-Moving Space不为空同时满足三个条件</span></div><div class="line">      <span class="comment">//(处于zygote，Non-Moving Space有独立地址，前台回收器是GSS)中的一个时,</span></div><div class="line">      <span class="comment">//检查ImageSpace和Non-Moving Space只见没有内存空隙</span></div><div class="line">      space::ImageSpace* first_space = <span class="literal">nullptr</span>;</div><div class="line">      <span class="keyword">for</span> (space::ImageSpace* space : boot_image_spaces_) &#123;</div><div class="line">        <span class="keyword">if</span> (first_space == <span class="literal">nullptr</span> || space-&gt;Begin() &lt; first_space-&gt;Begin()) &#123;</div><div class="line">          first_space = space;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">bool</span> no_gap = MemMap::CheckNoGaps(first_space-&gt;GetMemMap(), non_moving_space_-&gt;GetMemMap());</div><div class="line">      <span class="keyword">if</span> (!no_gap) &#123;</div><div class="line">        PrintFileToLog(<span class="string">"/proc/self/maps"</span>, LogSeverity::ERROR);</div><div class="line">        MemMap::DumpMaps(LOG(ERROR), <span class="literal">true</span>);</div><div class="line">        ...</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">instrumentation::Instrumentation* <span class="keyword">const</span> instrumentation = runtime-&gt;GetInstrumentation();</div><div class="line"><span class="keyword">if</span> (gc_stress_mode_) &#123;</div><div class="line">      backtrace_lock_ = <span class="keyword">new</span> Mutex(<span class="string">"GC complete lock"</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (is_running_on_memory_tool_ || gc_stress_mode_) &#123;</div><div class="line">      instrumentation-&gt;InstrumentQuickAllocEntryPoints();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="三-总结"><a href="#三-总结" class="headerlink" title="三. 总结"></a>三. 总结</h2><h3 id="3-1-前台回收器是ConcurrentCopying"><a href="#3-1-前台回收器是ConcurrentCopying" class="headerlink" title="3.1 前台回收器是ConcurrentCopying"></a>3.1 前台回收器是ConcurrentCopying</h3><p>从代码逻辑看，如果<code>foreground_collector_type_=kCollectorTypeCC</code>时Heap的创建流程要跟其他回收器类型的创建流程不太相同：</p>
<ol>
<li><code>requested_alloc_space_begin = 300MB - non_moving_space_capacity</code></li>
<li>创建ImageSpace(只要image文件不为空，都会创建)，如果创建成功，<code>requested_alloc_space_begin=ImageSpace+boo.oat</code><blockquote>
<p>这一点所有回收器类型都一样，不同的是，如果创建失败，<code>requested_alloc_space_begin = 300MB - non_moving_space_capacity</code>, 其他回收器类型则是<code>requested_alloc_space_begin = nullptr</code></p>
</blockquote>
</li>
<li>如果<code>background_collector_type_ != kCollectorTypeHomogeneousSpaceCompact</code>,则不支持<code>Homogeneous-Space-Compact</code></li>
<li>由于是<code>CC</code>回收器，所以<strong>必然会给Non-Moving Space独立的地址</strong></li>
<li><p>由于是<code>CC</code>回收器，所以即使ImageSpace创建失败，<code>requested_alloc_space_begin</code>也不会为<code>nullptr</code>,又因为Non-Moving Space有独立的地址，所以最后<code>request_begin=requested_alloc_space_begin + non_moving_space_capacity</code></p>
<blockquote>
<p>如果ImageSpace创建成功，<code>request_begin=ImageSpace+boot.oat+non_moving_space_capacity</code>;如果创建失败，<code>request_begin = 300MB-non_moving_space_capacity+non_moving_space_capacity</code>-&gt;<code>request_begin=300MB</code></p>
</blockquote>
</li>
<li><p>紧跟着<code>requested_alloc_space_begin</code>创建用于Non-Moving Space的匿名内存映射<code>non_moving_space_mem_map</code>, 将<code>request_begin</code>固定在300MB的地址(<code>request_begin=reinterpret_cast&lt;uint8_t*&gt;(300*MB)</code>)；之后将匿名内存映射封装成Non-Moving Space，如果在Zygote中，就叫<code>ZygoteSpace</code>,否则叫<code>Non-Moving Space</code></p>
</li>
<li>由于是<code>CC</code>回收器,所以不会创建两块匿名内存<code>main_mem_map_1,main_mem_map_2</code>,而是紧跟着在<code>request_begin</code>后(即300MB,因为之前已经将<code>request_begin</code>固定在这个地址)直接创建<code>RegionSpace</code></li>
<li>创建<code>LargeObjectSpace</code></li>
<li>如果<code>kUseTableLookupReadBarrier=true</code>，创建<code>ReadBarrierTable</code></li>
<li>创建<code>CardTable</code>,<code>ModUnionTable</code>(如果ImageSpace创建成功),如果<code>collector::SemiSpace::kUseRememberedSet == true</code>创建<code>RememberedSet</code>;创建<code>allocation_stack_,mark_stack_,live_stack_</code>;创建锁;创建<code>TaskProcessor,ReferenceProcessor</code></li>
<li>由于是<code>CC</code>回收器,创建<code>collector::ConcurrentCopying</code>并添加至<code>garbage_collectors_</code></li>
<li>如果ImageSpace创建成功，且Non-Moving Space不为空，检查ImageSpace和Non-Moving Space之间有没有内存间隙<blockquote>
<p>因为是<code>CC</code>,所以Non-Moving Space必然有独立地址，所以只需要判断ImageSpace创建成功和Non-Moving Space不为空</p>
</blockquote>
</li>
</ol>
<h3 id="3-2-前台回收器是GSS"><a href="#3-2-前台回收器是GSS" class="headerlink" title="3.2 前台回收器是GSS"></a>3.2 前台回收器是GSS</h3><p>GSS(Generational Semi-Space)是另一个较为特殊的回收器类型</p>
<ol>
<li><code>requested_alloc_space_begin=nullptr</code></li>
<li>创建ImageSpace，如果成功，<code>requested_alloc_space_begin=ImageSpace+boot.oat</code>,如果创建失败,<code>requested_alloc_space_begin=nullptr</code></li>
<li>如果<code>background_collector_type_ != kCollectorTypeHomogeneousSpaceCompact</code>，则肯定不支持Homogeneous-Space-Compact</li>
<li>由于是<code>GSS</code>回收器,所以不会给Non-Moving Space独立的地址(<strong>这一点很重要,即不会创建Non-Moving Space的匿名内存映射</strong>)</li>
<li>如果ImageSpace创建失败，则<code>request_begin=requested_alloc_space_begin=nullptr</code>;如果创建成功,则<code>request_begin=reuqest_alloc_space_begin=ImageSpace+boo.oat</code></li>
<li>由于是<code>GSS</code>回收器,那么Non-Moving Space不会有独立地址，如果此时处于Zygote中，则紧跟ImageSpace+boo.oat创建匿名内存映射<code>main_mem_map_1</code>(<strong>因为Non-Moving Space没有独立地址，所以不会将request_begin固定在300MB,又因为如果ImageSpace创建成功此时request_begin=ImageSpace+boot.oat</strong>)</li>
<li>如果<code>background_collector_type_ == kCollectorTypeHomogeneousSpaceCompact</code>，则会紧跟着<code>main_mem_map_1</code>再创建第二块匿名内存映射<code>main_mem_map_2</code>,否则不会创建<code>main_mem_map_2</code></li>
<li>将<code>main_mem_map_1</code>封装成<code>Main Space</code>,由于是<code>GSS</code>回收器，所以将<code>non_moving_space_</code>也指向<code>Main Space</code></li>
<li>由于是<code>GSS</code>回收器,调用<code>space::BumpPointerSpace::Create</code>直接创建<code>BumpPointerSpace1</code>和<code>BumpPointerSpace2</code></li>
<li>创建<code>LargeObjectSpace</code></li>
<li>创建<code>CardTable</code>,<code>ModUnionTable</code>(如果ImageSpace创建成功),由于是<code>GSS</code>回收器，所以<code>non_moving_space_ == main_space_</code>,所以不会创建<code>RememberedSet</code>;创建<code>allocation_stack_,mark_stack_,live_stack_</code>;创建锁;创建<code>TaskProcessor,ReferenceProcessor</code></li>
<li>由于是<code>GSS</code>,所以创建<code>collector::SemiSpace</code>,其中<code>generational_ = true</code></li>
<li>如果ImageSpace创建成功，且<code>MainSpace</code>不为空，检查ImageSpace和Non-Moving Space之间有没有内存间隙<blockquote>
<p>因为是<code>GSS</code>,所以<code>non_moving_space_</code>指向<code>MainSpace</code>,所以只需要判断ImageSpace创建成功和Non-Moving Space不为空</p>
</blockquote>
</li>
</ol>
<h3 id="3-3-Moving-GC-Semi-Space-MarkCompact-HomogeneousSpaceCompact"><a href="#3-3-Moving-GC-Semi-Space-MarkCompact-HomogeneousSpaceCompact" class="headerlink" title="3.3 Moving GC(Semi-Space, MarkCompact, HomogeneousSpaceCompact)"></a>3.3 Moving GC(Semi-Space, MarkCompact, HomogeneousSpaceCompact)</h3><ol>
<li><code>requested_alloc_space_begin=nullptr</code></li>
<li>创建ImageSpace，如果成功，<code>requested_alloc_space_begin=ImageSpace+boot.oat</code>,如果创建失败,<code>requested_alloc_space_begin=nullptr</code></li>
<li>由于不是<code>GSS</code>和<code>CC</code>，所以只要传入的<code>use_homogeneous_space_compaction==true</code>或者<code>background_collector_type_ == kCollectorTypeHomogeneousSpaceCompact</code>时会支持Homogeneous-Space-Compact</li>
<li>Non-Moving<strong>必然有独立的地址</strong></li>
<li>如果ImageSpace创建成功，<code>request_begin = requested_alloc_space_begin + non_moving_space_capacity</code>,否则<code>request_begin=nullptr</code></li>
<li>创建Non-Moving Space使用的匿名内存映射<code>non_moving_space_mem_map</code>,将<code>request_begin</code>固定在300MB的地址(<code>request_begin=reinterpret_cast&lt;uint8_t*&gt;(300*MB)</code>)</li>
<li>紧跟<code>request_begin</code>创建匿名内存映射<code>main_mem_map_1</code></li>
<li>如果支持Homogeneous-Space-Compact或者前后台回收器有一个是<code>Semi-Space</code>,则紧跟<code>main_mem_map_1</code>创建第二块匿名内存映射<code>main_mem_map_2</code></li>
<li>将<code>non_moving_space_mem_map</code>封装成<code>Non-Moving Space</code>,由<code>non_moving_space_</code>指向</li>
<li>将<code>main_mem_map_1</code>封装成<code>BumpPointerSpace1</code>，将<code>main_mem_map_2</code>封装成<code>BumpPointerSpace2</code></li>
<li>创建<code>LargeObjectSpace</code></li>
<li>创建<code>CardTable</code>,<code>ModUnionTable</code>(如果ImageSpace创建成功),如果<code>collector::SemiSpace::kUseRememberedSet == true</code>创建<code>RememberedSet</code>;创建<code>allocation_stack_,mark_stack_,live_stack_</code>;创建锁;创建<code>TaskProcessor,ReferenceProcessor</code></li>
<li>如果前后台回收器中有一个是<code>SS</code>或<code>Homogeneous-Space-Compact</code>，创建<code>collector::SemiSpace</code>;如果前后台回收器有一个是<code>MarkCompact</code>,则创建<code>collector::MarkCompact</code></li>
<li>如果ImageSpace创建成功，且Non-Moving Space不为空，检查ImageSpace和Non-Moving Space之间有没有内存间隙<blockquote>
<p>因为Non-Moving必然有独立的地址,所以只需要判断ImageSpace创建成功和Non-Moving Space不为空</p>
</blockquote>
</li>
</ol>
<h3 id="3-4-前台回收器MarkSweep或Concurrent-MarkSweep"><a href="#3-4-前台回收器MarkSweep或Concurrent-MarkSweep" class="headerlink" title="3.4 前台回收器MarkSweep或Concurrent MarkSweep"></a>3.4 前台回收器MarkSweep或Concurrent MarkSweep</h3><ol>
<li><code>requested_alloc_space_begin=nullptr</code></li>
<li>创建ImageSpace，如果成功，<code>requested_alloc_space_begin=ImageSpace+boot.oat</code>,如果创建失败,<code>requested_alloc_space_begin=nullptr</code></li>
<li>由于不是<code>GSS</code>和<code>CC</code>，所以只要传入的<code>use_homogeneous_space_compaction=true</code>或者<code>background_collector_type_ == kCollectorTypeHomogeneousSpaceCompact</code>时会支持Homogeneous-Space-Compact</li>
<li>只要当前处于Zygote当中，则Non-Moving Space必然有独立地址，否则得看是否支持Homogeneous-Space-Compact,支持的话，就有独立地址，不支持就没有</li>
<li>如果ImageSpace创建失败且<code>foreground_collector_type_=kCollectorTypeMS</code>同时当前处于dex2oat,<code>requested_alloc_space_begin=kAllocSpaceBeginForDeterministicAoT</code></li>
<li>如果ImageSpace创建成功且如果Non-Moving Space有独立地址的话，创建Non-Moving Space要用到的匿名内存映射<code>non_moving_space_mem_map</code>,将<code>request_begin</code>固定在300MB的地址(<code>request_begin=reinterpret_cast&lt;uint8_t*&gt;(300*MB)</code>)</li>
<li>如果Non-Moving Space有独立地址或者当前不在Zygote中,紧跟着<code>request_begin</code>(300MB)创建匿名内存映射<code>main_mem_map_1</code>;如果Non-Moving Space没有独立地址同时处于Zygote中，则紧跟着ImageSpace_boot.oat创建匿名内存映射<code>main_mem_map_1</code></li>
<li>如果支持Homogeneous-Space-Compact,紧跟着<code>main_mem_map_1</code>创建第二块匿名内存映射<code>main_mem_map_2</code>,否则不创建<code>main_mem_map_2</code></li>
<li>如果Non-Moving Space有独立地址，将<code>non_moving_space_mem_map</code>封装成<code>Non-Moving Space</code></li>
<li>将<code>main_mem_map_1</code>封装成<code>Main Space</code>,如果Non-Moving Space没有独立地址，则将<code>non_moving_space_</code>也指向<code>MainSpace</code></li>
<li>如果之前创建了<code>main_mem_map_2</code>,则将<code>main_mem_map_2</code>封装成<code>Main Backup Space</code></li>
<li>创建<code>LargeObjectSpace</code></li>
<li>移除<code>Main Backup Space</code></li>
<li>创建<code>CardTable</code>,<code>ModUnionTable</code>(如果ImageSpace创建成功),如果Non-Moving Space有独立地址，创建<code>RememberedSet</code>，否则不创建；创建<code>allocation_stack_,mark_stack_,live_stack_</code>;创建锁;创建<code>TaskProcessor,ReferenceProcessor</code></li>
<li>创建一组回收器，里面有三个回收器分别是<code>MarkSweep, PartialMarkSweep, StickyMarkSweep</code>,如果是<code>Concurrent Mark Compact</code>，则这一组回收器是支持并行GC的；如果是<code>MarkSweep</code>,则这一组不支持并行GC</li>
<li>如果ImageSpace创建成功且Non-Moving Space不为空同时满足：处于Zygote或者Non-Moving Space有独立地址时，检查ImageSpace和Non-Moving Space之间有没有内存间隙<blockquote>
<p>因为Non-Moving Space有没有独立地址不确定，需要视条件而定</p>
</blockquote>
</li>
</ol>
<h2 id="四-参考资料"><a href="#四-参考资料" class="headerlink" title="四. 参考资料"></a>四. 参考资料</h2><ol>
<li><a href="http://blog.csdn.net/luoshengyang/article/details/42072975" target="_blank" rel="external">ART运行时垃圾收集机制简要介绍和学习计划</a></li>
<li><a href="https://source.android.com/devices/tech/dalvik/gc-debug.html" target="_blank" rel="external">Debugging ART Garbage Collection</a></li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/ART-Runtime-创建-二-启动参数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/ART-Runtime-创建-二-启动参数/" itemprop="url">ART Runtime 创建(二)--启动参数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T14:53:34+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ART/" itemprop="url" rel="index">
                    <span itemprop="name">ART</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Android 7.0 aosp_shamu-userdebug</p>
</blockquote>
<h2 id="一-启动时获取的参数"><a href="#一-启动时获取的参数" class="headerlink" title="一. 启动时获取的参数"></a>一. 启动时获取的参数</h2><p><code>AndroidRuntime::startVm</code>(<code>/framework/bae/cpre/jni/AndroidRuntime.cpp</code>)方法会首先获取大量系统属性,并将这些系统属性转化为实际的启动参数,下面是获取的系统属性以及对应的启动参数:</p>
<ul>
<li><p>dalvik.vm.checkjni(ro.kernel.android.checkjni)</p>
<blockquote>
<p>真实值:无<br>默认为false, 如果为true, 则添加参数<code>-Xcheck:jni</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.execution-mode</p>
<blockquote>
<p>真实值:无<br>默认为KEMDefault, 有四个取值:<code>KEMDefault, kEMIntPortable, kEMIntFast, kEMJitCompiler</code>. 如果不是<code>kEMDefault</code>,则相应的参数为:<code>-Xint:portable</code>, <code>-Xint:fast</code>, <code>-Xint:jit</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.stack-trace-file</p>
<blockquote>
<p>真实值:<code>/data/anr/traces.txt</code><br>参数的形式为:<code>-Xstacktracefile:/data/anr/traces.txt</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.jniopts</p>
<blockquote>
<p>真实值:没有设置<br>如果有设置的话,参数形式为:<code>Xjnipots:...</code></p>
</blockquote>
</li>
<li><p>{exit, runtime_exit}</p>
<blockquote>
<p>Hook Runtime的<code>exit()</code>为<code>runtime_exit(int code)</code>函数</p>
</blockquote>
</li>
<li><p>{vfprintf, runtime_vfprintf}</p>
<blockquote>
<p>Hook Runtime的<code>fprintf()</code>为<code>runtime_vfprintf(FILE* fp, const char* format, va_list ap)</code>函数</p>
</blockquote>
</li>
<li><p>{sensitiveThread, runtime_isSensitiveThread()}</p>
<blockquote>
<p>Hook Runtime的<code>sensitiveThread()</code>为<code>runtime_isSensitiveThread()</code>函数</p>
</blockquote>
</li>
<li><p>直接添加参数<code>-verbose:gc</code></p>
</li>
<li><p>dalvik.vm.heapstartsize</p>
<blockquote>
<p>真实值:<code>8m</code><br>参数的形式为:<code>-Xms8m</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.heapsize</p>
<blockquote>
<p>真实值:<code>512m</code><br>参数的形式为:<code>-Xmx512m</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.heapgrowthlimit</p>
<blockquote>
<p>真实值:<code>256m</code><br>参数形式为:<code>-XX:HeapGrowthLimit=256m</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.heapminfree</p>
<blockquote>
<p>真实值:<code>512k</code>,<br>参数形式为:<code>-XX:HeapMinFree=512k</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.heapmaxfree</p>
<blockquote>
<p>真实值:<code>8m</code><br>参数形式为:<code>-XX:HeapMaxFree=8m</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.heaputilization</p>
<blockquote>
<p>真实值:<code>0.75</code><br>参数形式为:<code>-XX:HeapTargetUtilization=0.75</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.usejit</p>
<blockquote>
<p>真实值:<code>true</code><br>参数形式为:<code>-Xusejit:true</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.jitmaxsize</p>
<blockquote>
<p>真实值是:无<br>如果设置则参数形式为:<code>-Xjitmaxsize:${dalvik.vm.jitmaxsize}</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.jitinitialize</p>
<blockquote>
<p>真实值:无,<br>如果设置参数形式为:<code>-Xjitinitialize:${dalvik.vm.jitinitialize}</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.jitthreshold</p>
<blockquote>
<p>真实值:无<br>如果设置参数形式为:<code>-Xjitthreshold:..</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.usejitprofiles</p>
<blockquote>
<p>真实值:<code>true</code>,<br>参数形式为:<code>-Xjitsaveprofilinginfo</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.jitprithreadweight</p>
<blockquote>
<p>真实值:无<br>如果设置,参数的形式为:<code>-Xjitprithreadweight</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.jittransitionweight</p>
<blockquote>
<p>真实值:无<br>如果设置,参数的形式为:<code>-Xjittransitionweight:${dalvik.vm.jittransitionweight}</code></p>
</blockquote>
</li>
<li><p>ro.config.low_ram</p>
<blockquote>
<p>真实值:无<br>如果设置,参数形式为:<code>-XXLowMemoryMode</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.gctype</p>
<blockquote>
<p>真实值:无<br>如果设置,参数形式为:<code>-Xgc:${dalvik.vm.gctype}</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.backgroundgctype  </p>
<blockquote>
<p>真实值:无<br>如果设置,参数形式为:<code>-XX:BackgroundGC=${dalvik.vm.backgroundgctype}</code></p>
</blockquote>
</li>
<li><p>直接添加参数<code>-agentlib:jdwp=transport=dt_android_adb,suspend=n,server=y</code></p>
</li>
<li><p>dalvik.vm.lockprof.threshold</p>
<blockquote>
<p>真实值:<code>500</code><br>参数形式为:<code>-Xlockprofthreshold:500</code></p>
</blockquote>
</li>
<li><p>vold.decrypt</p>
<blockquote>
<p><code>trigger_restart_framework</code><br>因为不等于<code>trigfer_restart_min_framework</code>和<code>1</code>,所以还要获取属性<code>dalvik.vm.image-dex2oat-filter</code>, 系统中并未设置该值,如果设置了,参数的形式为:<code>--compiler-filter=${dalvik.vm.image-dex2oat-filter}, -Ximage-compiler-option</code></p>
</blockquote>
</li>
<li><p>直接添加参数<code>Ximage-compiler-option</code></p>
</li>
<li>直接添加参数<code>--compiled-classes=/system/etc/preloaded-classes</code></li>
<li><p>如果文件<code>/system/etc/compiled-classes</code>存在(实际存在),则添加参数:<code>-Ximage-compiler-option</code>, <code>--compiled-classes=/system/etc/compiled-classes</code></p>
</li>
<li><p>dalvik.vm.imgae-dex2oat-flags</p>
<blockquote>
<p>真实值:无<br>如果设置,参数形式为:<code>-Ximage-compile-option</code>, <code>${image-dex2oat-flags}</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.dex2oat-Xms</p>
<blockquote>
<p>真实值:<code>64m</code><br>参数形式为:<code>-Xcompiler-option</code>, <code>--runtime-arg</code>, <code>-Xcompiler-option</code>, <code>-Xms64m</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.dex2oat-Xmx</p>
<blockquote>
<p>真实值:<code>512m</code><br>参数形式为:<code>-Xcompiler-option</code>, <code>--runtime-arg</code>, <code>-Xcompiler-option</code>, <code>-Xms512m</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.dex2oat-filter</p>
<blockquote>
<p>真实值:无<br>如果设置了,参数的形式为:<code>-Xcompiler-option</code>, <code>--runtime-arg</code>, <code>-Xcompiler-option</code>, <code>--compiler-filter=${dalvik.vm.dex2oat-filter}</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.dex2oat-threads</p>
<blockquote>
<p>真实值:无<br>如果设置了,参数形式为:<code>-Xcompiler-option</code>, <code>--runtime-arg</code>, <code>-Xcompiler-option</code>, <code>-j${dalvik.vm.dex2oat-threads}</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.image-dex2oat-threads</p>
<blockquote>
<p>真实值:无<br>如果设置了,参数形式为:<code>-Ximage-compiler-option</code>, <code>--runtime-arg</code>, <code>-Ximage-compiler-option</code>, <code>-j${dalvik.vm.image-dex2oat-threads}</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.isa.arm.variant</p>
<blockquote>
<p>真实值:<code>krait</code><br>参数最终形式为:<code>-Ximage-compiler-option</code>, <code>--runtime-arg</code>, <code>-Ximage-compiler-option</code>, <code>--instruction-set-variant=krait</code> , <code>-Xcompiler-option</code>, <code>--runtime-arg</code>, <code>-Xcompiler-option</code>, <code>--instruction-set-variant=krait</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.isa.arm.features</p>
<blockquote>
<p>真实值:<code>default</code><br>参数形式为:<code>-Ximage-compiler-option</code>, <code>--runtime-arg</code>, <code>-Ximage-compiler-option</code>, <code>--instruction-set-features=default</code>, <code>-Xcompiler-option</code>, <code>--runtime-arg</code>, <code>-Xcompiler-option</code>, <code>instruction-set-variant-features=default</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.dex2oat-flags</p>
<blockquote>
<p>真实值:无<br>如果设置,参数形式为:<code>-Xcompiler-option</code>, <code>[dex2oat-flags]</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.extra-opts</p>
<blockquote>
<p>真实值:无<br>如果设置,参数形式为:<code>[extra-opts]</code></p>
</blockquote>
</li>
<li><p>读取Locale,然后添加参数<code>-Duser.locale=zh-Hans-CN</code></p>
</li>
<li><p>ro.debuggable</p>
<blockquote>
<p>真实值:<code>1</code>,<br>如果<code>ro.debuggable=1</code>同时<code>dalvik.vm.method-trace=true</code>(实际为false),则添加参数<code>-Xmethod-trace</code>, <code>-Xmethod-trace-file:[dalvik.vm.method-trace-file]</code>, <code>-Xmethod-trace-file-size:[dalvik.vm.method-trace-file-siz]</code>, 如果<code>dalvik.vm.method-trace-stream=true</code>, 添加参数<code>-Xmethod-trace-stream</code>(实际都没有添加)</p>
</blockquote>
</li>
<li><p>ro.dalvik.vm.native.bridge</p>
<blockquote>
<p>真实值:<code>0</code><br>如果值不为0, 则参数为:<code>-XX:NativeBridge=[ro.dalvik.vm.native.bridge]</code></p>
</blockquote>
</li>
<li><p>ro.product.cpu.abilist32</p>
<blockquote>
<p>真实值:<code>[armeabi-v7a,armeabi]</code><br>参数形式为:<code>--cpu-abilist=[armeabi-v7a,armeabi]</code></p>
</blockquote>
</li>
<li><p>dalvik.vm.zygote.max-boot-retry</p>
<blockquote>
<p>真实值:无<br>如果设置, 最终形式为:<code>-Xzygote-max-boot-retry=[dalvik.vm.zygote.max-boot-retry]</code></p>
</blockquote>
</li>
<li><p>debug.generate-debug-info</p>
<blockquote>
<p>真实值:无<br>如果值为<code>true</code>, 添加参数:<code>-Xcompiler-option</code>, <code>--generate-debug-info</code>, <code>-Ximage-compiler-option</code>, <code>--generate-debug-info</code></p>
</blockquote>
</li>
<li><p>ro.build.fingerprint</p>
<blockquote>
<p>真实值:<code>Android/aosp_shamu/shamu:7.0/NBD91U/xx12231922:userdebug/test-keys</code><br>参数形式为:<code>-Xfingerprint:Android/aosp_shamu/shamu:7.0/NBD91U/xx12231922:userdebug/test-keys</code></p>
</blockquote>
</li>
</ul>
<h2 id="二-实际传入的参数"><a href="#二-实际传入的参数" class="headerlink" title="二. 实际传入的参数"></a>二. 实际传入的参数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &#123;`-Xstacktracefile:/data/anr/traces.txt`, NULL&#125;, //&#123;optionString, extraInfo&#125;</div><div class="line">  &#123;`exit`, runtime_exit&#125;,</div><div class="line">  &#123;`vfprintf`, `runtime_vfprintf`&#125;,</div><div class="line">  &#123;`sensitiveThread`, `runtime_isSensitiveThread`&#125;,</div><div class="line">  &#123;`-verbose:gc`, NULL&#125;,</div><div class="line">  &#123;`-Xms8m`, NULL&#125;,</div><div class="line">  &#123;`-Xmx512m`, NULL&#125;,</div><div class="line">  &#123;`-XX:HeapGrowthLimit=256m`,NULL&#125;,</div><div class="line">  &#123;`-XX:HeapMinFree=512k`, NULL&#125;,</div><div class="line">  &#123;`-XX:HeapMaxFree=8m`,NULL&#125;,</div><div class="line">  &#123;`-XX:HeapTargetUtilization=0.75`,NULL&#125;,</div><div class="line">  &#123;`-Xusejit:true`, NULL&#125;,</div><div class="line">  &#123;`-Xjitsaveprofilinginfo`,NULL&#125;,</div><div class="line">  &#123;`-agentlib:jdwp=transport=dt_android_adb,suspend=n,server=y`, NULL&#125;,</div><div class="line">  &#123;`-Xlockprofthreshold:500`,NULL&#125;,</div><div class="line">  &#123;`-Ximage-compiler-option`,NULL&#125;,</div><div class="line">  &#123;`--compiled-classes=/system/etc/preloaded-classes`,NULL&#125;,</div><div class="line">  &#123;`-Ximage-compiler-option`,NULL&#125;,</div><div class="line">  &#123;`--compiled-classes=/system/etc/compiled-classes`,NULL&#125;,</div><div class="line">  &#123;`-Xcompiler-option`,NULL&#125;,</div><div class="line">  &#123;`--runtime-arg`,NULL&#125;,</div><div class="line">  &#123;`-Xcompiler-option`,NULL&#125;,</div><div class="line">  &#123;`-Xms64m`,NULL&#125;,</div><div class="line">  &#123;`-Xcompiler-option`,NULL&#125;,</div><div class="line">  &#123;`--runtime-arg`,NULL&#125;,</div><div class="line">  &#123;`-Xcompiler-option`,NULL&#125;,</div><div class="line">  &#123;`-Xmx512m`,NULL&#125;,</div><div class="line">  &#123;`-Ximage-compiler-option`,NULL&#125;,</div><div class="line">  &#123;`--runtime-arg`,NULL&#125;,</div><div class="line">  &#123;`-Ximage-compiler-option`,NULL&#125;,</div><div class="line">  &#123;`--instruction-set-variant=krait`,NULL&#125;,</div><div class="line">  &#123;`-Xcompiler-option`,NULL&#125;,</div><div class="line">  &#123;`--runtime-arg`,NULL&#125;,</div><div class="line">  &#123;`-Xcompiler-option`,NULL&#125;,</div><div class="line">  &#123;`--instruction-set-variant=krait`,NULL&#125;,</div><div class="line">  &#123;`-Ximage-compiler-option`,NULL&#125;,</div><div class="line">  &#123;`--runtime-arg`,NULL&#125;,</div><div class="line">  &#123;`-Ximage-compiler-option`,NULL&#125;,</div><div class="line">  &#123;`--instruction-set-features=default`,NULL&#125;,</div><div class="line">  &#123;`-Xcompiler-option`,NULL&#125;,</div><div class="line">  &#123;`--runtime-arg`,NULL&#125;,</div><div class="line">  &#123;`-Xcompiler-option`,NULL&#125;,</div><div class="line">  &#123;`--instruction-set-features=default`,NULL&#125;,</div><div class="line">  &#123;`-Duser.locale=zh-Hans-CN`,NULL&#125;,</div><div class="line">  &#123;`--cpu-abilist=[armeabi-v7a,armeabi]`,NULL&#125;,</div><div class="line">  &#123;`-Xfingerprint:Android/aosp_shamu/shamu:7.0/NBD91U/xx12231922:userdebug/test-keys`, NULL&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="三-存储参数的数据结构和方法"><a href="#三-存储参数的数据结构和方法" class="headerlink" title="三. 存储参数的数据结构和方法"></a>三. 存储参数的数据结构和方法</h2><h3 id="3-1-存储参数的数据结构"><a href="#3-1-存储参数的数据结构" class="headerlink" title="3.1 存储参数的数据结构"></a>3.1 存储参数的数据结构</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">JavaVMInitArgs</span> &#123;</span></div><div class="line">  jint          version;</div><div class="line">  jint          nOptions;</div><div class="line">  JavaVMOption* options;</div><div class="line">  jboolean      ignoreUnrecognized</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">JavaVMOption</span> &#123;</span></div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* optionString;</div><div class="line">  <span class="keyword">void</span>*       extractInfo;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::<span class="built_in">string</span>, <span class="keyword">const</span> <span class="keyword">void</span>*&gt;&gt; RuntimeOptions</div></pre></td></tr></table></figure>
<h3 id="3-2-最终传入的数据结构"><a href="#3-2-最终传入的数据结构" class="headerlink" title="3.2 最终传入的数据结构"></a>3.2 最终传入的数据结构</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">JavaVMInitArgs initArgs;</div><div class="line">initArgs.version = JNI_VERSION_1_4;</div><div class="line">initArgs.options = mOptions.editArray();</div><div class="line">initArgs.nOptions = mOptions.size();</div><div class="line">initArgs.ignoreUnrecognized = JNI_FALSE;</div></pre></td></tr></table></figure>
<h3 id="3-3-添加参数的方法"><a href="#3-3-添加参数的方法" class="headerlink" title="3.3 添加参数的方法"></a>3.3 添加参数的方法</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> AndroidRuntime::addOption(<span class="keyword">const</span> <span class="keyword">char</span>* optionString, <span class="keyword">void</span>* extraInfo)</div><div class="line">&#123;</div><div class="line">    JavaVMOption opt;</div><div class="line">    opt.optionString = optionString;</div><div class="line">    opt.extraInfo = extraInfo;</div><div class="line">    mOptions.add(opt);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="四-解析参数流程"><a href="#四-解析参数流程" class="headerlink" title="四. 解析参数流程"></a>四. 解析参数流程</h2><h3 id="4-1-JNI-CreateJavaVM"><a href="#4-1-JNI-CreateJavaVM" class="headerlink" title="4.1 JNI_CreateJavaVM"></a>4.1 JNI_CreateJavaVM</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="function">jint <span class="title">JNI_CreateJavaVM</span><span class="params">(JavaVM** p_vm, JNIEnv** p_env, <span class="keyword">void</span>* vm_args)</span> </span>&#123;</div><div class="line">  <span class="keyword">const</span> JavaVMInitArgs* args = <span class="keyword">static_cast</span>&lt;JavaVMInitArgs*&gt;(vm_args);</div><div class="line">  ...</div><div class="line">  RuntimeOptions options;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args-&gt;nOptions; ++i) &#123;</div><div class="line">      JavaVMOption* option = &amp;args-&gt;options[i];</div><div class="line">      options.push_back(<span class="built_in">std</span>::make_pair(<span class="built_in">std</span>::<span class="built_in">string</span>(option-&gt;optionString), option-&gt;extraInfo));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">bool</span> ignore_unrecognized = args-&gt;ignoreUnrecognized;</div><div class="line">  <span class="keyword">if</span> (!Runtime::Create(options, ignore_unrecognized)) &#123;</div><div class="line">      <span class="keyword">return</span> JNI_ERR;</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-2-Runtime-Create"><a href="#4-2-Runtime-Create" class="headerlink" title="4.2 Runtime::Create()"></a>4.2 Runtime::Create()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> Runtime::Create(<span class="keyword">const</span> RuntimeOptions&amp; raw_options, <span class="keyword">bool</span> ignore_unrecognized) &#123;</div><div class="line">  RuntimeArgumentMap runtime_options;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> ParseOptions(raw_options, ignore_unrecognized, &amp;runtime_options) &amp;&amp;</div><div class="line">      Create(<span class="built_in">std</span>::move(runtime_options));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-3-Runtime-ParseOptions"><a href="#4-3-Runtime-ParseOptions" class="headerlink" title="4.3 Runtime::ParseOptions"></a>4.3 Runtime::ParseOptions</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> Runtime::ParseOptions(<span class="keyword">const</span> RuntimeOptions&amp; raw_options,</div><div class="line">                           <span class="keyword">bool</span> ignore_unrecognized,</div><div class="line">                           RuntimeArgumentMap* runtime_options) &#123;</div><div class="line">  InitLogging(<span class="comment">/* argv */</span> <span class="literal">nullptr</span>);  </div><div class="line">  <span class="keyword">bool</span> parsed = ParsedOptions::Parse(raw_options, ignore_unrecognized, runtime_options);</div><div class="line">  <span class="keyword">if</span> (!parsed) &#123;</div><div class="line">    LOG(ERROR) &lt;&lt; <span class="string">"Failed to parse options"</span>;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-4-ParsedOptions-Parse"><a href="#4-4-ParsedOptions-Parse" class="headerlink" title="4.4 ParsedOptions::Parse"></a>4.4 ParsedOptions::Parse</h3><p>位于/art/runtime/parsed_options.cc<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> ParsedOptions::Parse(<span class="keyword">const</span> RuntimeOptions&amp; options,</div><div class="line">                          <span class="keyword">bool</span> ignore_unrecognized,</div><div class="line">                          RuntimeArgumentMap* runtime_options) &#123;</div><div class="line">  CHECK(runtime_options != <span class="literal">nullptr</span>);</div><div class="line">  ParsedOptions parser;</div><div class="line">  <span class="keyword">return</span> parser.DoParse(options, ignore_unrecognized, runtime_options);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="4-5-ParsedOptions-DoParse"><a href="#4-5-ParsedOptions-DoParse" class="headerlink" title="4.5 ParsedOptions::DoParse"></a>4.5 ParsedOptions::DoParse</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> ParsedOptions::DoParse(<span class="keyword">const</span> RuntimeOptions&amp; options,</div><div class="line">                            <span class="keyword">bool</span> ignore_unrecognized,</div><div class="line">                            RuntimeArgumentMap* runtime_options) &#123;</div><div class="line">  ...</div><div class="line">  <span class="comment">//将字符串参数生成对应的M::key结构</span></div><div class="line">  <span class="keyword">auto</span> parser = MakeParser(ignore_unrecognized);</div><div class="line"></div><div class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; argv_list;</div><div class="line">  <span class="comment">//解析带有extraOption的参数, [5.2]</span></div><div class="line">  <span class="keyword">if</span> (!ProcessSpecialOptions(options, <span class="literal">nullptr</span>, &amp;argv_list)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  CmdlineResult parse_result = parser-&gt;Parse(argv_list);</div><div class="line"></div><div class="line">  <span class="comment">// 处理parse errors</span></div><div class="line">  <span class="keyword">if</span> (parse_result.IsError()) &#123;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">using</span> M = RuntimeArgumentMap;</div><div class="line">  RuntimeArgumentMap args = parser-&gt;ReleaseArgumentsMap();</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (args.Exists(M::Help)) &#123;</div><div class="line">    <span class="comment">//-help</span></div><div class="line">    Usage(<span class="literal">nullptr</span>);</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args.Exists(M::ShowVersion)) &#123;</div><div class="line">    <span class="comment">//-showversion</span></div><div class="line">    UsageMessage(<span class="built_in">stdout</span>, <span class="string">"ART version %s\n"</span>, Runtime::GetVersion());</div><div class="line">    Exit(<span class="number">0</span>);</div><div class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (args.Exists(M::BootClassPath)) &#123;</div><div class="line">    <span class="comment">//-Xbootclasspath</span></div><div class="line">    LOG(INFO) &lt;&lt; <span class="string">"setting boot class path to "</span> &lt;&lt; *args.Get(M::BootClassPath);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//-Xusejit和-Xint不能同时使用</span></div><div class="line">  <span class="keyword">if</span> (args.GetOrDefault(M::UseJitCompilation) &amp;&amp; args.GetOrDefault(M::Interpret)) &#123;</div><div class="line">    Usage(<span class="string">"-Xusejit:true and -Xint cannot be specified together"</span>);</div><div class="line">    Exit(<span class="number">0</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//获取默认的bootclasspath</span></div><div class="line">  <span class="keyword">if</span> (getenv(<span class="string">"BOOTCLASSPATH"</span>) != <span class="literal">nullptr</span>) &#123;</div><div class="line">    args.SetIfMissing(M::BootClassPath, <span class="built_in">std</span>::<span class="built_in">string</span>(getenv(<span class="string">"BOOTCLASSPATH"</span>)));</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//获取默认的classpath</span></div><div class="line">  <span class="keyword">if</span> (getenv(<span class="string">"CLASSPATH"</span>) != <span class="literal">nullptr</span>) &#123;</div><div class="line">    args.SetIfMissing(M::ClassPath, <span class="built_in">std</span>::<span class="built_in">string</span>(getenv(<span class="string">"CLASSPATH"</span>)));</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//设置参数-XX:ParallelGCThreads=0u</span></div><div class="line">  <span class="comment">//kDefaultEnableParallelGC=false</span></div><div class="line">  args.SetIfMissing(M::ParallelGCThreads, gc::Heap::kDefaultEnableParallelGC ?</div><div class="line">      <span class="keyword">static_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(sysconf(_SC_NPROCESSORS_CONF) - <span class="number">1u</span>) : <span class="number">0u</span>);</div><div class="line"></div><div class="line">  <span class="comment">// -verbose:gc</span></div><div class="line">  &#123;</div><div class="line">    LogVerbosity *log_verbosity = args.Get(M::Verbose);</div><div class="line">    <span class="keyword">if</span> (log_verbosity != <span class="literal">nullptr</span>) &#123;</div><div class="line">      gLogVerbosity = *log_verbosity;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  MaybeOverrideVerbosity();</div><div class="line"></div><div class="line">  <span class="comment">// 设置-Xprofile:,由于在启动时没有指定这个参数,所以使用默认值:</span></div><div class="line">  Trace::SetDefaultClockSource(args.GetOrDefault(M::ProfileClock));</div><div class="line">  <span class="comment">//再次检查extraInfo</span></div><div class="line">  <span class="keyword">if</span> (!ProcessSpecialOptions(options, &amp;args, <span class="literal">nullptr</span>)) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  &#123;</div><div class="line"></div><div class="line">    <span class="comment">// 如果没有设置,background回收器是默认的homogeneous compaction</span></div><div class="line">    <span class="comment">// 如果foreground回收器是GSS, 则background也是GSS</span></div><div class="line">    <span class="comment">// 如果是low memory模式, 则使用semispace</span></div><div class="line">    gc::CollectorType background_collector_type_;</div><div class="line">    gc::CollectorType collector_type_ = (XGcOption&#123;&#125;).collector_type_;  <span class="comment">// NOLINT [whitespace/braces] [5]</span></div><div class="line">    <span class="comment">//查看是否存在-XX:LowMemoryMode,实际上是没有的</span></div><div class="line">    <span class="keyword">bool</span> low_memory_mode_ = args.Exists(M::LowMemoryMode);</div><div class="line">    <span class="comment">//获取参数-XX:BackgroundGC,实际上并未指定,所以使用默认值</span></div><div class="line">    background_collector_type_ = args.GetOrDefault(M::BackgroundGc);</div><div class="line">    &#123;</div><div class="line">      <span class="comment">//获取参数-Xgc,实际上参数中并没有指定</span></div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (background_collector_type_ == gc::kCollectorTypeNone) &#123;</div><div class="line">      <span class="keyword">if</span> (collector_type_ != gc::kCollectorTypeGSS) &#123;</div><div class="line">        <span class="comment">//如果foreground回收器不是GSS,且当前是low_memory_mode,则使用SS, 否则指定为homogeneous compact</span></div><div class="line">        background_collector_type_ = low_memory_mode_ ?</div><div class="line">            gc::kCollectorTypeSS : gc::kCollectorTypeHomogeneousSpaceCompact;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        background_collector_type_ = collector_type_;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    args.Set(M::BackgroundGc, BackgroundGcOption &#123; background_collector_type_ &#125;);</div><div class="line">  &#125;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ART_TARGET)</span></div><div class="line">  <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">core_jar</span><span class="params">(<span class="string">"/core.jar"</span>)</span></span>;</div><div class="line">  <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">core_libart_jar</span><span class="params">(<span class="string">"/core-libart.jar"</span>)</span></span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">  <span class="comment">// The host uses hostdex files.</span></div><div class="line">  <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">core_jar</span><span class="params">(<span class="string">"/core-hostdex.jar"</span>)</span></span>;</div><div class="line">  <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">core_libart_jar</span><span class="params">(<span class="string">"/core-libart-hostdex.jar"</span>)</span></span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">  <span class="comment">//获取-Xbootclasspath,之前已经通过getenv("BOOTCLASSPATH")设置</span></div><div class="line">  <span class="keyword">auto</span> boot_class_path_string = args.GetOrDefault(M::BootClassPath);</div><div class="line">  <span class="comment">//在bootclasspath中查找/core.jar, 如果找到的话,则用/core-libart.jar替换</span></div><div class="line">  <span class="keyword">size_t</span> core_jar_pos = boot_class_path_string.find(core_jar);</div><div class="line">  <span class="keyword">if</span> (core_jar_pos != <span class="built_in">std</span>::<span class="built_in">string</span>::npos) &#123;</div><div class="line">    boot_class_path_string.replace(core_jar_pos, core_jar.size(), core_libart_jar);</div><div class="line">    args.Set(M::BootClassPath, boot_class_path_string);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  &#123;</div><div class="line">    <span class="comment">//获取-Xbootclasspath和-Xbootclasspath-location:</span></div><div class="line">    <span class="keyword">auto</span>&amp;&amp; boot_class_path = args.GetOrDefault(M::BootClassPath);</div><div class="line">    <span class="keyword">auto</span>&amp;&amp; boot_class_path_locations = args.GetOrDefault(M::BootClassPathLocations);</div><div class="line">    <span class="comment">//实际并未指定-Xbootclasspath-location</span></div><div class="line">    <span class="keyword">if</span> (args.Exists(M::BootClassPathLocations)) &#123;</div><div class="line">      <span class="comment">//如果boot_class_path_locations的path数量不等于boot_class_path中的path路径,打印Usage并返回</span></div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//如果没有指定compilercallbacks回调函数(实际参数中并没有指定)以及没有指定-Ximage(实际参数也并未指定)</span></div><div class="line">  <span class="comment">//指定image文件路径是/system/framework/boot.art</span></div><div class="line">  <span class="keyword">if</span> (!args.Exists(M::CompilerCallbacksPtr) &amp;&amp; !args.Exists(M::Image)) &#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> image = GetAndroidRoot();</div><div class="line">    image += <span class="string">"/framework/boot.art"</span>;</div><div class="line">    args.Set(M::Image, image);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//获取-XX:HeapGrowthLimit(实际参数中为256m),判断是否小于0或者大于-Xmx(实际为512m)</span></div><div class="line">  <span class="comment">//如果小于0或者大于-Xmx,则将-XX:HeapGrowthLimit设为-Xmx的值</span></div><div class="line">  <span class="keyword">if</span> (args.GetOrDefault(M::HeapGrowthLimit) &lt;= <span class="number">0u</span> ||</div><div class="line">      args.GetOrDefault(M::HeapGrowthLimit) &gt; args.GetOrDefault(M::MemoryMaximumSize)) &#123;</div><div class="line">    args.Set(M::HeapGrowthLimit, args.GetOrDefault(M::MemoryMaximumSize));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//实际参数中并没有指定-Xexperimental</span></div><div class="line">  <span class="keyword">if</span> (args.GetOrDefault(M::Experimental) &amp; ExperimentalFlags::kLambdas) &#123;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  *runtime_options = <span class="built_in">std</span>::move(args);</div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>DoParse方法主要做了以下几件事:</p>
<ol>
<li>先将所有的字符串参数名称集中生成对应的<code>RuntimeArgumentMap::[KEY]</code>结构</li>
<li>从实际传入的参数中解析<code>extra_info</code>,<code>extra_info</code>用来hook函数,实际传入的参数中hook的是下面三个函数:<code>exit</code>,<code>vfprintf</code>,<code>sensitiveThread</code></li>
<li>判断传入的参数中是否有<code>-help,-showversion</code>,如果存在,则打印对应的帮助信息并返回</li>
<li>确保<code>-Xusejit</code>和<code>-Xint</code>不能共同使用</li>
<li><code>getenv(BOOTCLASSPATH)</code>并设置<code>-Xbootclasspath</code></li>
<li><code>getenv(CLASSPATH)</code>并设置<code>-Xclasspath</code></li>
<li>设置<code>-XX:ParallelGCThreads=0u</code></li>
<li>根据实际传入的参数设置<code>LogVerbosity</code></li>
<li>获取<code>Xprofile</code>,由于实际参数中没有设置,所以使用默认值,并设置<code>Trace::SetDefaultClockSource</code></li>
<li>再次检索<code>extra_info</code></li>
<li>根据<code>kuseReadBarrier</code>的值确定foreground GC, 如果<code>kuseReadBarrier=true</code>,<code>foregroundGC=CC</code>,否则<code>foregroundGC=default</code>;查看实际参数中是否指定<code>-Xgc</code>,如果指定了则将参数指定的GC设为background GC(实际参数中并未指定);如果foreground GC是GSS,则background GC也是GSS;如果foreground GC不是GSS,则如果实际参数中指定了<code>-XX:LowMemoryMode</code>(实际参数中并未指定), 即低内存模式下<code>backgroundGC=GSS</code>, 否则<code>backgroundGC=homogeneous Space Compact</code></li>
<li>如果bootclasspath中包含<code>/core.jar</code>,则用<code>/core-libart.jar</code>替换</li>
<li>如果指定了<code>-Xbootclasspath-location</code>,检查<code>-Xbootclasspath-location</code>锁指定的path数量是否和<code>-Xbootclasspath</code>中的path数量一样,不一样输出Usage并返回</li>
<li>由于实际参数中并没有指定<code>-Ximage:</code>和名为<code>compilercallbacks</code>的<code>extra_info</code>,指定Runtime的Image文件是<code>/system/framework/boot.art</code></li>
<li>确保<code>-XX:HeapGrowthLimit</code>大于0同时小于<code>-Xmx</code></li>
</ol>
<h4 id="4-5-1-ParsedOptions-ProcessSpecialOptions"><a href="#4-5-1-ParsedOptions-ProcessSpecialOptions" class="headerlink" title="4.5.1 ParsedOptions::ProcessSpecialOptions"></a>4.5.1 ParsedOptions::ProcessSpecialOptions</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> ParsedOptions::ProcessSpecialOptions(<span class="keyword">const</span> RuntimeOptions&amp; options,</div><div class="line">                                          RuntimeArgumentMap* runtime_options,</div><div class="line">                                          <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt;* out_options) &#123;</div><div class="line">  <span class="keyword">using</span> M = RuntimeArgumentMap;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</div><div class="line">      <span class="keyword">const</span> <span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">option</span><span class="params">(options[i].first)</span></span>;</div><div class="line">      <span class="keyword">if</span> (option == <span class="string">"bootclasspath"</span>) &#123;</div><div class="line">        ... <span class="comment">//实际并没有设置</span></div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (option == <span class="string">"compilercallbacks"</span>) &#123;</div><div class="line">        ... <span class="comment">//实际并没有设置</span></div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (option == <span class="string">"imageinstructionset"</span>) &#123;</div><div class="line">        ... <span class="comment">//实际并没有设置</span></div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (option == <span class="string">"sensitiveThread"</span>) &#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">void</span>* hook = options[i].second;</div><div class="line">        <span class="keyword">bool</span> (*hook_is_sensitive_thread)() = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">bool</span> (*)()&gt;(<span class="keyword">const_cast</span>&lt;<span class="keyword">void</span>*&gt;(hook));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (runtime_options != <span class="literal">nullptr</span>) &#123;</div><div class="line">          runtime_options-&gt;Set(M::HookIsSensitiveThread, hook_is_sensitive_thread);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (option == <span class="string">"vfprintf"</span>) &#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">void</span>* hook = options[i].second;</div><div class="line">        <span class="keyword">if</span> (hook == <span class="literal">nullptr</span>) &#123;</div><div class="line">          Usage(<span class="string">"vfprintf argument was nullptr"</span>);</div><div class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> (*hook_vfprintf)(FILE *, <span class="keyword">const</span> <span class="keyword">char</span>*, va_list) =</div><div class="line">            <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">int</span> (*)(FILE *, <span class="keyword">const</span> <span class="keyword">char</span>*, va_list)&gt;(<span class="keyword">const_cast</span>&lt;<span class="keyword">void</span>*&gt;(hook));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (runtime_options != <span class="literal">nullptr</span>) &#123;</div><div class="line">          runtime_options-&gt;Set(M::HookVfprintf, hook_vfprintf);</div><div class="line">        &#125;</div><div class="line">        hook_vfprintf_ = hook_vfprintf;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (option == <span class="string">"exit"</span>) &#123;</div><div class="line">        <span class="keyword">const</span> <span class="keyword">void</span>* hook = options[i].second;</div><div class="line">        <span class="keyword">if</span> (hook == <span class="literal">nullptr</span>) &#123;</div><div class="line">          Usage(<span class="string">"exit argument was nullptr"</span>);</div><div class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">void</span>(*hook_exit)(jint) = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>(*)(jint)&gt;(<span class="keyword">const_cast</span>&lt;<span class="keyword">void</span>*&gt;(hook));</div><div class="line">        <span class="keyword">if</span> (runtime_options != <span class="literal">nullptr</span>) &#123;</div><div class="line">          runtime_options-&gt;Set(M::HookExit, hook_exit);</div><div class="line">        &#125;</div><div class="line">        hook_exit_ = hook_exit;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (option == <span class="string">"abort"</span>) &#123;</div><div class="line">        ... <span class="comment">//实际并没有设置</span></div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        ... <span class="comment">//实际并没有设置</span></div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/ART-Runtime创建-一-整体流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/ART-Runtime创建-一-整体流程/" itemprop="url">ART Runtime创建(一)--整体流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T14:44:11+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ART/" itemprop="url" rel="index">
                    <span itemprop="name">ART</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一-Zygote启动过程中的创建虚拟机过程"><a href="#一-Zygote启动过程中的创建虚拟机过程" class="headerlink" title="一. Zygote启动过程中的创建虚拟机过程"></a>一. Zygote启动过程中的创建虚拟机过程</h1><p>Zygote的代码位于<code>/framework/base/cmds/app_process/app_main.cpp</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">int main(int argc, char* const argv[])</div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    //[1.1]</div><div class="line">    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));</div><div class="line"></div><div class="line">    ... // handle args</div><div class="line"></div><div class="line">    if (zygote) &#123;</div><div class="line">        //[1.2]</div><div class="line">        runtime.start("com.android.internal.os.ZygoteInit", args, zygote);</div><div class="line">    &#125; else if (className) &#123;</div><div class="line">        runtime.start("com.android.internal.os.RuntimeInit", args, zygote);</div><div class="line">    &#125; else &#123;</div><div class="line">        fprintf(stderr, "Error: no class name or --zygote supplied.\n");</div><div class="line">        app_usage();</div><div class="line">        LOG_ALWAYS_FATAL("app_process: no class name or --zygote supplied.");</div><div class="line">        return 10;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>main</code>方法中省略的代码中主要在处理传入的参数, 从而确定当前是否要执行zygote的逻辑以及启动zygote时是否需要启动<code>system_server</code>, 这里主要两个关键调用:</p>
<ol>
<li><code>AppRuntime runtime(...)</code>这行代码创建了一个<code>AppRuntime</code>对象,AppRuntime继承自<code>AndroidRuntime</code></li>
<li><code>runtime.start(...)</code>调用AppRuntime的<code>start</code>方法,由于AppRuntime并没有重写父类的start方法,所以这里实际调用的是<code>AndroidRuntime::start(...)</code></li>
</ol>
<h2 id="1-1-AndroidRuntime"><a href="#1-1-AndroidRuntime" class="headerlink" title="1.1 AndroidRuntime"></a>1.1 AndroidRuntime</h2><p><code>AppRuntime</code>的定义就在<code>app_main.cpp</code>中,其构造函数为:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">AppRuntime(<span class="keyword">char</span>* argBlockStart, <span class="keyword">const</span> <span class="keyword">size_t</span> argBlockLength)</div><div class="line">        : AndroidRuntime(argBlockStart, argBlockLength)</div><div class="line">        , mClass(<span class="literal">NULL</span>)&#123;&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到AppRuntime的构造函数没做任何事,主要就是调用父类<code>AndroidRuntime</code>的构造函数, <code>AndroidRuntime</code>定义在<code>/framework/base/include/android_runtime/AndroidRuntime.h</code>,对应的源文件在<code>/framework/base/core/jni/AndroidRuntime.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//全局变量</span></div><div class="line"><span class="keyword">static</span> AndroidRuntime* gCurRuntime = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">AndroidRuntime::AndroidRuntime(<span class="keyword">char</span>* argBlockStart, <span class="keyword">const</span> <span class="keyword">size_t</span> argBlockLength) :</div><div class="line">        mExitWithoutCleanup(<span class="literal">false</span>),</div><div class="line">        mArgBlockStart(argBlockStart),</div><div class="line">        mArgBlockLength(argBlockLength)</div><div class="line">&#123;</div><div class="line">    SkGraphics::Init();</div><div class="line"></div><div class="line">    <span class="comment">// mOptions的类型是:Vector&lt;JavaVMOption&gt;</span></div><div class="line">    mOptions.setCapacity(<span class="number">20</span>);</div><div class="line"></div><div class="line">    assert(gCurRuntime == <span class="literal">NULL</span>);        <span class="comment">// one per process</span></div><div class="line">    gCurRuntime = <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="1-2-AndroidRuntime-start"><a href="#1-2-AndroidRuntime-start" class="headerlink" title="1.2 AndroidRuntime::start"></a>1.2 AndroidRuntime::start</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</div><div class="line">&#123;</div><div class="line">    ... <span class="comment">//设置ANDROID_ROOT</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/* 启动虚拟机 */</span></div><div class="line">    <span class="comment">//[1.3]</span></div><div class="line">    JniInvocation jni_invocation;</div><div class="line">    <span class="comment">//[1.4]</span></div><div class="line">    jni_invocation.Init(<span class="literal">NULL</span>);</div><div class="line">    JNIEnv* env;</div><div class="line">    <span class="comment">//[1.5], mJavaVM是AndroidRuntime的static变量,初始化为NULL</span></div><div class="line">    <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//[1.6]</span></div><div class="line">    onVmCreated(env);</div><div class="line"></div><div class="line">    <span class="comment">/* 注册android相关的jni方法 */</span></div><div class="line">    <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</div><div class="line">        ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ... <span class="comment">//调用com.android.internal.os.ZygoteInit或者RuntimeInit的main方法</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</div><div class="line">        ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</div><div class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</div><div class="line">        ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="1-3-JniInvocation-JniInvocation"><a href="#1-3-JniInvocation-JniInvocation" class="headerlink" title="1.3 JniInvocation::JniInvocation"></a>1.3 JniInvocation::JniInvocation</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">JniInvocation::JniInvocation() :</div><div class="line">    handle_(<span class="literal">NULL</span>),</div><div class="line">    JNI_GetDefaultJavaVMInitArgs_(<span class="literal">NULL</span>),</div><div class="line">    JNI_CreateJavaVM_(<span class="literal">NULL</span>),</div><div class="line">    JNI_GetCreatedJavaVMs_(<span class="literal">NULL</span>) &#123;</div><div class="line"></div><div class="line">  LOG_ALWAYS_FATAL_IF(jni_invocation_ != <span class="literal">NULL</span>, <span class="string">"JniInvocation instance already initialized"</span>);</div><div class="line">  jni_invocation_ = <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>JniInvocation</code>类的头文件和源文件分别在<code>/libnativehelper/include/nativehelper/JniInvocation.h</code>,<code>/libnativehelper/JniInvocation.cpp</code>.<br><code>JniInvocation</code>中有三个重要的变量:</p>
<ul>
<li><code>JNI_CreateJavaVM_</code>(创建虚拟机实例)</li>
<li><code>JNI_GetCreatedJavaVMs_</code>(获取创建的虚拟机实例)</li>
<li><code>JNI_GetDefaultJavaVMInitArgs_</code>(获取虚拟机的默认初始化参数)</li>
</ul>
<p>这三个变量是标准的Java虚拟机的接口,也就是说实现了这个三个接口,就可以实现一个Java虚拟机,具体可参考<a href="http://blog.csdn.net/luoshengyang/article/details/18006645" target="_blank" rel="external">罗升阳的博客</a>.<br><code>JniInvocation</code>的构造函数中初始化这三个变量为NULL</p>
<h2 id="1-4-JniInvocation-Init"><a href="#1-4-JniInvocation-Init" class="headerlink" title="1.4 JniInvocation::Init"></a>1.4 JniInvocation::Init</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> JniInvocation::Init(<span class="keyword">const</span> <span class="keyword">char</span>* library) &#123;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __ANDROID__</span></div><div class="line">  <span class="keyword">char</span> buffer[PROP_VALUE_MAX];</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">  <span class="keyword">char</span>* buffer = <span class="literal">NULL</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">  <span class="comment">//由于传入的library是NULL,所以最后实际获取到的library是libart.so</span></div><div class="line">  library = GetLibrary(library, buffer);</div><div class="line">  <span class="keyword">const</span> <span class="keyword">int</span> kDlopenFlags = RTLD_NOW | RTLD_NODELETE;</div><div class="line">  handle_ = dlopen(library, kDlopenFlags);</div><div class="line">  <span class="keyword">if</span> (handle_ == <span class="literal">NULL</span>) &#123;</div><div class="line">    ... <span class="comment">//打开libart.so失败,直接返回;如果打开其他library失败,则尝试打开libart.so</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">//寻找并导出JNI_GetDefaultJavaVMInitArgs_</span></div><div class="line">  <span class="keyword">if</span> (!FindSymbol(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>**&gt;(&amp;JNI_GetDefaultJavaVMInitArgs_),</div><div class="line">                  <span class="string">"JNI_GetDefaultJavaVMInitArgs"</span>)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//寻找并导出JNI_CreateJavaVM_</span></div><div class="line">  <span class="keyword">if</span> (!FindSymbol(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>**&gt;(&amp;JNI_CreateJavaVM_),</div><div class="line">                  <span class="string">"JNI_CreateJavaVM"</span>)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//寻找并导出JNI_GetCreatedJavaVMs_</span></div><div class="line">  <span class="keyword">if</span> (!FindSymbol(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span>**&gt;(&amp;JNI_GetCreatedJavaVMs_),</div><div class="line">                  <span class="string">"JNI_GetCreatedJavaVMs"</span>)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">bool</span> JniInvocation::FindSymbol(<span class="keyword">void</span>** pointer, <span class="keyword">const</span> <span class="keyword">char</span>* symbol) &#123;</div><div class="line">  *pointer = dlsym(handle_, symbol);</div><div class="line">  ... <span class="comment">// handle error</span></div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>JniInvocation::Init</code>的主要工作就是通过<code>dlopen</code>函数打开<code>libart.so</code>,之后利用<code>dlsym</code>函数寻找并导出Java虚拟机的三个接口,这样就可以通过这三个接口创建并访问虚拟机</p>
<h2 id="1-5-AndroidRuntime-startVm"><a href="#1-5-AndroidRuntime-startVm" class="headerlink" title="1.5 AndroidRuntime::startVm"></a>1.5 AndroidRuntime::startVm</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> AndroidRuntime::startVm(JavaVM** pJavaVM, JNIEnv** pEnv, <span class="keyword">bool</span> zygote)</div><div class="line">&#123;</div><div class="line">    ... <span class="comment">//解析启动参数</span></div><div class="line"></div><div class="line">    initArgs.version = JNI_VERSION_1_4;</div><div class="line">    initArgs.options = mOptions.editArray();</div><div class="line">    initArgs.nOptions = mOptions.size();</div><div class="line">    initArgs.ignoreUnrecognized = JNI_FALSE;</div><div class="line"></div><div class="line">     <span class="comment">/**</span></div><div class="line">     * 创建虚拟机, 每一个进程有一个JavaVM*, 每一个线程有一个JNIEnv*</div><div class="line">     */</div><div class="line">    <span class="comment">//[1.5.1]</span></div><div class="line">    <span class="keyword">if</span> (JNI_CreateJavaVM(pJavaVM, pEnv, &amp;initArgs) &lt; <span class="number">0</span>) &#123;</div><div class="line">        ALOGE(<span class="string">"JNI_CreateJavaVM failed\n"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Android::startVm</code>主要做了两项工作:</p>
<ol>
<li>解析虚拟机启动参数</li>
<li>调用<code>JNI_CreateJavaVM</code>创建虚拟机.源码的注释中清楚地说明了创建虚拟机后<strong>每一个进程都应该具有一个JavaVM指针,而每一个线程都具有一个JNIEnv指针</strong>.<code>JNI_CreateJavaVM</code>实现在<code>/libnativehelper/JniInvocation.cpp</code>中,其主要逻辑就是返回之前从<code>libart.so</code>中导出的<code>JNI_CreateJavaVM_</code>接口,即<code>JNI_CreateJavaVM</code>的真正实现是由<code>libart.so</code>完成的</li>
</ol>
<h3 id="1-5-1-JniInvocation-JNI-CreateJavaVM"><a href="#1-5-1-JniInvocation-JNI-CreateJavaVM" class="headerlink" title="1.5.1 JniInvocation::JNI_CreateJavaVM"></a>1.5.1 JniInvocation::JNI_CreateJavaVM</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="function">jint <span class="title">JNI_CreateJavaVM</span><span class="params">(JavaVM** p_vm, JNIEnv** p_env, <span class="keyword">void</span>* vm_args)</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> JniInvocation::GetJniInvocation().JNI_CreateJavaVM(p_vm, p_env, vm_args);</div><div class="line">&#125;</div><div class="line"></div><div class="line">jint JniInvocation::JNI_CreateJavaVM(JavaVM** p_vm, JNIEnv** p_env, <span class="keyword">void</span>* vm_args) &#123;</div><div class="line">  <span class="keyword">return</span> JNI_CreateJavaVM_(p_vm, p_env, vm_args);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>JNI_CreateJavaVM_</code>就是之前在<code>JniInvocation::Init</code>中导出的函数指针</p>
<h2 id="1-6-AppRuntime-onVmCreated"><a href="#1-6-AppRuntime-onVmCreated" class="headerlink" title="1.6 AppRuntime::onVmCreated"></a>1.6 AppRuntime::onVmCreated</h2><p><code>AndroidRuntime::onVmCreated</code>是一个虚方法,AndroidRuntime类并没有实现这个方法,具体实现是由子类<code>AppRuntime</code>实现<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onVmCreated</span><span class="params">(JNIEnv* env)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span> (mClassName.isEmpty()) &#123;</div><div class="line">        <span class="keyword">return</span>; <span class="comment">// Zygote. Nothing to do here.</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(mClassName.<span class="built_in">string</span>());</div><div class="line">    mClass = env-&gt;FindClass(slashClassName);</div><div class="line">    <span class="keyword">if</span> (mClass == <span class="literal">NULL</span>) &#123;</div><div class="line">        ALOGE(<span class="string">"ERROR: could not find class '%s'\n"</span>, mClassName.<span class="built_in">string</span>());</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">free</span>(slashClassName);</div><div class="line"></div><div class="line">    mClass = <span class="keyword">reinterpret_cast</span>&lt;jclass&gt;(env-&gt;NewGlobalRef(mClass));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从代码中可以看出,如果是Zygote的启动,则<code>onVmCreated</code>实际什么也没有做</p>
<h1 id="二-libart-so中的JNI-CreateJavaVM"><a href="#二-libart-so中的JNI-CreateJavaVM" class="headerlink" title="二. libart.so中的JNI_CreateJavaVM"></a>二. libart.so中的JNI_CreateJavaVM</h1><p>libart.so的代码都位于<code>/art</code>目录下,而<code>JNI_CreateJavaVM</code>定义在<code>/art/runtime/java_vm_ext.cc</code>中:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="function">jint <span class="title">JNI_CreateJavaVM</span><span class="params">(JavaVM** p_vm, JNIEnv** p_env, <span class="keyword">void</span>* vm_args)</span> </span>&#123;</div><div class="line">  <span class="function">ScopedTrace <span class="title">trace</span><span class="params">(__FUNCTION__)</span></span>;</div><div class="line">  <span class="keyword">const</span> JavaVMInitArgs* args = <span class="keyword">static_cast</span>&lt;JavaVMInitArgs*&gt;(vm_args);</div><div class="line">  <span class="comment">//检查Jni版本号</span></div><div class="line">  <span class="keyword">if</span> (IsBadJniVersion(args-&gt;version)) &#123;</div><div class="line">    LOG(ERROR) &lt;&lt; <span class="string">"Bad JNI version passed to CreateJavaVM: "</span> &lt;&lt; args-&gt;version;</div><div class="line">    <span class="keyword">return</span> JNI_EVERSION;</div><div class="line">  &#125;</div><div class="line">  RuntimeOptions options;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args-&gt;nOptions; ++i) &#123;</div><div class="line">    JavaVMOption* option = &amp;args-&gt;options[i];</div><div class="line">    options.push_back(<span class="built_in">std</span>::make_pair(<span class="built_in">std</span>::<span class="built_in">string</span>(option-&gt;optionString), option-&gt;extraInfo));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">bool</span> ignore_unrecognized = args-&gt;ignoreUnrecognized;</div><div class="line">  <span class="comment">//[2.1] 创建Runtime</span></div><div class="line">  <span class="keyword">if</span> (!Runtime::Create(options, ignore_unrecognized)) &#123;</div><div class="line">    <span class="keyword">return</span> JNI_ERR;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//初始化native loader, 确保在使用JNI之前所需的环境都已经设置好</span></div><div class="line">  android::InitializeNativeLoader();</div><div class="line"></div><div class="line">  Runtime* runtime = Runtime::Current();</div><div class="line">  <span class="comment">//[2.2] 启动Runtime</span></div><div class="line">  <span class="keyword">bool</span> started = runtime-&gt;Start();</div><div class="line">  <span class="keyword">if</span> (!started) &#123;</div><div class="line">    <span class="keyword">delete</span> Thread::Current()-&gt;GetJniEnv();</div><div class="line">    <span class="keyword">delete</span> runtime-&gt;GetJavaVM();</div><div class="line">    LOG(WARNING) &lt;&lt; <span class="string">"CreateJavaVM failed"</span>;</div><div class="line">    <span class="keyword">return</span> JNI_ERR;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//获取JNIEnv和JavaVM,返回给上层</span></div><div class="line">  *p_env = Thread::Current()-&gt;GetJniEnv();</div><div class="line">  *p_vm = runtime-&gt;GetJavaVM();</div><div class="line">  <span class="keyword">return</span> JNI_OK;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="2-1-Runtime-Create"><a href="#2-1-Runtime-Create" class="headerlink" title="2.1 Runtime::Create"></a>2.1 Runtime::Create</h2><p>代码位于<code>/art/runtime/runtime.cc</code><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> Runtime::Create(<span class="keyword">const</span> RuntimeOptions&amp; raw_options, <span class="keyword">bool</span> ignore_unrecognized) &#123;</div><div class="line">  RuntimeArgumentMap runtime_options;</div><div class="line">  <span class="comment">//首先调用ParseOptions,之后再调用另一个重载版本的Create</span></div><div class="line">  <span class="keyword">return</span> ParseOptions(raw_options, ignore_unrecognized, &amp;runtime_options) &amp;&amp;</div><div class="line">      Create(<span class="built_in">std</span>::move(runtime_options));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">bool</span> Runtime::Create(RuntimeArgumentMap&amp;&amp; runtime_options) &#123;</div><div class="line">  <span class="keyword">if</span> (Runtime::instance_ != <span class="literal">nullptr</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line">  instance_ = <span class="keyword">new</span> Runtime;</div><div class="line">  <span class="comment">//调用Runtime::Init(), [2.1.1]</span></div><div class="line">  <span class="keyword">if</span> (!instance_-&gt;Init(<span class="built_in">std</span>::move(runtime_options))) &#123;</div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> Currently deleting the instance will abort the runtime on destruction. Now This will</span></div><div class="line">    <span class="comment">// leak memory, instead. Fix the destructor. b/19100793.</span></div><div class="line">    <span class="comment">// delete instance_;</span></div><div class="line">    instance_ = <span class="literal">nullptr</span>;</div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>ParseOptions()</code>最终会调用<code>ParsedOptions::DoParse</code>方法(<code>/art/runtime/parsed_options.cc</code>),主要就是用来解析传入的启动参数,这里暂时先不分析其主要逻辑.从代码中可以看到<code>Create</code>函数主要操作视调用<code>Runtime::Init</code>函数</p>
<h3 id="2-1-1-Runtime-Init"><a href="#2-1-1-Runtime-Init" class="headerlink" title="2.1.1 Runtime::Init"></a>2.1.1 Runtime::Init</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line">bool Runtime::Init(RuntimeArgumentMap&amp;&amp; runtime_options_in) &#123;</div><div class="line">  RuntimeArgumentMap runtime_options(std::move(runtime_options_in));</div><div class="line">  ScopedTrace trace(__FUNCTION__);</div><div class="line"></div><div class="line">  MemMap::Init();</div><div class="line">  using Opt = RuntimeArgumentMap;</div><div class="line">  QuasiAtomic::Startup();</div><div class="line"></div><div class="line">  //创建OatFileManager, OatFileManager主要用来加载oat文件</div><div class="line">  oat_file_manager_ = new OatFileManager;</div><div class="line"></div><div class="line">  Thread::SetSensitiveThreadHook(runtime_options.GetOrDefault(Opt::HookIsSensitiveThread));</div><div class="line">  Monitor::Init(runtime_options.GetOrDefault(Opt::LockProfThreshold));</div><div class="line"></div><div class="line">  //从传入的参数中初始化boot_class_path_string_, class_path_string_, patchoat_executable_等变量</div><div class="line">  //创建monitor_list_, monitor_pool_, thread_list_, intern_table_</div><div class="line">  //继续获取一些基本变量</div><div class="line">  ...</div><div class="line"></div><div class="line">  //查看参数中是否指定了解释执行,如果指定,则告知虚拟机所有代码都是解释执行</div><div class="line">  if (runtime_options.GetOrDefault(Opt::Interpret)) &#123;</div><div class="line">    GetInstrumentation()-&gt;ForceInterpretOnly();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  //仍然是从传入的参数中初始化一些基础变量, 并获取CompilerFilter</div><div class="line">  ...</div><div class="line"></div><div class="line">  //创建堆Heap</div><div class="line">  heap_ = new gc::Heap(...);</div><div class="line">  if (!heap_-&gt;HasBootImageSpace() &amp;&amp; !allow_dex_file_fallback_) &#123;</div><div class="line">    LOG(ERROR) &lt;&lt; "Dex file fallback disabled, cannot continue without image.";</div><div class="line">    return false;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ... //获取dump_gc_performance_on_shutdown_, 配置Jdwp</div><div class="line"></div><div class="line">  //创建JIT选项,JIT是7.0中新增的,用来提升代码执行效率</div><div class="line">  jit_options_.reset(jit::JitOptions::CreateFromRuntimeArguments(runtime_options));</div><div class="line">  //如果此时是dex2oat程序,dex2oat执行时也会创建一个Runtime用来编译dex文件,此时不需要开启JIT选项</div><div class="line">  if (IsAotCompiler()) &#123;</div><div class="line">    jit_options_-&gt;SetUseJitCompilation(false);</div><div class="line">    jit_options_-&gt;SetSaveProfilingInfo(false);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  //创建lamba_box_table, arena_pool_, jit_arena_pool_, 如果是64位架构且当前是dex2oat, 获取low_4gb_arena_pool_</div><div class="line">  ...</div><div class="line">  //创建线性分配器linear_alloc_,LinearAlloc创建时会用到上面创建的low_4gb_arena_pool_(64位架构且是dex2oat时)或者arena_pool_</div><div class="line">  linear_alloc_.reset(CreateLinearAlloc());</div><div class="line"></div><div class="line">  BlockSignals();</div><div class="line">  //初始化SIGSEGV信号处理函数为HandleUnexpectedSignal</div><div class="line">  InitPlatformSignalHandlers();</div><div class="line"></div><div class="line">  //arm, arm64, x86, mips, mips64, thumb2, x86_64架构下,</div><div class="line">  //implicit_null_checks_ = true</div><div class="line">  //implicit_so_checks_ !(RUNNING_ON_MEMORY_TOOL &amp;&amp; kMemoryToolIsValgrind)</div><div class="line">  ....</div><div class="line"></div><div class="line">  ... //处理no_sig_chain = false时的情况(no_sig_chain在之前根据传入的参数获取)</div><div class="line"></div><div class="line">  //创建JavaVMExt</div><div class="line">  java_vm_ = new JavaVMExt(this, runtime_options);</div><div class="line"></div><div class="line">  //创建线程TLS</div><div class="line">  Thread::Startup();</div><div class="line">  //attach线程, 创建Thread对象,初始化Thread对象</div><div class="line">  Thread* self = Thread::Attach("main", false, nullptr, false);</div><div class="line"></div><div class="line">  // Set us to runnable so tools using a runtime can allocate and GC by default</div><div class="line">  self-&gt;TransitionFromSuspendedToRunnable();</div><div class="line"></div><div class="line">  // 验证heap</div><div class="line">  GetHeap()-&gt;EnableObjectValidation();</div><div class="line"></div><div class="line">  //创建ClassLinker</div><div class="line">  class_linker_ = new ClassLinker(intern_table_);</div><div class="line">  if (GetHeap()-&gt;HasBootImageSpace()) &#123;</div><div class="line">    ...</div><div class="line">    bool result = class_linker_-&gt;InitFromBootImage(&amp;error_msg);</div><div class="line">    ...</div><div class="line">    if (boot_class_path_string_.empty()) &#123;</div><div class="line">      // 如果bootclasspath没有显示指定,则从加载的dex文件列表中进行构造,这里的dex文件列表是系统构建时已经创建好的众多预加载的文件</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">    // 在intern_table_中添加boot image space;将boo image space添加到当前ClassLinker的ClassTable中</div><div class="line">    ...</div><div class="line">  &#125; else &#123;</div><div class="line">    ....</div><div class="line">    if (!class_linker_-&gt;InitWithoutImage(std::move(boot_class_path), &amp;error_msg)) &#123;</div><div class="line">      return false;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ... //MethodTrace, ProfilerOptions, Trace</div><div class="line"></div><div class="line">  //提前分配一个OutOfMemoryError</div><div class="line">  self-&gt;ThrowNewException("Ljava/lang/OutOfMemoryError;",</div><div class="line">                          "OutOfMemoryError thrown while trying to throw OutOfMemoryError; "</div><div class="line">                          "no stack trace available");</div><div class="line">  pre_allocated_OutOfMemoryError_ = GcRoot&lt;mirror::Throwable&gt;(self-&gt;GetException());</div><div class="line">  self-&gt;ClearException();</div><div class="line"></div><div class="line">  //提前分配一个NoClassDefFoundError</div><div class="line">  self-&gt;ThrowNewException("Ljava/lang/NoClassDefFoundError;",</div><div class="line">                          "Class not found using the boot class loader; no stack trace available");</div><div class="line">  pre_allocated_NoClassDefFoundError_ = GcRoot&lt;mirror::Throwable&gt;(self-&gt;GetException());</div><div class="line">  self-&gt;ClearException();</div><div class="line"></div><div class="line">  ... //从传入的参数中获取native_bridge_file_name</div><div class="line"></div><div class="line">  return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Runtime::Init</code>方法代码量较大,整个过程中创建或者初始化了很多工具组件如<code>MemMap, QuasiAtomic</code>等,并且从传入的参数依次获取了一些基础变量如<code>boot_class_path_string_, class_path_string_</code>等,之后还设置信号处理函数等,不过整体来看<code>Init</code>方法的主要逻辑很清楚,分别做了以下几件事:</p>
<ol>
<li>创建<code>OatFileManager</code>对象,<code>OatFileManager</code>是在7.0中新增的工具类,Runtime在解析读取oat文件都是通过这个工具类完成</li>
<li>创建了<code>Heap</code>(整个创建过程比较冗长,复杂)</li>
<li>根据传入参数配置JIT选项,如果当前是dex2oat则不配置JIT</li>
<li>创建<code>LinearAlloc</code></li>
<li>创建<code>JavaVMExt</code></li>
<li>创建一个线程,同时attach线程(attach的过程实际就是创建Thread对象并初始化Thread对象的过程)</li>
<li>创建<code>ClassLinker</code>,如果有<code>BootImageSpace</code>则调用<code>ClassLinker::InitFromBootImage</code>完成ClassLinker的初始化;如果没有<code>BootImageSpace</code>,则调用<code>ClassLinker::InitWithoutImage</code>来完成初始化</li>
<li>提前分配一个<code>OutOfMemoryError</code>和<code>NoClassDefFoundError</code></li>
</ol>
<blockquote>
<p><code>Heap</code>的创建过程比较复杂,个人觉得需要单独整理一个篇幅来学习, <code>OatFileManager</code>和<code>LinearAlloc</code>的构造函数都很简单, 另外<code>ClassLinker</code>的初始化过程也较为繁琐,加上<code>ClassLinker</code>类比较重要,同样需要单独的篇幅来学习</p>
</blockquote>
<h3 id="2-1-2-JavaVMExt-JavaVMExt"><a href="#2-1-2-JavaVMExt-JavaVMExt" class="headerlink" title="2.1.2 JavaVMExt::JavaVMExt"></a>2.1.2 JavaVMExt::JavaVMExt</h3><p><code>JavaVMExt</code>的源文件是<code>/art/runtime/java_vm_ext.cc</code>,<code>JavaVMExt</code>继承自<code>JavaVM</code>:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JavaVMExt</span> :</span> <span class="keyword">public</span> JavaVM &#123;</div><div class="line">  ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<blockquote>
<p><code>JavaVM</code>定义在<code>/libnativehelper/include/nativehelper/jni.h</code>中</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">JavaVMExt::JavaVMExt(Runtime* runtime, <span class="keyword">const</span> RuntimeArgumentMap&amp; runtime_options)</div><div class="line">    : runtime_(runtime),</div><div class="line">      check_jni_abort_hook_(<span class="literal">nullptr</span>),</div><div class="line">      check_jni_abort_hook_data_(<span class="literal">nullptr</span>),</div><div class="line">      check_jni_(<span class="literal">false</span>),  <span class="comment">// Initialized properly in the constructor body below.</span></div><div class="line">      force_copy_(runtime_options.Exists(RuntimeArgumentMap::JniOptsForceCopy)),</div><div class="line">      tracing_enabled_(runtime_options.Exists(RuntimeArgumentMap::JniTrace)</div><div class="line">                       || VLOG_IS_ON(third_party_jni)),</div><div class="line">      trace_(runtime_options.GetOrDefault(RuntimeArgumentMap::JniTrace)),</div><div class="line">      globals_lock_(<span class="string">"JNI global reference table lock"</span>),</div><div class="line">      globals_(gGlobalsInitial, gGlobalsMax, kGlobal),</div><div class="line">      libraries_(<span class="keyword">new</span> Libraries),</div><div class="line">      unchecked_functions_(&amp;gJniInvokeInterface),</div><div class="line">      weak_globals_lock_(<span class="string">"JNI weak global reference table lock"</span>, kJniWeakGlobalsLock),</div><div class="line">      weak_globals_(kWeakGlobalsInitial, kWeakGlobalsMax, kWeakGlobal),</div><div class="line">      allow_accessing_weak_globals_(<span class="literal">true</span>),</div><div class="line">      weak_globals_add_condition_(<span class="string">"weak globals add condition"</span>, weak_globals_lock_) &#123;</div><div class="line">  functions = unchecked_functions_;</div><div class="line">  SetCheckJniEnabled(runtime_options.Exists(RuntimeArgumentMap::CheckJni));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到,<code>JavaVMExt</code>的构造函数存储了<code>Runtme</code>指针,之后初始化了自身变量</p>
<h3 id="2-1-3-Thread-Startup"><a href="#2-1-3-Thread-Startup" class="headerlink" title="2.1.3 Thread::Startup"></a>2.1.3 Thread::Startup</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Thread::Startup() &#123;</div><div class="line">  ...</div><div class="line">  <span class="comment">//调用pthread_key_create来创建线程私有数据TLS</span></div><div class="line">  CHECK_PTHREAD_CALL(pthread_key_create, (&amp;Thread::pthread_key_self_, Thread::ThreadExitCallback),</div><div class="line">                     <span class="string">"self key"</span>);</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-1-4-Thread-Attach"><a href="#2-1-4-Thread-Attach" class="headerlink" title="2.1.4 Thread::Attach"></a>2.1.4 Thread::Attach</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">Thread* Thread::Attach(<span class="keyword">const</span> <span class="keyword">char</span>* thread_name, <span class="keyword">bool</span> as_daemon, jobject thread_group,</div><div class="line">                       <span class="keyword">bool</span> create_peer) &#123;</div><div class="line">  Runtime* runtime = Runtime::Current();</div><div class="line">  ...</div><div class="line">  Thread* self;</div><div class="line">  &#123;</div><div class="line">    <span class="function">MutexLock <span class="title">mu</span><span class="params">(<span class="literal">nullptr</span>, *Locks::runtime_shutdown_lock_)</span></span>;</div><div class="line">    <span class="keyword">if</span> (runtime-&gt;IsShuttingDownLocked()) &#123;</div><div class="line">      ...</div><div class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      Runtime::Current()-&gt;StartThreadBirth();</div><div class="line">      <span class="comment">//创建Thread对象</span></div><div class="line">      self = <span class="keyword">new</span> Thread(as_daemon);</div><div class="line">      <span class="comment">//初始化Thread对象</span></div><div class="line">      <span class="keyword">bool</span> init_success = self-&gt;Init(runtime-&gt;GetThreadList(), runtime-&gt;GetJavaVM());</div><div class="line">      Runtime::Current()-&gt;EndThreadBirth();</div><div class="line">      <span class="keyword">if</span> (!init_success) &#123;</div><div class="line">        <span class="keyword">delete</span> self;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//设置创建String对象的entry point为StringFactory</span></div><div class="line">  self-&gt;InitStringEntryPoints();  </div><div class="line">  self-&gt;SetState(kNative);</div><div class="line"></div><div class="line">  ... <span class="comment">//传入的create_peer为false</span></div><div class="line"></div><div class="line">  &#123;</div><div class="line">    <span class="function">ScopedObjectAccess <span class="title">soa</span><span class="params">(self)</span></span>;</div><div class="line">    Dbg::PostThreadStart(self);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-2-Runtime-Start"><a href="#2-2-Runtime-Start" class="headerlink" title="2.2 Runtime::Start"></a>2.2 Runtime::Start</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> Runtime::Start() &#123;</div><div class="line"></div><div class="line">  ..</div><div class="line"></div><div class="line">  Thread* self = Thread::Current();</div><div class="line">  self-&gt;TransitionFromRunnableToSuspended(kNative);</div><div class="line">  started_ = <span class="literal">true</span>;</div><div class="line"></div><div class="line">  <span class="comment">// 创建JIT</span></div><div class="line">  <span class="keyword">if</span> (jit_options_-&gt;UseJitCompilation() || jit_options_-&gt;GetSaveProfilingInfo()) &#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> error_msg;</div><div class="line">    <span class="keyword">if</span> (!IsZygote()) &#123;</div><div class="line">      <span class="comment">// If we are the zygote then we need to wait until after forking to create the code cache</span></div><div class="line">      <span class="comment">// due to SELinux restrictions on r/w/x memory regions.</span></div><div class="line">      CreateJit();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jit_options_-&gt;UseJitCompilation()) &#123;</div><div class="line">      <span class="keyword">if</span> (!jit::Jit::LoadCompilerLibrary(&amp;error_msg)) &#123;</div><div class="line">        <span class="comment">// Try to load compiler pre zygote to reduce PSS. b/27744947</span></div><div class="line">        LOG(WARNING) &lt;&lt; <span class="string">"Failed to load JIT compiler with error "</span> &lt;&lt; error_msg;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ...</div><div class="line"></div><div class="line">  &#123;</div><div class="line">    <span class="function">ScopedTrace <span class="title">trace2</span><span class="params">(<span class="string">"InitNativeMethods"</span>)</span></span>;</div><div class="line">    <span class="comment">//初始化JniConstants的常量,JniConstants定义在/libnativehelper/include/native/JniConstants.h</span></div><div class="line">    <span class="comment">//注册runtime中的native method,主要对应于Java层的java.lang,dalvik.system这些包下的类</span></div><div class="line">    InitNativeMethods();</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//创建main_thread_group和system_thread_group</span></div><div class="line">  InitThreadGroups(self);</div><div class="line">  <span class="comment">//创建一个java.lang.Thread对象,并将Thread.nativePeer变量设为ART中的Thread对象self</span></div><div class="line">  Thread::FinishStartup();</div><div class="line">  <span class="comment">//调用ClassLoader.getSystemClassLoader创建系统ClassLoader</span></div><div class="line">  system_class_loader_ = CreateSystemClassLoader(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">  <span class="comment">//如果当前处于Zygote模式, 利用unshare,以及mount的SLAVE模式创建外部存储文件系统</span></div><div class="line">  <span class="keyword">if</span> (is_zygote_) &#123;</div><div class="line">    <span class="keyword">if</span> (!InitZygote()) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">if</span> (is_native_bridge_loaded_) &#123;</div><div class="line">      PreInitializeNativeBridge(<span class="string">"."</span>);</div><div class="line">    &#125;</div><div class="line">    NativeBridgeAction action = force_native_bridge_</div><div class="line">        ? NativeBridgeAction::kInitialize</div><div class="line">        : NativeBridgeAction::kUnload;</div><div class="line">    InitNonZygoteOrPostFork(self-&gt;GetJniEnv(),</div><div class="line">                            <span class="comment">/* is_system_server */</span> <span class="literal">false</span>,</div><div class="line">                            action,</div><div class="line">                            GetInstructionSetString(kRuntimeISA));</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//启动java.lang.Daemon中定义的后台线程</span></div><div class="line">  StartDaemonThreads();</div><div class="line"></div><div class="line">  &#123;</div><div class="line">    <span class="function">ScopedObjectAccess <span class="title">soa</span><span class="params">(self)</span></span>;</div><div class="line">    self-&gt;GetJniEnv()-&gt;locals.AssertEmpty();</div><div class="line">  &#125;</div><div class="line">  finished_starting_ = <span class="literal">true</span>;</div><div class="line"></div><div class="line">  <span class="comment">//如果ProfilerOptions开启且存在profile文件,打开profile文件</span></div><div class="line">  <span class="keyword">if</span> (profiler_options_.IsEnabled() &amp;&amp; !profile_output_filename_.empty()) &#123;</div><div class="line">    <span class="keyword">int</span> fd = open(profile_output_filename_.c_str(), O_RDWR|O_CREAT|O_EXCL, <span class="number">0660</span>);</div><div class="line">    <span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</div><div class="line">      close(fd);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (errno != EEXIST) &#123;</div><div class="line">      LOG(WARNING) &lt;&lt; <span class="string">"Failed to access the profile file. Profiler disabled."</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  ... <span class="comment">//Trace相关</span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Runtime::Start</code>主要操作是:</p>
<ol>
<li>如果当前不是Zygote,则创建JIT</li>
<li>初始化<code>libnativehelper.so</code>中定义的<code>JniConstants</code>,注册<code>java.lang</code>,<code>dalvik.system</code>包下的本地方法</li>
<li>创建main_thread_group和system_thread_group</li>
<li>创建一个java.lang.Thread对象,并将Thread.nativePeer变量设为ART中的Thread对象self</li>
<li>调用ClassLoader.getSystemClassLoader创建系统ClassLoader</li>
<li>如果当前处于Zygote模式, 利用unshare,以及mount的SLAVE模式创建外部存储文件系统;如果不是,则初始化native bridge</li>
<li>启动java.lang.Daemon中定义的后台线程</li>
<li>判断<code>ProfilerOptions</code>是否开启,如果开启且profile文件不为空,则打开profile文件(Profile文件是在7.0中跟JIT一起加入的, 主要为了提升运行效率)</li>
<li>查看<code>Trace</code>相关配置,如果不为空,则开启Trace</li>
</ol>
<h1 id="三-总结"><a href="#三-总结" class="headerlink" title="三.总结"></a>三.总结</h1><p>Java虚拟机有三个标准接口,只要实现这三个接口,就可以实现一个自定义的虚拟机,这三个接口分别是:<code>JNI_CreateJavaVM_, JNI_GetCreatedJavaVMs_, JNI_GetDefaultJavaVMInitArgs_</code>,这三个接口的具体实现都位于<code>libart.so</code>动态库中,Zygote进程是通过<code>dlopen</code>打开<code>libart.so</code>,之后通过<code>dlsym</code>分别导出这三个接口,并调用<code>JNI_CreateJavaVM_</code>创建虚拟机Runtime实例,并将Runtime实例保存在<code>JavaVM</code>结构,<code>JavaVM</code>代表的就是虚拟机执行环境(在<code>libart.so</code>中实际返回的是其子类<code>JavaVMExt</code>).</p>
<blockquote>
<p>需要留意的是,源码的注释中写的很清楚,每一个进程都必须有一个<code>JavaVM</code>,而每一个线程都有一个<code>JNIEnv</code></p>
</blockquote>
<p><code>JNI_CreateJavaVM_</code>创建虚拟机Runtime的过程可以总结为:</p>
<ol>
<li>解析传入的参数,将参数以<code>key-value</code>的形式组合在一起</li>
<li>调用<code>Runtime::Create</code>创建Runtime实例,创建的过程中还会依次创建<code>OatFileManager, Heap, LinearAlloc, JavaVMExt, Thread, ClassLinker</code>,同时初始化线程和ClassLinker</li>
<li>调用<code>Runtime::Start</code>完成最后的初始化工作</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/ART的反射调用-二-创建对象实例/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/ART的反射调用-二-创建对象实例/" itemprop="url">ART的反射调用(二)--创建对象实例</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T14:38:58+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ART/" itemprop="url" rel="index">
                    <span itemprop="name">ART</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>通过反射创建实例的用法是：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Class&lt;?&gt; clz = Class.forName(<span class="string">"com.xx.xx"</span>);</div><div class="line">Constructor&lt;?&gt; constructor = clz.getConstructor(String.Class);</div><div class="line">Object obj = constructor.newInstance(<span class="string">"xx"</span>);</div></pre></td></tr></table></figure></p>
<blockquote>
<p>通过<code>Class.forName</code>在上一篇<a href="http://www.jianshu.com/p/29b580e452a1" target="_blank" rel="external">ART的反射调用(一)</a>中已经分析</p>
</blockquote>
<h1 id="一-Class-getConstructor"><a href="#一-Class-getConstructor" class="headerlink" title="一. Class.getConstructor"></a>一. Class.getConstructor</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Constructor&lt;T&gt; <span class="title">getConstructor</span><span class="params">(Class&lt;?&gt;... parameterTypes)</span></span></div><div class="line">        <span class="keyword">throws</span> NoSuchMethodException, SecurityException &#123;</div><div class="line">    <span class="keyword">return</span> getConstructor0(parameterTypes, Member.PUBLIC);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Constructor&lt;T&gt; <span class="title">getConstructor0</span><span class="params">(Class&lt;?&gt;[] parameterTypes,</span></span></div><div class="line">                      <span class="keyword">int</span> which) <span class="keyword">throws</span> NoSuchMethodException&#123;</div><div class="line">    <span class="keyword">if</span> (parameterTypes == <span class="keyword">null</span>) &#123;</div><div class="line">        parameterTypes = EmptyArray.CLASS;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (Class&lt;?&gt; c : parameterTypes) &#123;</div><div class="line">        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodException(<span class="string">"parameter type is null"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//核心调用</span></div><div class="line">    Constructor&lt;T&gt; result = getDeclaredConstructorInternal(parameterTypes);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span> || which == Member.PUBLIC &amp;&amp; !Modifier.isPublic(result.getAccessFlags())) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodException(<span class="string">"&lt;init&gt; "</span> + Arrays.toString(parameterTypes));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> Constructor&lt;T&gt; <span class="title">getDeclaredConstructorInternal</span><span class="params">(Class&lt;?&gt;[] args)</span></span>;</div></pre></td></tr></table></figure>
<h2 id="1-1-getDeclaredConstructorInternal"><a href="#1-1-getDeclaredConstructorInternal" class="headerlink" title="1.1 getDeclaredConstructorInternal"></a>1.1 getDeclaredConstructorInternal</h2><p><code>getDeclaredConstructorInternal</code>的实现在<code>/art/runtime/native/java_lang_Class.cc</code>中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> jobject <span class="title">Class_getDeclaredConstructorInternal</span><span class="params">(</span></span></div><div class="line">        JNIEnv* env, jobject javaThis, jobjectArray args) &#123;</div><div class="line">    <span class="function">ScopedFastNativeObjectAccess <span class="title">soa</span><span class="params">(env)</span></span>;</div><div class="line">    <span class="comment">//核心调用,[1.2]</span></div><div class="line">    mirror::Constructor* result = mirror::Class::GetDeclaredConstructorInternal(</div><div class="line">          soa.Self(),</div><div class="line">          <span class="comment">//将Java层的Class对象转换为mirror::Class指针</span></div><div class="line">          DecodeClass(soa, javaThis),</div><div class="line">          <span class="comment">//将Java层的数组转换为存放mirror::Class指针的数组</span></div><div class="line">          soa.Decode&lt;mirror::ObjectArray&lt;mirror::Class&gt;*&gt;(args));</div><div class="line">    <span class="keyword">return</span> soa.AddLocalReference&lt;jobject&gt;(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="1-2-mirror-Class-GetDeclaredConstructorInternal"><a href="#1-2-mirror-Class-GetDeclaredConstructorInternal" class="headerlink" title="1.2 mirror::Class::GetDeclaredConstructorInternal"></a>1.2 mirror::Class::GetDeclaredConstructorInternal</h2><p><code>GetDeclaredConstructorInternal</code>声明在<code>/art/runtime/mirror/class.h</code><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">bool</span> kTransactionActive = <span class="literal">false</span>&gt;</div><div class="line"><span class="keyword">static</span> Constructor* GetDeclaredConstructorInternal(Thread* self,</div><div class="line">                                                 mirror::Class* klass,</div><div class="line">                                                 mirror::ObjectArray&lt;mirror::Class&gt;* args)</div><div class="line">  SHARED_REQUIRES(Locks::mutator_lock_);</div></pre></td></tr></table></figure></p>
<blockquote>
<p>NOTE:kTransactionActive默认为false</p>
</blockquote>
<p>这个方法的实现在<code>/art/runtime/mirror/class.cc</code><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">bool</span> kTransactionActive&gt;</div><div class="line">mirror::Constructor* Class::GetDeclaredConstructorInternal(</div><div class="line">          Thread* self,</div><div class="line">          mirror::Class* klass,</div><div class="line">          mirror::ObjectArray&lt;mirror::Class&gt;* args) &#123;</div><div class="line">    StackHandleScope&lt;<span class="number">1</span>&gt; hs(self);</div><div class="line">    <span class="comment">//kTransactionActive默认为false</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> pointer_size = kTransactionActive</div><div class="line">                                    ? Runtime::Current()-&gt;GetClassLinker()-&gt;GetImagePointerSize()</div><div class="line">                                    : <span class="keyword">sizeof</span>(<span class="keyword">void</span>*);</div><div class="line">    <span class="comment">//[1.3]</span></div><div class="line">    ArtMethod* result = klass-&gt;GetDeclaredConstructor(self, hs.NewHandle(args), pointer_size);</div><div class="line">    <span class="comment">//[1.4]</span></div><div class="line">    <span class="keyword">return</span> result != <span class="literal">nullptr</span></div><div class="line">        ? mirror::Constructor::CreateFromArtMethod&lt;kTransactionActive&gt;(self, result)</div><div class="line">        : <span class="literal">nullptr</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="1-3-mirror-Class-GetDeclaredConstructor"><a href="#1-3-mirror-Class-GetDeclaredConstructor" class="headerlink" title="1.3 mirror::Class::GetDeclaredConstructor"></a>1.3 mirror::Class::GetDeclaredConstructor</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">ArtMethod* Class::GetDeclaredConstructor(Thread* self,</div><div class="line">        Handle&lt;mirror::ObjectArray&lt;mirror::Class&gt;&gt; args, <span class="keyword">size_t</span> pointer_size) &#123;</div><div class="line">    <span class="comment">//迭代每一个Direct Method, [1.3.1]</span></div><div class="line">    <span class="comment">//m是ArtMethod     </span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; m : GetDirectMethods(pointer_size)) &#123;</div><div class="line">        <span class="comment">// 跳过&lt;clinit&gt;方法, &lt;clinit&gt;是类的初始化方法,不是构造函数,所以跳过</span></div><div class="line">        <span class="keyword">if</span> (m.IsStatic() || !m.IsConstructor()) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// May cause thread suspension and exceptions.</span></div><div class="line">        <span class="comment">// GetInterfaceMethodIfProxy方法一般情况下都是直接返回m的this引用</span></div><div class="line">        <span class="comment">// EqualParameters方法用来判断传入的参数是否与方法本身的参数相同</span></div><div class="line">        <span class="keyword">if</span> (m.GetInterfaceMethodIfProxy(<span class="keyword">sizeof</span>(<span class="keyword">void</span>*))-&gt;EqualParameters(args)) &#123;</div><div class="line">            <span class="keyword">return</span> &amp;m;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (UNLIKELY(self-&gt;IsExceptionPending())) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="1-3-1-mirror-Class-GetDirectMethods"><a href="#1-3-1-mirror-Class-GetDirectMethods" class="headerlink" title="1.3.1 mirror::Class::GetDirectMethods"></a>1.3.1 mirror::Class::GetDirectMethods</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">inline</span> IterationRange&lt;StrideIterator&lt;ArtMethod&gt;&gt; Class::GetDirectMethods(<span class="keyword">size_t</span> pointer_size) &#123;</div><div class="line">    CheckPointerSize(pointer_size);</div><div class="line">    <span class="keyword">return</span> GetDirectMethodsSliceUnchecked(pointer_size).AsRange();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到,<code>GetDirectMethods</code>实质上就是封装调用了<code>GetDirectMethodsSliceUnchecked</code>,<code>GetDirectMethodsSliceUnchecked</code>定义在<code>/art/runtime/mirror/class-inl.h</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">///art/runtime/mirror/class-inl.h</span></div><div class="line"><span class="keyword">inline</span> ArraySlice&lt;ArtMethod&gt; Class::GetDirectMethodsSliceUnchecked(<span class="keyword">size_t</span> pointer_size) &#123;</div><div class="line">    <span class="keyword">return</span> ArraySlice&lt;ArtMethod&gt;(GetMethodsPtr(), <span class="comment">//返回LengthPrefixedArray&lt;ArtMethod&gt;*,实质上封装的是当前类的Method数组指针</span></div><div class="line">                                 GetDirectMethodsStartOffset(),<span class="comment">//返回Direct Method的起始偏移地址</span></div><div class="line">                                 GetVirtualMethodsStartOffset(),<span class="comment">//返回Virtual Method的起始偏移地址</span></div><div class="line">                                 ArtMethod::Size(pointer_size),<span class="comment">//pointer_size实质上是sizeof(void *)</span></div><div class="line">                                 ArtMethod::Alignment(pointer_size));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ArraySlice</code>定义在<code>/art/runtime/base/array_slice.h</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// /art/runtime/base/array_slice.h</span></div><div class="line">ArraySlice(LengthPrefixedArray&lt;T&gt;* <span class="built_in">array</span>,</div><div class="line">             <span class="keyword">uint32_t</span> start_offset,</div><div class="line">             <span class="keyword">uint32_t</span> end_offset,</div><div class="line">             <span class="keyword">size_t</span> element_size = <span class="keyword">sizeof</span>(T),</div><div class="line">             <span class="keyword">size_t</span> alignment = <span class="keyword">alignof</span>(T))</div><div class="line">      : array_(<span class="literal">nullptr</span>),</div><div class="line">        size_(end_offset - start_offset),<span class="comment">//Virtual Method的起始地址减去Direct Method的起始地址,这一段存储的全部是Direct Method</span></div><div class="line">        element_size_(element_size) &#123;<span class="comment">//每一个element的大小都是sizeof(void *)</span></div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> (size_ != <span class="number">0</span>) &#123;</div><div class="line">      ...</div><div class="line">      <span class="comment">//T实质上是ArtMethod, 而array_的声明是T* array_,所以array_实质是ArtMethod*</span></div><div class="line">      <span class="comment">//实际就是将array_指向ArtMethod数组</span></div><div class="line">      array_ = &amp;<span class="built_in">array</span>-&gt;At(start_offset, element_size_, alignment);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//AsRange的作用是获取所有Direct Method</span></div><div class="line">IterationRange&lt;StrideIterator&lt;T&gt;&gt; AsRange() &#123;</div><div class="line">   <span class="keyword">return</span> size() != <span class="number">0</span> ? MakeIterationRange(begin(), end())</div><div class="line">                      : MakeEmptyIterationRange(StrideIterator&lt;T&gt;(<span class="literal">nullptr</span>, <span class="number">0</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//指向ArtMethod数组的起始</span></div><div class="line">StrideIterator&lt;T&gt; begin() &#123;</div><div class="line">    <span class="keyword">return</span> StrideIterator&lt;T&gt;(&amp;AtUnchecked(<span class="number">0</span>), element_size_);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//size_是DirectMethods的长度</span></div><div class="line">StrideIterator&lt;T&gt; end() &#123;</div><div class="line">    <span class="keyword">return</span> StrideIterator&lt;T&gt;(&amp;AtUnchecked(size_), element_size_);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">T&amp; <span class="title">AtUnchecked</span><span class="params">(<span class="keyword">size_t</span> index)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> *<span class="keyword">reinterpret_cast</span>&lt;T*&gt;(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(array_) + index * element_size_);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>StrideIterator</code>定义在<code>/art/runtime/stride_iterator.h</code>, <code>StrideIterator</code>继承自<code>std::iterator</code>,并且重写了操作符<code>++</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StrideIterator</span> :</span> <span class="keyword">public</span> <span class="built_in">std</span>::iterator&lt;<span class="built_in">std</span>::forward_iterator_tag, T&gt; &#123;</div><div class="line">    ...</div><div class="line">    StrideIterator(T* ptr, <span class="keyword">size_t</span> stride): ptr_(<span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(ptr)),</div><div class="line">          stride_(stride) &#123;&#125;</div><div class="line"></div><div class="line"></div><div class="line">    StrideIterator <span class="keyword">operator</span>++() &#123;  <span class="comment">// Value after modification.</span></div><div class="line">        ptr_ += stride_;</div><div class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的代码中可以看出,<code>mirror::Class::GetDirectMethods</code>方法简单来说执行了以下几步:</p>
<ol>
<li>获取Direct Method的数组</li>
<li>根据获取到的数组,封装得到Direct Method数组的<code>iterator</code>,这样就可以通过for循环迭代Direct Method数组</li>
</ol>
<h2 id="1-4-mirror-Constructor-CreateFromArtMethod"><a href="#1-4-mirror-Constructor-CreateFromArtMethod" class="headerlink" title="1.4 mirror::Constructor::CreateFromArtMethod"></a>1.4 mirror::Constructor::CreateFromArtMethod</h2><p><code>mirror::Constructor</code>类定义在<code>/art/runtime/mirror/method.h</code><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//继承自AbstractMethod, AbstractMethod定义在/art/runtime/mirror/abstract_method.h</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MANAGED</span> <span class="title">Constructor</span>:</span> <span class="keyword">public</span> AbstractMethod &#123;</div><div class="line"> <span class="keyword">public</span>:</div><div class="line">  <span class="keyword">template</span> &lt;<span class="keyword">bool</span> kTransactionActive = <span class="literal">false</span>&gt;</div><div class="line">  <span class="keyword">static</span> Constructor* CreateFromArtMethod(Thread* self, ArtMethod* method)</div><div class="line">      SHARED_REQUIRES(Locks::mutator_lock_) REQUIRES(!Roles::uninterruptible_);</div><div class="line"></div><div class="line">  <span class="keyword">static</span> mirror::<span class="function">Class* <span class="title">StaticClass</span><span class="params">()</span> <span class="title">SHARED_REQUIRES</span><span class="params">(Locks::mutator_lock_)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> static_class_.Read();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetClass</span><span class="params">(Class* klass)</span> <span class="title">SHARED_REQUIRES</span><span class="params">(Locks::mutator_lock_)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ResetClass</span><span class="params">()</span> <span class="title">SHARED_REQUIRES</span><span class="params">(Locks::mutator_lock_)</span></span>;</div><div class="line"></div><div class="line">  <span class="keyword">static</span> mirror::<span class="function">Class* <span class="title">ArrayClass</span><span class="params">()</span> <span class="title">SHARED_REQUIRES</span><span class="params">(Locks::mutator_lock_)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> array_class_.Read();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetArrayClass</span><span class="params">(Class* klass)</span> <span class="title">SHARED_REQUIRES</span><span class="params">(Locks::mutator_lock_)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ResetArrayClass</span><span class="params">()</span> <span class="title">SHARED_REQUIRES</span><span class="params">(Locks::mutator_lock_)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">VisitRoots</span><span class="params">(RootVisitor* visitor)</span> <span class="title">SHARED_REQUIRES</span><span class="params">(Locks::mutator_lock_)</span></span>;</div><div class="line"></div><div class="line"> <span class="keyword">private</span>:</div><div class="line">  <span class="keyword">static</span> GcRoot&lt;Class&gt; static_class_;  <span class="comment">// java.lang.reflect.Constructor.class.</span></div><div class="line">  <span class="keyword">static</span> GcRoot&lt;Class&gt; array_class_;  <span class="comment">// [java.lang.reflect.Constructor.class.</span></div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><code>CreateFromArtMethod</code>的实现在<code>/art/runtime/mirror/method.cc</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">bool</span> kTransactionActive&gt; <span class="comment">//kTransactionActive默认为false</span></div><div class="line">Constructor* Constructor::CreateFromArtMethod(Thread* self, ArtMethod* method) &#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">//生成java.lang.reflect.Constructor对象并转换为Constructor*指针</span></div><div class="line">    <span class="keyword">auto</span>* ret = down_cast&lt;Constructor*&gt;(StaticClass()-&gt;AllocObject(self));</div><div class="line">    <span class="keyword">if</span> (LIKELY(ret != <span class="literal">nullptr</span>)) &#123;</div><div class="line">        <span class="comment">//将Constructor*指针向上转型为AbstractMethod*指针,并调用AbstractMethod的CreateFromArtMethod</span></div><div class="line">        <span class="keyword">static_cast</span>&lt;AbstractMethod*&gt;(ret)-&gt;CreateFromArtMethod&lt;kTransactionActive&gt;(method);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//设置构造函数的基本信息,如accessFlag,methodIndex等</span></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">bool</span> kTransactionActive&gt; <span class="comment">//kTransactionActive默认为false</span></div><div class="line"><span class="keyword">bool</span> AbstractMethod::CreateFromArtMethod(ArtMethod* method) &#123;</div><div class="line">    <span class="keyword">auto</span>* interface_method = method-&gt;GetInterfaceMethodIfProxy(</div><div class="line">        kTransactionActive ? Runtime::Current()-&gt;GetClassLinker()-&gt;GetImagePointerSize()</div><div class="line">            : <span class="keyword">sizeof</span>(<span class="keyword">void</span>*));</div><div class="line">    SetArtMethod&lt;kTransactionActive&gt;(method);</div><div class="line">    SetFieldObject&lt;kTransactionActive&gt;(DeclaringClassOffset(), method-&gt;GetDeclaringClass());</div><div class="line">    SetFieldObject&lt;kTransactionActive&gt;(</div><div class="line">        DeclaringClassOfOverriddenMethodOffset(), interface_method-&gt;GetDeclaringClass());</div><div class="line">    SetField32&lt;kTransactionActive&gt;(AccessFlagsOffset(), method-&gt;GetAccessFlags());</div><div class="line">    SetField32&lt;kTransactionActive&gt;(DexMethodIndexOffset(), method-&gt;GetDexMethodIndex());</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="二-Constructor-newInstance"><a href="#二-Constructor-newInstance" class="headerlink" title="二. Constructor.newInstance"></a>二. Constructor.newInstance</h1><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public T newInstance(Object... args) throws InstantiationException,</div><div class="line">            IllegalAccessException, IllegalArgumentException, InvocationTargetException &#123;</div><div class="line">    //一般情况下,serializationClass为null          </div><div class="line">    if (serializationClass == null) &#123;</div><div class="line">        return newInstance0(args);</div><div class="line">    &#125; else &#123;</div><div class="line">        return (T) newInstanceFromSerialization(serializationCtor, serializationClass);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">private native T newInstance0(Object... args) throws InstantiationException,</div><div class="line">            IllegalAccessException, IllegalArgumentException, InvocationTargetException;</div></pre></td></tr></table></figure>
<h2 id="2-1-newInstance0"><a href="#2-1-newInstance0" class="headerlink" title="2.1 newInstance0"></a>2.1 newInstance0</h2><p><code>newInstance0</code>的实现在<code>/art/runtime/native/java_lang_refrect_Constructor</code><br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">static jobject Constructor_newInstance0(JNIEnv* env, jobject javaMethod, jobjectArray javaArgs) &#123;</div><div class="line">    ScopedFastNativeObjectAccess soa(env);</div><div class="line">    mirror::Constructor* m = soa.Decode&lt;mirror::Constructor*&gt;(javaMethod);</div><div class="line">    StackHandleScope&lt;1&gt; hs(soa.Self());</div><div class="line">    Handle&lt;mirror::Class&gt; c(hs.NewHandle(m-&gt;GetDeclaringClass()));</div><div class="line">    //抽象类不允许创建对象</div><div class="line">    if (UNLIKELY(c-&gt;IsAbstract())) &#123;</div><div class="line">      soa.Self()-&gt;ThrowNewExceptionF("Ljava/lang/InstantiationException;", "Can't instantiate %s %s",</div><div class="line">                                     c-&gt;IsInterface() ? "interface" : "abstract class",</div><div class="line">                                     PrettyDescriptor(c.Get()).c_str());</div><div class="line">      return nullptr;</div><div class="line">    &#125;</div><div class="line">    // 如果构造函数不可访问且Class不是public</div><div class="line">    if (!m-&gt;IsAccessible() &amp;&amp; !c-&gt;IsPublic()) &#123;</div><div class="line">      //回退两个栈帧,newInstance0一般都是通过Constructor.newInstance(Object... arg0)调用</div><div class="line">      auto* caller = GetCallingClass(soa.Self(), 2);</div><div class="line">      if (caller != nullptr &amp;&amp; !caller-&gt;CanAccess(c.Get())) &#123;</div><div class="line">        if (PrettyDescriptor(c.Get()) == "dalvik.system.DexPathList$Element") &#123;</div><div class="line">            LOG(WARNING) &lt;&lt; "The dalvik.system.DexPathList$Element constructor"</div><div class="line">                            is not accessible by default. This is a temporary "</div><div class="line">                            "workaround for backwards compatibility with class-loader hacks."</div><div class="line">                            "Please update your application.";</div><div class="line">        &#125; else &#123;</div><div class="line">            soa.Self()-&gt;ThrowNewExceptionF(</div><div class="line">                "Ljava/lang/IllegalAccessException;", "%s is not accessible from %s",</div><div class="line">                PrettyClass(c.Get()).c_str(), PrettyClass(caller).c_str());</div><div class="line">            return nullptr;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    //确保类已经被解析完成</div><div class="line">    if (!Runtime::Current()-&gt;GetClassLinker()-&gt;EnsureInitialized(soa.Self(), c, true, true)) &#123;</div><div class="line">      DCHECK(soa.Self()-&gt;IsExceptionPending());</div><div class="line">      return nullptr;</div><div class="line">    &#125;</div><div class="line">    bool movable = true;</div><div class="line">    //如果当前要创建对象的类是java.lang.Class</div><div class="line">    if (!kMovingClasses &amp;&amp; c-&gt;IsClassClass()) &#123;</div><div class="line">        movable = false;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // String constructor is replaced by a StringFactory method in InvokeMethod.</div><div class="line">    if (c-&gt;IsStringClass()) &#123;</div><div class="line">      return InvokeMethod(soa, javaMethod, nullptr, javaArgs, 2);</div><div class="line">    &#125;</div><div class="line">    //如果类是java.lang.Class,则调用Class::AllocNonMovableObject创建对象</div><div class="line">    mirror::Object* receiver =</div><div class="line">        movable ? c-&gt;AllocObject(soa.Self()) : c-&gt;AllocNonMovableObject(soa.Self());</div><div class="line">    if (receiver == nullptr) &#123;</div><div class="line">      return nullptr;</div><div class="line">    &#125;</div><div class="line">    jobject javaReceiver = soa.AddLocalReference&lt;jobject&gt;(receiver);</div><div class="line">    InvokeMethod(soa, javaMethod, javaReceiver, javaArgs, 2);</div><div class="line">    // Constructors are ()V methods, so we shouldn't touch the result of InvokeMethod.</div><div class="line">    return javaReceiver;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上述代码中可以得出:</p>
<ol>
<li>如果类是抽象类,则不允许创建对象</li>
<li>如果要创建的类不是public且构造函数不可访问,则抛出<code>IllegalAccessException</code>(<code>dalvik.system.DexPathList$Element</code>除外)</li>
<li>创建对象之前,要确保类已经完成了解析</li>
<li>如果要创建对象的类是<code>java.lang.String</code>,则特别对待,最终要调用<code>java.lang.StringFactory</code>来创建String对象</li>
</ol>
<h2 id="2-2-InvokeMethod"><a href="#2-2-InvokeMethod" class="headerlink" title="2.2 InvokeMethod"></a>2.2 InvokeMethod</h2><p><code>InvokeMethod</code>的实现在<code>/art/runtime/reflection.cc</code><br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="function">jobject <span class="title">InvokeMethod</span><span class="params">(<span class="keyword">const</span> ScopedObjectAccessAlreadyRunnable&amp; soa, jobject javaMethod,</span></span></div><div class="line">                     jobject javaReceiver, jobject javaArgs, <span class="keyword">size_t</span> num_frames) &#123;</div><div class="line">  <span class="comment">//如果函数调用栈不对,则抛出StackOverFlowError</span></div><div class="line">  ...</div><div class="line"></div><div class="line">  <span class="comment">//将javaMethod即java层的Constructor对象转换为mirror::AbstractMethod*</span></div><div class="line">  <span class="comment">//java层的Constructor类对应mirror::Constructor,而mirror::Constructor继承自mirror::AbstractMethod</span></div><div class="line">  <span class="keyword">auto</span>* abstract_method = soa.Decode&lt;mirror::AbstractMethod*&gt;(javaMethod);</div><div class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> accessible = abstract_method-&gt;IsAccessible();</div><div class="line">  ArtMethod* m = abstract_method-&gt;GetArtMethod();</div><div class="line"></div><div class="line">  mirror::Class* declaring_class = m-&gt;GetDeclaringClass();</div><div class="line">  <span class="comment">//一般情况下,要创建对象的类已经被解析过</span></div><div class="line">  <span class="keyword">if</span> (UNLIKELY(!declaring_class-&gt;IsInitialized())) &#123;</div><div class="line">      ...</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  mirror::Object* receiver = <span class="literal">nullptr</span>;</div><div class="line">  <span class="keyword">if</span> (!m-&gt;IsStatic()) &#123;</div><div class="line">      <span class="comment">//如果要创建对象的类是String,则用StringFactory来创建String对象</span></div><div class="line">      <span class="keyword">if</span> (declaring_class-&gt;IsStringClass() &amp;&amp; m-&gt;IsConstructor()) &#123;</div><div class="line">          jmethodID mid = soa.EncodeMethod(m);</div><div class="line">          <span class="comment">//根据methodId获取对应的StringFactory的方法</span></div><div class="line">          m = soa.DecodeMethod(WellKnownClasses::StringInitToStringFactoryMethodID(mid));</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          receiver = soa.Decode&lt;mirror::Object*&gt;(javaReceiver);</div><div class="line">          <span class="keyword">if</span> (!VerifyObjectIsClass(receiver, declaring_class)) &#123;</div><div class="line">              <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">          &#125;</div><div class="line">          <span class="comment">// 查找虚拟方法的真正实现</span></div><div class="line">          m = receiver-&gt;GetClass()-&gt;FindVirtualMethodForVirtualOrInterface(m, <span class="keyword">sizeof</span>(<span class="keyword">void</span>*));</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 将java层的参数转换为mirror::ObjectArray数组</span></div><div class="line">  <span class="keyword">auto</span>* objects = soa.Decode&lt;mirror::ObjectArray&lt;mirror::Object&gt;*&gt;(javaArgs);</div><div class="line">  <span class="keyword">auto</span>* np_method = m-&gt;GetInterfaceMethodIfProxy(<span class="keyword">sizeof</span>(<span class="keyword">void</span>*));</div><div class="line"></div><div class="line">  <span class="comment">//获取要调用的方法在dex文件中记录的参数列表</span></div><div class="line">  <span class="keyword">const</span> DexFile::TypeList* classes = np_method-&gt;GetParameterTypeList();</div><div class="line">  <span class="keyword">uint32_t</span> classes_size = (classes == <span class="literal">nullptr</span>) ? <span class="number">0</span> : classes-&gt;Size();</div><div class="line">  <span class="keyword">uint32_t</span> arg_count = (objects != <span class="literal">nullptr</span>) ? objects-&gt;GetLength() : <span class="number">0</span>;</div><div class="line">  <span class="comment">//判断传入的参数与dex文件中记录的参数是否一致,不一致抛出IllegalArgumentException</span></div><div class="line">  <span class="keyword">if</span> (arg_count != classes_size) &#123;</div><div class="line">      ...<span class="comment">//throw IllegalArgumentException</span></div><div class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 验证类的accessible</span></div><div class="line">  mirror::Class* calling_class = <span class="literal">nullptr</span>;</div><div class="line">  <span class="keyword">if</span> (!accessible &amp;&amp; !VerifyAccess(soa.Self(), receiver, declaring_class, m-&gt;GetAccessFlags(),</div><div class="line">                                   &amp;calling_class, num_frames)) &#123;</div><div class="line">      ...<span class="comment">//throw IllegalAccessException</span></div><div class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  JValue result;</div><div class="line">  <span class="keyword">uint32_t</span> shorty_len = <span class="number">0</span>;</div><div class="line">  <span class="comment">//获取method的方法声明字符串</span></div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span>* shorty = np_method-&gt;GetShorty(&amp;shorty_len);</div><div class="line">  <span class="function">ArgArray <span class="title">arg_array</span><span class="params">(shorty, shorty_len)</span></span>;</div><div class="line">  <span class="comment">//创建参数数组</span></div><div class="line">  <span class="keyword">if</span> (!arg_array.BuildArgArrayFromObjectArray(receiver, objects, np_method)) &#123;</div><div class="line">      CHECK(soa.Self()-&gt;IsExceptionPending());</div><div class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">//核心调用,执行方法, [2.3]</span></div><div class="line">  InvokeWithArgArray(soa, m, &amp;arg_array, &amp;result, shorty);</div><div class="line"></div><div class="line">  <span class="comment">// 如果有异常发生,则抛出InvocationTargetException</span></div><div class="line">  <span class="keyword">if</span> (soa.Self()-&gt;IsExceptionPending()) &#123;</div><div class="line">      ... <span class="comment">//创建InvocationTargetException对象实例,并抛出</span></div><div class="line">      <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 如果是基础类型,则自动装箱并返回</span></div><div class="line">  <span class="keyword">return</span> soa.AddLocalReference&lt;jobject&gt;(BoxPrimitive(Primitive::GetType(shorty[<span class="number">0</span>]), result));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="2-3-InvokeWithArgArray"><a href="#2-3-InvokeWithArgArray" class="headerlink" title="2.3 InvokeWithArgArray"></a>2.3 InvokeWithArgArray</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">InvokeWithArgArray</span><span class="params">(<span class="keyword">const</span> ScopedObjectAccessAlreadyRunnable&amp; soa,</span></span></div><div class="line">                               ArtMethod* method, ArgArray* arg_array, JValue* result,</div><div class="line">                               <span class="keyword">const</span> <span class="keyword">char</span>* shorty)</div><div class="line">        <span class="title">SHARED_REQUIRES</span><span class="params">(Locks::mutator_lock_)</span> &#123;</div><div class="line">    <span class="keyword">uint32_t</span>* args = arg_array-&gt;GetArray();</div><div class="line">    ...</div><div class="line">    <span class="comment">//最后实际调用ArtMethod::Invoke</span></div><div class="line">    method-&gt;Invoke(soa.Self(), args, arg_array-&gt;GetNumBytes(), result, shorty);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-4-总结"><a href="#2-4-总结" class="headerlink" title="2.4 总结"></a>2.4 总结</h2><p>可以看到最后<code>Constructor.newInstance</code>最后实际调用的是<code>ArtMethod::Invoke</code>方法,在执行<code>ArtMethod::Invoke</code>之前的所有工作主要是确保类已经被解析,以及生成参数,另外如果要创建对象的类是<code>String</code>类,则都转而调用相应的<code>StringFactory</code>的方法,由此可以看出创建String对象都是由StringFactory完成.</p>
<p><code>ArtMethod::Invoke</code>方法涉及到了方法具体的执行逻辑(执行本地机器指令还是解释执行,以及调用到其他方法是entryPoint等),另外Android 7.0还加入了JIT机制,这些需要花时间慢慢掌握.<br>下面这张图是官网的JIT的工作流程图</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3323476-3d4aa1c373e81e4b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="jit-workflow.png"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/ART的反射调用-一-获取Class对象/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/ART的反射调用-一-获取Class对象/" itemprop="url">ART的反射调用(一)-获取Class对象</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T14:24:25+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ART/" itemprop="url" rel="index">
                    <span itemprop="name">ART</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>典型的反射调用形式为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">classForName</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 获取 Class 对象</span></div><div class="line">        Class&lt;?&gt; clz = Class.forName(<span class="string">"com.xx.xx.XX"</span>);</div><div class="line">       ...</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="1-Class-forName"><a href="#1-Class-forName" class="headerlink" title="1. Class.forName"></a>1. Class.forName</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String className)</div><div class="line">                <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">    <span class="keyword">return</span> forName(className, <span class="keyword">true</span>, VMStack.getCallingClassLoader());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String name, <span class="keyword">boolean</span> initialize,ClassLoader loader)</div><div class="line">          <span class="keyword">throws</span> ClassNotFoundException&#123;</div><div class="line">    <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</div><div class="line">        loader = BootClassLoader.getInstance();</div><div class="line">    &#125;</div><div class="line">    Class&lt;?&gt; result;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        result = classForName(name, initialize, loader);</div><div class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">        Throwable cause = e.getCause();</div><div class="line">        <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> LinkageError) &#123;</div><div class="line">            <span class="keyword">throw</span> (LinkageError) cause;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">native</span> Class&lt;?&gt; classForName(String className, <span class="keyword">boolean</span> shouldInitialize,</div><div class="line">            ClassLoader classLoader) <span class="keyword">throws</span> ClassNotFoundException;</div></pre></td></tr></table></figure>
<p><code>Class.forName(String)</code>函数实际是封装调用另一个重载版本的<code>Class.forName(String,boolean,ClassLoader)</code>, 在传入第三个参数时首先调用<code>VMStack.getCallingClassLoader</code>方法，这个方法从函数名中大致可以判断出它的作用是获取当前调用者ClassLoader，最后再调用本地方法<code>classForName</code></p>
<h3 id="1-1-VMStack-getCallingClassLoader"><a href="#1-1-VMStack-getCallingClassLoader" class="headerlink" title="1.1 VMStack.getCallingClassLoader"></a>1.1 VMStack.getCallingClassLoader</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">native</span> <span class="keyword">public</span> <span class="keyword">static</span> ClassLoader <span class="title">getCallingClassLoader</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">// 定义在art/runtime/native/dalvik_system_VMStack.cc</div><div class="line">static jobject VMStack_getCallingClassLoader(JNIEnv* env, jclass) &#123;</div><div class="line">  ScopedFastNativeObjectAccess soa(env);</div><div class="line">  NthCallerVisitor visitor(soa.Self(), 2);</div><div class="line">  visitor.WalkStack();</div><div class="line">  if (UNLIKELY(visitor.caller == nullptr)) &#123;</div><div class="line">    // The caller is an attached native thread.</div><div class="line">    return nullptr;</div><div class="line">  &#125;</div><div class="line">  return soa.AddLocalReference&lt;jobject&gt;(visitor.caller-&gt;GetDeclaringClass()-&gt;GetClassLoader());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法的核心调用是<code>visitor.WalkStack()</code>，WalkStack()的实现在<code>art/runtime/stack.cc</code>,具体的实现这里先不深究(由于时间原因，这块内容还未理解透彻)，不过从代码中可以大致看出WalkStack()方法是根据函数调用栈帧获取到当前调用者，继而获取对应的<code>ClassLoader</code></p>
<h2 id="2-Class-classForName"><a href="#2-Class-classForName" class="headerlink" title="2. Class_classForName"></a>2. Class_classForName</h2><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">static jclass Class_classForName(JNIEnv* env, jclass, jstring javaName, jboolean initialize,</div><div class="line">                                 jobject javaLoader) &#123;</div><div class="line">    ScopedFastNativeObjectAccess soa(env);</div><div class="line">    ScopedUtfChars name(env, javaName);</div><div class="line">    if (name.c_str() == nullptr) &#123;</div><div class="line">        return nullptr;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 将com.xx.xx转换为com/xx/xx</div><div class="line">    if (!IsValidBinaryClassName(name.c_str())) &#123;</div><div class="line">        soa.Self()-&gt;ThrowNewExceptionF("Ljava/lang/ClassNotFoundException;",</div><div class="line">                                       "Invalid name: %s", name.c_str());</div><div class="line">        return nullptr;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    std::string descriptor(DotToDescriptor(name.c_str()));</div><div class="line">    StackHandleScope&lt;2&gt; hs(soa.Self());</div><div class="line">    Handle&lt;mirror::ClassLoader&gt; class_loader(hs.NewHandle(soa.Decode&lt;mirror::ClassLoader*&gt;(javaLoader)));</div><div class="line">    ClassLinker* class_linker = Runtime::Current()-&gt;GetClassLinker();</div><div class="line">    //核心调用，调用ClassLinker::FindClass()</div><div class="line">    Handle&lt;mirror::Class&gt; c(</div><div class="line">        hs.NewHandle(class_linker-&gt;FindClass(soa.Self(), descriptor.c_str(), class_loader)));</div><div class="line">    if (c.Get() == nullptr) &#123;</div><div class="line">        ScopedLocalRef&lt;jthrowable&gt; cause(env, env-&gt;ExceptionOccurred());</div><div class="line">        env-&gt;ExceptionClear();</div><div class="line">        jthrowable cnfe = reinterpret_cast&lt;jthrowable&gt;(env-&gt;NewObject(WellKnownClasses::java_lang_ClassNotFoundException,</div><div class="line">                                                                      WellKnownClasses::java_lang_ClassNotFoundException_init,</div><div class="line">                                                                      javaName, cause.get()));</div><div class="line">        if (cnfe != nullptr) &#123;</div><div class="line">            // Make sure allocation didn't fail with an OOME.</div><div class="line">            env-&gt;Throw(cnfe);</div><div class="line">        &#125;</div><div class="line">        return nullptr;</div><div class="line">    &#125;</div><div class="line">    if (initialize) &#123;</div><div class="line">        //确保类已经完成解析</div><div class="line">        class_linker-&gt;EnsureInitialized(soa.Self(), c, true, true);</div><div class="line">    &#125;</div><div class="line">    return soa.AddLocalReference&lt;jclass&gt;(c.Get());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从代码中可以看出核心调用是<code>class_linker-&gt;FindClass(...)</code></p>
<h2 id="3-ClassLinker-FindClass"><a href="#3-ClassLinker-FindClass" class="headerlink" title="3. ClassLinker::FindClass"></a>3. ClassLinker::FindClass</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line">mirror::Class* ClassLinker::FindClass(Thread* self,</div><div class="line">                                      const char* descriptor,</div><div class="line">                                      Handle&lt;mirror::ClassLoader&gt; class_loader) &#123;</div><div class="line">    ...</div><div class="line">    self-&gt;AssertNoPendingException();</div><div class="line">    if (descriptor[1] == &apos;\0&apos;) &#123;</div><div class="line">        // 只有基础类型的descriptor是1个字符</div><div class="line">        return FindPrimitiveClass(descriptor[0]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    const size_t hash = ComputeModifiedUtf8Hash(descriptor);</div><div class="line">    // 在传入的ClassLoader的已加载表中查找类, [3.1]</div><div class="line">    mirror::Class* klass = LookupClass(self, descriptor, hash, class_loader.Get());</div><div class="line">    if (klass != nullptr) &#123;</div><div class="line">        //确保类已经被解析</div><div class="line">        return EnsureResolved(self, descriptor, klass);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 执行到这里，意味着没有找到类</div><div class="line">    if (descriptor[0] == &apos;[&apos;) &#123;</div><div class="line">        return CreateArrayClass(self, descriptor, hash, class_loader);</div><div class="line">    &#125; else if (class_loader.Get() == nullptr) &#123;</div><div class="line">        // 如果ClassLoader是nullptr，则在boot_class_path_中查找</div><div class="line">        ClassPathEntry pair = FindInClassPath(descriptor, hash, boot_class_path_);</div><div class="line">        if (pair.second != nullptr) &#123;</div><div class="line">            return DefineClass(self,</div><div class="line">                           descriptor,</div><div class="line">                           hash,</div><div class="line">                           ScopedNullHandle&lt;mirror::ClassLoader&gt;(),</div><div class="line">                           *pair.first,</div><div class="line">                           *pair.second);</div><div class="line">        &#125; else &#123;</div><div class="line">            //仍然没有找到的话，创建一个ClassNoDefFoundError</div><div class="line">            mirror::Throwable* pre_allocated = Runtime::Current()-&gt;GetPreAllocatedNoClassDefFoundError();</div><div class="line">            self-&gt;SetException(pre_allocated);</div><div class="line">            return nullptr;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        ScopedObjectAccessUnchecked soa(self);</div><div class="line">        mirror::Class* cp_klass;</div><div class="line">        //递归的在传入的ClassLoader以及它的各级parent中查找类, [3.2]</div><div class="line">        if (FindClassInPathClassLoader(soa, self, descriptor, hash, class_loader, &amp;cp_klass)) &#123;</div><div class="line">            if (cp_klass != nullptr) &#123;</div><div class="line">              //找到，直接返回</div><div class="line">              return cp_klass;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        //如果Runtime是编译器，则直接创建ClassNoDefFoundError,只有在dex2oat中创建的Runtime会是编译器</div><div class="line">        if (Runtime::Current()-&gt;IsAotCompiler()) &#123;</div><div class="line">            mirror::Throwable* pre_allocated = Runtime::Current()-&gt;GetPreAllocatedNoClassDefFoundError();</div><div class="line">            self-&gt;SetException(pre_allocated);</div><div class="line">            return nullptr;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        //执行到意味着仍然没有找到相应的类</div><div class="line">        ScopedLocalRef&lt;jobject&gt; class_loader_object(soa.Env(),</div><div class="line">                                                    soa.AddLocalReference&lt;jobject&gt;(class_loader.Get()));</div><div class="line">        std::string class_name_string(DescriptorToDot(descriptor));</div><div class="line"></div><div class="line">        ScopedLocalRef&lt;jobject&gt; result(soa.Env(), nullptr);</div><div class="line">        &#123;</div><div class="line">            ScopedThreadStateChange tsc(self, kNative);</div><div class="line">            ScopedLocalRef&lt;jobject&gt; class_name_object(soa.Env(),</div><div class="line">                                                      soa.Env()-&gt;NewStringUTF(class_name_string.c_str()));</div><div class="line">            if (class_name_object.get() == nullptr) &#123;</div><div class="line">                return nullptr;</div><div class="line">            &#125;</div><div class="line">            //调用ClassLoader的loadClass在传入的ClassLoader中查找</div><div class="line">            result.reset(soa.Env()-&gt;CallObjectMethod(class_loader_object.get(),</div><div class="line">                                                     WellKnownClasses::java_lang_ClassLoader_loadClass,</div><div class="line">                                                     class_name_object.get()));</div><div class="line">        &#125;</div><div class="line">        if (self-&gt;IsExceptionPending()) &#123;</div><div class="line">            // If the ClassLoader threw, pass that exception up.</div><div class="line">            return nullptr;</div><div class="line">        &#125; else if (result.get() == nullptr) &#123;</div><div class="line">            //　抛出NullPointerException</div><div class="line">            ThrowNullPointerException(StringPrintf(&quot;ClassLoader.loadClass returned null for %s&quot;,</div><div class="line">                                                   class_name_string.c_str()).c_str());</div><div class="line">            return nullptr;</div><div class="line">        &#125; else &#123;</div><div class="line">            // 终于找到</div><div class="line">            return soa.Decode&lt;mirror::Class*&gt;(result.get());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    UNREACHABLE();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>ClassLinker::FindClass</code>的逻辑可以总结为：</p>
<ol>
<li>如果要找的类是基础类型，则直接调用<code>FindPrimitiveClass</code>查找基础类型；如果不是则在传入的ClassLoader的已加载类表中查找类(首先会判断ClassLaoder是否为null，如果为null,就在<code>boot_class_table_</code>中查找，否则就在ClassLoader自己的<code>ClassTable</code>中查找)，如果找到，确保类已经被解析并返回</li>
<li>如果在传入的ClassLoader的已加载类表中没有找到类,则首先判断ClassLoader是否为空，如果为空，在<code>boot_class_path_</code>中查找，如果不为空，则调用<code>FindClassInPathClassLoader</code>在传入的ClassLoader以及它的各级parent中查找类</li>
<li>如果仍然没有找到，则调用传入的ClassLoader的<code>loadClass</code>在传入的ClassLoader中查找，找到返回，否则抛出异常</li>
</ol>
<h3 id="3-1-ClassLinker-LookupClass"><a href="#3-1-ClassLinker-LookupClass" class="headerlink" title="3.1 ClassLinker::LookupClass"></a>3.1 ClassLinker::LookupClass</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">mirror::Class* ClassLinker::LookupClass(Thread* self,</div><div class="line">                                        <span class="keyword">const</span> <span class="keyword">char</span>* descriptor,</div><div class="line">                                        <span class="keyword">size_t</span> hash,</div><div class="line">                                        mirror::ClassLoader* class_loader) &#123;</div><div class="line">    &#123;</div><div class="line">        <span class="function">ReaderMutexLock <span class="title">mu</span><span class="params">(self, *Locks::classlinker_classes_lock_)</span></span>;</div><div class="line">        <span class="comment">//获取ClassLoader对应的ClassTable，如果ClassLoader为null,则则返回boot_class_table_</span></div><div class="line">        ClassTable* <span class="keyword">const</span> class_table = ClassTableForClassLoader(class_loader);</div><div class="line">        <span class="keyword">if</span> (class_table != <span class="literal">nullptr</span>) &#123;</div><div class="line">            mirror::Class* result = class_table-&gt;Lookup(descriptor, hash);</div><div class="line">            <span class="keyword">if</span> (result != <span class="literal">nullptr</span>) &#123;</div><div class="line">                <span class="keyword">return</span> result;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (class_loader != <span class="literal">nullptr</span> || !dex_cache_boot_image_class_lookup_required_) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//在Image Space中查找类，Image Space映射的是boot.art和boot.oat</span></div><div class="line">    mirror::Class* result = LookupClassFromBootImage(descriptor);</div><div class="line">    <span class="keyword">if</span> (result != <span class="literal">nullptr</span>) &#123;</div><div class="line">        result = InsertClass(descriptor, result, hash);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">constexpr</span> <span class="keyword">uint32_t</span> kMaxFailedDexCacheLookups = <span class="number">1000</span>;</div><div class="line">        <span class="keyword">if</span> (++failed_dex_cache_class_lookups_ &gt; kMaxFailedDexCacheLookups) &#123;</div><div class="line">            AddBootImageClassesToClassTable();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">ClassTable* ClassLinker::ClassTableForClassLoader(mirror::ClassLoader* class_loader) &#123;</div><div class="line">    <span class="keyword">return</span> class_loader == <span class="literal">nullptr</span> ? &amp;boot_class_table_ : class_loader-&gt;GetClassTable();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-ClassLinker-FindClassInPathClassLoader"><a href="#3-2-ClassLinker-FindClassInPathClassLoader" class="headerlink" title="3.2 ClassLinker::FindClassInPathClassLoader"></a>3.2 ClassLinker::FindClassInPathClassLoader</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> ClassLinker::FindClassInPathClassLoader(ScopedObjectAccessAlreadyRunnable&amp; soa,</div><div class="line">                                             Thread* self,</div><div class="line">                                             <span class="keyword">const</span> <span class="keyword">char</span>* descriptor,</div><div class="line">                                             <span class="keyword">size_t</span> hash,</div><div class="line">                                             Handle&lt;mirror::ClassLoader&gt; class_loader,</div><div class="line">                                             mirror::Class** result) &#123;</div><div class="line">    <span class="comment">//递归调用的终止条件</span></div><div class="line">    <span class="comment">//如果是BootClassLoader,在boot_class_path_中查找类，并完成类的解析</span></div><div class="line">    <span class="keyword">if</span> (IsBootClassLoader(soa, class_loader.Get())) &#123;</div><div class="line">        ClassPathEntry pair = FindInClassPath(descriptor, hash, boot_class_path_);</div><div class="line">        <span class="keyword">if</span> (pair.second != <span class="literal">nullptr</span>) &#123;</div><div class="line">            mirror::Class* klass = LookupClass(self, descriptor, hash, <span class="literal">nullptr</span>);</div><div class="line">            <span class="keyword">if</span> (klass != <span class="literal">nullptr</span>) &#123;</div><div class="line">              *result = EnsureResolved(self, descriptor, klass);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">              *result = DefineClass(self,descriptor,hash,</div><div class="line">                                    ScopedNullHandle&lt;mirror::ClassLoader&gt;(),</div><div class="line">                                    *pair.first,</div><div class="line">                                    *pair.second);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (*result == <span class="literal">nullptr</span>) &#123;</div><div class="line">              self-&gt;ClearException();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            *result = <span class="literal">nullptr</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//递归调用的终止条件</span></div><div class="line">    <span class="comment">//确保传入的ClassLoader必须是PathClassLoader</span></div><div class="line">    <span class="keyword">if</span> (class_loader-&gt;GetClass() != soa.Decode&lt;mirror::Class*&gt;(</div><div class="line">                        WellKnownClasses::dalvik_system_PathClassLoader)) &#123;</div><div class="line">      *result = <span class="literal">nullptr</span>;</div><div class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Handles as RegisterDexFile may allocate dex caches (and cause thread suspension).</span></div><div class="line">    StackHandleScope&lt;<span class="number">4</span>&gt; hs(self);</div><div class="line">    Handle&lt;mirror::ClassLoader&gt; h_parent(hs.NewHandle(class_loader-&gt;GetParent()));</div><div class="line">    <span class="comment">//递归调用,在parent中查找,一般情况下，一个应用的PathClassLoader的parent层级为：</span></div><div class="line">    <span class="comment">//PathClassLoader(apk)--&gt;PathClassLoader(system)-&gt;BootClassLoader</span></div><div class="line">    <span class="comment">//所以一般情况下，传入的ClassLoader的parent就是系统的PathClassLoader, 从而递归调用只会调用两次，即</span></div><div class="line">    <span class="comment">//h_parent第一次等于PathClassLoader(system),第二次h_parent等于BootClassLoader</span></div><div class="line">    <span class="keyword">bool</span> recursive_result = FindClassInPathClassLoader(soa, self, descriptor, hash, h_parent, result);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!recursive_result) &#123;</div><div class="line">        <span class="comment">// Something wrong up the chain.</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (*result != <span class="literal">nullptr</span>) &#123;</div><div class="line">        <span class="comment">// Found the class up the chain.</span></div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取DexFile的mCookie变量，mCookie指向的是已加载的dex文件列表</span></div><div class="line">    ArtField* <span class="keyword">const</span> cookie_field = soa.DecodeField(WellKnownClasses::dalvik_system_DexFile_cookie);</div><div class="line">    <span class="comment">//获取DexPathList的dexElements</span></div><div class="line">    ArtField* <span class="keyword">const</span> dex_file_field =</div><div class="line">        soa.DecodeField(WellKnownClasses::dalvik_system_DexPathList__Element_dexFile);</div><div class="line">    <span class="comment">//获取PathClassLoader的pathList属性</span></div><div class="line">    mirror::Object* dex_path_list =</div><div class="line">        soa.DecodeField(WellKnownClasses::dalvik_system_PathClassLoader_pathList)-&gt;</div><div class="line">        GetObject(class_loader.Get());</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (dex_path_list != <span class="literal">nullptr</span> &amp;&amp; dex_file_field != <span class="literal">nullptr</span> &amp;&amp; cookie_field != <span class="literal">nullptr</span>) &#123;</div><div class="line">        mirror::Object* dex_elements_obj =</div><div class="line">            soa.DecodeField(WellKnownClasses::dalvik_system_DexPathList_dexElements)-&gt;</div><div class="line">            GetObject(dex_path_list);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (dex_elements_obj != <span class="literal">nullptr</span>) &#123;</div><div class="line">            Handle&lt;mirror::ObjectArray&lt;mirror::Object&gt;&gt; dex_elements =</div><div class="line">                hs.NewHandle(dex_elements_obj-&gt;AsObjectArray&lt;mirror::Object&gt;());</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int32_t</span> i = <span class="number">0</span>; i &lt; dex_elements-&gt;GetLength(); ++i) &#123;</div><div class="line">                mirror::Object* element = dex_elements-&gt;GetWithoutChecks(i);</div><div class="line">                <span class="keyword">if</span> (element == <span class="literal">nullptr</span>) &#123;</div><div class="line">                    <span class="comment">// Should never happen, fall back to java code to throw a NPE.</span></div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                mirror::Object* dex_file = dex_file_field-&gt;GetObject(element);</div><div class="line">                <span class="keyword">if</span> (dex_file != <span class="literal">nullptr</span>) &#123;</div><div class="line">                  <span class="comment">//将mCookie转换为LongArray*类型</span></div><div class="line">                  mirror::LongArray* long_array = cookie_field-&gt;GetObject(dex_file)-&gt;AsLongArray();</div><div class="line">                  <span class="keyword">if</span> (long_array == <span class="literal">nullptr</span>) &#123;</div><div class="line">                      <span class="keyword">break</span>;</div><div class="line">                  &#125;</div><div class="line">                  <span class="keyword">int32_t</span> long_array_size = long_array-&gt;GetLength();</div><div class="line">                  <span class="keyword">for</span> (<span class="keyword">int32_t</span> j = kDexFileIndexStart; j &lt; long_array_size; ++j) &#123;</div><div class="line">                      <span class="comment">//将LongArray转换为DexFile*类型</span></div><div class="line">                      <span class="keyword">const</span> DexFile* cp_dex_file = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> DexFile*&gt;(<span class="keyword">static_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(</div><div class="line">                          long_array-&gt;GetWithoutChecks(j)));</div><div class="line">                      <span class="comment">//查找ClassDef</span></div><div class="line">                      <span class="keyword">const</span> DexFile::ClassDef* dex_class_def = cp_dex_file-&gt;FindClassDef(descriptor, hash);</div><div class="line">                      <span class="keyword">if</span> (dex_class_def != <span class="literal">nullptr</span>) &#123;</div><div class="line">                          <span class="comment">//解析类，加载属性，方法</span></div><div class="line">                          mirror::Class* klass = DefineClass(self,</div><div class="line">                                                             descriptor,</div><div class="line">                                                             hash,</div><div class="line">                                                             class_loader,</div><div class="line">                                                             *cp_dex_file,</div><div class="line">                                                             *dex_class_def);</div><div class="line">                          <span class="keyword">if</span> (klass == <span class="literal">nullptr</span>) &#123;</div><div class="line">                            self-&gt;ClearException();</div><div class="line">                            <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">                          &#125;</div><div class="line">                          *result = klass;</div><div class="line">                          <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">                      &#125;</div><div class="line">                  &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      self-&gt;AssertNoPendingException();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Result is still null from the parent call, no need to set it again...</span></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>FindClassInPathClassLoader</code>主要逻辑是<strong>递归的在传入的ClassLoader的各级parent中依次查找类(典型的双亲委派模式)</strong> , 一般情况下，一个应用的PathClassLoader的parent层级为：｀PathClassLoader(apk)–&gt;PathClassLoader(system)-&gt;BootClassLoader｀所以一般情况下，传入的ClassLoader的parent就是系统的PathClassLoader, 从而递归调用只会调用两次，即h_parent第一次等于PathClassLoader(system),第二次h_parent等于BootClassLoader. 在双亲中如果找到类，则直接返回，如果没有找到，则依次获取几个重要的变量<code>BaseDexClassLoader.pathList, DexPathList.dexElement, DexFile.mCookie</code>,根据这几个变量在传入的ClassLoader所加载的dex文件列表中查找类</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>一般而言，反射获取一个类时会调用<code>Class.forName(String)</code>，获取类的过程可以总结为以下几步：</p>
<ol>
<li>根据函数调用栈帧获取调用者的ClassLoader(如果调用的是<code>Class.forName(String, boolean, ClassLoader)</code>,就没有根据栈帧获取ClassLoader这一步)</li>
<li>每一个ClassLoader都有一个ClassTable,用来缓存已经加载的类．如果传入的ClassLoader为null,就在BootClassLoader对应的<code>boot_class_table_</code>中查找，如果ClassLaoder不为null,就在ClassLoader对应的ClassTable中查找；如果找到Class，确保Class已经解析后,返回，否则进入下一步</li>
<li>如果没有在缓存的ClassTable中找到类，首先判断传入的ClassLoader是否为null,如果是，就在<code>boot_class_path_</code>中查找，如果不是，则递归的依次在传入的ClassLoader各级parent以及自身当中查找类(除了<code>BootClassLoader</code>,其余parent以及自身ClassLoader都必须是<code>PathClassLoader</code>,查找类主要是通过在Java层的几个重要变量完成:<code>BaseDexClassLoader.pathList, DexPathList.dexElement, DexFile.mCookie</code>),如果找到则返回(查找的过程中，如果找到了类，会完成对类的解析过程)，如果没找到则再进入下一步</li>
<li>以上几步都没有找到的话，再调用传入的ClassLoader的<code>loadClass</code>进行最后一次查找(<code>loadClass</code>的过程中如果找到类，也会完成对类的解析)，找到则返回，没找到则抛出异常</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/img/avatar.jpg"
               alt="王小宝" />
          <p class="site-author-name" itemprop="name">王小宝</p>
           
              <p class="site-description motion-element" itemprop="description">90后迷途小书童</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/wangyun137" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/73df471e39bb" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  简书
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">王小宝</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
