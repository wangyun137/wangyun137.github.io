<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="迷途小书童" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="90后迷途小书童">
<meta property="og:type" content="website">
<meta property="og:title" content="迷途小书童">
<meta property="og:url" content="https://wangyun137.github.io/index.html">
<meta property="og:site_name" content="迷途小书童">
<meta property="og:description" content="90后迷途小书童">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="迷途小书童">
<meta name="twitter:description" content="90后迷途小书童">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://wangyun137.github.io/"/>





  <title>迷途小书童</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">迷途小书童</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">遇见一个人可能只要一秒，喜欢一个人可能需要一天，忘记一个人却需要一辈子</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-/"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/ArrayMap源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/ArrayMap源码分析/" itemprop="url">ArrayMap源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:54:42+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java集合类源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">Java集合类源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>ArrayMap</code>是Android提供的一种替换<code>HashMap</code>的数据结构，官方对它的介绍说ArrayMap是一种更有效率的Map结构，其原理是内部维护了两个数组，一个数组用来保存每一个key值得hash值，另一个数组用来保存key-value, 用来保存key-value的数组是保存hash值数组大小的两倍，下面这张图很好的展示了ArrayMap原理:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/3323476-6ee1a9f59e86ba75.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ArrayMap.png"></p>
<p>来源<a href="http://www.jianshu.com/p/7b9a1b386265" target="_blank" rel="external">HashMap，ArrayMap，SparseArray源码分析及性能对比</a></p>
<h1 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BASE_SIZE = <span class="number">4</span>;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CACHE_SIZE = <span class="number">10</span>;</div><div class="line"></div><div class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] EMPTY_IMMUTABLE_INTS = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>];</div><div class="line"></div><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ArrayMap EMPTY = <span class="keyword">new</span> ArrayMap&lt;&gt;(-<span class="number">1</span>);</div><div class="line"></div><div class="line"><span class="comment">//缓存相关</span></div><div class="line">   <span class="keyword">static</span> Object[] mBaseCache;</div><div class="line">   <span class="keyword">static</span> <span class="keyword">int</span> mBaseCacheSize;</div><div class="line">   <span class="keyword">static</span> Object[] mTwiceBaseCache;</div><div class="line">   <span class="keyword">static</span> <span class="keyword">int</span> mTwiceBaseCacheSize;</div><div class="line"></div><div class="line">   <span class="keyword">final</span> <span class="keyword">boolean</span> mIdentityHashCode;</div><div class="line">   <span class="keyword">int</span>[] mHashes;</div><div class="line">   Object[] mArray;</div><div class="line">   <span class="keyword">int</span> mSize;</div><div class="line">   <span class="comment">//集合操作工具类</span></div><div class="line">   MapCollections&lt;K, V&gt; mCollections;</div></pre></td></tr></table></figure>
<ul>
<li><code>mHashes</code>用来存放key值相对应的hash值</li>
<li><code>mArray</code>用来存放key-value, key值在2n处， value在2n+1处</li>
<li>ArrayMap还加入了缓存，<code>mBaseCache</code>用来缓存容量为<code>BASE_SIZE</code>的数组，<code>mTwiceBaseCache</code>用来缓存容量为<code>2 * BASE_SIZE</code>的数组</li>
</ul>
<h1 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ArrayMap</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>(<span class="number">0</span>, <span class="keyword">false</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ArrayMap</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>(capacity, <span class="keyword">false</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line"><span class="comment">/** &#123;<span class="doctag">@hide</span>&#125; */</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ArrayMap</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">boolean</span> identityHashCode)</span> </span>&#123;</div><div class="line">       mIdentityHashCode = identityHashCode;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (capacity &lt; <span class="number">0</span>) &#123;</div><div class="line">           mHashes = EMPTY_IMMUTABLE_INTS;</div><div class="line">           mArray = EmptyArray.OBJECT;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (capacity == <span class="number">0</span>) &#123;</div><div class="line">           mHashes = EmptyArray.INT;</div><div class="line">           mArray = EmptyArray.OBJECT;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           allocArrays(capacity);</div><div class="line">       &#125;</div><div class="line">       mSize = <span class="number">0</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ArrayMap</span><span class="params">(ArrayMap&lt;K, V&gt; map)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>();</div><div class="line">       <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</div><div class="line">           putAll(map);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>一般情况下，在开发中我们主要使用空参构造函数和一个参数的构造函数，不过这两个构造函数都是调用了第三个hide的构造函数, 这个构造函数中主要工作就是分配数组</p>
<h2 id="allocArrays"><a href="#allocArrays" class="headerlink" title="allocArrays"></a>allocArrays</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">allocArrays</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> size)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mHashes == EMPTY_IMMUTABLE_INTS) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"ArrayMap is immutable"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (size == (BASE_SIZE*<span class="number">2</span>)) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (ArrayMap.class) &#123;</div><div class="line">                <span class="keyword">if</span> (mTwiceBaseCache != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> Object[] array = mTwiceBaseCache;</div><div class="line">                    mArray = array;</div><div class="line">                    mTwiceBaseCache = (Object[])array[<span class="number">0</span>];</div><div class="line">                    mHashes = (<span class="keyword">int</span>[])array[<span class="number">1</span>];</div><div class="line">                    array[<span class="number">0</span>] = array[<span class="number">1</span>] = <span class="keyword">null</span>;</div><div class="line">                    mTwiceBaseCacheSize--;</div><div class="line">                    <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"Retrieving 2x cache "</span> + mHashes</div><div class="line">                            + <span class="string">" now have "</span> + mTwiceBaseCacheSize + <span class="string">" entries"</span>);</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (size == BASE_SIZE) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (ArrayMap.class) &#123;</div><div class="line">                <span class="keyword">if</span> (mBaseCache != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">final</span> Object[] array = mBaseCache;</div><div class="line">                    mArray = array;</div><div class="line">                    mBaseCache = (Object[])array[<span class="number">0</span>];</div><div class="line">                    mHashes = (<span class="keyword">int</span>[])array[<span class="number">1</span>];</div><div class="line">                    <span class="comment">//将缓存置为null</span></div><div class="line">                    array[<span class="number">0</span>] = array[<span class="number">1</span>] = <span class="keyword">null</span>;</div><div class="line">                    <span class="comment">//递减mBaseCacheSize</span></div><div class="line">                    mBaseCacheSize--;</div><div class="line">                    <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"Retrieving 1x cache "</span> + mHashes</div><div class="line">                            + <span class="string">" now have "</span> + mBaseCacheSize + <span class="string">" entries"</span>);</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mHashes = <span class="keyword">new</span> <span class="keyword">int</span>[size];</div><div class="line">        mArray = <span class="keyword">new</span> Object[size&lt;&lt;<span class="number">1</span>];</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从代码中可以看到，如果分配的size恰好等于4或者8, 则ArrayMap会优先在缓存中找，如果有缓存则直接使用缓存的数组，这样就避免了频繁的创建数组带来的内存消耗</p>
<h1 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h1><h1 id="1-put"><a href="#1-put" class="headerlink" title="1. put"></a>1. put</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> hash;</div><div class="line">       <span class="keyword">int</span> index;</div><div class="line">       <span class="comment">//查找key值对应的index,如果找到则为正数，否则为负数，代表了将要被插入的位置</span></div><div class="line">       <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</div><div class="line">           hash = <span class="number">0</span>;</div><div class="line">           <span class="comment">//【1.1】</span></div><div class="line">           index = indexOfNull();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           hash = mIdentityHashCode ? System.identityHashCode(key) : key.hashCode();</div><div class="line">           index = indexOf(key, hash);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//已存在key值，直接覆盖为新值</span></div><div class="line">       <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</div><div class="line">           index = (index&lt;&lt;<span class="number">1</span>) + <span class="number">1</span>;</div><div class="line">           <span class="keyword">final</span> V old = (V)mArray[index];</div><div class="line">           mArray[index] = value;</div><div class="line">           <span class="keyword">return</span> old;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//key值并不存在，则对index取反，获取将要被插入的index</span></div><div class="line">       index = ~index;</div><div class="line">       <span class="keyword">if</span> (mSize &gt;= mHashes.length) &#123;</div><div class="line">           <span class="comment">//确定扩容的容量</span></div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> n = mSize &gt;= (BASE_SIZE*<span class="number">2</span>) ? (mSize+(mSize&gt;&gt;<span class="number">1</span>))</div><div class="line">                   : (mSize &gt;= BASE_SIZE ? (BASE_SIZE*<span class="number">2</span>) : BASE_SIZE);</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"put: grow from "</span> + mHashes.length + <span class="string">" to "</span> + n);</div><div class="line"></div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span>[] ohashes = mHashes;</div><div class="line">           <span class="keyword">final</span> Object[] oarray = mArray;</div><div class="line">           <span class="comment">//重新分配数组，如果满足缓存条件，使用缓存</span></div><div class="line">           allocArrays(n);</div><div class="line"></div><div class="line">           <span class="comment">//迁移数组</span></div><div class="line">           <span class="keyword">if</span> (mHashes.length &gt; <span class="number">0</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"put: copy 0-"</span> + mSize + <span class="string">" to 0"</span>);</div><div class="line">               System.arraycopy(ohashes, <span class="number">0</span>, mHashes, <span class="number">0</span>, ohashes.length);</div><div class="line">               System.arraycopy(oarray, <span class="number">0</span>, mArray, <span class="number">0</span>, oarray.length);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">//释放之前的数组，如果之前的数组满足缓存条件，则将数组缓存起来, 【1.2】</span></div><div class="line">           freeArrays(ohashes, oarray, mSize);</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       <span class="comment">//插入数据</span></div><div class="line">       <span class="keyword">if</span> (index &lt; mSize) &#123;</div><div class="line">           <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"put: move "</span> + index + <span class="string">"-"</span> + (mSize-index)</div><div class="line">                   + <span class="string">" to "</span> + (index+<span class="number">1</span>));</div><div class="line">           System.arraycopy(mHashes, index, mHashes, index + <span class="number">1</span>, mSize - index);</div><div class="line">           System.arraycopy(mArray, index &lt;&lt; <span class="number">1</span>, mArray, (index + <span class="number">1</span>) &lt;&lt; <span class="number">1</span>, (mSize - index) &lt;&lt; <span class="number">1</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       mHashes[index] = hash;</div><div class="line">       mArray[index&lt;&lt;<span class="number">1</span>] = key;</div><div class="line">       mArray[(index&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>] = value;</div><div class="line">       mSize++;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>查找key值对应的index, 这里使用的也是二分搜索法，如果key值已存在则index为正数，否则为负数</li>
<li>如果key值已存在，直接覆盖为新值</li>
<li>如果key值不存在，对index取反</li>
<li>如果容量不够，进行扩容操作，生成新的数组，如果满足缓存条件，还会将就数组缓存起来避免频繁分配数组，之后前移现有数据到新数组</li>
<li>插入数据</li>
</ol>
<h2 id="1-1-indexOfNull"><a href="#1-1-indexOfNull" class="headerlink" title="1.1 indexOfNull"></a>1.1 indexOfNull</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">indexOfNull</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = mSize;</div><div class="line"></div><div class="line">    <span class="comment">//如果数组为空，那么什么也不做</span></div><div class="line">    <span class="keyword">if</span> (N == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> ~<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//二分搜索</span></div><div class="line">    <span class="keyword">int</span> index = ContainerHelpers.binarySearch(mHashes, N, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">//index &lt; 0 代表数组中并不存在key,直接返回</span></div><div class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> index;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//如果index处对应的key值恰好就是null, 则直接返回index</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == mArray[index&lt;&lt;<span class="number">1</span>]) &#123;</div><div class="line">        <span class="keyword">return</span> index;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//从index后面找寻是否存在key为null</span></div><div class="line">    <span class="keyword">int</span> end;</div><div class="line">    <span class="keyword">for</span> (end = index + <span class="number">1</span>; end &lt; N &amp;&amp; mHashes[end] == <span class="number">0</span>; end++) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mArray[end &lt;&lt; <span class="number">1</span>]) <span class="keyword">return</span> end;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//从index前面找寻是否存在key为null</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = index - <span class="number">1</span>; i &gt;= <span class="number">0</span> &amp;&amp; mHashes[i] == <span class="number">0</span>; i--) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == mArray[i &lt;&lt; <span class="number">1</span>]) <span class="keyword">return</span> i;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//都没找到，返回将要被插入的索引位置的负数</span></div><div class="line">    <span class="keyword">return</span> ~end;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> <code>indexOf</code>的实现与<code>indexOfNull</code>基本一样，只不过<code>indexOfNull</code>是判断key值是否等于null</p>
<h2 id="1-2-freeArrays"><a href="#1-2-freeArrays" class="headerlink" title="1.2 freeArrays"></a>1.2 freeArrays</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">freeArrays</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span>[] hashes, <span class="keyword">final</span> Object[] array, <span class="keyword">final</span> <span class="keyword">int</span> size)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (hashes.length == (BASE_SIZE*<span class="number">2</span>)) &#123;</div><div class="line">           <span class="keyword">synchronized</span> (ArrayMap.class) &#123;</div><div class="line">               <span class="keyword">if</span> (mTwiceBaseCacheSize &lt; CACHE_SIZE) &#123;</div><div class="line">                   array[<span class="number">0</span>] = mTwiceBaseCache;</div><div class="line">                   array[<span class="number">1</span>] = hashes;</div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i=(size&lt;&lt;<span class="number">1</span>)-<span class="number">1</span>; i&gt;=<span class="number">2</span>; i--) &#123;</div><div class="line">                       array[i] = <span class="keyword">null</span>;</div><div class="line">                   &#125;</div><div class="line">                   mTwiceBaseCache = array;</div><div class="line">                   mTwiceBaseCacheSize++;</div><div class="line">                   <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"Storing 2x cache "</span> + array</div><div class="line">                           + <span class="string">" now have "</span> + mTwiceBaseCacheSize + <span class="string">" entries"</span>);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (hashes.length == BASE_SIZE) &#123;</div><div class="line">           <span class="keyword">synchronized</span> (ArrayMap.class) &#123;</div><div class="line">               <span class="keyword">if</span> (mBaseCacheSize &lt; CACHE_SIZE) &#123;</div><div class="line">                   array[<span class="number">0</span>] = mBaseCache;</div><div class="line">                   array[<span class="number">1</span>] = hashes;</div><div class="line">                   <span class="keyword">for</span> (<span class="keyword">int</span> i=(size&lt;&lt;<span class="number">1</span>)-<span class="number">1</span>; i&gt;=<span class="number">2</span>; i--) &#123;</div><div class="line">                       array[i] = <span class="keyword">null</span>;</div><div class="line">                   &#125;</div><div class="line">                   mBaseCache = array;</div><div class="line">                   mBaseCacheSize++;</div><div class="line">                   <span class="keyword">if</span> (DEBUG) Log.d(TAG, <span class="string">"Storing 1x cache "</span> + array</div><div class="line">                           + <span class="string">" now have "</span> + mBaseCacheSize + <span class="string">" entries"</span>);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><code>CACHE_SIZE</code>等于10，这意味着最多缓存十个数组，当旧的数组大小等于4或者8的时候，都会被缓存</p>
<h1 id="2-get"><a href="#2-get" class="headerlink" title="2. get"></a>2. get</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> index = indexOfKey(key);</div><div class="line">    <span class="keyword">return</span> index &gt;= <span class="number">0</span> ? (V)mArray[(index&lt;&lt;<span class="number">1</span>)+<span class="number">1</span>] : <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>get</code>方法非常简单，获取索引，根据索引返回对应值，就这么简单!</p>
<h1 id="3-remove"><a href="#3-remove" class="headerlink" title="3. remove"></a>3. remove</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> index = indexOfKey(key);</div><div class="line">       <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">return</span> removeAt(index);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">public</span> V <span class="title">removeAt</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> Object old = mArray[(index &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>];</div><div class="line">       <span class="keyword">if</span> (mSize &lt;= <span class="number">1</span>) &#123;</div><div class="line">           freeArrays(mHashes, mArray, mSize);</div><div class="line">           mHashes = EmptyArray.INT;</div><div class="line">           mArray = EmptyArray.OBJECT;</div><div class="line">           mSize = <span class="number">0</span>;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">       	<span class="comment">//如果容量不到1/3降低ArrayMap容量</span></div><div class="line">           <span class="keyword">if</span> (mHashes.length &gt; (BASE_SIZE*<span class="number">2</span>) &amp;&amp; mSize &lt; mHashes.length/<span class="number">3</span>) &#123;</div><div class="line">               <span class="comment">//保证容量不小于BASE_SIZE * 2</span></div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> n = mSize &gt; (BASE_SIZE*<span class="number">2</span>) ? (mSize + (mSize&gt;&gt;<span class="number">1</span>)) : (BASE_SIZE*<span class="number">2</span>);</div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span>[] ohashes = mHashes;</div><div class="line">               <span class="keyword">final</span> Object[] oarray = mArray;</div><div class="line">               allocArrays(n);</div><div class="line"></div><div class="line">               mSize--;</div><div class="line">               <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</div><div class="line">                   System.arraycopy(ohashes, <span class="number">0</span>, mHashes, <span class="number">0</span>, index);</div><div class="line">                   System.arraycopy(oarray, <span class="number">0</span>, mArray, <span class="number">0</span>, index &lt;&lt; <span class="number">1</span>);</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (index &lt; mSize) &#123;</div><div class="line">                   System.arraycopy(ohashes, index + <span class="number">1</span>, mHashes, index, mSize - index);</div><div class="line">                   System.arraycopy(oarray, (index + <span class="number">1</span>) &lt;&lt; <span class="number">1</span>, mArray, index &lt;&lt; <span class="number">1</span>,</div><div class="line">                           (mSize - index) &lt;&lt; <span class="number">1</span>);</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               mSize--;</div><div class="line">               <span class="keyword">if</span> (index &lt; mSize) &#123;</div><div class="line">                   <span class="comment">//把后面的数据往前前移一位</span></div><div class="line">                   System.arraycopy(mHashes, index + <span class="number">1</span>, mHashes, index, mSize - index);</div><div class="line">                   System.arraycopy(mArray, (index + <span class="number">1</span>) &lt;&lt; <span class="number">1</span>, mArray, index &lt;&lt; <span class="number">1</span>,</div><div class="line">                           (mSize - index) &lt;&lt; <span class="number">1</span>);</div><div class="line">               &#125;</div><div class="line">               mArray[mSize &lt;&lt; <span class="number">1</span>] = <span class="keyword">null</span>;</div><div class="line">               mArray[(mSize &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>] = <span class="keyword">null</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> (V)old;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><code>remove</code>首先获取索引值，然后直接调用<code>removeAt</code>来删除对应的值， </p>
<h1 id="性能分析"><a href="#性能分析" class="headerlink" title="性能分析"></a>性能分析</h1><p><code>ArrayMap</code>在确定index时，使用的也是二分查找法，其效率肯定会随着数据量的增大而受到影响，另外从代码中也可以看到，<code>ArrayMap</code>中比较频繁的出现了数组迁移，这就又会造成一些性能的损失，但是如果从内存角度来看，<code>ArrayMap</code>内部使用了缓存，且在删除元素后，会适当的缩小容量，减少内存占用，综合来看，如果数据量不大，且鲨如何删除操作不频繁时<code>ArrayMap</code>还是比较适用</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/SparseArray源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/SparseArray源码分析/" itemprop="url">SparseArray源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:53:18+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java集合类源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">Java集合类源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>SparseArray</code>是Android官方推荐的一种高效率的<code>Map</code>类工具，如果key值是int值，最好使用<code>SparseArray</code>而不是<code>HashMap</code></p>
<p><code>SparseArray</code>内部是使用基本类型<code>int</code>型数组来存放key值，这就意味着其内部省去了hash操作，只要比较int值是否相同即可判断是否是同一个对象，而<code>HashMap</code>虽然也可以用int类型来当key值，但是首先就会有一个自动装箱的过程，将<code>int</code>类型装箱成为<code>Integer</code>，先不论内部实现的效率，单就装箱这一点，其效率必然就会降低很多，再加上其内部会有hash等操作，效率上自然比不上SparseArray， 不过虽然<code>SparseArray</code>效率要高，但是<code>SparseArray</code>只能用于key是int的情形</p>
<p>下面就来看一下<code>SparseArray</code>的具体实现</p>
<h1 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SparseArray</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Cloneable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object DELETED = <span class="keyword">new</span> Object();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mGarbage = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span>[] mKeys;</div><div class="line">    <span class="keyword">private</span> Object[] mValues;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSize;</div><div class="line">    </div><div class="line">    ...</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>可以看到<code>SparseArray</code>内部是用两个数组分别存放key和value，其中存放key的数组是int数组，这也省去了装箱操作，提升了效率</li>
<li><code>DELETED</code>对象，从名字就可以看出其作用，它是占位对象，表示某索引位置的对象已被删除，用<code>DELETED</code>来占位, 方便后续的gc操作</li>
</ol>
<h1 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">SparseArray</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>(<span class="number">10</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">SparseArray</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (initialCapacity == <span class="number">0</span>) &#123;</div><div class="line">    	 <span class="comment">//new int[0]</span></div><div class="line">         mKeys = EmptyArray.INT;</div><div class="line">         <span class="comment">//new Object[0]</span></div><div class="line">         mValues = EmptyArray.OBJECT;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">         mValues = ArrayUtils.newUnpaddedObjectArray(initialCapacity);</div><div class="line">         mKeys = <span class="keyword">new</span> <span class="keyword">int</span>[mValues.length];</div><div class="line">    &#125;</div><div class="line">     mSize = <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>构造函数比较简单，主要就是根据初始容量初始化两个数组</p>
<h1 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h1><h1 id="1-put"><a href="#1-put" class="headerlink" title="1. put"></a>1. put</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">int</span> key, E value)</span> </span>&#123;</div><div class="line">       <span class="comment">//通过二分搜索获取索引， i&gt;=0代表key值已存在， i&lt;0代表key值不存在，i取反下一个元素的插入位置, 【1.1】</span></div><div class="line">       <span class="keyword">int</span> i = ContainerHelpers.binarySearch(mKeys, mSize, key);</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</div><div class="line">           <span class="comment">//直接放入value</span></div><div class="line">           mValues[i] = value;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">//取反，获得对应的正数</span></div><div class="line">           i = ~i;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (i &lt; mSize &amp;&amp; mValues[i] == DELETED) &#123;</div><div class="line">               <span class="comment">//如果索引处的value是DELETED, 直接替换为新的value即可</span></div><div class="line">               mKeys[i] = key;</div><div class="line">               mValues[i] = value;</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (mGarbage &amp;&amp; mSize &gt;= mKeys.length) &#123;</div><div class="line">               <span class="comment">//如果容量不足，且有元素被删除, 进行gc操作</span></div><div class="line">               <span class="comment">//此时数组中可能会有不连续的DELETED值存在，这种值是无效的，还占据空间，gc()的意义在于将所有</span></div><div class="line">               <span class="comment">//有效的值按顺序连接在一起，替换所有DELETED值，节省空间, 【1.2】</span></div><div class="line">               gc();</div><div class="line"></div><div class="line">               <span class="comment">//重新取得索引值</span></div><div class="line">               i = ~ContainerHelpers.binarySearch(mKeys, mSize, key);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="comment">//如果容量够，直接插入，如果容量不够，先扩容，再插入, 【1.3】</span></div><div class="line">           mKeys = GrowingArrayUtils.insert(mKeys, mSize, i, key);</div><div class="line">           mValues = GrowingArrayUtils.insert(mValues, mSize, i, value);</div><div class="line">           mSize++;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先通过二分搜索获取索引值, 返回的i如果是正数，代表key值已经存在， 如果是负数，代表key值不存在，对i取反后，就是即将要插入的索引位置</li>
<li>如果key值已经存在，直接覆盖旧的value</li>
<li>如果不存在，对i取反，获得正数的索引位置，如果索引处的值是被删除过的即<code>values[i] = DELETED</code>，直接替换为新的value后返回; 如果有元素被删除过<code>mGarbage = true</code>，且keys数组容量不足，进行gc操作，如果values数组中有<code>DELETED</code>元素存在，将有效地值前移替换这些废弃的值，从而节省空间, 进行完gc后，重新获取索引值</li>
<li>进行插入操作，如果容量够，直接插入，如果容量不够，先扩容，再插入</li>
</ol>
<blockquote>
<p>从使用二分搜索法，我们其实就可以知道， <code>SparseArray</code>存放的数据是按照key值得大小有序排列(升序or降序)，查看过<code>ContainerHelpers.binarySearch</code>后就可以知道，是按升序进行排列</p>
</blockquote>
<h2 id="1-1-ContainerHelpers-binarySearch"><a href="#1-1-ContainerHelpers-binarySearch" class="headerlink" title="1.1 ContainerHelpers.binarySearch"></a>1.1 ContainerHelpers.binarySearch</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binarySearch</span><span class="params">(<span class="keyword">int</span>[] array, <span class="keyword">int</span> size, <span class="keyword">int</span> value)</span> </span>&#123;</div><div class="line">       <span class="keyword">int</span> lo = <span class="number">0</span>;</div><div class="line">       <span class="keyword">int</span> hi = size - <span class="number">1</span>;</div><div class="line"></div><div class="line">       <span class="keyword">while</span> (lo &lt;= hi) &#123;</div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> mid = (lo + hi) &gt;&gt;&gt; <span class="number">1</span>;<span class="comment">//无符号右移一位，等价于除以2</span></div><div class="line">           <span class="keyword">final</span> <span class="keyword">int</span> midVal = array[mid];</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (midVal &lt; value) &#123;</div><div class="line">               lo = mid + <span class="number">1</span>;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (midVal &gt; value) &#123;</div><div class="line">               hi = mid - <span class="number">1</span>;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">return</span> mid;  <span class="comment">// value found</span></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> ~lo;  <span class="comment">// value not present</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><code>&gt;&gt;&gt;1</code>无符号右移一位等价于除以2但又比除法操作更高效，如果要查找的值已经存在，则返回相应的索引值，如果不存在，则返回一个负数，这个负数取反后，就是被查找的元素将要被插入的位置</p>
<h2 id="1-2-gc"><a href="#1-2-gc" class="headerlink" title="1.2 gc"></a>1.2 gc</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">gc</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> n = mSize;</div><div class="line">    <span class="keyword">int</span> o = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span>[] keys = mKeys;</div><div class="line">    Object[] values = mValues;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</div><div class="line">        Object val = values[i];</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (val != DELETED) &#123;</div><div class="line">            <span class="keyword">if</span> (i != o) &#123;</div><div class="line">                keys[o] = keys[i];</div><div class="line">                values[o] = val;</div><div class="line">                values[i] = <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            o++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mGarbage = <span class="keyword">false</span>;</div><div class="line">    mSize = o;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>gc</code>函数的主要功能就是遍历<code>values</code>数组，用有效的value前移替换<code>DELETED</code>无效的值，从而使有效的值连续排列在一起，节省空间</p>
<h2 id="1-3-GrowingArrayUtils-insert"><a href="#1-3-GrowingArrayUtils-insert" class="headerlink" title="1.3 GrowingArrayUtils.insert"></a>1.3 GrowingArrayUtils.insert</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span>[] insert(<span class="keyword">int</span>[] array, <span class="keyword">int</span> currentSize, <span class="keyword">int</span> index, <span class="keyword">int</span> element) &#123;</div><div class="line">       <span class="keyword">assert</span> currentSize &lt;= array.length;</div><div class="line">	<span class="comment">//容量够，直接插入</span></div><div class="line">       <span class="keyword">if</span> (currentSize + <span class="number">1</span> &lt;= array.length) &#123;</div><div class="line">           System.arraycopy(array, index, array, index + <span class="number">1</span>, currentSize - index);</div><div class="line">           array[index] = element;</div><div class="line">           <span class="keyword">return</span> array;</div><div class="line">       &#125;</div><div class="line">	<span class="comment">//容量不够的话，先扩容，如果currentSize &lt;= 4, 扩容成8, 如果 &gt; 4，则扩容至原先容量的2倍</span></div><div class="line">       <span class="keyword">int</span>[] newArray = ArrayUtils.newUnpaddedIntArray(growSize(currentSize));</div><div class="line">       System.arraycopy(array, <span class="number">0</span>, newArray, <span class="number">0</span>, index);</div><div class="line">       newArray[index] = element;</div><div class="line">       System.arraycopy(array, index, newArray, index + <span class="number">1</span>, array.length - index);</div><div class="line">       <span class="keyword">return</span> newArray;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>如果容量够，则直接插入</li>
<li>容量不够的话，先扩容，扩容的size是由<code>growSize</code>函数决定，其原理是如果当前size小于等于4,则固定扩容后的容量是8,如果大于4,则扩容原先容量的两倍，之后拷贝原有数据至新的数组中，最后再根据索引值插入数据</li>
</ol>
<h1 id="2-get"><a href="#2-get" class="headerlink" title="2. get"></a>2. get</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> get(key, <span class="keyword">null</span>);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> key, E valueIfKeyNotFound)</span> </span>&#123;</div><div class="line">       <span class="comment">//根据key获得索引值</span></div><div class="line">       <span class="keyword">int</span> i = ContainerHelpers.binarySearch(mKeys, mSize, key);</div><div class="line"></div><div class="line">       <span class="comment">//i&lt;0代表没找到， value = DELETED代表这个值已作废，也表明没找到</span></div><div class="line">       <span class="keyword">if</span> (i &lt; <span class="number">0</span> || mValues[i] == DELETED) &#123;</div><div class="line">           <span class="keyword">return</span> valueIfKeyNotFound;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">return</span> (E) mValues[i];</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到，<code>get</code>操作非常简单，首先获得索引值，之后直接从values数组中获取相应的值，不论是获取索引值还是获取value, 都是直接操作数组，所以效率非常高</p>
<h1 id="3-delete"><a href="#3-delete" class="headerlink" title="3. delete"></a>3. delete</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> key)</span> </span>&#123;</div><div class="line">       <span class="comment">//获取索引值</span></div><div class="line">       <span class="keyword">int</span> i = ContainerHelpers.binarySearch(mKeys, mSize, key);</div><div class="line">       <span class="comment">//将对应索引位置的value设为DELETED</span></div><div class="line">       <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (mValues[i] != DELETED) &#123;</div><div class="line">               mValues[i] = DELETED;</div><div class="line">               mGarbage = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>和<code>get</code>的操作类似，只不过是获取索引值后，将values数组中对应处的值覆盖为<code>DELETED</code></p>
<h1 id="性能分析"><a href="#性能分析" class="headerlink" title="性能分析"></a>性能分析</h1><p><code>SparseArray</code>内部使用了二分搜索法，如果在数据量比较小的情况下，其查询效率应该是比较高的，但是随着数据量的增大，二分搜索的效率也会呈现性下降，而<code>HashMap</code>内部在获取对应的索引值时，使用的是先计算hash值再通过<code>hash &amp; (length - 1)</code>的形式获取索引值，当数据量较大时这种方式就比较具有优势，加上HashMap内部对hash算法进行了优化，尽可能的减少了hash碰撞，所以如果数据量很大时，<code>HashMap</code>的查询效率并不会比<code>SparseArray</code>差，甚至可能会优于<code>SparseArray</code>, 但是<code>HashMap</code>如果键值是整型时，不可避免的会进行装箱操作，这一点上<code>SparseArray</code>肯定优于<code>HashMap</code>, 综合来看，在一般的使用场景中，很少会用到非常大的数据量，如果键值是整型数据，应当首选<code>SparseArray</code></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/HashSet源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/HashSet源码分析/" itemprop="url">HashSet源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:51:52+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java集合类源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">Java集合类源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>Set</code>集合的最主要特性就是没有重复元素，<code>HashSet</code>是Set的一个字类，其内部基于HashMap实现</p>
<h1 id="1-成员变量"><a href="#1-成员变量" class="headerlink" title="1. 成员变量"></a>1. 成员变量</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> HashMap&lt;E,Object&gt; map;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object PRESENT = <span class="keyword">new</span> Object();</div></pre></td></tr></table></figure>
<p>可以看到HashSet内部有一个HashMap, 但是<code>PRESENT</code>是干什么用的？HashMap是key-value形式的，但是Set是存储的是单一值，那么内部想要借由HashMap来实现的话，就必须有一个固定的value值，即HashSet中存放的每一个值在HashMap中作为key值，对应的value值都固定为PRESENT对象</p>
<h1 id="2-构造函数"><a href="#2-构造函数" class="headerlink" title="2. 构造函数"></a>2. 构造函数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">()</span> </span>&#123;</div><div class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</div><div class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;(Math.max((<span class="keyword">int</span>) (c.size()/.<span class="number">75f</span>) + <span class="number">1</span>, <span class="number">16</span>));</div><div class="line">    addAll(c);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</div><div class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;(initialCapacity, loadFactor);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashSet</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</div><div class="line">    map = <span class="keyword">new</span> HashMap&lt;&gt;(initialCapacity);</div><div class="line">&#125;</div><div class="line"></div><div class="line">HashSet(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor, <span class="keyword">boolean</span> dummy) &#123;</div><div class="line">    map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(initialCapacity, loadFactor);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一般起我们最常用的就是空参构造函数，在空参函数中会调用HashMap的空参构造函数， 由<a href="http://www.jianshu.com/p/752d09ffd91d" target="_blank" rel="external">HashMap源码分析</a>可以知道，空参构造函数的HashMap初始容量为4</p>
<h1 id="3-方法"><a href="#3-方法" class="headerlink" title="3. 方法"></a>3. 方法</h1><h2 id="3-1-add"><a href="#3-1-add" class="headerlink" title="3.1 add"></a>3.1 add</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> map.put(e, PRESENT)==<span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在HashMap中，如果key值没有hash碰撞或者在冲突的链表上没有相同的key，HashMap.put会返回null, 否则会返回被替换的旧值，而由于HashSet中，所有key值对应的value都是<code>PRESENT</code>对象，这样就算在HashMap中有相等的key值，更新的也只是<code>PRESENT</code>,并没有在HashMap中插入新的key值，从而保证了<code>HashSet</code>中值的唯一性</p>
<h2 id="3-2-remove"><a href="#3-2-remove" class="headerlink" title="3.2 remove"></a>3.2 remove</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> map.remove(o)==PRESENT;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HashMap.remove如果删除成功，会返回对应的value，如果不存在对应的entry则返回null, 而HashSet中所有key值对应的value固定都是<code>PRESENT</code></p>
<h2 id="3-3-iterator"><a href="#3-3-iterator" class="headerlink" title="3.3 iterator"></a>3.3 iterator</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> map.keySet().iterator();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/HashTable源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/HashTable源码分析/" itemprop="url">HashTable源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:49:35+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java集合类源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">Java集合类源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>HashTable跟HashMap在功能上来基本类似，其解决hash冲突的方法也是基于<strong>链地址法</strong>， 唯一的不同点在HashTable的方法是同步的，多线程操作时，在外部无需使用同步机制</p>
<h1 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h1><h1 id="1-成员变量"><a href="#1-成员变量" class="headerlink" title="1. 成员变量"></a>1. 成员变量</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> HashtableEntry&lt;K,V&gt;[] table;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> count;</div><div class="line"></div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">int</span> threshold;</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">float</span> loadFactor;</div><div class="line"></div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> modCount = <span class="number">0</span>;</div></pre></td></tr></table></figure>
<p>HashTable的成员变量跟HashMap的成员变量类似，同样都有<code>loadFactor, modCount, threshold</code></p>
<h1 id="2-put"><a href="#2-put" class="headerlink" title="2. put"></a>2. put</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       HashtableEntry tab[] = table;</div><div class="line">       <span class="comment">//直接调用key.hashCode()</span></div><div class="line">       <span class="keyword">int</span> hash = hash(key);</div><div class="line">       <span class="comment">//计算索引值</span></div><div class="line">       <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</div><div class="line">       <span class="comment">//如果已经存在key值相等的entry，用新value替换旧value</span></div><div class="line">       <span class="keyword">for</span> (HashtableEntry&lt;K,V&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</div><div class="line">           <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</div><div class="line">               V old = e.value;</div><div class="line">               e.value = value;</div><div class="line">               <span class="keyword">return</span> old;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       modCount++;</div><div class="line">       <span class="keyword">if</span> (count &gt;= threshold) &#123;</div><div class="line">           <span class="comment">//扩容至之前容量的两倍</span></div><div class="line">           rehash();</div><div class="line">           tab = table;</div><div class="line">           hash = hash(key);</div><div class="line">           index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Creates the new entry.</span></div><div class="line">       HashtableEntry&lt;K,V&gt; e = tab[index];</div><div class="line">       tab[index] = <span class="keyword">new</span> HashtableEntry&lt;&gt;(hash, key, value, e);</div><div class="line">       count++;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>HashTable的put逻辑大体上与HashMap的一致，都可以总结为：</p>
<ol>
<li>计算key值的hash</li>
<li>由hash得出索引</li>
<li>如果已经存在key值相等的entry，用新value替换旧value</li>
<li>递增modCount, 检查是否key-value键值对数量是否达到阈值，如果达到进行扩容操作，扩容至原先容量的两倍</li>
<li>创建Entry, 放入数组</li>
</ol>
<p>但是HashTable中计算hash值和索引值这两步，跟HashMap有很大区别, HashTable是直接获取了key值得hashCode()返回值，然后用求模的方式计算索引，相比于HashMap来说，不仅效率略低，同时由于HashTable并没有硬性要求容量必须是2的n次方，从而会造成index冲突的几率加大，减慢了查询的效率</p>
<p>另外，可以看到HashTable的put方法增加了<code>synchronized</code>关键字，这就意味着put方法是一个同步方法，相对于HashMap的非同步put方法，其在单线程模型下效率肯定会略低</p>
<h1 id="3-get"><a href="#3-get" class="headerlink" title="3. get"></a>3. get</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">       HashtableEntry tab[] = table;</div><div class="line">       <span class="keyword">int</span> hash = hash(key);</div><div class="line">       <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</div><div class="line">       <span class="keyword">for</span> (HashtableEntry&lt;K,V&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</div><div class="line">           <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</div><div class="line">               <span class="keyword">return</span> e.value;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>get方法也是被<code>synchronized</code>修饰</p>
<h1 id="4-遍历HashTable"><a href="#4-遍历HashTable" class="headerlink" title="4. 遍历HashTable"></a>4. 遍历HashTable</h1><h2 id="4-1-HashTable-entrySet"><a href="#4-1-HashTable-entrySet" class="headerlink" title="4.1 HashTable.entrySet"></a>4.1 HashTable.entrySet</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Set&lt;Entry&lt;K,V&gt;&gt; entrySet() &#123;</div><div class="line">    <span class="keyword">if</span> (entrySet==<span class="keyword">null</span>)</div><div class="line">        entrySet = Collections.synchronizedSet(<span class="keyword">new</span> EntrySet(), <span class="keyword">this</span>);</div><div class="line">    <span class="keyword">return</span> entrySet;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，获取entrySet时，调用<code>Collections.synchronizedSet</code>来保证Set是同步的</p>
<h2 id="4-2-EntrySet-iterator"><a href="#4-2-EntrySet-iterator" class="headerlink" title="4.2 EntrySet.iterator"></a>4.2 EntrySet.iterator</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ENTRIES = <span class="number">2</span>;</div><div class="line"></div><div class="line"><span class="keyword">public</span> Iterator&lt;Entry&lt;K,V&gt;&gt; iterator() &#123;</div><div class="line">    <span class="keyword">return</span> getIterator(ENTRIES);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Iterator&lt;T&gt; <span class="title">getIterator</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">   <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> Collections.emptyIterator();</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Enumerator&lt;&gt;(type, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-3-Enumerator"><a href="#4-3-Enumerator" class="headerlink" title="4.3 Enumerator"></a>4.3 Enumerator</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Enumerator</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Enumeration</span>&lt;<span class="title">T</span>&gt;, <span class="title">Iterator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">	HashtableEntry[] table = Hashtable.<span class="keyword">this</span>.table;</div><div class="line">	...</div><div class="line">	<span class="keyword">protected</span> <span class="keyword">int</span> expectedModCount = modCount;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">         <span class="keyword">if</span> (modCount != expectedModCount)</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</div><div class="line">         <span class="keyword">return</span> nextElement();</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">nextElement</span><span class="params">()</span> </span>&#123;</div><div class="line">         HashtableEntry&lt;K,V&gt; et = entry;</div><div class="line">         <span class="keyword">int</span> i = index;</div><div class="line">         HashtableEntry[] t = table;</div><div class="line">         <span class="comment">/* Use locals for faster loop iteration */</span></div><div class="line">         <span class="keyword">while</span> (et == <span class="keyword">null</span> &amp;&amp; i &gt; <span class="number">0</span>) &#123;</div><div class="line">             et = t[--i];</div><div class="line">         &#125;</div><div class="line">         entry = et;</div><div class="line">         index = i;</div><div class="line">         <span class="keyword">if</span> (et != <span class="keyword">null</span>) &#123;</div><div class="line">             HashtableEntry&lt;K,V&gt; e = lastReturned = entry;</div><div class="line">             entry = e.next;</div><div class="line">             <span class="comment">//KEYS代表要获取key的集合， VALUES代表获取value的集合，ENTIRES代表获取entry的集合</span></div><div class="line">             <span class="keyword">return</span> type == KEYS ? (T)e.key : (type == VALUES ? (T)e.value : (T)e);</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException(<span class="string">"Hashtable Enumerator"</span>);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到HashTable也同样采用Fast-Fail机制，当使用迭代器遍历时，不可以调用HashTable.remove来删除元素，而是应该用迭代器自身的remove方法</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/LinkedHashMap源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/LinkedHashMap源码分析/" itemprop="url">LinkedHashMap源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:48:11+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java集合类源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">Java集合类源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>LinkedHashMap具有以下特性</p>
<ul>
<li>LinkedHashMap继承自HashMap, 它可以保证迭代的顺序跟插入的顺序是一致的</li>
<li>不是同步的，如果多个线程同时访问，需要从外部保持同步</li>
<li>LinkedHashMap还可以按照访问顺序进行排序，如果是按照访问顺序，那么调用get以后，会将访问的元素移到链表末尾</li>
</ul>
<h1 id="LinkedHashMap的重要变量"><a href="#LinkedHashMap的重要变量" class="headerlink" title="LinkedHashMap的重要变量"></a>LinkedHashMap的重要变量</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">    * 双向链表的表头</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">transient</span> LinkedHashMapEntry&lt;K,V&gt; header;</div><div class="line"></div><div class="line">   <span class="comment">/**</span></div><div class="line">    * true: 按照访问顺序; false: 按照插入顺序</div><div class="line">    *</div><div class="line">    * <span class="doctag">@serial</span></div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> accessOrder;</div></pre></td></tr></table></figure>
<p>LinkedHashMap是HashMap的子类，从而继承了HashMap中属性，另外LinkedHashMap自定义了两个变量，这两个变量也就是实现其排序的关键</p>
<h1 id="1-init"><a href="#1-init" class="headerlink" title="1. init"></a>1. init</h1><p>init方法会在构造函数中调用，HashMap的init是一个空实现，LinkedHashMap重写了init方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">       header = <span class="keyword">new</span> LinkedHashMapEntry&lt;&gt;(-<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">       header.before = header.after = header;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>init方法主要就是初始化了<code>header</code>变量，将header的beafore和after都指向header自身</p>
<h1 id="2-put"><a href="#2-put" class="headerlink" title="2. put"></a>2. put</h1><p>LinkedHashMap没有重写put方法, 完全还是HashMap.put的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</div><div class="line">           inflateTable(threshold);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (key == <span class="keyword">null</span>)</div><div class="line">           <span class="keyword">return</span> putForNullKey(value);</div><div class="line"></div><div class="line">       <span class="keyword">int</span> hash = sun.misc.Hashing.singleWordWangJenkinsHash(key);</div><div class="line">       <span class="keyword">int</span> i = indexFor(hash, table.length);</div><div class="line">       <span class="keyword">for</span> (HashMapEntry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</div><div class="line">           Object k;</div><div class="line">           <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</div><div class="line">               V oldValue = e.value;</div><div class="line">               e.value = value;</div><div class="line">               e.recordAccess(<span class="keyword">this</span>);</div><div class="line">               <span class="keyword">return</span> oldValue;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       modCount++;</div><div class="line">       addEntry(hash, key, value, i);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>LinkedHashMap虽然没有重写put方法，但是其重写了两个关键方法<code>recordAccess</code>和<code>addEntry</code>, 其中<code>recordAccess</code>是用来记录访问顺序的方法，即更新当前entry的after,before</p>
<h2 id="2-1-addEntry"><a href="#2-1-addEntry" class="headerlink" title="2.1 addEntry"></a>2.1 addEntry</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// removeEldestEntry(eldest)固定返回false..</span></div><div class="line">        LinkedHashMapEntry&lt;K,V&gt; eldest = header.after;</div><div class="line">        <span class="keyword">if</span> (eldest != header) &#123;</div><div class="line">            <span class="keyword">boolean</span> removeEldest;</div><div class="line">            size++;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                removeEldest = removeEldestEntry(eldest);</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                size--;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (removeEldest) &#123;</div><div class="line">                removeEntryForKey(eldest.key);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>.addEntry(hash, key, value, bucketIndex);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>虽然在<code>super.addEntry</code>之前有一段逻辑，但是由于<code>removeEldestEntry</code>方法固定返回false，所以这一段代码执行与否都没有什么影响…, <code>super.addEntry</code>主要是为了执行扩容操作，<code>HashMap.addEntry</code>在扩容后会执行<code>createEntry</code>方法，而LinkedHashMap重写了<code>createEntry</code>方法</p>
<h2 id="2-2-createEntry"><a href="#2-2-createEntry" class="headerlink" title="2.2 createEntry"></a>2.2 createEntry</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">createEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line">    HashMapEntry&lt;K,V&gt; old = table[bucketIndex];</div><div class="line">    LinkedHashMapEntry&lt;K,V&gt; e = <span class="keyword">new</span> LinkedHashMapEntry&lt;&gt;(hash, key, value, old);</div><div class="line">    table[bucketIndex] = e;</div><div class="line">    <span class="comment">//更新链表指针, 【2.3】</span></div><div class="line">    e.addBefore(header);</div><div class="line">    size++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>创建对应的Entry, 如果是要归属到同一个链表内的，将newEntry的next指针指向oldEntry, 将newEntry放置到相应的索引处</li>
<li>更新双向链表指针</li>
</ol>
<h2 id="2-3-LinkedHashMapEntry-addBefore"><a href="#2-3-LinkedHashMapEntry-addBefore" class="headerlink" title="2.3 LinkedHashMapEntry.addBefore"></a>2.3 LinkedHashMapEntry.addBefore</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addBefore</span><span class="params">(LinkedHashMapEntry&lt;K,V&gt; existingEntry)</span> </span>&#123;</div><div class="line">     after  = existingEntry;</div><div class="line">     before = existingEntry.before;</div><div class="line">     before.after = <span class="keyword">this</span>;</div><div class="line">     after.before = <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面这张图显示了执行两次put操作后(假设没有hash冲突)的链表指向</p>
<h1 id="3-get"><a href="#3-get" class="headerlink" title="3. get"></a>3. get</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">        LinkedHashMapEntry&lt;K,V&gt; e = (LinkedHashMapEntry&lt;K,V&gt;)getEntry(key);</div><div class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        e.recordAccess(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">return</span> e.value;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="3-1-LinkedHashMapEntry-recordAccess"><a href="#3-1-LinkedHashMapEntry-recordAccess" class="headerlink" title="3.1 LinkedHashMapEntry.recordAccess"></a>3.1 LinkedHashMapEntry.recordAccess</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">recordAccess</span><span class="params">(java.util.HashMap&lt;K,V&gt; m)</span> </span>&#123;</div><div class="line">       LinkedHashMap&lt;K,V&gt; lm = (LinkedHashMap&lt;K,V&gt;)m;</div><div class="line">       <span class="keyword">if</span> (lm.accessOrder) &#123;</div><div class="line">           lm.modCount++;</div><div class="line">           <span class="comment">//从双向链表中删除当前元素</span></div><div class="line">           remove();</div><div class="line">           <span class="comment">//重新将元素添加到链表表头</span></div><div class="line">           addBefore(lm.header);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</div><div class="line">       before.after = after;</div><div class="line">       after.before = before;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>如果是访问顺序进行排序,首先将当前entry从双向链表中删除，之后再重新添当前entry到表头</p>
<h1 id="4-遍历"><a href="#4-遍历" class="headerlink" title="4.遍历"></a>4.遍历</h1><p>LinkedHashMap的遍历需要注意的事项跟HashMap的一致，不能在使用迭代器遍历的时候调用LinkedHashMap.remove()删除元素，其原理不变，仍然是使用<code>expectedModCount</code></p>
<h2 id="4-1-LinkedHashIterator-nextEntry"><a href="#4-1-LinkedHashIterator-nextEntry" class="headerlink" title="4.1 LinkedHashIterator.nextEntry"></a>4.1 LinkedHashIterator.nextEntry</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">LinkedHashMapEntry&lt;K,V&gt; nextEntry    = header.after;</div><div class="line">LinkedHashMapEntry&lt;K,V&gt; lastReturned = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">Map.<span class="function">Entry&lt;K,V&gt; <span class="title">nextEntry</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (modCount != expectedModCount)</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (nextEntry == header)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</div><div class="line">	</div><div class="line">   LinkedHashMapEntry&lt;K,V&gt; e = lastReturned = nextEntry;</div><div class="line">   nextEntry = e.after;</div><div class="line">   <span class="keyword">return</span> e;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到，迭代器迭代时，LinkedHashMap会从双向链表的header处开始向后按顺序遍历</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/HashMap源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/HashMap源码分析/" itemprop="url">HashMap源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:44:46+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java集合类源码分析/" itemprop="url" rel="index">
                    <span itemprop="name">Java集合类源码分析</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>HashMap具有以下特点：</p>
<ol>
<li>Hashmap是基于Map的非同步实现，如果多线程修改，必须在外部保持同步</li>
<li>允许使用null值和null键</li>
<li>不保证映射顺序</li>
<li>Hashmap实际上是一个链表散列的数据结构，即数组和链表的结合体</li>
<li>Hashmap底层是一个数组，数组中每一项又是一个链表</li>
<li>默认容量 = 4(必须是2的n次方), 默认加载因子 = 0.75</li>
<li>只有对于HashMap中的Entry有新增或删除的操作，都会更新modCount</li>
</ol>
<blockquote>
<p>假定Hash函数将元素适当的分布在各桶之间，可为基本操作<code>get</code>和<code>put</code>提供稳定的性能，迭代collection视图所需的时间与HashMap实例的容量(桶的数量）及其大小(键值映射关系数)成比例，<strong>所以如果迭代性能很重要，则不要将出示容量设置的太高或将加载因子设置的太低</strong></p>
</blockquote>
<h1 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//默认初始容量为4</span></div><div class="line">staic <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">4</span>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</div><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> HashMapEntry&lt;?,?&gt;[] EMPTY_TABLE = &#123;&#125;;</div><div class="line"></div><div class="line"><span class="keyword">transient</span> HashMapEntry&lt;K,V&gt;[] table = (HashMapEntry&lt;K,V&gt;[]) EMPTY_TABLE;</div><div class="line"></div><div class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size;</div><div class="line"></div><div class="line"><span class="keyword">int</span> threshold;</div><div class="line"></div><div class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor = DEFAULT_LOAD_FACTOR;</div><div class="line"></div><div class="line"><span class="keyword">transient</span> <span class="keyword">int</span> modCount;</div></pre></td></tr></table></figure>
<h1 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">//默认容量是4, 加载因子是0.75</span></div><div class="line">        <span class="keyword">this</span>(DEFAULT_INITIAL_CAPACITY, DEFAULT_LOAD_FACTOR);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> +</div><div class="line">                    initialCapacity);</div><div class="line">        <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY) &#123;</div><div class="line">            initialCapacity = MAXIMUM_CAPACITY;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (initialCapacity &lt; DEFAULT_INITIAL_CAPACITY) &#123;</div><div class="line">            initialCapacity = DEFAULT_INITIAL_CAPACITY;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</div><div class="line">                    loadFactor);</div><div class="line"></div><div class="line">        threshold = initialCapacity;</div><div class="line">        init();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>一般情况下，我们使用HashMap时都会调用空参构造函数，可以看到，空参构造函数的初始容量默认为4</p>
<h1 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h1><h1 id="1-put"><a href="#1-put" class="headerlink" title="1. put"></a>1. put</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">    <span class="comment">//如果table是空，重新初始化table,容量是threshold，如果是空构造函数，threshold就是4</span></div><div class="line">    <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</div><div class="line">    	<span class="comment">//【1.1】</span></div><div class="line">        inflateTable(threshold);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//如果key是null, 更新相应的Entry, key = null， 则Entry放在table[0]</span></div><div class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</div><div class="line">    	<span class="comment">//【1.2】</span></div><div class="line">        <span class="keyword">return</span> putForNullKey(value);</div><div class="line"></div><div class="line">    <span class="comment">//计算hash值， 【1.3】</span></div><div class="line">    <span class="keyword">int</span> hash = sun.misc.Hashing.singleWordWangJenkinsHash(key);</div><div class="line">    <span class="comment">//获取hash值对应的index位置， 【1.4】</span></div><div class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</div><div class="line">    <span class="comment">//如果对应的index位置已经有链表，证明hash冲突，遍历链表</span></div><div class="line">    <span class="keyword">for</span> (HashMapEntry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</div><div class="line">        Object k;</div><div class="line">        <span class="comment">//如果链表中某一个entry的key值与传入的key值相等，更新entry对应的value值</span></div><div class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</div><div class="line">            V oldValue = e.value;</div><div class="line">            e.value = value;</div><div class="line">            e.recordAccess(<span class="keyword">this</span>);</div><div class="line">            <span class="keyword">return</span> oldValue;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//如果没有hash冲突或者在hash冲突的链表中没有相等的key值，更新modCount</span></div><div class="line">    modCount++;</div><div class="line">    <span class="comment">//添加新的Entry， 【1.5】</span></div><div class="line">    addEntry(hash, key, value, i);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>key = null时，对应的Entry放置在索引0处</li>
<li>如果key值存在了，新的value会替换旧的value，<code>put</code>方法会返回旧value</li>
<li>计算对应的索引值的方法是, 获取key值hash值，然后用<code>hash &amp; table.length - 1</code>, table.length总是2的n次方</li>
</ol>
<blockquote>
<p>对于任意给定对象，只要其<code>hashCode()</code>返回值相同，那么HashMap计算出来的hash值也总相同</p>
</blockquote>
<h2 id="1-1-inflateTable"><a href="#1-1-inflateTable" class="headerlink" title="1.1 inflateTable"></a>1.1 inflateTable</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">inflateTable</span><span class="params">(<span class="keyword">int</span> toSize)</span> </span>&#123;</div><div class="line">    <span class="comment">// 保证HashMap的容量是2的n次方</span></div><div class="line">    <span class="keyword">int</span> capacity = roundUpToPowerOf2(toSize);</div><div class="line"></div><div class="line">    <span class="comment">//计算threshold值</span></div><div class="line">    <span class="keyword">float</span> thresholdFloat = capacity * loadFactor;</div><div class="line">    <span class="keyword">if</span> (thresholdFloat &gt; MAXIMUM_CAPACITY + <span class="number">1</span>) &#123;</div><div class="line">        thresholdFloat = MAXIMUM_CAPACITY + <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    threshold = (<span class="keyword">int</span>) thresholdFloat;</div><div class="line">    table = <span class="keyword">new</span> HashMapEntry[capacity];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">roundUpToPowerOf2</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</div><div class="line">    <span class="comment">// assert number &gt;= 0 : "number must be non-negative";</span></div><div class="line">    <span class="keyword">int</span> rounded = number &gt;= MAXIMUM_CAPACITY</div><div class="line">            ? MAXIMUM_CAPACITY</div><div class="line">            : (rounded = Integer.highestOneBit(number)) != <span class="number">0</span></div><div class="line">            <span class="comment">//Integer.bitCount返回number的二进制补码中1的总数量</span></div><div class="line">            ? (Integer.bitCount(number) &gt; <span class="number">1</span>) ? rounded &lt;&lt; <span class="number">1</span> : rounded</div><div class="line">            : <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> rounded;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HashMap的容量会强制性的圆整到2的n次方，即使在初始化时传入的初始容量不是2的n次方，这样做是为了减少hash碰撞率从而提升空间利用效率</p>
<h2 id="1-2-Hashing-singleWordWangJenkinsHash"><a href="#1-2-Hashing-singleWordWangJenkinsHash" class="headerlink" title="1.2 Hashing.singleWordWangJenkinsHash"></a>1.2 Hashing.singleWordWangJenkinsHash</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">singleWordWangJenkinsHash</span><span class="params">(Object k)</span> </span>&#123;</div><div class="line">       <span class="keyword">int</span> h = k.hashCode();</div><div class="line"></div><div class="line">       h += (h &lt;&lt;  <span class="number">15</span>) ^ <span class="number">0xffffcd7d</span>;</div><div class="line">       h ^= (h &gt;&gt;&gt; <span class="number">10</span>); <span class="comment">//无符号右移6位</span></div><div class="line">       h += (h &lt;&lt;   <span class="number">3</span>);</div><div class="line">       h ^= (h &gt;&gt;&gt;  <span class="number">6</span>);<span class="comment">//无符号右移6位,空位以0补齐, 带符号右移是根据最左边的符号位来确定空位补什么，如果符号位是1，则空位补1,符号位是0，空位补0</span></div><div class="line">       h += (h &lt;&lt;   <span class="number">2</span>) + (h &lt;&lt; <span class="number">14</span>);</div><div class="line">       <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">16</span>);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h2 id="1-3-putForNullKey"><a href="#1-3-putForNullKey" class="headerlink" title="1.3 putForNullKey"></a>1.3 putForNullKey</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> V <span class="title">putForNullKey</span><span class="params">(V value)</span> </span>&#123;</div><div class="line">	<span class="comment">//如果null已经有对应的value,则替换旧value为新value</span></div><div class="line">    <span class="keyword">for</span> (HashMapEntry&lt;K,V&gt; e = table[<span class="number">0</span>]; e != <span class="keyword">null</span>; e = e.next) &#123;</div><div class="line">        <span class="keyword">if</span> (e.key == <span class="keyword">null</span>) &#123;</div><div class="line">            V oldValue = e.value;</div><div class="line">            e.value = value;</div><div class="line">            e.recordAccess(<span class="keyword">this</span>);</div><div class="line">            <span class="keyword">return</span> oldValue;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    modCount++;</div><div class="line">    addEntry(<span class="number">0</span>, <span class="keyword">null</span>, value, <span class="number">0</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>null可以做键值，但是null所对应的value每次只能存一个，如果已存在以null为键值的Entry, 会有新的value替换旧value</p>
<h2 id="1-4-indexFor"><a href="#1-4-indexFor" class="headerlink" title="1.4 indexFor"></a>1.4 indexFor</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">indexFor</span><span class="params">(<span class="keyword">int</span> h, <span class="keyword">int</span> length)</span> </span>&#123;</div><div class="line">    <span class="comment">//length总是2的n次方时， h &amp; (length - 1)等价于对length取模,h % length</span></div><div class="line">    <span class="keyword">return</span> h &amp; (length-<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于pow(2, n)是2的n次方，所以pow(2,n) - 1的二进制必然每一位都是1，这样用hash值同pow(2,n)-1进行位与操作，得到的值得低位与hash值得低位一致</p>
<h2 id="1-5-addEntry"><a href="#1-5-addEntry" class="headerlink" title="1.5 addEntry"></a>1.5 addEntry</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="keyword">null</span> != table[bucketIndex])) &#123;</div><div class="line">           <span class="comment">//如果key-value键值对数量达到threshold且对应index处有Entry即存在链表, 扩容</span></div><div class="line">           resize(<span class="number">2</span> * table.length);</div><div class="line">           <span class="comment">//计算hash值，null键值的hash是0</span></div><div class="line">           hash = (<span class="keyword">null</span> != key) ? sun.misc.Hashing.singleWordWangJenkinsHash(key) : <span class="number">0</span>;</div><div class="line">           bucketIndex = indexFor(hash, table.length);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//创建新的Entry,并放入对应的位置</span></div><div class="line">       createEntry(hash, key, value, bucketIndex);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">       <span class="function"><span class="keyword">void</span> <span class="title">createEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</div><div class="line">       HashMapEntry&lt;K,V&gt; e = table[bucketIndex];</div><div class="line">       table[bucketIndex] = <span class="keyword">new</span> HashMapEntry&lt;&gt;(hash, key, value, e);</div><div class="line">       size++;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li>如果key-value键值对的总和达到<code>threshold</code>且对应的索引处存在链表，进行扩容</li>
<li>创建新的Entry,并放入<code>table</code>中</li>
</ul>
<h1 id="2-get"><a href="#2-get" class="headerlink" title="2. get"></a>2. get</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">      <span class="comment">//如果key为null, 获取null对应的value</span></div><div class="line">      <span class="keyword">if</span> (key == <span class="keyword">null</span>)</div><div class="line">      	<span class="comment">//【2.1】</span></div><div class="line">          <span class="keyword">return</span> getForNullKey();</div><div class="line"><span class="comment">//【2.2】</span></div><div class="line">      Entry&lt;K,V&gt; entry = getEntry(key);</div><div class="line"></div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span> == entry ? <span class="keyword">null</span> : entry.getValue();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="2-1-getForNullKey"><a href="#2-1-getForNullKey" class="headerlink" title="2.1 getForNullKey"></a>2.1 getForNullKey</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> V <span class="title">getForNullKey</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (HashMapEntry&lt;K,V&gt; e = table[<span class="number">0</span>]; e != <span class="keyword">null</span>; e = e.next) &#123;</div><div class="line">        <span class="keyword">if</span> (e.key == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">return</span> e.value;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-2-getEntry"><a href="#2-2-getEntry" class="headerlink" title="2.2 getEntry"></a>2.2 getEntry</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">getEntry</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">int</span> hash = (key == <span class="keyword">null</span>) ? <span class="number">0</span> : sun.misc.Hashing.singleWordWangJenkinsHash(key);</div><div class="line">       <span class="keyword">for</span> (HashMapEntry&lt;K,V&gt; e = table[indexFor(hash, table.length)]; e != <span class="keyword">null</span>; e = e.next) &#123;</div><div class="line">           Object k;</div><div class="line">           <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</div><div class="line">               <span class="keyword">return</span> e;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>这里吐槽一下：曾经遇到一个面试官问我如果哈希冲突的时候HashMap是通过什么方式获取value的，我很确定的说会遍历链表，然后判断entry的哈希值是否跟key值计算出来的hash值相等同时会判断entry的key值和传入的key是否会相等，然后那个面试官告诉我不对!!!弄得我一脸懵逼，我说就是这样的啊，结果他可能觉得我知错不改，脸色不太好的告诉我回去再好好看看。。。好吧，我现在再一次好好看了，依然不知道我哪里说错了，也许这位大哥可能有自己独特的理解</p>
</blockquote>
<h1 id="3-remove"><a href="#3-remove" class="headerlink" title="3. remove"></a>3. remove</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    Entry&lt;K,V&gt; e = removeEntryForKey(key);</div><div class="line">    <span class="keyword">return</span> (e == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.getValue());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">removeEntryForKey</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> hash = (key == <span class="keyword">null</span>) ? <span class="number">0</span> : sun.misc.Hashing.singleWordWangJenkinsHash(key);</div><div class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</div><div class="line">    HashMapEntry&lt;K,V&gt; prev = table[i];</div><div class="line">    HashMapEntry&lt;K,V&gt; e = prev;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</div><div class="line">        HashMapEntry&lt;K,V&gt; next = e.next;</div><div class="line">        Object k;</div><div class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</div><div class="line">            modCount++;</div><div class="line">            size--;</div><div class="line">            <span class="keyword">if</span> (prev == e)</div><div class="line">                table[i] = next;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                prev.next = next;</div><div class="line">            e.recordRemoval(<span class="keyword">this</span>);</div><div class="line">            <span class="keyword">return</span> e;</div><div class="line">        &#125;</div><div class="line">        prev = e;</div><div class="line">        e = next;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> e;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>删除元素其实也是首先计算has值，之后会根据hash值回去元素的索引值，之后遍历索引位置处的链表，之后再进行entry的比对，如果想等，就会删除这个元素，这里要注意的是之前提到过的一旦HashMap中的元素发生删除或增加的改变时，会增加<code>modCount</code></p>
<h1 id="4-遍历HashMap"><a href="#4-遍历HashMap" class="headerlink" title="4. 遍历HashMap"></a>4. 遍历HashMap</h1><p>一般遍历HashMap都是通过迭代器来遍历:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  Iterator iter = map.entrySet().iterator();</div><div class="line">　<span class="keyword">while</span> (iter.hasNext()) &#123;</div><div class="line">　　	   Map.Entry entry = (Map.Entry) iter.next();</div><div class="line">　　    Object key = entry.getKey();</div><div class="line">　　    Object val = entry.getValue();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>用迭代器来遍历Hashmap时，<strong>不可以调用put或remove这样会更改HashMap中Entry数量的操作，如果调用了，会抛出ConcurrentModificationException</strong>，这是因为<code>fast-fail</code>机制，至于具体原因，从下面的代码分析中可以知道</p>
</blockquote>
<h2 id="4-1-entrySet"><a href="#4-1-entrySet" class="headerlink" title="4.1 entrySet"></a>4.1 entrySet</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet() &#123;</div><div class="line">    <span class="keyword">return</span> entrySet0();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet0() &#123;</div><div class="line">    Set&lt;Map.Entry&lt;K,V&gt;&gt; es = entrySet;</div><div class="line">    <span class="keyword">return</span> es != <span class="keyword">null</span> ? es : (entrySet = <span class="keyword">new</span> EntrySet());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用<code>entrySet()</code>以后会返回一个<code>EntrySet</code>对象</p>
<h2 id="4-2-EntrySet-iterator"><a href="#4-2-EntrySet-iterator" class="headerlink" title="4.2 EntrySet.iterator"></a>4.2 EntrySet.iterator</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Iterator&lt;Map.Entry&lt;K,V&gt;&gt; iterator() &#123;</div><div class="line">    <span class="keyword">return</span> newEntryIterator();</div><div class="line">&#125;</div><div class="line">    </div><div class="line">Iterator&lt;Map.Entry&lt;K,V&gt;&gt; newEntryIterator()   &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> EntryIterator();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>EntryIterator</code>继承自<code>HashIterator</code>, <code>EntryIterator.next</code>实际调用的是其父类<code>HashIterator.nextEntry()</code></p>
<h2 id="4-3-HashIterator构造函数"><a href="#4-3-HashIterator构造函数" class="headerlink" title="4.3 HashIterator构造函数"></a>4.3 HashIterator构造函数</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HashIterator</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">       HashMapEntry&lt;K,V&gt; next;        <span class="comment">// next entry to return</span></div><div class="line">       <span class="keyword">int</span> expectedModCount;   <span class="comment">// For fast-fail</span></div><div class="line">       <span class="keyword">int</span> index;              <span class="comment">// current slot</span></div><div class="line">       HashMapEntry&lt;K,V&gt; current;     <span class="comment">// current entry</span></div><div class="line"></div><div class="line">       HashIterator() &#123;</div><div class="line">           expectedModCount = modCount;</div><div class="line">           <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123; <span class="comment">// advance to first entry</span></div><div class="line">               HashMapEntry[] t = table;</div><div class="line">               <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="keyword">null</span>)</div><div class="line">                   ;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       ...</div><div class="line">       </div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>在<code>HashIterator</code>中有一个很重要的变量<code>expectedModCount</code>, 可以看到在构造函数中将它的值摄为了<code>HashMap.modCount</code>，这就意味着<code>HashIterator</code>对象一旦创建，<code>expectedModCount</code>值就是固定的，如果在用迭代器遍历HashMap时进行<code>put</code>或<code>remove</code>，那么<code>modCount</code>值必然会和<code>expectedModCount</code>不相等，一旦不相等，就会抛出<code>ConcurrentModificationException</code></p>
<h2 id="4-4-HashIterator-nextEntry"><a href="#4-4-HashIterator-nextEntry" class="headerlink" title="4.4 HashIterator.nextEntry"></a>4.4 HashIterator.nextEntry</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">nextEntry</span><span class="params">()</span> </span>&#123;</div><div class="line">         <span class="keyword">if</span> (modCount != expectedModCount)</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</div><div class="line"></div><div class="line">         HashMapEntry&lt;K,V&gt; e = next;</div><div class="line">         <span class="keyword">if</span> (e == <span class="keyword">null</span>)</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException();</div><div class="line"></div><div class="line">         <span class="keyword">if</span> ((next = e.next) == <span class="keyword">null</span>) &#123;</div><div class="line">             HashMapEntry[] t = table;</div><div class="line">             <span class="keyword">while</span> (index &lt; t.length &amp;&amp; (next = t[index++]) == <span class="keyword">null</span>)</div><div class="line">                   ;</div><div class="line">         &#125;</div><div class="line">         current = e;</div><div class="line">         <span class="keyword">return</span> e;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到，正如之前所说，当<code>expectedModCount != modCount</code>时，会抛出<code>ConcurrentModificationException</code>, 那如果想在遍历的时候也可以进行删除操作，应该通过什么方法呢？答案是通过<code>Iterator.remove</code></p>
<h2 id="4-5-HashIterator-remove"><a href="#4-5-HashIterator-remove" class="headerlink" title="4.5 HashIterator.remove"></a>4.5 HashIterator.remove</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (current == <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (modCount != expectedModCount)</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</div><div class="line"></div><div class="line">        Object k = current.key;</div><div class="line">        current = <span class="keyword">null</span>;</div><div class="line">        HashMap.<span class="keyword">this</span>.removeEntryForKey(k);</div><div class="line">        expectedModCount = modCount;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>由于<code>HashIterator</code>是HashMap的内部类，所以可以调用HashMap的内部方法<code>removeEntryForKey</code>，当删除完entry后，会更新<code>expectedModCount</code>,这样在进行下一次的<code>next()</code>调用时， <code>expectedModCount</code>就会与<code>modCount</code>保持一致</p>
<h1 id="5-遍历key和遍历value"><a href="#5-遍历key和遍历value" class="headerlink" title="5. 遍历key和遍历value"></a>5. 遍历key和遍历value</h1><p>如果通过迭代器遍历key和遍历value时的注意事项跟用迭代器遍历HashMap的注意事项一样，也是不可以在遍历时调用<code>remove</code>方法，原理也是一样的，内部有一个<code>expectedModCount</code>，如果要删除要掉用迭代器的<code>remove</code>方法</p>
<h1 id="6-Java8新特性"><a href="#6-Java8新特性" class="headerlink" title="6. Java8新特性"></a>6. Java8新特性</h1><p>在Java8中新增了<code>forEach</code>方法，接收一个<code>BiConsumere&lt;? super K, ? super V&gt;</code>参数，这个参数是一个<strong>函数式接口</strong>，所谓函数式接口是指接口只有一个待实现的方法(Java8中，接口可以有默认的实现), 函数式接口可以用<code>lambda</code>表达式来代替, <code>BiConsumer&lt;K, V&gt;</code>的<code>lambda</code>表达式原型是<code>(K, V) - Void</code>, 即传入K,V, 返回Void</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://wiki.jikexueyuan.com/project/java-collection/hashmap.html" target="_blank" rel="external">HashMap的实现原理</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/Retrofit学习-三/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/Retrofit学习-三/" itemprop="url">Retrofit学习(三)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:41:55+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Retrofit/" itemprop="url" rel="index">
                    <span itemprop="name">Retrofit</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>目前比较流行的使用Retrofit的方法是<code>Retrofit + RxJava + Gson</code>, 之前的<a href="http://www.jianshu.com/p/e2a9871036b9" target="_blank" rel="external">Retrofit学习(二)</a>已经分析过Retrofit是如何结合RxJava，这一篇主要看一下同Gson的结合</p>
<p>要想在Retrofit中使用Gson, 需要添加Gson对应的Converter:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">OkHttpclient client = <span class="keyword">new</span> OkHttpClient.Builder().build();</div><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">    .client(client)</div><div class="line">    .addCallAdapterFactory(RxJava2CallAdapterFactory.create())</div><div class="line">    <span class="comment">//添加Gson</span></div><div class="line">    .addConverterFactory(GsonConverterFactory.create())</div><div class="line">    .baseUrl(<span class="string">"http://localhost:4567/"</span>)</div><div class="line">    .build();</div></pre></td></tr></table></figure></p>
<h2 id="GsonConverterFactory"><a href="#GsonConverterFactory" class="headerlink" title="GsonConverterFactory"></a>GsonConverterFactory</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GsonConverterFactory</span> <span class="keyword">extends</span> <span class="title">Converter</span>.<span class="title">Factory</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GsonConverterFactory <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> create(<span class="keyword">new</span> Gson());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> GsonConverterFactory <span class="title">create</span><span class="params">(Gson gson)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GsonConverterFactory(gson);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Gson gson;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">GsonConverterFactory</span><span class="params">(Gson gson)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (gson == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"gson == null"</span>);</div><div class="line">        <span class="keyword">this</span>.gson = gson;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotations,</div><div class="line">                                                            Retrofit retrofit) &#123;</div><div class="line">        TypeAdapter&lt;?&gt; adapter = gson.getAdapter(TypeToken.get(type));</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GsonResponseBodyConverter&lt;&gt;(gson, adapter);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">public</span> Converter&lt;?, RequestBody&gt; requestBodyConverter(Type type,</div><div class="line">                                                          Annotation[] parameterAnnotations, Annotation[] methodAnnotations, Retrofit retrofit) &#123;</div><div class="line">        TypeAdapter&lt;?&gt; adapter = gson.getAdapter(TypeToken.get(type));</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> GsonRequestBodyConverter&lt;&gt;(gson, adapter);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从之前的<a href="http://www.jianshu.com/p/62680bcc259f" target="_blank" rel="external">Retrofit学习(一)</a>中我们可以知道，每次调用接口方法时都会通过<code>ServiceMethod.Builder.build()</code>创建一个<code>ServiceMethod</code>对象, <code>ServiceMethod.Builder.build()</code>会初始化<code>responseConverter</code>, 经过一系列调用最终会调用<code>Converter.Factory.responseBodyConverter</code>，如果在初始化Retrofit时添加了<code>GsonConverterFactory</code>，则会相应地调用<code>GsonConverterFactory.responseBodyConverter</code></p>
<h2 id="GsonConverterFactory-responseBodyConverter"><a href="#GsonConverterFactory-responseBodyConverter" class="headerlink" title="GsonConverterFactory.responseBodyConverter"></a>GsonConverterFactory.responseBodyConverter</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] 	annotations,Retrofit retrofit) &#123;</div><div class="line">       TypeAdapter&lt;?&gt; adapter = gson.getAdapter(TypeToken.get(type));</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> GsonResponseBodyConverter&lt;&gt;(gson, adapter);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>从之前的<a href="http://www.jianshu.com/p/62680bcc259f" target="_blank" rel="external">Retrofit学习(一)</a>和<a href="http://www.jianshu.com/p/e2a9871036b9" target="_blank" rel="external">Retrofit学习(二)</a>可以知道，最终的步骤都会是<code>OkHttpCall.execute</code>或<code>OkHttpCall.enqueue</code>，不论是<code>enqueue</code>还是<code>execute</code>,都会调用<code>OkHttpCall.parseResponse</code>方法，该方法最主要的作用是从<code>okhttp3.Response</code>中得到<code>okhttp3.ResponseBody</code>，之后调用<code>ServiceMethod.toResponse</code></p>
<h2 id="ServiceMethod-toResponse"><a href="#ServiceMethod-toResponse" class="headerlink" title="ServiceMethod.toResponse"></a>ServiceMethod.toResponse</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">R <span class="title">toResponse</span><span class="params">(ResponseBody body)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">return</span> responseConverter.convert(body);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用<code>Converter.convert</code>转换结果，这里的<code>Convert</code>就是<code>GsonResponseBodyConverter</code></p>
<h2 id="GsonResponseBodyConverter-convert"><a href="#GsonResponseBodyConverter-convert" class="headerlink" title="GsonResponseBodyConverter.convert"></a>GsonResponseBodyConverter.convert</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">convert</span><span class="params">(ResponseBody value)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       JsonReader jsonReader = gson.newJsonReader(value.charStream());</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">return</span> adapter.read(jsonReader);</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           value.close();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/Retrofit学习-二/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/Retrofit学习-二/" itemprop="url">Retrofit学习(二)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:22:11+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Retrofit/" itemprop="url" rel="index">
                    <span itemprop="name">Retrofit</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前的<a href="https://wangyun137.github.io/2017/07/24/Retrofit%E5%AD%A6%E4%B9%A0-%E4%B8%80/">Retrofit学习(一)</a>了解了一下<code>Retrofit</code>的最基本使用，不过目前最流行的<code>Retrofit</code>使用方式是<code>Retrofit + RxJava + Gson</code>, 如果要使用<code>RxJava</code>, 需要在创建<code>Retrofit</code>时配置<code>RxJava</code>对应的CallAdapter:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">OkHttpclient client = <span class="keyword">new</span> OkHttpClient.Builder().build();</div><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">    .client(client)</div><div class="line">    .addCallAdapterFactory(RxJava2CallAdapterFactory.create())</div><div class="line">    .baseUrl(<span class="string">"http://localhost:4567/"</span>)</div><div class="line">    .build();</div></pre></td></tr></table></figure>
<p>下面就主要分析一下<code>RxJava2CallAdapterFactory</code>是如何工作的</p>
<h2 id="RxJava2CallAdapterFactory"><a href="#RxJava2CallAdapterFactory" class="headerlink" title="RxJava2CallAdapterFactory"></a>RxJava2CallAdapterFactory</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RxJava2CallAdapterFactory <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RxJava2CallAdapterFactory(<span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RxJava2CallAdapterFactory <span class="title">createAsync</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RxJava2CallAdapterFactory(<span class="keyword">null</span>, <span class="keyword">true</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RxJava2CallAdapterFactory <span class="title">createWithScheduler</span><span class="params">(Scheduler scheduler)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"scheduler == null"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RxJava2CallAdapterFactory(scheduler, <span class="keyword">false</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Scheduler scheduler;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isAsync;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">RxJava2CallAdapterFactory</span><span class="params">(Scheduler scheduler, <span class="keyword">boolean</span> isAsync)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.scheduler = scheduler;</div><div class="line">    <span class="keyword">this</span>.isAsync = isAsync;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>RxJava2CallAdapterFactory</code>提供了三个<code>create</code>系列方法，一般情况下，最常使用的是第一个没有参数的<code>create</code>方法，即不指定<code>Scheduler</code>，<code>isAsync = false</code>, <code>isAsync</code>指明是调用<code>Call.execute</code>还是<code>Call.enqueue</code></p>
<h2 id="RxJava2CallAdapterFactory-get"><a href="#RxJava2CallAdapterFactory-get" class="headerlink" title="RxJava2CallAdapterFactory.get"></a>RxJava2CallAdapterFactory.get</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</div><div class="line">    Class&lt;?&gt; rawType = getRawType(returnType);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (rawType == Completable.class) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RxJava2CallAdapter(Void.class, scheduler, isAsync, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</div><div class="line">                <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> isFlowable = rawType == Flowable.class;</div><div class="line">    <span class="keyword">boolean</span> isSingle = rawType == Single.class;</div><div class="line">    <span class="keyword">boolean</span> isMaybe = rawType == Maybe.class;</div><div class="line">    <span class="comment">//确保返回值是Observable, Flowable, Single, Maybe</span></div><div class="line">    <span class="keyword">if</span> (rawType != Observable.class &amp;&amp; !isFlowable &amp;&amp; !isSingle &amp;&amp; !isMaybe) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> isResult = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">boolean</span> isBody = <span class="keyword">false</span>;</div><div class="line">    Type responseType;</div><div class="line">    <span class="comment">//ParameterizedType指泛型类型，如List&lt;T&gt;</span></div><div class="line">    <span class="keyword">if</span> (!(returnType <span class="keyword">instanceof</span> ParameterizedType)) &#123;</div><div class="line">        String name = isFlowable ? <span class="string">"Flowable"</span></div><div class="line">                : isSingle ? <span class="string">"Single"</span></div><div class="line">                : isMaybe ? <span class="string">"Maybe"</span> : <span class="string">"Observable"</span>;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//获取返回值的泛型参数</span></div><div class="line">    Type observableType = getParameterUpperBound(<span class="number">0</span>, (ParameterizedType) returnType);</div><div class="line">    Class&lt;?&gt; rawObservableType = getRawType(observableType);</div><div class="line">    <span class="keyword">if</span> (rawObservableType == Response.class) &#123;</div><div class="line">        <span class="comment">//如果泛型参数是Response, 且Response没有泛型参数,抛出异常，Response必须是以泛型形式使用</span></div><div class="line">        <span class="keyword">if</span> (!(observableType <span class="keyword">instanceof</span> ParameterizedType)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//获取Response&lt;T&gt;中的T</span></div><div class="line">        responseType = getParameterUpperBound(<span class="number">0</span>, (ParameterizedType) observableType);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawObservableType == Result.class) &#123;</div><div class="line">        <span class="comment">//如果泛型参数是Result, 且Result没有泛型参数， 抛出异常，Result必须是以泛型形式使用</span></div><div class="line">        <span class="keyword">if</span> (!(observableType <span class="keyword">instanceof</span> ParameterizedType)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//获取Result&lt;T&gt;中的T</span></div><div class="line">        responseType = getParameterUpperBound(<span class="number">0</span>, (ParameterizedType) observableType);</div><div class="line">        isResult = <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        responseType = observableType;</div><div class="line">        isBody = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RxJava2CallAdapter(responseType, scheduler, isAsync, isResult, isBody, isFlowable,</div><div class="line">            isSingle, isMaybe, <span class="keyword">false</span>);</div><div class="line">&#125;``</div></pre></td></tr></table></figure>
<ol>
<li>如果返回值类型是<code>Completable</code>， 直接返回一个<code>RxJava2CallAdapter</code>指定其中的<code>isBody = true, isCompletable = true</code></li>
<li>确保方法的返回值<code>Observable</code>, <code>Flowable</code>, <code>Single</code>, <code>Maybe</code>, 否则返回null, 如果是null, 则根据之前的分析，如果<code>CallAdapter.Factory.get()</code>返回null, 在<code>Retrofit.nextCallAdapter</code>中会抛出异常(<code>Retrofit</code>默认有一个<code>ExecutorCallAdapterFactory</code>, 但如果方法返回值不是<code>Call</code>类型，其<code>get()</code>方法会直接返回null)</li>
<li>如果返回值不是泛型，抛出异常</li>
<li>获取返回值中的泛型参数的类型，假设返回值类型<code>Observable&lt;Bean&gt;</code>, 这里获取到的泛型参数类型就是<code>Bean</code></li>
<li>如果泛型参数的类型是<code>retrofit2.Response</code>或<code>retrofit2.Result</code>，确保<code>Response</code>和<code>Result</code>也是以泛型的形式声明的，即返回值类型是<code>Observable&lt;Response&lt;T&gt;&gt;</code>或<code>Observable&lt;Result&lt;T&gt;&gt;</code>；<code>Retrofit + RxJava2</code>最常见的的用法是<code>Observable&lt;Bean&gt; getName(...)</code>, 一般都会直接使用自定义的<code>Bean</code>类， 所以一般情况下， <code>isBody = true</code></li>
<li>返回<code>RxJava2CallAdapter</code></li>
</ol>
<h2 id="RxJava2CallAdapter-adapt"><a href="#RxJava2CallAdapter-adapt" class="headerlink" title="RxJava2CallAdapter.adapt"></a>RxJava2CallAdapter.adapt</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">adapt</span><span class="params">(Call&lt;R&gt; call)</span> </span>&#123;</div><div class="line">    <span class="comment">//call是OkHttpCall, 将R转换为Response&lt;R&gt;</span></div><div class="line">    Observable&lt;Response&lt;R&gt;&gt; responseObservable = isAsync</div><div class="line">            ? <span class="keyword">new</span> CallEnqueueObservable&lt;&gt;(call)</div><div class="line">            : <span class="keyword">new</span> CallExecuteObservable&lt;&gt;(call);</div><div class="line"></div><div class="line">    Observable&lt;?&gt; observable;</div><div class="line">    <span class="keyword">if</span> (isResult) &#123;</div><div class="line">        observable = <span class="keyword">new</span> ResultObservable&lt;&gt;(responseObservable);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBody) &#123;</div><div class="line">        <span class="comment">//将Response&lt;T&gt;转换为T</span></div><div class="line">        observable = <span class="keyword">new</span> BodyObservable&lt;&gt;(responseObservable);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        observable = responseObservable;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (scheduler != <span class="keyword">null</span>) &#123;</div><div class="line">        observable = observable.subscribeOn(scheduler);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isFlowable) &#123;</div><div class="line">        <span class="keyword">return</span> observable.toFlowable(BackpressureStrategy.LATEST);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isSingle) &#123;</div><div class="line">        <span class="keyword">return</span> observable.singleOrError();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isMaybe) &#123;</div><div class="line">        <span class="keyword">return</span> observable.singleElement();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isCompletable) &#123;</div><div class="line">        <span class="keyword">return</span> observable.ignoreElements();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> observable;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先生成一个<code>Obsersavle&lt;Response&lt;R&gt;&gt;</code>, 这里会根据<code>isAsync</code>是否为tru,来确定是生成<code>CallEnqueueObservable</code>还是<code>CallExecuteObservable</code>，这两者的区别在于前者最终实际是调用<code>OkHttpCall.enqueue</code>方法，后者实际调用了<code>OkHttpCall.execute</code>方法， 前者异步执行，后者同步执行</li>
<li><code>Retrofit + RxJava2</code>最常见的的用法是<code>Observable&lt;Bean&gt; getName(...)</code>, 一般都会直接使用自定义的<code>Bean</code>类，</li>
<li>根据之前的分析可以知道，一般情况下，由于开发者都直接使用自己的Bean, 所以<code>isBody = true</code>， 会创建一个<code>BodyObservable</code></li>
<li>之后会根据方法返回值是否是<code>Flowable, Single, Maybe, Completable</code>其中一种来做出具体的转换</li>
</ol>
<h2 id="BodyObservable"><a href="#BodyObservable" class="headerlink" title="BodyObservable"></a>BodyObservable</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BodyObservable</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Observable&lt;Response&lt;T&gt;&gt; upstream;</div><div class="line"></div><div class="line">    BodyObservable(Observable&lt;Response&lt;T&gt;&gt; upstream) &#123;</div><div class="line">        <span class="keyword">this</span>.upstream = upstream;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</div><div class="line">        <span class="comment">//upstream是CallExecuteObservable或CallEnqueueObservable, BodyObserver是一个代理</span></div><div class="line">        <span class="comment">//作用就是把Response&lt;T&gt;转换为T</span></div><div class="line">        upstream.subscribe(<span class="keyword">new</span> BodyObserver&lt;T&gt;(observer));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BodyObserver</span>&lt;<span class="title">R</span>&gt; <span class="keyword">implements</span> <span class="title">Observer</span>&lt;<span class="title">Response</span>&lt;<span class="title">R</span>&gt;&gt; </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Observer&lt;? <span class="keyword">super</span> R&gt; observer;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> terminated;</div><div class="line"></div><div class="line">        BodyObserver(Observer&lt;? <span class="keyword">super</span> R&gt; observer) &#123;</div><div class="line">            <span class="keyword">this</span>.observer = observer;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(Disposable disposable)</span> </span>&#123;</div><div class="line">            observer.onSubscribe(disposable);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Response&lt;R&gt; response)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (response.isSuccessful()) &#123;</div><div class="line">                observer.onNext(response.body());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                ...</div><div class="line">            &#125;            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (!terminated) &#123;</div><div class="line">                observer.onComplete();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable throwable)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (!terminated) &#123;</div><div class="line">                observer.onError(throwable);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里<code>upstream</code>是<code>CallExecutorObservable</code>或<code>CallEnqueueObservable</code>，一般情况下，这里会是<code>CallExecutorObservable</code>；<code>在subscribeActual</code>中可以看到，在传入的<code>observer</code>外又包装了一个<code>BodyObserver</code>, 传入的<code>observer</code>就是开发者传入的自定义<code>Observer</code></p>
<h1 id="CallExecutorObservable"><a href="#CallExecutorObservable" class="headerlink" title="CallExecutorObservable"></a>CallExecutorObservable</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CallExecuteObservable</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Observable</span>&lt;<span class="title">Response</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Call&lt;T&gt; originalCall;</div><div class="line"></div><div class="line">    CallExecuteObservable(Call&lt;T&gt; originalCall) &#123;</div><div class="line">        <span class="keyword">this</span>.originalCall = originalCall;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> Response&lt;T&gt;&gt; observer)</span> </span>&#123;</div><div class="line">        <span class="comment">//originalCall是OkHttpCall</span></div><div class="line">        Call&lt;T&gt; call = originalCall.clone();</div><div class="line">        observer.onSubscribe(<span class="keyword">new</span> CallDisposable(call));</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> terminated = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//call.execute会调用OkHttpCall.execute(), 从而得到okhttp3.Response</span></div><div class="line">            <span class="comment">//再从okhttp3.Response中得到okhttp3.ResponseBody, 然后调用    Converter.convert转换结果，最后将接过封装为retrofit.Response</span></div><div class="line">            Response&lt;T&gt; response = call.execute();</div><div class="line">            <span class="keyword">if</span> (!call.isCanceled()) &#123;</div><div class="line">            	<span class="comment">//BodyObserver.onNext -&gt; 自定义Onserver.onNext</span></div><div class="line">                observer.onNext(response);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!call.isCanceled()) &#123;</div><div class="line">                terminated = <span class="keyword">true</span>;</div><div class="line">                observer.onComplete();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CallDisposable</span> <span class="keyword">implements</span> <span class="title">Disposable</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Call&lt;?&gt; call;</div><div class="line"></div><div class="line">        CallDisposable(Call&lt;?&gt; call) &#123;</div><div class="line">            <span class="keyword">this</span>.call = call;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispose</span><span class="params">()</span> </span>&#123;</div><div class="line">            call.cancel();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDisposed</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> call.isCanceled();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>originalCall</code>是<code>OkHttpCall</code>, 可以看到在<code>subscribeActual</code>中会调用<code>call.execute</code>即调用<code>OkHttpCall.execute</code>来从而得到okhttp3.Response, 再从okhttp3.Response中得到okhttp3.ResponseBody, 然后调用    <code>Converter.convert</code>转换结果，最后将结果封装为<code>retrofit.Response</code>,</p>
<p><code>subscribeActual</code>的参数<code>observer</code>是<code>BodyObserver</code>, 而从之前的分析中可以看到<code>BodyObserver</code>的各方法会再调用开发人员自定义的<code>Observer</code>的响应方法</p>
<p> <strong>这里看似比较抽象的一系列操作，是为了获得一个统一的结果， 一般开发人员在定义请求方法时,都会使用<code>Observable&lt;Bean&gt;</code>这种方式，即直接将<code>Observable&lt;T&gt;</code>中的T设为自定义Bean, 但不同场景下肯定会定义不同的类型Bean, Retrofit不可能预先知道开发人员会定义那些Bean, 为了得到一个统一的结果，先将Bean转换为<code>Reponse&lt;T&gt;</code>,这样无论T是哪种类型，都可以得到一个统一的结果，之后再通过<code>Response.body()</code>将Response转换为自定义Bean</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/Retrofit学习-一/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/Retrofit学习-一/" itemprop="url">Retrofit学习(一)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:18:55+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Retrofit/" itemprop="url" rel="index">
                    <span itemprop="name">Retrofit</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一-使用用例"><a href="#一-使用用例" class="headerlink" title="一. 使用用例"></a>一. 使用用例</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//步骤【1】</span></div><div class="line">OkHttpclient client = <span class="keyword">new</span> OkHttpClient.Builder().build();</div><div class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</div><div class="line">	.client(client)</div><div class="line">       .baseUrl(<span class="string">"http://localhost:4567/"</span>)</div><div class="line">       .build();</div><div class="line">   </div><div class="line">   </div><div class="line">   <span class="meta">@GET</span>(<span class="string">"/getName"</span>)</div><div class="line">   <span class="function">Call&lt;ResponseBody&gt; <span class="title">request</span><span class="params">(@Query(<span class="string">"name"</span>)</span> String name)</span>;</div><div class="line">  	</div><div class="line">   <span class="comment">//步骤【2】</span></div><div class="line">   IService service = retrofit.create(IService.class); </div><div class="line">   Call&lt;ResponseBody&gt; call = service.request(<span class="string">"test"</span>);</div><div class="line">   <span class="comment">//步骤【3】</span></div><div class="line">   call.enqueue(<span class="keyword">new</span> Callable() &#123;</div><div class="line">   	...</div><div class="line">   )</div></pre></td></tr></table></figure>
<h1 id="二-源码解析"><a href="#二-源码解析" class="headerlink" title="二. 源码解析"></a>二. 源码解析</h1><h2 id="1-Retrofit-Build"><a href="#1-Retrofit-Build" class="headerlink" title="1. Retrofit.Build"></a>1. Retrofit.Build</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">    <span class="comment">//一般情况下，Platform是Android</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>(Platform.get());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    Builder(Platform platform) &#123;</div><div class="line">            <span class="keyword">this</span>.platform = platform;</div><div class="line">            converterFactories.add(<span class="keyword">new</span> BuiltInConverters());</div><div class="line">        &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> Retrofit <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (baseUrl == <span class="keyword">null</span>) &#123;</div><div class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Base URL required."</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        okhttp3.Call.Factory callFactory = <span class="keyword">this</span>.callFactory;</div><div class="line">        <span class="keyword">if</span> (callFactory == <span class="keyword">null</span>) &#123;</div><div class="line">             callFactory = <span class="keyword">new</span> OkHttpClient();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Executor callbackExecutor = <span class="keyword">this</span>.callbackExecutor;</div><div class="line">        <span class="comment">//如果是Android平台，则Executor的实际逻辑就是在当前主线程中runnable</span></div><div class="line">        <span class="keyword">if</span> (callbackExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">            callbackExecutor = platform.defaultCallbackExecutor();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        List&lt;CallAdapter.Factory&gt; adapterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.adapterFactories);</div><div class="line">        <span class="comment">//如果是Android平台，defaultCallAdapterFactory是ExecutorCallAdapterFactory</span></div><div class="line">            adapterFactories.add(platform.defaultCallAdapterFactory(callbackExecutor));</div><div class="line"></div><div class="line">       <span class="comment">//如果没设置，默认没有convert</span></div><div class="line">       List&lt;Converter.Factory&gt; converterFactories = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.converterFactories);</div><div class="line"></div><div class="line">       <span class="comment">//validateEagerly默认为false</span></div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Retrofit(callFactory, baseUrl, converterFactories, adapterFactories,</div><div class="line">                    callbackExecutor, validateEagerly);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>如果没有设置<code>CallAdapter</code>,对于Android平台，默认使用<code>ExecutorCallAdapterFactory</code></li>
<li>如果没有设置<code>ConvertFactory</code>, 默认使用<code>BuiltInConverters</code></li>
</ol>
<h2 id="2-Retrofit-create"><a href="#2-Retrofit-create" class="headerlink" title="2. Retrofit.create"></a>2. Retrofit.create</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>&#123;</div><div class="line">	<span class="comment">//校验传入的Class是不是Interface,且定义了至少一个方法</span></div><div class="line">       Utils.validateServiceInterface(service);</div><div class="line">       <span class="keyword">if</span> (validateEagerly) &#123;</div><div class="line">       	<span class="comment">//如果是Android平台，isDefaultMethod = false, 将service中所有method都生成对应的</span></div><div class="line">       	<span class="comment">//ServiceMethod类，并放入缓存(核心调用为【2.1】loadServiceMethod)</span></div><div class="line">           eagerlyValidateMethods(service);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> (T) Proxy.newProxyInstance(service.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[]&#123;service&#125;,</div><div class="line">               <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">                   <span class="keyword">private</span> <span class="keyword">final</span> Platform platform = Platform.get();</div><div class="line"></div><div class="line">                   <span class="meta">@Override</span></div><div class="line">                   <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span></span></div><div class="line">                           <span class="keyword">throws</span> Throwable &#123;</div><div class="line">                       <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</div><div class="line">                           <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</div><div class="line">                       &#125;</div><div class="line">                       <span class="comment">//Android平台isDefaultMethod = false</span></div><div class="line">                       <span class="keyword">if</span> (platform.isDefaultMethod(method)) &#123;</div><div class="line">                           <span class="keyword">return</span> platform.invokeDefaultMethod(method, service, proxy, args);</div><div class="line">                       &#125;</div><div class="line">                       ServiceMethod&lt;Object, Object&gt; serviceMethod =</div><div class="line">                               (ServiceMethod&lt;Object, Object&gt;) loadServiceMethod(method);</div><div class="line">                       OkHttpCall&lt;Object&gt; okHttpCall = <span class="keyword">new</span> OkHttpCall&lt;&gt;(serviceMethod, args);</div><div class="line">                       <span class="keyword">return</span> serviceMethod.callAdapter.adapt(okHttpCall);</div><div class="line">                   &#125;</div><div class="line">               &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先校验传入的Class是不是一个接口</li>
<li>因为默认的validateEagly = false, 所以不执行eagerlyValidateMethods方法，该方法实质上根据接口中的所有方法生成每个方法相应的ServiceMethod，并放入缓存</li>
<li><strong>创建动态代理(核心步骤)，以后每次调用接口的方法都会调用InvocationHandler.invoke(…)方法</strong></li>
</ol>
<h3 id="2-1-Retrofit-loadServiceMethod"><a href="#2-1-Retrofit-loadServiceMethod" class="headerlink" title="2.1 Retrofit.loadServiceMethod"></a>2.1 Retrofit.loadServiceMethod</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ServiceMethod&lt;?, ?&gt; loadServiceMethod(Method method) &#123;</div><div class="line">    ServiceMethod&lt;?, ?&gt; result = serviceMethodCache.get(method);</div><div class="line">    <span class="keyword">if</span> (result != <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (serviceMethodCache) &#123;</div><div class="line">        result = serviceMethodCache.get(method);</div><div class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//【2.2】</span></div><div class="line">            result = <span class="keyword">new</span> ServiceMethod.Builder&lt;&gt;(<span class="keyword">this</span>, method).build();</div><div class="line">            serviceMethodCache.put(method, result);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>创建相应的<code>ServiceMethod</code>类，并放入缓存</p>
<h3 id="2-2-ServiceMethod-Builder"><a href="#2-2-ServiceMethod-Builder" class="headerlink" title="2.2 ServiceMethod.Builder"></a>2.2 ServiceMethod.Builder</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Builder(Retrofit retrofit, Method method) &#123;</div><div class="line">    <span class="keyword">this</span>.retrofit = retrofit;</div><div class="line">    <span class="keyword">this</span>.method = method;</div><div class="line">    <span class="keyword">this</span>.methodAnnotations = method.getAnnotations();</div><div class="line">    <span class="keyword">this</span>.parameterTypes = method.getGenericParameterTypes();</div><div class="line">    <span class="keyword">this</span>.parameterAnnotationsArray = method.getParameterAnnotations();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> ServiceMethod <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="comment">//获取CallAdapter, 【2.2.1】</span></div><div class="line">     callAdapter = createCallAdapter();</div><div class="line">     <span class="comment">//获取Call&lt;T&gt;中T的具体类型</span></div><div class="line">     responseType = callAdapter.responseType();</div><div class="line">     <span class="comment">//确保T并不是retrofit2.Response或者okhttp3.Response</span></div><div class="line">     <span class="keyword">if</span> (responseType == Response.class||responseType == okhttp3.Response.class) &#123;</div><div class="line">		...</div><div class="line">     &#125;</div><div class="line">     <span class="comment">//如果没有设置Converter,默认的Converter是BuiltInConverter, 通过</span></div><div class="line">     <span class="comment">//BuiltInConvert.responseBodyConverter返回Convert, </span></div><div class="line">     <span class="comment">//如果Annotation中Streaming, 则返回StreamingResponseBodyConverter， </span></div><div class="line">     <span class="comment">//否则返回BufferingResponseBodyConverter </span></div><div class="line">     <span class="comment">//【2.2.2】</span></div><div class="line">     responseConverter = createResponseConverter();</div><div class="line">     <span class="comment">//处理方法的注释, 【2.2.3】</span></div><div class="line">     <span class="keyword">for</span> (Annotation annotation : methodAnnotations) &#123;</div><div class="line">          parseMethodAnnotation(annotation);</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">if</span> (httpMethod == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> methodError(...);</div><div class="line">     &#125;</div><div class="line"></div><div class="line">    <span class="comment">//对于GET，HEAD等没有body的请求，不允许出现@FormEncodedUrl或@MultiPart等注释</span></div><div class="line">     <span class="keyword">if</span> (!hasBody) &#123;</div><div class="line">         <span class="keyword">if</span> (isMultipart) &#123;</div><div class="line">                <span class="keyword">throw</span> methodError(..);</div><div class="line">         &#125;</div><div class="line">         <span class="keyword">if</span> (isFormEncoded) &#123;</div><div class="line">               <span class="keyword">throw</span> methodError(...);</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">     <span class="comment">//处理参数的注解, 【2.2.4】</span></div><div class="line">     <span class="keyword">int</span> parameterCount = parameterAnnotationsArray.length;</div><div class="line">     parameterHandlers = <span class="keyword">new</span> ParameterHandler&lt;?&gt;[parameterCount];</div><div class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; parameterCount; p++) &#123;</div><div class="line">           Type parameterType = parameterTypes[p];</div><div class="line">            <span class="keyword">if</span> (Utils.hasUnresolvableType(parameterType)) &#123;</div><div class="line">                 <span class="keyword">throw</span> parameterError(...);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Annotation[] parameterAnnotations = parameterAnnotationsArray[p];</div><div class="line">            <span class="keyword">if</span> (parameterAnnotations == <span class="keyword">null</span>) &#123;</div><div class="line">                  <span class="keyword">throw</span> parameterError(...);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            parameterHandlers[p] = parseParameter(p, parameterType, parameterAnnotations);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (relativeUrl == <span class="keyword">null</span> &amp;&amp; !gotUrl) &#123;</div><div class="line">              <span class="keyword">throw</span> methodError(...);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//GET, DELETE等方法不可以有@Body</span></div><div class="line">       <span class="keyword">if</span> (!isFormEncoded &amp;&amp; !isMultipart &amp;&amp; !hasBody &amp;&amp; gotBody) &#123;</div><div class="line">             <span class="keyword">throw</span> methodError(...);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//有@FormUrlEncoded注释则参数中至少有一个@Field注释</span></div><div class="line">       <span class="keyword">if</span> (isFormEncoded &amp;&amp; !gotField) &#123;</div><div class="line">             <span class="keyword">throw</span> methodError(...);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//有@Multipart注释，参数中至少有一个@Part注释</span></div><div class="line">       <span class="keyword">if</span> (isMultipart &amp;&amp; !gotPart) &#123;</div><div class="line">             <span class="keyword">throw</span> methodError(...);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ServiceMethod&lt;&gt;(<span class="keyword">this</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ol>
<li>获取CallAdapter</li>
<li>获取Call<t>中T的具体类型，并确保T并不是retrofit2.Reponse或okhttp3.Response</t></li>
<li>获取Converter</li>
<li>处理方法注释</li>
<li>注释参数注释</li>
</ol>
<h4 id="2-2-1-ServiceMethod-createCallAdapter"><a href="#2-2-1-ServiceMethod-createCallAdapter" class="headerlink" title="2.2.1 ServiceMethod.createCallAdapter"></a>2.2.1 ServiceMethod.createCallAdapter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> CallAdapter&lt;T, R&gt; <span class="title">createCallAdapter</span><span class="params">()</span> </span>&#123;</div><div class="line">      Type returnType = method.getGenericReturnType();</div><div class="line">       <span class="comment">//返回值不能是TypeVariable和WildcardType</span></div><div class="line">       <span class="keyword">if</span> (Utils.hasUnresolvableType(returnType)) &#123;</div><div class="line">             <span class="keyword">throw</span> methodError(...);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//确保返回值不能是void</span></div><div class="line">       <span class="keyword">if</span> (returnType == <span class="keyword">void</span>.class) &#123;</div><div class="line">            <span class="keyword">throw</span> methodError(...);</div><div class="line">      &#125;</div><div class="line">      Annotation[] annotations = method.getAnnotations();</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">             <span class="keyword">return</span> (CallAdapter&lt;T, R&gt;) retrofit.callAdapter(returnType, annotations);</div><div class="line">      &#125; <span class="keyword">catch</span> (RuntimeException e) &#123; </div><div class="line">             <span class="keyword">throw</span> methodError(...);</div><div class="line">      &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="2-2-1-1-Retrofit-callAdapter"><a href="#2-2-1-1-Retrofit-callAdapter" class="headerlink" title="2.2.1.1 Retrofit.callAdapter"></a>2.2.1.1 Retrofit.callAdapter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> CallAdapter&lt;?, ?&gt; callAdapter(Type returnType, Annotation[] annotations) &#123;</div><div class="line">    <span class="keyword">return</span> nextCallAdapter(<span class="keyword">null</span>, returnType, annotations);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> CallAdapter&lt;?, ?&gt; nextCallAdapter(CallAdapter.Factory skipPast, Type returnType,</div><div class="line">                                         Annotation[] annotations) &#123;</div><div class="line">    checkNotNull(returnType, <span class="string">"returnType == null"</span>);</div><div class="line">    checkNotNull(annotations, <span class="string">"annotations == null"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">int</span> start = adapterFactories.indexOf(skipPast) + <span class="number">1</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = start, count = adapterFactories.size(); i &lt; count; i++) &#123;</div><div class="line">    	<span class="comment">//如果没有显示的设置，Android平台的默认只有一个CallAdapter.Factory -&gt; ExecutorCallAdapterFactory</span></div><div class="line">        CallAdapter&lt;?, ?&gt; adapter = adapterFactories.get(i).get(returnType, annotations, <span class="keyword">this</span>);</div><div class="line">        <span class="keyword">if</span> (adapter != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> adapter;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...        </div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(...);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="2-2-1-2-ExecutorCallAdapterFactory-get"><a href="#2-2-1-2-ExecutorCallAdapterFactory-get" class="headerlink" title="2.2.1.2 ExecutorCallAdapterFactory.get()"></a>2.2.1.2 ExecutorCallAdapterFactory.get()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> CallAdapter&lt;?, ?&gt; get(Type returnType, Annotation[] annotations, Retrofit retrofit) &#123;</div><div class="line">    <span class="comment">//确保返回值类型是Call</span></div><div class="line">    <span class="keyword">if</span> (getRawType(returnType) != Call.class) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//返回Call&lt;T&gt;的具体所指的类型</span></div><div class="line">    <span class="keyword">final</span> Type responseType = Utils.getCallResponseType(returnType);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CallAdapter&lt;Object, Call&lt;?&gt;&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Type <span class="title">responseType</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> responseType;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Call&lt;Object&gt; <span class="title">adapt</span><span class="params">(Call&lt;Object&gt; call)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ExecutorCallbackCall&lt;&gt;(callbackExecutor, call);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-2-ServiceMethod-createResponseConverter"><a href="#2-2-2-ServiceMethod-createResponseConverter" class="headerlink" title="2.2.2 ServiceMethod.createResponseConverter()"></a>2.2.2 ServiceMethod.createResponseConverter()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> Converter&lt;ResponseBody, T&gt; <span class="title">createResponseConverter</span><span class="params">()</span> </span>&#123;</div><div class="line">           Annotation[] annotations = method.getAnnotations();</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="keyword">return</span> retrofit.responseBodyConverter(responseType, annotations);</div><div class="line">           &#125; <span class="keyword">catch</span> (RuntimeException e) &#123; </div><div class="line">                <span class="keyword">throw</span> methodError(...);</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<h5 id="2-2-2-1-Retrofit-responseBodyConverter"><a href="#2-2-2-1-Retrofit-responseBodyConverter" class="headerlink" title="2.2.2.1 Retrofit.responseBodyConverter"></a>2.2.2.1 Retrofit.responseBodyConverter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Converter&lt;ResponseBody, T&gt; <span class="title">responseBodyConverter</span><span class="params">(Type type, Annotation[] annotations)</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> nextResponseBodyConverter(<span class="keyword">null</span>, type, annotations);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="keyword">public</span> &lt;T&gt; <span class="function">Converter&lt;ResponseBody, T&gt; <span class="title">nextResponseBodyConverter</span><span class="params">(Converter.Factory skipPast,Type type, Annotation[] annotations)</span> </span>&#123;</div><div class="line">   </div><div class="line">       checkNotNull(type, <span class="string">"type == null"</span>);</div><div class="line">       checkNotNull(annotations, <span class="string">"annotations == null"</span>);</div><div class="line"></div><div class="line">       <span class="keyword">int</span> start = converterFactories.indexOf(skipPast) + <span class="number">1</span>;</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = start, count = converterFactories.size(); i &lt; count; i++) &#123;</div><div class="line">       	<span class="comment">//如果没有显示设置， convertFactories里面只有BuiltInConverters</span></div><div class="line">           Converter&lt;ResponseBody, ?&gt; converter =</div><div class="line">                   converterFactories.get(i).responseBodyConverter(type, annotations, <span class="keyword">this</span>);</div><div class="line">           <span class="keyword">if</span> (converter != <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">return</span> (Converter&lt;ResponseBody, T&gt;) converter;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       ...</div><div class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(...);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h5 id="2-2-2-2-BuiltInConverters-responseBodyConverter"><a href="#2-2-2-2-BuiltInConverters-responseBodyConverter" class="headerlink" title="2.2.2.2 BuiltInConverters.responseBodyConverter"></a>2.2.2.2 BuiltInConverters.responseBodyConverter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="keyword">public</span> Converter&lt;ResponseBody, ?&gt; responseBodyConverter(Type type, Annotation[] annotations,</div><div class="line">                                                           Retrofit retrofit) &#123;</div><div class="line">       <span class="keyword">if</span> (type == ResponseBody.class) &#123;</div><div class="line">           <span class="keyword">return</span> Utils.isAnnotationPresent(annotations, Streaming.class)</div><div class="line">                   ? StreamingResponseBodyConverter.INSTANCE</div><div class="line">                   : BufferingResponseBodyConverter.INSTANCE;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (type == Void.class) &#123;</div><div class="line">           <span class="keyword">return</span> VoidResponseBodyConverter.INSTANCE;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="2-2-3-ServiceMethod-parseMethodAnnotation"><a href="#2-2-3-ServiceMethod-parseMethodAnnotation" class="headerlink" title="2.2.3 ServiceMethod.parseMethodAnnotation"></a>2.2.3 ServiceMethod.parseMethodAnnotation</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseMethodAnnotation</span><span class="params">(Annotation annotation)</span> </span>&#123;</div><div class="line">           <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> DELETE) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"DELETE"</span>, ((DELETE) annotation).value(), <span class="keyword">false</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> GET) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"GET"</span>, ((GET) annotation).value(), <span class="keyword">false</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> HEAD) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"HEAD"</span>, ((HEAD) annotation).value(), <span class="keyword">false</span>);</div><div class="line">               <span class="keyword">if</span> (!Void.class.equals(responseType)) &#123;</div><div class="line">                   <span class="keyword">throw</span> methodError(<span class="string">"HEAD method must use Void as response type."</span>);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> PATCH) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"PATCH"</span>, ((PATCH) annotation).value(), <span class="keyword">true</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> POST) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"POST"</span>, ((POST) annotation).value(), <span class="keyword">true</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> PUT) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"PUT"</span>, ((PUT) annotation).value(), <span class="keyword">true</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> OPTIONS) &#123;</div><div class="line">               parseHttpMethodAndPath(<span class="string">"OPTIONS"</span>, ((OPTIONS) annotation).value(), <span class="keyword">false</span>);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> HTTP) &#123;</div><div class="line">               HTTP http = (HTTP) annotation;</div><div class="line">               parseHttpMethodAndPath(http.method(), http.path(), http.hasBody());</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> retrofit2.http.Headers) &#123;</div><div class="line">               String[] headersToParse = ((retrofit2.http.Headers) annotation).value();</div><div class="line">               <span class="keyword">if</span> (headersToParse.length == <span class="number">0</span>) &#123;</div><div class="line">                   <span class="keyword">throw</span> methodError(<span class="string">"@Headers annotation is empty."</span>);</div><div class="line">               &#125;</div><div class="line">               headers = parseHeaders(headersToParse);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> Multipart) &#123;</div><div class="line">               <span class="keyword">if</span> (isFormEncoded) &#123;</div><div class="line">                   <span class="keyword">throw</span> methodError(<span class="string">"Only one encoding annotation is allowed."</span>);</div><div class="line">               &#125;</div><div class="line">               isMultipart = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (annotation <span class="keyword">instanceof</span> FormUrlEncoded) &#123;</div><div class="line">               <span class="keyword">if</span> (isMultipart) &#123;</div><div class="line">                   <span class="keyword">throw</span> methodError(<span class="string">"Only one encoding annotation is allowed."</span>);</div><div class="line">               &#125;</div><div class="line">               isFormEncoded = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p><code>parseMethodAnnotation</code>方法主要就是用过<code>parseHttpMethodAndPath</code>方法设置<code>ServiceMethhod</code>的请求方法，相对Url,  是否有body等选项</p>
<h4 id="2-2-4-ServiceMethod-parseParameter"><a href="#2-2-4-ServiceMethod-parseParameter" class="headerlink" title="2.2.4 ServiceMethod.parseParameter"></a>2.2.4 ServiceMethod.parseParameter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ParameterHandler&lt;?&gt; parseParameter(<span class="keyword">int</span> p, Type parameterType, Annotation[] annotations) &#123;</div><div class="line">     ParameterHandler&lt;?&gt; result = <span class="keyword">null</span>;</div><div class="line">     <span class="keyword">for</span> (Annotation annotation : annotations) &#123;</div><div class="line">          <span class="comment">//核心调用</span></div><div class="line">         ParameterHandler&lt;?&gt; annotationAction = parseParameterAnnotation(</div><div class="line">                        p, parameterType, annotations, annotation);</div><div class="line">         <span class="keyword">if</span> (annotationAction == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">continue</span>;</div><div class="line">          &#125;</div><div class="line">         <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">throw</span> parameterError(...);</div><div class="line">         &#125;</div><div class="line">         result = annotationAction;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> parameterError(p, <span class="string">"No Retrofit annotation found."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法中的核心调用<code>parseParameterAnnotation</code>,这个方法的主要作用是根据参数的注解进行不同的处理，参数的注解可以是以下几种:</p>
<ul>
<li>@Url</li>
<li>@Path</li>
<li>@Query</li>
<li>@QueryName</li>
<li>@QueryMap</li>
<li>@Header</li>
<li>@HeaderMap</li>
<li>@Field</li>
<li>@FieldMap</li>
<li>@Part</li>
<li>@PartMap</li>
<li>@Body</li>
</ul>
<h3 id="2-3-ServiceMethod-callAdapter-adapter"><a href="#2-3-ServiceMethod-callAdapter-adapter" class="headerlink" title="2.3 ServiceMethod.callAdapter.adapter"></a>2.3 ServiceMethod.callAdapter.adapter</h3><p>ServiceMethod.callAdapter是通过<code>ExcecutorAdapterFactory.get()</code>创建的一个匿名<code>CallAdapter</code>, 其实现为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">new</span> CallAdapter&lt;Object, Call&lt;?&gt;&gt;() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Type <span class="title">responseType</span><span class="params">()</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> responseType;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> Call&lt;Object&gt; <span class="title">adapt</span><span class="params">(Call&lt;Object&gt; call)</span> </span>&#123;</div><div class="line">               <span class="keyword">return</span> <span class="keyword">new</span> ExecutorCallbackCall&lt;&gt;(callbackExecutor, call);</div><div class="line">           &#125;</div><div class="line">       &#125;;</div><div class="line">       </div><div class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorCallbackCall</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Call</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">   	<span class="keyword">final</span> Executor callbackExecutor;</div><div class="line">       <span class="keyword">final</span> Call&lt;T&gt; delegate;</div><div class="line">   	....</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>由此可以看出，最终真正返回的是<code>ExecutorCallbackCall</code>, 其中<code>delagate</code>是<code>OkHttpCall</code></p>
<h2 id="3-ExecutorCallbackCall-enqueue"><a href="#3-ExecutorCallbackCall-enqueue" class="headerlink" title="3. ExecutorCallbackCall.enqueue"></a>3. ExecutorCallbackCall.enqueue</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;</div><div class="line">   	<span class="keyword">if</span> (callback == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"callback == null"</span>);</div><div class="line">	<span class="comment">//实际是调用OkHttpCall.enqueue</span></div><div class="line">       delegate.enqueue(<span class="keyword">new</span> Callback&lt;T&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(Call&lt;T&gt; call, <span class="keyword">final</span> Response&lt;T&gt; response)</span> </span>&#123;</div><div class="line">                   callbackExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                           <span class="keyword">if</span> (delegate.isCanceled()) &#123;</div><div class="line">                               callback.onFailure(ExecutorCallbackCall.<span class="keyword">this</span>, <span class="keyword">new</span> IOException(<span class="string">"Canceled"</span>));</div><div class="line">                           &#125; <span class="keyword">else</span> &#123;</div><div class="line">                               callback.onResponse(ExecutorCallbackCall.<span class="keyword">this</span>, response);</div><div class="line">                           &#125;</div><div class="line">                       &#125;</div><div class="line">                   &#125;);</div><div class="line">               &#125;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Call&lt;T&gt; call, <span class="keyword">final</span> Throwable t)</span> </span>&#123;</div><div class="line">                   callbackExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                       <span class="meta">@Override</span></div><div class="line">                       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                           callback.onFailure(ExecutorCallbackCall.<span class="keyword">this</span>, t);</div><div class="line">                       &#125;</div><div class="line">                   &#125;);</div><div class="line">               &#125;</div><div class="line">      &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>可以看到实际调用的是<code>OkHttpCall.enqueue</code></p>
<h3 id="3-1-OkHttpCall-enqueue"><a href="#3-1-OkHttpCall-enqueue" class="headerlink" title="3.1 OkHttpCall.enqueue"></a>3.1 OkHttpCall.enqueue</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(<span class="keyword">final</span> Callback&lt;T&gt; callback)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (callback == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"callback == null"</span>);</div><div class="line"></div><div class="line">       okhttp3.Call call;</div><div class="line">       Throwable failure;</div><div class="line"></div><div class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (executed)</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already executed."</span>);</div><div class="line">           executed = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">           call = rawCall;</div><div class="line">           failure = creationFailure;</div><div class="line">           <span class="keyword">if</span> (call == <span class="keyword">null</span> &amp;&amp; failure == <span class="keyword">null</span>) &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">               	<span class="comment">//【3.1.1】</span></div><div class="line">                   call = rawCall = createRawCall();</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                   failure = creationFailure = t;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (failure != <span class="keyword">null</span>) &#123;</div><div class="line">           callback.onFailure(<span class="keyword">this</span>, failure);</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (canceled) &#123;</div><div class="line">           call.cancel();</div><div class="line">       &#125;</div><div class="line">	<span class="comment">//调用okhttp3.Call.enqueue,后续走的就是okhttp请求的流程</span></div><div class="line">       call.enqueue(<span class="keyword">new</span> okhttp3.Callback() &#123;</div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(okhttp3.Call call, okhttp3.Response rawResponse)</span></span></div><div class="line">                   <span class="keyword">throws</span> IOException &#123;</div><div class="line">               Response&lt;T&gt; response;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">//【3.1.2】</span></div><div class="line">                   response = parseResponse(rawResponse);</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable e) &#123;</div><div class="line">                   callFailure(e);</div><div class="line">                   <span class="keyword">return</span>;</div><div class="line">               &#125;</div><div class="line">               callSuccess(response);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(okhttp3.Call call, IOException e)</span> </span>&#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   callback.onFailure(OkHttpCall.<span class="keyword">this</span>, e);</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                   t.printStackTrace();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callFailure</span><span class="params">(Throwable e)</span> </span>&#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   callback.onFailure(OkHttpCall.<span class="keyword">this</span>, e);</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                   t.printStackTrace();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callSuccess</span><span class="params">(Response&lt;T&gt; response)</span> </span>&#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   callback.onResponse(OkHttpCall.<span class="keyword">this</span>, response);</div><div class="line">               &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                   t.printStackTrace();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="3-1-1-OkHttpCall-createNewCall"><a href="#3-1-1-OkHttpCall-createNewCall" class="headerlink" title="3.1.1 OkHttpCall.createNewCall"></a>3.1.1 OkHttpCall.createNewCall</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> okhttp3.<span class="function">Call <span class="title">createRawCall</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	<span class="comment">//这里的args就是被动态代理的方法的参数, 【3.1.2.1】</span></div><div class="line">    Request request = serviceMethod.toRequest(args);</div><div class="line">    <span class="comment">//callFactory是OkHttpClient</span></div><div class="line">    okhttp3.Call call = serviceMethod.callFactory.newCall(request);</div><div class="line">    <span class="keyword">if</span> (call == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Call.Factory returned null."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> call;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>OkHttpClient</code>同样实现了<code>okhttp3.Call.Factory</code>接口， 而通过步骤【1】和【2.2】的代码可以看出, 这里的<code>callFactory</code>就是<code>OkHttpClient</code>,所以调用的是<code>OkhttpClient.newCall</code>(实际返回一个<code>okhttp3.RealCall</code>)</p>
<h5 id="3-1-1-1-ServiceMethod-toRequest"><a href="#3-1-1-1-ServiceMethod-toRequest" class="headerlink" title="3.1.1.1 ServiceMethod.toRequest"></a>3.1.1.1 ServiceMethod.toRequest</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function">Request <span class="title">toRequest</span><span class="params">(Object... args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       RequestBuilder requestBuilder = <span class="keyword">new</span> RequestBuilder(httpMethod, baseUrl, relativeUrl, headers,</div><div class="line">               contentType, hasBody, isFormEncoded, isMultipart);</div><div class="line"></div><div class="line">        ParameterHandler&lt;Object&gt;[] handlers = (ParameterHandler&lt;Object&gt;[]) parameterHandlers;</div><div class="line"></div><div class="line">       <span class="keyword">int</span> argumentCount = args != <span class="keyword">null</span> ? args.length : <span class="number">0</span>;</div><div class="line">       <span class="keyword">if</span> (argumentCount != handlers.length) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Argument count ("</span> + argumentCount</div><div class="line">                   + <span class="string">") doesn't match expected count ("</span> + handlers.length + <span class="string">")"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; argumentCount; p++) &#123;</div><div class="line">       	<span class="comment">//不同参数的注释有对应不同的handler, 以Query为例，其handler是Query&lt;T&gt;</span></div><div class="line">           handlers[p].apply(requestBuilder, args[p]);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> requestBuilder.build();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>这个方法的核心调用在于<code>handlers[p].apply</code>,不同的参数注释，对应这不同的<code>ParameterHandler</code>,以<code>@Query</code>为例，它所对应的<code>ParammeterHandler</code>是<code>Query&lt;T&gt;</code>, <code>Query&lt;T&gt;.apply</code>的作用是将<code>@Query</code>所修饰的参数转为<code>String</code>类型并添加到要请求的url的query string中</p>
<h4 id="3-1-2-OkHttpCall-parseResponse"><a href="#3-1-2-OkHttpCall-parseResponse" class="headerlink" title="3.1.2 OkHttpCall.parseResponse"></a>3.1.2 OkHttpCall.parseResponse</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function">Response&lt;T&gt; <span class="title">parseResponse</span><span class="params">(okhttp3.Response rawResponse)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        ResponseBody rawBody = rawResponse.body();</div><div class="line"></div><div class="line">        <span class="comment">// Remove the body's source (the only stateful object) so we can pass the response along.</span></div><div class="line">        rawResponse = rawResponse.newBuilder()</div><div class="line">                .body(<span class="keyword">new</span> NoContentResponseBody(rawBody.contentType(), rawBody.contentLength()))</div><div class="line">                .build();</div><div class="line"></div><div class="line">        <span class="keyword">int</span> code = rawResponse.code();</div><div class="line">        <span class="keyword">if</span> (code &lt; <span class="number">200</span> || code &gt;= <span class="number">300</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// Buffer the entire body to avoid future I/O.</span></div><div class="line">                ResponseBody bufferedBody = Utils.buffer(rawBody);</div><div class="line">                <span class="keyword">return</span> Response.error(bufferedBody, rawResponse);</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                rawBody.close();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (code == <span class="number">204</span> || code == <span class="number">205</span>) &#123;</div><div class="line">            rawBody.close();</div><div class="line">            <span class="keyword">return</span> Response.success(<span class="keyword">null</span>, rawResponse);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        ExceptionCatchingRequestBody catchingBody = <span class="keyword">new</span> ExceptionCatchingRequestBody(rawBody);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            T body = serviceMethod.toResponse(catchingBody);</div><div class="line">            <span class="keyword">return</span> Response.success(body, rawResponse);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">            <span class="comment">// If the underlying source threw an exception, propagate that rather than indicating it was</span></div><div class="line">            <span class="comment">// a runtime exception.</span></div><div class="line">            catchingBody.throwIfCaught();</div><div class="line">            <span class="keyword">throw</span> e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">`</div></pre></td></tr></table></figure>
<h4 id="3-1-3-ServiceMethod-toResponse"><a href="#3-1-3-ServiceMethod-toResponse" class="headerlink" title="3.1.3 ServiceMethod.toResponse"></a>3.1.3 ServiceMethod.toResponse</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function">R <span class="title">toResponse</span><span class="params">(ResponseBody body)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">return</span> responseConverter.convert(body);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在之前【2.2.2】中可以得知， 如果没有设置Converter，则使用默认的BuiltInConverter来获取对应的response convert, 如果方法中有<code>@Streaming</code>注释，则<code>responseConverter</code>是<code>StreamingResponseBodyConverter</code>, 否则是<code>BufferingResponseBodyConverter</code>, 一般情况下不会有<code>@Streaming</code>注释</p>
<h4 id="3-1-4-Converter-convert"><a href="#3-1-4-Converter-convert" class="headerlink" title="3.1.4 Converter.convert"></a>3.1.4 Converter.convert</h4><h5 id="3-1-4-1-StreamingResponseBodyConverter"><a href="#3-1-4-1-StreamingResponseBodyConverter" class="headerlink" title="3.1.4.1 StreamingResponseBodyConverter"></a>3.1.4.1 StreamingResponseBodyConverter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamingResponseBodyConverter</span></span></div><div class="line">        <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">ResponseBody</span>, <span class="title">ResponseBody</span>&gt; &#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> StreamingResponseBodyConverter INSTANCE = <span class="keyword">new</span> StreamingResponseBodyConverter();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ResponseBody <span class="title">convert</span><span class="params">(ResponseBody value)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">return</span> value;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="3-1-4-2-BufferingResponseBodyConverter"><a href="#3-1-4-2-BufferingResponseBodyConverter" class="headerlink" title="3.1.4.2 BufferingResponseBodyConverter"></a>3.1.4.2 BufferingResponseBodyConverter</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BufferingResponseBodyConverter</span></span></div><div class="line">            <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">ResponseBody</span>, <span class="title">ResponseBody</span>&gt; &#123;</div><div class="line">        <span class="keyword">static</span> <span class="keyword">final</span> BufferingResponseBodyConverter INSTANCE = <span class="keyword">new</span> BufferingResponseBodyConverter();</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ResponseBody <span class="title">convert</span><span class="params">(ResponseBody value)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Buffer the entire body to avoid future I/O.</span></div><div class="line">            <span class="keyword">return</span> Utils.buffer(value);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            value.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line"><span class="comment">//Utils.buffer </span></div><div class="line"><span class="function"><span class="keyword">static</span> ResponseBody <span class="title">buffer</span><span class="params">(<span class="keyword">final</span> ResponseBody body)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    Buffer buffer = <span class="keyword">new</span> Buffer();</div><div class="line">    body.source().readAll(buffer);</div><div class="line">    <span class="keyword">return</span> ResponseBody.create(body.contentType(), body.contentLength(), buffer);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://wangyun137.github.io/2017/07/24/DiskLruCache学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="王小宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="迷途小书童">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/07/24/DiskLruCache学习/" itemprop="url">DiskLruCache学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T15:15:26+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DiskLruCache/" itemprop="url" rel="index">
                    <span itemprop="name">DiskLruCache</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一-用法"><a href="#一-用法" class="headerlink" title="一. 用法"></a>一. 用法</h1><p><code>DiskLruCache</code>是Google官方推荐的磁盘缓存方案，很多优秀的App都在使用这一方案，在<a href="http://blog.csdn.net/guolin_blog/article/details/28863651" target="_blank" rel="external">Android DiskLruCache完全解析， 硬盘缓存的最佳方案</a>这篇博客中，很详细的介绍了如何使用<code>DiskLruCache</code>，通过这篇博文可以将<code>DiskLruCache</code>的用法总结为以下几个步骤:</p>
<h2 id="1-1-写缓存"><a href="#1-1-写缓存" class="headerlink" title="1.1 写缓存"></a>1.1 写缓存</h2><ol>
<li>确定缓存目录， 获取App版本号， 调用<code>DiskaLruCache.open</code>创建<code>DiskLruCache</code>对象</li>
<li>通过<code>DiskLruCache.editor()</code>获取<code>DiskLruCache.Editor</code>对象</li>
<li>通过<code>Editor.newOutputStream()</code>获取输出流，之后利用该输出流将缓存文件写入磁盘</li>
<li>调用<code>Editor.commit()</code>,<code>DiskLruCache.flush()</code>刷新日志文件</li>
</ol>
<h2 id="1-2-读缓存"><a href="#1-2-读缓存" class="headerlink" title="1.2 读缓存"></a>1.2 读缓存</h2><ol>
<li>通过<code>DiskLruCache.get()</code>获取<code>Snapshot</code>对象</li>
<li>通过<code>Snapshot.getInputStream()</code>获取输入流，利用该输入流读取缓存文件</li>
</ol>
<h2 id="1-3-日志文件"><a href="#1-3-日志文件" class="headerlink" title="1.3 日志文件"></a>1.3 日志文件</h2><p><code>DiskLruCache</code>主要通过日志文件来记录和管理缓存文件，在<code>DiskLruCache</code>的源码中有一段注释详细陈述了日志文件的格式:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">libcore.io.DiskLruCache</div><div class="line">1</div><div class="line">100</div><div class="line">2</div><div class="line"></div><div class="line">CLEAN 3400330d1dfc7f3f7f4b8d4d803dfcf6 832 21054</div><div class="line">DIRTY 335c4c6028171cfddfbaae1a9c313c52</div><div class="line">CLEAN 335c4c6028171cfddfbaae1a9c313c52 3934 2342</div><div class="line">REMOVE 335c4c6028171cfddfbaae1a9c313c52</div><div class="line">DIRTY 1ab96a171faeeee38496d8b330771a7a</div><div class="line">CLEAN 1ab96a171faeeee38496d8b330771a7a 1600 234</div><div class="line">READ 335c4c6028171cfddfbaae1a9c313c52</div><div class="line">READ 3400330d1dfc7f3f7f4b8d4d803dfcf6</div></pre></td></tr></table></figure>
<p>前五行是日志文件的头部信息，其意义分别是</p>
<ul>
<li>第一行的<code>libcore.io.DiskLruCache</code>是文件的<code>MAGIC</code>, 用来标识该文件是<code>DiskLruCache</code>的日志文件</li>
<li>第二行是<code>DiskLruCache</code>自身的版本号</li>
<li>第三行是App的版本号，通过<code>DiskLruCache.open</code>的第二个参数设置</li>
<li>第四行是<code>DiskLruCache.open</code>的第三个参数，代表一个key值可以缓存多少个Entry</li>
<li>第五行是一个空行</li>
</ul>
<p>从第六行开始记录了缓存文件的相应操作:</p>
<ul>
<li>每次调用<code>DiskLruCache.edit()</code>时，都会向日志文件写入一条DIRTY数据，表示当前正在准备写入一条缓存数据, DIRTY后面各一个空格写入缓存的key值</li>
<li>当调用<code>Editor.commit()</code>将缓存写入成功之后，会在DIRTY数据下一行写入一条key值相同的CLEAN数据， CLEAN后面隔一个空格写入相同的key值，key值后隔一个空格写入以字节为单位的该缓存文件的大小，如果在<code>DiskLruCache.open</code>中第三个参数<code>valueCount</code>传大于1的值，那么每一个key值可以对应多个缓存文件，相应的一条CLEAN数据后面就会记录多个缓存文件的大小，其数目等于<code>valueCount</code>；如果调用<code>Editor.abort()</code>，那么会在DIRTY数据下一行下入一条REMOVE记录。也就是说， 每一条DIRTY数据下一行都有条CLEAN数据或REMOVE<br>数据，DIRTY数据不可以单独存在，否则这条数据就会被删除掉; 当调用<code>DiskLruCache.get()</code>时都会想日志文件写如一条READ数据，表示正在读取缓存文件</li>
</ul>
<h1 id="二-源码分析"><a href="#二-源码分析" class="headerlink" title="二.源码分析"></a>二.源码分析</h1><p>下面就根据这几个步骤结合源码来看一下<code>DiskLruCache</code>的具体实现</p>
<h2 id="2-1-重要变量和类"><a href="#2-1-重要变量和类" class="headerlink" title="2.1 重要变量和类"></a>2.1 重要变量和类</h2><h3 id="2-1-1-变量"><a href="#2-1-1-变量" class="headerlink" title="2.1.1 变量"></a>2.1.1 变量</h3><ul>
<li>journalWriter: Writer 用于向日志文件写入内容</li>
<li>lruEntries: LinkedHashMap<string, entry=""> 每一个缓存文件都有一个对应的Entry对象，lruEntries用来存放key值对应的Entry对象</string,></li>
<li>redundantOpCount:记录操作缓存的次数，如果该值达到2000，<code>DiskLruCache</code>就会重新构建日志文件，将其中一些冗余的数据删除</li>
<li>size: 记录总有缓存文件总大小</li>
<li>maxSize: 所有缓存文件大小的总和的上限值，如果超过该值，那么就会删除一些缓存文件</li>
<li>cleanupCallable: Callable 当缓存文件总大小超过上限时会触发该任务，用于清除一些缓存文件，从而减少缓存文件总和</li>
</ul>
<h3 id="2-1-2-类"><a href="#2-1-2-类" class="headerlink" title="2.1.2 类"></a>2.1.2 类</h3><ul>
<li>Snapshot: 调用<code>DiskLruCache.get()</code>会获取一个<code>Snapshot</code>对象，通过<code>Snapshot</code>可以获取缓存文件的输入流</li>
<li>Editor: 编辑器，对于缓存文件的操作以及日志文件的更新都是通过这个类完成</li>
<li>Entry: 每一个缓存文件都有一个对应的<code>Entry</code>对象， <code>DiskLruCache</code>通过操作<code>Entry</code>对象来完成对缓存文件的操作</li>
<li>StrictLineReader: 封装了输入流，提供可以每次读取一行内容的方法</li>
</ul>
<h2 id="2-2-DiskLruCache-open"><a href="#2-2-DiskLruCache-open" class="headerlink" title="2.2 DiskLruCache.open"></a>2.2 DiskLruCache.open</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> String JOURNAL_FILE = <span class="string">"journal"</span>;</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> String JOURNAL_FILE_BACKUP = <span class="string">"journal.bkp"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DiskLruCache <span class="title">open</span><span class="params">(File directory, <span class="keyword">int</span> appVersion, <span class="keyword">int</span> valueCount, <span class="keyword">long</span> maxSize)</span></span></div><div class="line">           <span class="keyword">throws</span> IOException &#123;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (maxSize &lt;= <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"maxSize &lt;= 0"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (valueCount &lt;= <span class="number">0</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"valueCount &lt;= 0"</span>);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//如果备份文件存在则使用备份文件</span></div><div class="line">       File backupFile = <span class="keyword">new</span> File(directory, JOURNAL_FILE_BACKUP);</div><div class="line">       <span class="keyword">if</span> (backupFile.exists()) &#123;</div><div class="line">           File journalFile = <span class="keyword">new</span> File(directory, JOURNAL_FILE);</div><div class="line">           <span class="comment">//如果日志文件存在，删除备份文件</span></div><div class="line">           <span class="keyword">if</span> (journalFile.exists()) &#123;</div><div class="line">               backupFile.delete();</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="comment">//将备份文件重命名为日志文件</span></div><div class="line">               renameTo(backupFile, journalFile, <span class="keyword">false</span>);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Prefer to pick up where we left off.</span></div><div class="line">       DiskLruCache cache = <span class="keyword">new</span> DiskLruCache(directory, appVersion, valueCount, maxSize);</div><div class="line">       <span class="comment">//如果日志文件存在的话，读取日志文件并处理，填充lruEntries, 然后直接返回DiskLruCache对象</span></div><div class="line">       <span class="keyword">if</span> (cache.journalFile.exists()) &#123;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               <span class="comment">//读取journal文件, 【2.2.1】</span></div><div class="line">               cache.readJournal();</div><div class="line">               <span class="comment">//处理读取的journal文件内容, 【2.2.2】</span></div><div class="line">               cache.processJournal();</div><div class="line">               <span class="keyword">return</span> cache;</div><div class="line">           &#125; <span class="keyword">catch</span> (IOException journalIsCorrupt) &#123;</div><div class="line">               ...</div><div class="line">               cache.delete();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//如果没有已有的日志文件，创建对应的缓存目录， 并初始化日志文件</span></div><div class="line">       directory.mkdirs();</div><div class="line">       cache = <span class="keyword">new</span> DiskLruCache(directory, appVersion, valueCount, maxSize);</div><div class="line">       <span class="comment">//新建日志文件,【2.2.3】</span></div><div class="line">       cache.rebuildJournal();</div><div class="line">       <span class="keyword">return</span> cache;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先检查备份文件是否存在，之后再确定日志文件是否存在， 如果日志文件存在，则删除备份文件，如果日志文件不存在但备份文件村咋，将备份文件重命名为日志文件</li>
<li>创建<code>DiskLruCache</code>对象，构造函数中几个参数的意义分别是:<code>directory</code> - 缓存目录; <code>appVersion</code> - 应用版本号; <code>valueCount</code> - 一个可以可以缓存几个Entry, 一般都传1; <code>maxSize</code> - 所有缓存文件大小的总和占据的最大存储空间</li>
<li>如果日志文件已存在，读取日志文件并根据日志文件进行一些必要的操作，如删除以<code>DIRTY</code>开头的文件</li>
<li>如果日志文件不存在，创建缓存目录,并新建日志文件</li>
</ol>
<h3 id="2-2-1-DiskLruCache-readJournal"><a href="#2-2-1-DiskLruCache-readJournal" class="headerlink" title="2.2.1 DiskLruCache.readJournal"></a>2.2.1 DiskLruCache.readJournal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readJournal</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       StrictLineReader reader = <span class="keyword">new</span> StrictLineReader(<span class="keyword">new</span> FileInputStream(journalFile), Util.US_ASCII);</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">//读取第一行魔数</span></div><div class="line">           String magic = reader.readLine();</div><div class="line">           <span class="comment">//读取第二行version</span></div><div class="line">           String version = reader.readLine();</div><div class="line">           <span class="comment">//读取第三行appVersion</span></div><div class="line">           String appVersionString = reader.readLine();</div><div class="line">           <span class="comment">//读取第四行valueCount</span></div><div class="line">           String valueCountString = reader.readLine();</div><div class="line">           <span class="comment">//读取第五行空行</span></div><div class="line">           String blank = reader.readLine();</div><div class="line">           <span class="comment">//确保头部信息正确</span></div><div class="line">           <span class="keyword">if</span> (!MAGIC.equals(magic)</div><div class="line">                   || !VERSION_1.equals(version)</div><div class="line">                   || !Integer.toString(appVersion).equals(appVersionString)</div><div class="line">                   || !Integer.toString(valueCount).equals(valueCountString)</div><div class="line">                   || !<span class="string">""</span>.equals(blank)) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IOException(...);</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           <span class="keyword">int</span> lineCount = <span class="number">0</span>;</div><div class="line">           <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   <span class="comment">//处理这一行内容,【2.2.1.1】</span></div><div class="line">                   readJournalLine(reader.readLine());</div><div class="line">                   lineCount++;</div><div class="line">               &#125; <span class="keyword">catch</span> (EOFException endOfJournal) &#123;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="comment">//处理了多少行 - lruEntries.size()</span></div><div class="line">           redundantOpCount = lineCount - lruEntries.size();</div><div class="line"></div><div class="line">           <span class="comment">// 如果遇到IO异常， 重新构建日志文件</span></div><div class="line">           <span class="keyword">if</span> (reader.hasUnterminatedLine()) &#123;</div><div class="line">               rebuildJournal();</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               journalWriter = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(</div><div class="line">                       <span class="keyword">new</span> FileOutputStream(journalFile, <span class="keyword">true</span>), Util.US_ASCII));</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           Util.closeQuietly(reader);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>从代码中可以看到，读取日志文件每一行内容主要使用了<code>StrictLineReader</code>这个类， 这个类实际上封装了<code>InputStream</code>, 内部有一个缓存数组，每次缓存<strong>8192</strong>个字节，从而提高了读取的效率，当遇到换行符时即判定为一行内容</p>
</blockquote>
<ol>
<li>首先读取前五行，校验是否是正确的头部信息</li>
<li>c处理完前五行之后，依次读取每一行内容并根据内容进行操作</li>
<li>如果遇到IO异常，重新构建日志文件；否则一切正常的话， 初始化<code>journalWriter</code>(用来写入日志文件)</li>
</ol>
<h4 id="2-2-1-1-DiskLruCache-readJournalLine"><a href="#2-2-1-1-DiskLruCache-readJournalLine" class="headerlink" title="2.2.1.1 DiskLruCache.readJournalLine"></a>2.2.1.1 DiskLruCache.readJournalLine</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readJournalLine</span><span class="params">(String line)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="comment">//获取第一个空格的位置</span></div><div class="line">       <span class="keyword">int</span> firstSpace = line.indexOf(<span class="string">' '</span>);</div><div class="line">       <span class="keyword">if</span> (firstSpace == -<span class="number">1</span>) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"unexpected journal line: "</span> + line);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//第一个空格后面是key的起始位置</span></div><div class="line">       <span class="keyword">int</span> keyBegin = firstSpace + <span class="number">1</span>;</div><div class="line">       <span class="comment">//获取第二个空格的位置， 一般如果是CLEAN的话会有第二个空格</span></div><div class="line">       <span class="keyword">int</span> secondSpace = line.indexOf(<span class="string">' '</span>, keyBegin);</div><div class="line">       <span class="keyword">final</span> String key;</div><div class="line">       <span class="keyword">if</span> (secondSpace == -<span class="number">1</span>) &#123;</div><div class="line">           key = line.substring(keyBegin);</div><div class="line">           <span class="comment">//如果这一行的开头是REMOVE, 从lruEntries中删除key</span></div><div class="line">           <span class="keyword">if</span> (firstSpace == REMOVE.length() &amp;&amp; line.startsWith(REMOVE)) &#123;</div><div class="line">               lruEntries.remove(key);</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           key = line.substring(keyBegin, secondSpace);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//从lruEntries中获取key值对应的Entry, 如果lruEntries中没有对应的Entry，生成一个新的Entry并放入lruEntries</span></div><div class="line">       Entry entry = lruEntries.get(key);</div><div class="line">       <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">           entry = <span class="keyword">new</span> Entry(key);</div><div class="line">           lruEntries.put(key, entry);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//如果这一行是以CLEAN开头, 获取第二个空格之后内容</span></div><div class="line">       <span class="keyword">if</span> (secondSpace != -<span class="number">1</span> &amp;&amp; firstSpace == CLEAN.length() &amp;&amp; line.startsWith(CLEAN)) &#123;</div><div class="line">           String[] parts = line.substring(secondSpace + <span class="number">1</span>).split(<span class="string">" "</span>);</div><div class="line">           entry.readable = <span class="keyword">true</span>;</div><div class="line">           entry.currentEditor = <span class="keyword">null</span>;</div><div class="line">           entry.setLengths(parts);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//如果这一行是以DIRTY开头，将currentEditor指向一个新的Editor</span></div><div class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (secondSpace == -<span class="number">1</span> &amp;&amp; firstSpace == DIRTY.length() &amp;&amp; line.startsWith(DIRTY)) &#123;</div><div class="line">           entry.currentEditor = <span class="keyword">new</span> Editor(entry);</div><div class="line">       &#125;</div><div class="line">       <span class="comment">//如果这一行以READ开头，啥也不干</span></div><div class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (secondSpace == -<span class="number">1</span> &amp;&amp; firstSpace == READ.length() &amp;&amp; line.startsWith(READ)) &#123;</div><div class="line">           <span class="comment">// This work was already done by calling lruEntries.get().</span></div><div class="line">       &#125;</div><div class="line">       <span class="keyword">else</span> &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"unexpected journal line: "</span> + line);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>根据空格依次获得每一行的开头标识(DIRTY, CLEAN, REMOVE)以及对应的key值</li>
<li>如果这一行是以REMOVE开头，从<code>lruEntries</code>中删除key对应的Entry并返回</li>
<li>从<code>lruEntries</code>中获取key值对应的<code>Entry</code>，如果没有则生成一个新的<code>Entry</code>对象并放入<code>lruEntries</code>,这个操作的目的是为了保持日志文件和内存中<code>lruEntries</code>的数据的一致性</li>
<li>如果这一行是以CLEAN开头，获取key值以后的内容(记录一个或多个对象缓存文件的大小)，同时标记<code>entry.readable = true</code>, <code>entry.currentEditor = null</code>，即表示该缓存文件为可读的</li>
<li>如果这一行是以DIRTY开头的，将<code>entry.currentEditor</code>指向一个新创建的<code>Editor</code>对象</li>
</ol>
<h3 id="2-2-2-DiskLruCache-processJournal"><a href="#2-2-2-DiskLruCache-processJournal" class="headerlink" title="2.2.2 DiskLruCache.processJournal"></a>2.2.2 DiskLruCache.processJournal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processJournal</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="comment">//删除journal.tmp文件</span></div><div class="line">        deleteIfExists(journalFileTmp);</div><div class="line">        <span class="comment">//遍历lruEntries</span></div><div class="line">        <span class="keyword">for</span> (Iterator&lt;Entry&gt; i = lruEntries.values().iterator(); i.hasNext(); ) &#123;</div><div class="line">            Entry entry = i.next();</div><div class="line">            <span class="keyword">if</span> (entry.currentEditor == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//如果currentEditor为null, 代表该entry是CLEAN的，增加size</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> t = <span class="number">0</span>; t &lt; valueCount; t++) &#123;</div><div class="line">                    size += entry.lengths[t];</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//如果currentEditor不为null， 代表该entry是DIRTY的，删除对应的缓存文件和临时文件</span></div><div class="line">                <span class="comment">//并从lruEntries中删除该entry</span></div><div class="line">                entry.currentEditor = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> t = <span class="number">0</span>; t &lt; valueCount; t++) &#123;</div><div class="line">                    deleteIfExists(entry.getCleanFile(t));</div><div class="line">                    deleteIfExists(entry.getDirtyFile(t));</div><div class="line">                &#125;</div><div class="line">                i.remove();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol>
<li>如果临时日志文件存在，删除临时文件</li>
<li>遍历<code>lruEntries</code>, 如果<code>entry.currentEditor == null</code>代表这一个entry是CLEAN的，将entry对应的文件大小统计到所有缓存文件大小总和中；相反，则代表entry是DIRTY的，删除对应的缓存文件，并从<code>lruEntries</code>中删除(NOTE:这里其实针对的是只有DIRTY记录的缓存文件，因为正常情况下，每一条DIRTY数据后都会紧跟一条CLEAN或者REMOVE数据，如果有CLEAN或REMOVE数据，在之前的【2.2.1.1】<code>readJournalLine</code>中都已经经过了处理，其所对应的entry的currentEditor肯定为null或不在<code>lruEntries</code>中了)</li>
</ol>
<h3 id="2-2-3-DiskLruCache-rebuildJournal"><a href="#2-2-3-DiskLruCache-rebuildJournal" class="headerlink" title="2.2.3 DiskLruCache.rebuildJournal"></a>2.2.3 DiskLruCache.rebuildJournal</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">rebuildJournal</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="keyword">if</span> (journalWriter != <span class="keyword">null</span>) &#123;</div><div class="line">           journalWriter.close();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//先写入journal.tmp文件</span></div><div class="line">       Writer writer = <span class="keyword">new</span> BufferedWriter(</div><div class="line">               <span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(journalFileTmp), Util.US_ASCII));</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="comment">//写入头部信息</span></div><div class="line">           writer.write(MAGIC);</div><div class="line">           writer.write(<span class="string">"\n"</span>);</div><div class="line">           writer.write(VERSION_1);</div><div class="line">           writer.write(<span class="string">"\n"</span>);</div><div class="line">           writer.write(Integer.toString(appVersion));</div><div class="line">           writer.write(<span class="string">"\n"</span>);</div><div class="line">           writer.write(Integer.toString(valueCount));</div><div class="line">           writer.write(<span class="string">"\n"</span>);</div><div class="line">           writer.write(<span class="string">"\n"</span>);</div><div class="line"></div><div class="line">           <span class="keyword">for</span> (Entry entry : lruEntries.values()) &#123;</div><div class="line">               <span class="keyword">if</span> (entry.currentEditor != <span class="keyword">null</span>) &#123;</div><div class="line">                   <span class="comment">//如果currentEditor不为null, 则写入DIRTY开头的行</span></div><div class="line">                   writer.write(DIRTY + <span class="string">' '</span> + entry.key + <span class="string">'\n'</span>);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="comment">//写入以CLEAN开头的行</span></div><div class="line">                   writer.write(CLEAN + <span class="string">' '</span> + entry.key + entry.getLengths() + <span class="string">'\n'</span>);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           writer.close();</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (journalFile.exists()) &#123;</div><div class="line">           renameTo(journalFile, journalFileBackup, <span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">       renameTo(journalFileTmp, journalFile, <span class="keyword">false</span>);</div><div class="line">       journalFileBackup.delete();</div><div class="line"></div><div class="line">       journalWriter = <span class="keyword">new</span> BufferedWriter(</div><div class="line">               <span class="keyword">new</span> OutputStreamWriter(<span class="keyword">new</span> FileOutputStream(journalFile, <span class="keyword">true</span>), Util.US_ASCII));</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>首先写入固定头部</li>
<li>遍历<code>lruEntries</code>,根据<code>entry.currentEditor</code>是否等于null，写入DIRTY或者CLEAN记录</li>
</ol>
<h2 id="2-3-DiskLruCache-edit"><a href="#2-3-DiskLruCache-edit" class="headerlink" title="2.3 DiskLruCache.edit"></a>2.3 DiskLruCache.edit</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> Editor <span class="title">edit</span><span class="params">(String key)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="keyword">return</span> edit(key, ANY_SEQUENCE_NUMBER);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> Editor <span class="title">edit</span><span class="params">(String key, <span class="keyword">long</span> expectedSequenceNumber)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="comment">//如果journalWritter == null， 抛出异常</span></div><div class="line">       checkNotClosed();</div><div class="line">       <span class="comment">//校验key是否合法</span></div><div class="line">       validateKey(key);</div><div class="line">       <span class="comment">//从lruEntries中获取Entry</span></div><div class="line">       Entry entry = lruEntries.get(key);</div><div class="line">       <span class="keyword">if</span> (expectedSequenceNumber != ANY_SEQUENCE_NUMBER &amp;&amp; (entry == <span class="keyword">null</span></div><div class="line">               || entry.sequenceNumber != expectedSequenceNumber)) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// Snapshot is stale.</span></div><div class="line">       &#125;</div><div class="line">       <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">           entry = <span class="keyword">new</span> Entry(key);</div><div class="line">           lruEntries.put(key, entry);</div><div class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry.currentEditor != <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// Another edit is in progress.</span></div><div class="line">       &#125;</div><div class="line"></div><div class="line">       Editor editor = <span class="keyword">new</span> Editor(entry);</div><div class="line">       entry.currentEditor = editor;</div><div class="line"></div><div class="line">       <span class="comment">// 先写入DIRTY行</span></div><div class="line">       journalWriter.write(DIRTY + <span class="string">' '</span> + key + <span class="string">'\n'</span>);</div><div class="line">       journalWriter.flush();</div><div class="line">       <span class="keyword">return</span> editor;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>检查<code>journal</code>是否为null, 如果是抛出异常</li>
<li>检查key值是否符合<code>[a-z0-9_-]{1,120}</code>规则</li>
<li>根据key获取对应的<code>Entry</code></li>
<li>新建一个<code>Editor</code>对象，将<code>entry.currentEditor</code>指向新建的<code>Editor</code>对象</li>
<li>向日志文件写入DIRTY数据</li>
</ol>
<blockquote>
<p>每当调用<code>editor()</code>时都会先在日志文件中写入一条DIRTY数据,表示正在准备操作缓存文件</p>
</blockquote>
<h2 id="2-4-Editor-newOutputStream"><a href="#2-4-Editor-newOutputStream" class="headerlink" title="2.4 Editor.newOutputStream"></a>2.4 Editor.newOutputStream</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> OutputStream <span class="title">newOutputStream</span><span class="params">(<span class="keyword">int</span> index)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">           <span class="keyword">if</span> (index &lt; <span class="number">0</span> || index &gt;= valueCount) &#123;</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(...);</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">synchronized</span> (DiskLruCache.<span class="keyword">this</span>) &#123;</div><div class="line">               <span class="keyword">if</span> (entry.currentEditor != <span class="keyword">this</span>) &#123;</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (!entry.readable) &#123;</div><div class="line">                   written[index] = <span class="keyword">true</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="comment">//先在临时文件中写入</span></div><div class="line">               File dirtyFile = entry.getDirtyFile(index);</div><div class="line">               FileOutputStream outputStream;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   outputStream = <span class="keyword">new</span> FileOutputStream(dirtyFile);</div><div class="line">               &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">                   <span class="comment">// Attempt to recreate the cache directory.</span></div><div class="line">                   directory.mkdirs();</div><div class="line">                   <span class="keyword">try</span> &#123;</div><div class="line">                       outputStream = <span class="keyword">new</span> FileOutputStream(dirtyFile);</div><div class="line">                   &#125; <span class="keyword">catch</span> (FileNotFoundException e2) &#123;</div><div class="line">                       <span class="comment">// We are unable to recover. Silently eat the writes.</span></div><div class="line">                       <span class="keyword">return</span> NULL_OUTPUT_STREAM;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               <span class="comment">//FaultHidingOutputStream是一个代理类，实际还是调用outputStream的方法</span></div><div class="line">               <span class="comment">//只不过异常发生时会不会抛出异常</span></div><div class="line">               <span class="keyword">return</span> <span class="keyword">new</span> FaultHidingOutputStream(outputStream);</div><div class="line">           &#125;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>获取的是临时文件的输出流</p>
<h2 id="2-5-Editor-commit"><a href="#2-5-Editor-commit" class="headerlink" title="2.5 Editor.commit"></a>2.5 Editor.commit</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (hasErrors) &#123;</div><div class="line">        <span class="comment">//如果有错误，删除缓存文件, 【2.5.1】</span></div><div class="line">        completeEdit(<span class="keyword">this</span>, <span class="keyword">false</span>);</div><div class="line">        remove(entry.key); <span class="comment">// The previous entry is stale.</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        completeEdit(<span class="keyword">this</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    committed = <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果IO输出过程有错误发生，从<code>lruEntries</code>中删除相应entry,同时删除对应的缓存文件; 无论是否错误，都会调用<code>DiskLruCache.compleEdit</code>方法, 区别在于错误时传入的第二个参数为false, 正常时为true</p>
<blockquote>
<p><code>hasError</code>是在<code>FaultHidingOutputStream</code>中当出现IO异常时设为true</p>
</blockquote>
<h3 id="2-5-1-DiskLruCache-completeEdit"><a href="#2-5-1-DiskLruCache-completeEdit" class="headerlink" title="2.5.1 DiskLruCache.completeEdit"></a>2.5.1 DiskLruCache.completeEdit</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">completeEdit</span><span class="params">(Editor editor, <span class="keyword">boolean</span> success)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       Entry entry = editor.entry;</div><div class="line">       <span class="keyword">if</span> (entry.currentEditor != editor) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</div><div class="line">       &#125;</div><div class="line"></div><div class="line"></div><div class="line">       <span class="keyword">if</span> (success &amp;&amp; !entry.readable) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">               <span class="keyword">if</span> (!editor.written[i]) &#123;</div><div class="line">                   editor.abort();</div><div class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(...);</div><div class="line">               &#125;</div><div class="line">               <span class="comment">//确保临时文件存在</span></div><div class="line">               <span class="keyword">if</span> (!entry.getDirtyFile(i).exists()) &#123;</div><div class="line">                   editor.abort();</div><div class="line">                   <span class="keyword">return</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">           File dirty = entry.getDirtyFile(i);</div><div class="line">           <span class="keyword">if</span> (success) &#123;</div><div class="line">               <span class="keyword">if</span> (dirty.exists()) &#123;</div><div class="line">                   File clean = entry.getCleanFile(i);</div><div class="line">                   dirty.renameTo(clean);</div><div class="line">                   <span class="keyword">long</span> oldLength = entry.lengths[i];</div><div class="line">                   <span class="keyword">long</span> newLength = clean.length();</div><div class="line">                   entry.lengths[i] = newLength;</div><div class="line">                   size = size - oldLength + newLength;</div><div class="line">               &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               deleteIfExists(dirty);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       redundantOpCount++;</div><div class="line">       entry.currentEditor = <span class="keyword">null</span>;</div><div class="line">       <span class="keyword">if</span> (entry.readable | success) &#123;</div><div class="line">           entry.readable = <span class="keyword">true</span>;</div><div class="line">           <span class="comment">//向日志文件写入CLEAN行</span></div><div class="line">           journalWriter.write(CLEAN + <span class="string">' '</span> + entry.key + entry.getLengths() + <span class="string">'\n'</span>);</div><div class="line">           <span class="keyword">if</span> (success) &#123;</div><div class="line">               entry.sequenceNumber = nextSequenceNumber++;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">//从lruEntries中删除，并向日志文件写入REMOVE行</span></div><div class="line">           lruEntries.remove(entry.key);</div><div class="line">           journalWriter.write(REMOVE + <span class="string">' '</span> + entry.key + <span class="string">'\n'</span>);</div><div class="line">       &#125;</div><div class="line">       journalWriter.flush();</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (size &gt; maxSize || journalRebuildRequired()) &#123;</div><div class="line">           executorService.submit(cleanupCallable);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>确保临时的缓存文件存在，不存在则调用<code>Editor.abort</code></li>
<li>如果传入的<code>success = true</code>即代表IO输出成功，则将临时缓存文件重命名为正式的缓存文件，同时更新缓存文件大小总和；如果<code>sucess = false</code>代表出现错误，则删除临时缓存文件</li>
<li>递增<code>redundantOpCount</code></li>
<li>如果IO输出成功，想日志文件写入CLEAN行数据，否则从<code>lruEntries</code>中删除对应的entry,并向日志文件写入REMOVE行内容</li>
<li>如果缓存文件总大小超出上限或者<code>redundantOpCount</code>大于等于2000时，在线程池中执行<code>cleanupCallable</code>任务</li>
</ol>
<h4 id="2-5-1-1-DiskLruCache-cleanupCallable"><a href="#2-5-1-1-DiskLruCache-cleanupCallable" class="headerlink" title="2.5.1.1 DiskLruCache.cleanupCallable"></a>2.5.1.1 DiskLruCache.cleanupCallable</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Callable&lt;Void&gt; cleanupCallable = <span class="keyword">new</span> Callable&lt;Void&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Void <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (DiskLruCache.<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (journalWriter == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// Closed.</span></div><div class="line">            &#125;</div><div class="line">            trimToSize();</div><div class="line">            <span class="keyword">if</span> (journalRebuildRequired()) &#123;</div><div class="line">            	<span class="comment">//【2.2.3】</span></div><div class="line">                rebuildJournal();</div><div class="line">                redundantOpCount = <span class="number">0</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">trimToSize</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="comment">//如果缓存的文件总大小超过了maxSize, 删除缓存文件直到小于上限，并更新日志文件</span></div><div class="line">    <span class="keyword">while</span> (size &gt; maxSize) &#123;</div><div class="line">        Map.Entry&lt;String, Entry&gt; toEvict = lruEntries.entrySet().iterator().next();</div><div class="line">        remove(toEvict.getKey());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">journalRebuildRequired</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> redundantOpCompactThreshold = <span class="number">2000</span>;</div><div class="line">    <span class="keyword">return</span> redundantOpCount &gt;= redundantOpCompactThreshold <span class="comment">//</span></div><div class="line">            &amp;&amp; redundantOpCount &gt;= lruEntries.size();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-6-DiskLruCache-flush"><a href="#2-6-DiskLruCache-flush" class="headerlink" title="2.6 DiskLruCache.flush"></a>2.6 DiskLruCache.flush</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		<span class="comment">//确保journalWriter不等于null</span></div><div class="line">     checkNotClosed();</div><div class="line">     <span class="comment">//【2.5.1.1】, 删除缓存文件，直到总大小小于上限</span></div><div class="line">     trimToSize();</div><div class="line">     journalWriter.flush();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="2-7-DiskLruCache-get"><a href="#2-7-DiskLruCache-get" class="headerlink" title="2.7 DiskLruCache.get"></a>2.7 DiskLruCache.get</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Snapshot <span class="title">get</span><span class="params">(String key)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">	<span class="comment">//确保journalWriter不为null</span></div><div class="line">       checkNotClosed();</div><div class="line">       <span class="comment">//验证key值符合规则</span></div><div class="line">       validateKey(key);</div><div class="line">       Entry entry = lruEntries.get(key);</div><div class="line">       <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (!entry.readable) &#123;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line">	<span class="comment">//创建缓存文件输入流</span></div><div class="line">       InputStream[] ins = <span class="keyword">new</span> InputStream[valueCount];</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">               ins[i] = <span class="keyword">new</span> FileInputStream(entry.getCleanFile(i));</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</div><div class="line">           <span class="comment">// A file must have been deleted manually!</span></div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; valueCount; i++) &#123;</div><div class="line">               <span class="keyword">if</span> (ins[i] != <span class="keyword">null</span>) &#123;</div><div class="line">                   Util.closeQuietly(ins[i]);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">break</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       redundantOpCount++;</div><div class="line">       <span class="comment">//更新日志文件，添加READ行</span></div><div class="line">       journalWriter.append(READ + <span class="string">' '</span> + key + <span class="string">'\n'</span>);</div><div class="line">       <span class="keyword">if</span> (journalRebuildRequired()) &#123;</div><div class="line">           executorService.submit(cleanupCallable);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Snapshot(key, entry.sequenceNumber, ins, entry.lengths);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ol>
<li>确保<code>journalWriter</code>不等于null, key值符合规则</li>
<li>创建缓存文件输入流</li>
<li>向日志文件中写入READ行</li>
<li>返回<code>Snapshot</code>对象</li>
</ol>
<h2 id="2-8-DiskLruCache-close"><a href="#2-8-DiskLruCache-close" class="headerlink" title="2.8 DiskLruCache.close"></a>2.8 DiskLruCache.close</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    <span class="keyword">if</span> (journalWriter == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>; <span class="comment">// Already closed.</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (Entry entry : <span class="keyword">new</span> ArrayList&lt;Entry&gt;(lruEntries.values())) &#123;</div><div class="line">        <span class="keyword">if</span> (entry.currentEditor != <span class="keyword">null</span>) &#123;</div><div class="line">            entry.currentEditor.abort();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    trimToSize();</div><div class="line">    journalWriter.close();</div><div class="line">    journalWriter = <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>遍历<code>lruEntries</code>,如果<code>entry.currentEditor != null</code>, 调用<code>Editor.abort</code>(abort方法实际调用<code>DiakLruache.completeEdit</code>【2.5.1】, 第二个参数传入false)</li>
<li>检查缓存总大小是否超出上限，如果超出，删除一些缓存文件直到小于上限</li>
<li>关闭<code>journalWrite</code></li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/img/avatar.jpg"
               alt="王小宝" />
          <p class="site-author-name" itemprop="name">王小宝</p>
           
              <p class="site-description motion-element" itemprop="description">90后迷途小书童</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/wangyun137" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/73df471e39bb" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  简书
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">王小宝</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  






  





  

  

  

  

  

  

</body>
</html>
